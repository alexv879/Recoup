module.exports=[65474,e=>e.a(async(t,a)=>{try{var r=e.i(89171),i=e.i(7218),o=e.i(68253),n=e.i(55742),l=e.i(41310),s=e.i(9053),c=e.i(38851),d=e.i(15776),u=e.i(69907),p=t([o,n,s,c]);async function h(e){let t=Date.now();try{let{userId:a}=await (0,i.auth)();if(!a)throw d.errors.unauthorized();(0,u.logApiRequest)("POST","/api/collections/ai-call",a),await (0,s.requirePremiumAccess)(a,"ai_voice_calls"),await (0,c.validateConsentOrThrow)(a,["call","call_recording","data_storage"]);let{invoiceId:p,recipientPhone:h,recipientName:m,enablePaymentDuringCall:w=!0}=await e.json();if(!p||!h||!m)throw d.errors.badRequest("Missing required fields: invoiceId, recipientPhone, recipientName");let f=await o.db.collection("invoices").doc(p).get();if(!f.exists)throw d.errors.notFound("Invoice not found");let R=f.data();if(R.freelancerId!==a)throw d.errors.forbidden("You do not have access to this invoice");if("paid"===R.status)throw d.errors.badRequest("Invoice is already paid");if(R.amount<50)throw d.errors.badRequest("Invoice amount too low for AI call (minimum Â£50)");let v=(await o.db.collection("users").doc(a).get()).data(),g=v?.businessName||v?.name||"Your Freelancer",A=Math.floor((Date.now()-R.dueDate.toMillis())/864e5),C=await o.db.collection("collection_attempts").where("invoiceId","==",p).where("attemptType","==","ai_call").orderBy("createdAt","desc").limit(1).get();if(!C.empty){let e=C.docs[0].data();if((Date.now()-e.createdAt.toMillis())/36e5<24)throw d.errors.badRequest("Cannot make another AI call within 24 hours of the last call")}let E=await (0,l.initiateAICollectionCall)({recipientPhone:h,recipientName:m,invoiceReference:R.reference,amount:R.amount,dueDate:R.dueDate.toDate().toLocaleDateString("en-GB"),daysPastDue:A,businessName:g,invoiceId:p,freelancerId:a,enablePaymentDuringCall:w});if(!E.success)throw Error(E.error||"Failed to initiate call");let y=o.db.collection("collection_attempts").doc();await y.set({attemptId:y.id,invoiceId:p,freelancerId:a,attemptType:"ai_call",attemptDate:n.FieldValue.serverTimestamp(),attemptNumber:R.collectionsAttempts+1,result:"pending",resultDetails:"AI call initiated, awaiting completion",callSID:E.callSid,callStartedAt:n.FieldValue.serverTimestamp(),callOutcome:void 0,isPremiumFeature:!0,consentGiven:!0,createdAt:n.FieldValue.serverTimestamp()}),await o.db.collection("invoices").doc(p).update({collectionsAttempts:n.FieldValue.increment(1),updatedAt:n.FieldValue.serverTimestamp()});let I=(0,l.estimateAICallCost)({estimatedDurationMinutes:5,includeSMS:w,includeRecording:!0});await (0,s.logPremiumFeatureUsage)({userId:a,feature:"ai_voice_calls",invoiceId:p,cost:I.total}),(0,u.logInfo)("AI collection call initiated",{invoiceId:p,callSid:E.callSid,estimatedCost:I.total});let x=Date.now()-t;return(0,u.logApiResponse)("POST","/api/collections/ai-call",200,x,a),r.NextResponse.json({success:!0,message:"AI collection call initiated",attemptId:y.id,callSid:E.callSid,estimatedCost:I.total,costBreakdown:I,note:"Call is in progress. You will receive a notification when it completes."})}catch(a){let e=Date.now()-t;if((0,u.logApiResponse)("POST","/api/collections/ai-call",a.statusCode||500,e),402===a.statusCode)return r.NextResponse.json({error:a.message,upgradeRequired:!0,upgradeUrl:"/settings/billing/upgrade"},{status:402});return(0,d.handleApiError)(a)}}async function m(e){try{let{userId:t}=await (0,i.auth)();if(!t)throw d.errors.unauthorized();let{searchParams:a}=new URL(e.url),n=a.get("attemptId");if(!n)throw d.errors.badRequest("Missing attemptId parameter");let l=await o.db.collection("collection_attempts").doc(n).get();if(!l.exists)throw d.errors.notFound("Call attempt not found");let s=l.data();if(s?.freelancerId!==t)throw d.errors.forbidden("You do not have access to this call");return r.NextResponse.json({success:!0,attempt:{attemptId:s.attemptId,callSid:s.callSID,status:s.result,outcome:s.callOutcome,duration:s.callDuration,transcript:s.callTranscript,summary:s.callNotes,recordingUrl:s.callRecordingUrl,startedAt:s.callStartedAt,endedAt:s.callEndedAt,nextAction:s.nextAction}})}catch(e){return(0,d.handleApiError)(e)}}[o,n,s,c]=p.then?(await p)():p,e.s(["GET",()=>m,"POST",()=>h,"dynamic",0,"force-dynamic"]),a()}catch(e){a(e)}},!1),37954,e=>e.a(async(t,a)=>{try{var r=e.i(47909),i=e.i(74017),o=e.i(96250),n=e.i(84243),l=e.i(61916),s=e.i(14444),c=e.i(37092),d=e.i(69741),u=e.i(16795),p=e.i(87718),h=e.i(95169),m=e.i(47587),w=e.i(66012),f=e.i(70101),R=e.i(26937),v=e.i(10372),g=e.i(93695);e.i(52474);var A=e.i(220),C=e.i(65474),E=t([C]);[C]=E.then?(await E)():E;let x=new r.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/collections/ai-call/route",pathname:"/api/collections/ai-call",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/collections/ai-call/route.ts",nextConfigOutput:"",userland:C}),{workAsyncStorage:b,workUnitAsyncStorage:S,serverHooks:T}=x;function y(){return(0,o.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:S})}async function I(e,t,a){x.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/collections/ai-call/route";r=r.replace(/\/index$/,"")||"/";let o=await x.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!o)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:C,params:E,nextConfig:y,parsedUrl:I,isDraftMode:b,prerenderManifest:S,routerServerContext:T,isOnDemandRevalidate:P,revalidateOnlyGenerated:_,resolvedPathname:N,clientReferenceManifest:D,serverActionsManifest:O}=o,q=(0,d.normalizeAppPath)(r),M=!!(S.dynamicRoutes[q]||S.routes[N]),U=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,I,!1):t.end("This page could not be found"),null);if(M&&!b){let e=!!S.routes[N],t=S.dynamicRoutes[q];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await U();throw new g.NoFallbackError}}let F=null;!M||x.isDev||b||(F=N,F="/index"===F?"/":F);let H=!0===x.isDev||!M,k=M&&!H;O&&D&&(0,s.setReferenceManifestsSingleton)({page:r,clientReferenceManifest:D,serverActionsManifest:O,serverModuleMap:(0,c.createServerModuleMap)({serverActionsManifest:O})});let j=e.method||"GET",$=(0,l.getTracer)(),B=$.getActiveScopeSpan(),K={params:E,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>x.onRequestError(e,t,r,T)},sharedContext:{buildId:C}},V=new u.NodeNextRequest(e),L=new u.NodeNextResponse(t),G=p.NextRequestAdapter.fromNodeNextRequest(V,(0,p.signalFromNodeResponse)(t));try{let o=async e=>x.handle(G,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=$.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==h.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=a.get("next.route");if(i){let t=`${j} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${r}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),c=async n=>{var l,c;let d=async({previousCacheEntry:i})=>{try{if(!s&&P&&_&&!i)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await o(n);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let c=K.renderOpts.collectedTags;if(!M)return await (0,w.sendResponse)(V,L,r,K.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(r.headers);c&&(t[v.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=v.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,i=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=v.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:A.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:i}}}}catch(t){throw(null==i?void 0:i.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:P})},T),t}},u=await x.handleResponse({req:e,nextConfig:y,cacheKey:F,routeKind:i.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:P,revalidateOnlyGenerated:_,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:s});if(!M)return null;if((null==u||null==(l=u.value)?void 0:l.kind)!==A.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(c=u.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",P?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,f.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&M||p.delete(v.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,R.getCacheControlHeader)(u.cacheControl)),await (0,w.sendResponse)(V,L,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};B?await c(B):await $.withPropagatedContext(e.headers,()=>$.trace(h.BaseServerSpan.handleRequest,{spanName:`${j} ${r}`,kind:l.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},c))}catch(t){if(t instanceof g.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:q,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:P})}),M)throw t;return await (0,w.sendResponse)(V,L,new Response(null,{status:500})),null}}e.s(["handler",()=>I,"patchFetch",()=>y,"routeModule",()=>x,"serverHooks",()=>T,"workAsyncStorage",()=>b,"workUnitAsyncStorage",()=>S]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=_3149816a._.js.map