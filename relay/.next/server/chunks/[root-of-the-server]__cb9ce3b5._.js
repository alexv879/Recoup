module.exports=[17608,e=>e.a(async(t,a)=>{try{var n=e.i(68253),o=e.i(55742),r=e.i(69907),i=t([n,o]);async function c(e){let t=Date.now();try{let a=e.grossAmount*e.agencyCommissionRate,i=e.grossAmount-a,c=n.db.collection("payment_transactions").doc(),s={transactionId:c.id,transactionType:"agency_recovery",invoiceId:e.invoiceId,freelancerId:e.freelancerId,agencyHandoffId:e.agencyHandoffId,agencyId:e.agencyId,grossAmount:e.grossAmount,agencyCommissionRate:e.agencyCommissionRate,agencyCommissionAmount:a,netToFreelancer:i,status:"pending",notes:e.notes,createdAt:o.Timestamp.now()};return await c.set(s),(0,r.logDbOperation)("create_agency_recovery_transaction","payment_transactions",c.id,Date.now()-t),(0,r.logInfo)("Agency recovery transaction created",{transactionId:c.id,invoiceId:e.invoiceId,grossAmount:e.grossAmount,netToFreelancer:i}),{success:!0,transactionId:c.id}}catch(e){return(0,r.logError)("Failed to create agency recovery transaction",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function s(e,t=50){let a=Date.now();try{let o=await n.db.collection("payment_transactions").where("freelancerId","==",e).orderBy("createdAt","desc").limit(t).get();return(0,r.logDbOperation)("get_freelancer_transactions","payment_transactions",void 0,Date.now()-a),o.docs.map(e=>e.data())}catch(e){return(0,r.logError)("Failed to get freelancer transactions",e),[]}}async function l(e){try{let t=(await s(e,1e3)).filter(e=>"completed"===e.status),a=t.reduce((e,t)=>e+t.grossAmount,0),n=t.reduce((e,t)=>e+t.agencyCommissionAmount,0),o=t.reduce((e,t)=>e+t.netToFreelancer,0);return{totalRecovered:a,totalCommission:n,totalNet:o,transactionCount:t.length}}catch(e){return(0,r.logError)("Failed to calculate freelancer recoveries",e),{totalRecovered:0,totalCommission:0,totalNet:0,transactionCount:0}}}[n,o]=i.then?(await i)():i,e.s(["calculateFreelancerRecoveries",()=>l,"createAgencyRecoveryTransaction",()=>c,"getFreelancerTransactions",()=>s]),a()}catch(e){a(e)}},!1),94222,e=>e.a(async(t,a)=>{try{let t=await e.y("firebase-admin/storage");e.n(t),a()}catch(e){a(e)}},!0),53515,e=>e.a(async(t,a)=>{try{var n=e.i(94222),o=e.i(56300),r=e.i(69907),i=t([n,o]);function c(){if(!(0,o.getApps)().length)throw Error("Firebase is not initialized");let e=(0,n.getStorage)(),t=process.env.FIREBASE_STORAGE_BUCKET||`${process.env.FIREBASE_PROJECT_ID}.appspot.com`;return e.bucket(t)}async function s(e){try{let{fileBuffer:t,fileName:a,contentType:n,handoffId:o,freelancerId:i,documentType:s}=e,l=`documents/${i}/${o}/${s}/${a}`,d=c(),m=d.file(l);await m.save(t,{contentType:n,metadata:{handoffId:o,freelancerId:i,documentType:s,uploadedAt:new Date().toISOString()}}),(0,r.logInfo)("Document uploaded to Firebase Storage",{storagePath:l,fileName:a,handoffId:o,documentType:s}),await m.makePublic();let u=`https://storage.googleapis.com/${d.name}/${l}`;return{success:!0,storagePath:l,publicUrl:u}}catch(e){return(0,r.logError)("Failed to upload document to Firebase Storage",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function l(e,t=60){try{let a=c().file(e),[n]=await a.exists();if(!n)return{success:!1,error:"File not found"};let o=new Date;o.setMinutes(o.getMinutes()+t);let[i]=await a.getSignedUrl({action:"read",expires:o});return(0,r.logInfo)("Generated signed URL",{storagePath:e,expiresAt:o.toISOString()}),{success:!0,signedUrl:i,expiresAt:o}}catch(e){return(0,r.logError)("Failed to generate signed URL",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function d(e){try{let t=c().file(e),[a]=await t.exists();if(!a)return(0,r.logInfo)("Document already deleted or does not exist",{storagePath:e}),{success:!0};return await t.delete(),(0,r.logInfo)("Document deleted from Firebase Storage",{storagePath:e}),{success:!0}}catch(e){return(0,r.logError)("Failed to delete document from Firebase Storage",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function m(e,t){try{let a=c(),n=`documents/${t}/${e}/`,[o]=await a.getFiles({prefix:n}),i=o.map(e=>({name:e.name.split("/").pop()||e.name,storagePath:e.name,contentType:e.metadata.contentType||"application/octet-stream",size:parseInt(String(e.metadata.size||"0"),10),uploadedAt:new Date(e.metadata.timeCreated||Date.now()),documentType:String(e.metadata.metadata?.documentType||"unknown")}));return(0,r.logInfo)("Listed handoff documents",{handoffId:e,freelancerId:t,documentCount:i.length}),{success:!0,documents:i}}catch(e){return(0,r.logError)("Failed to list handoff documents",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function u(e){let t=`invoice-${e.invoiceReference}.pdf`;return s({fileBuffer:e.pdfBuffer,fileName:t,contentType:"application/pdf",handoffId:e.handoffId,freelancerId:e.freelancerId,documentType:"invoice"})}async function g(e){return s({fileBuffer:e.contentBuffer,fileName:e.fileName,contentType:e.contentType,handoffId:e.handoffId,freelancerId:e.freelancerId,documentType:"communication"})}[n,o]=i.then?(await i)():i,e.s(["deleteDocument",()=>d,"getSignedUrl",()=>l,"listHandoffDocuments",()=>m,"uploadCommunicationHistory",()=>g,"uploadDocument",()=>s,"uploadInvoicePDF",()=>u]),a()}catch(e){a(e)}},!1),15155,e=>e.a(async(t,a)=>{try{var n=e.i(68253),o=e.i(55742),r=e.i(69907),i=e.i(98941),c=e.i(27356),s=e.i(53515),l=e.i(17608),d=t([n,o,s,l]);[n,o,s,l]=d.then?(await d)():d;let I=[{agencyId:"agency_lowell_uk",agencyName:"Lowell Financial Ltd",agencyContactEmail:"handoffs@lowellfinancial.co.uk",agencyContactPhone:"+44 113 281 8820",commissionPercentage:25,minimumDebtAmount:100,specialties:["consumer","small_business"]},{agencyId:"agency_cabot_uk",agencyName:"Cabot Credit Management",agencyContactEmail:"newcases@cabotcm.co.uk",agencyContactPhone:"+44 113 234 5678",commissionPercentage:30,minimumDebtAmount:250,specialties:["consumer","high_value"]},{agencyId:"agency_intrum_uk",agencyName:"Intrum UK",agencyContactEmail:"uk.handoffs@intrum.com",agencyContactPhone:"+44 161 923 4000",commissionPercentage:20,minimumDebtAmount:50,specialties:["consumer","small_business","international"]}];async function m(e){try{let t=await n.db.collection("invoices").doc(e).get();if(!t.exists)return{eligible:!1,reason:"Invoice not found"};let a=t.data();if("paid"===a.status)return{eligible:!1,reason:"Invoice already paid"};if("in_collections"===a.status&&!(await n.db.collection("agency_handoffs").where("invoiceId","==",e).where("handoffStatus","in",["pending","in_progress"]).get()).empty)return{eligible:!1,reason:"Already escalated to agency"};if(a.amount<50)return{eligible:!1,reason:"Amount too low for agency escalation (minimum Â£50)"};if((await n.db.collection("collection_attempts").where("invoiceId","==",e).orderBy("createdAt","desc").get()).size<3)return{eligible:!1,reason:"Insufficient collection attempts (minimum 3 required)"};if(60>Math.floor((Date.now()-a.dueDate.toMillis())/864e5))return{eligible:!1,reason:"Not enough time passed (minimum 60 days overdue)"};let o="agency_intrum_uk";return a.amount>=250?o="agency_cabot_uk":a.amount>=100&&(o="agency_lowell_uk"),{eligible:!0,recommendedAgency:o}}catch(e){return(0,r.logError)("Failed to check escalation eligibility",e),{eligible:!1,reason:"System error"}}}async function u(e){try{let t=await m(e.invoiceId);if(!t.eligible)return{success:!1,error:t.reason||"Not eligible for escalation"};let a=(await n.db.collection("invoices").doc(e.invoiceId).get()).data(),l=(await n.db.collection("collection_attempts").where("invoiceId","==",e.invoiceId).orderBy("createdAt","desc").get()).docs.map(e=>e.data()),d=I.find(t=>t.agencyId===e.agencyId);if(!d)return{success:!1,error:"Agency not found"};if(a.amount<d.minimumDebtAmount)return{success:!1,error:`Amount below agency minimum (\xa3${d.minimumDebtAmount})`};let u=Math.floor((Date.now()-a.dueDate.toMillis())/864e5),g=l.map(e=>{let t="email";return t="sms_reminder"===e.attemptType?"sms":"physical_letter"===e.attemptType?"letter":"ai_call"===e.attemptType?"call":"email",{date:e.createdAt,type:t,summary:`${e.attemptType}: ${e.result}${e.resultDetails?" - "+e.resultDetails:""}`}}),f=n.db.collection("agency_handoffs").doc(),y={handoffId:f.id,invoiceId:e.invoiceId,freelancerId:e.freelancerId,agencyId:e.agencyId,handoffDate:o.FieldValue.serverTimestamp(),handoffStatus:"pending",agencyName:d.agencyName,agencyContactEmail:d.agencyContactEmail,agencyContactPhone:d.agencyContactPhone,originalAmount:a.amount,outstandingAmount:a.amount,daysPastDue:u,documents:[],communicationHistory:g,commissionPercentage:d.commissionPercentage,notes:e.notes,agencyUpdates:[],createdAt:o.FieldValue.serverTimestamp()};await f.set(y),await n.db.collection("invoices").doc(e.invoiceId).update({status:"in_collections",updatedAt:o.FieldValue.serverTimestamp()});let p=n.db.collection("collection_attempts").doc();await p.set({attemptId:p.id,invoiceId:e.invoiceId,freelancerId:e.freelancerId,attemptType:"manual_contact",attemptDate:o.FieldValue.serverTimestamp(),attemptNumber:l.length+1,result:"pending",resultDetails:`Escalated to ${d.agencyName}`,escalatedToAgency:!0,agencyHandoffId:f.id,escalationDate:o.FieldValue.serverTimestamp(),isPremiumFeature:!0,createdAt:o.FieldValue.serverTimestamp()});try{await (0,i.sendNotificationEmail)({toEmail:d.agencyContactEmail,subject:`New Collection Case: ${a.reference} - \xa3${a.amount.toFixed(2)}`,message:`A new collection case has been assigned to ${d.agencyName}.

**Invoice Details:**
- Invoice Number: ${a.reference}
- Client: ${a.clientName}
- Amount: \xa3${a.amount.toFixed(2)}
- Days Past Due: ${u}
- Original Invoice Date: ${a.invoiceDate.toDate().toLocaleDateString()}

**Case Summary:**
${g.length} collection attempts have been made:
${g.slice(0,5).map(e=>`- ${e.type}: ${e.summary}`).join("\n")}

**Next Steps:**
1. Review the case details in your agency portal
2. Download supporting documents (invoice PDFs, communication history)
3. Begin collection process per your standard procedures

Commission: ${d.commissionPercentage}% of recovered amount

Case ID: ${f.id}`,actionUrl:`${process.env.NEXT_PUBLIC_APP_URL}/agency/cases/${f.id}`}),(0,r.logInfo)("Agency notification email sent",{handoffId:f.id,agencyEmail:d.agencyContactEmail})}catch(e){(0,r.logError)("Failed to send agency notification email",e)}try{let t=(await n.db.collection("users").doc(e.freelancerId).get()).data();if(t){let s={notificationId:(0,c.nanoid)(),userId:e.freelancerId,type:"agency_handoff",title:"Invoice escalated to collection agency",message:`Invoice ${a.reference} (${a.clientName}) has been escalated to ${d.agencyName} for professional collection. You'll be notified of any updates.`,read:!1,actionUrl:`${process.env.NEXT_PUBLIC_APP_URL}/dashboard/collections/agency/${f.id}`,metadata:{handoffId:f.id,invoiceId:e.invoiceId,agencyName:d.agencyName},createdAt:o.Timestamp.now()};await n.db.collection("notifications").add(s),t.notificationPreferences?.emailNotifications&&t.email&&await (0,i.sendNotificationEmail)({toEmail:t.email,subject:"Invoice Escalated to Collection Agency",message:`Your invoice ${a.reference} for ${a.clientName} (\xa3${a.amount.toFixed(2)}) has been escalated to ${d.agencyName}.

**What happens next:**
1. ${d.agencyName} will take over the collection process
2. You'll receive updates on their progress
3. If payment is recovered, the commission (${d.commissionPercentage}%) will be automatically deducted

**You don't need to do anything** - the agency will handle all communication with the client.

We'll notify you of any developments.`,actionUrl:s.actionUrl}),(0,r.logInfo)("Freelancer notification sent",{handoffId:f.id,freelancerId:e.freelancerId})}}catch(e){(0,r.logError)("Failed to send freelancer notification",e)}try{let t=[],n={handoffId:f.id,invoiceId:e.invoiceId,generatedAt:new Date().toISOString(),attempts:g,summary:{totalAttempts:g.length,attemptTypes:{email:g.filter(e=>"email"===e.type).length,sms:g.filter(e=>"sms"===e.type).length,call:g.filter(e=>"call"===e.type).length,letter:g.filter(e=>"letter"===e.type).length},daysPastDue:u,originalAmount:a.amount}},i=Buffer.from(JSON.stringify(n,null,2),"utf-8"),c=await (0,s.uploadCommunicationHistory)({contentBuffer:i,fileName:`communication-history-${Date.now()}.json`,contentType:"application/json",handoffId:f.id,freelancerId:e.freelancerId});c.success&&c.storagePath&&(t.push(c.storagePath),await f.update({documents:t,documentUrls:t.map(e=>({storagePath:e,uploadedAt:o.Timestamp.now(),documentType:"communication_history"}))}),(0,r.logInfo)("Communication history uploaded to storage",{handoffId:f.id,storagePath:c.storagePath}))}catch(e){(0,r.logError)("Failed to upload documents to storage",e)}return(0,r.logInfo)("Agency handoff created",{handoffId:f.id,invoiceId:e.invoiceId,agencyId:e.agencyId}),{success:!0,handoffId:f.id}}catch(e){return(0,r.logError)("Failed to create agency handoff",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function g(e,t){try{let a=n.db.collection("agency_handoffs").doc(e),s=await a.get();if(!s.exists)return{success:!1,error:"Handoff not found"};let d={lastUpdate:o.FieldValue.serverTimestamp(),updatedAt:o.FieldValue.serverTimestamp()};if(t.status&&(d.handoffStatus=t.status,"closed"===t.status&&(d.closedAt=o.FieldValue.serverTimestamp())),void 0!==t.recoveryAmount){d.recoveryAmount=t.recoveryAmount,d.recoveryDate=o.FieldValue.serverTimestamp();let e=s.data();d.commissionAmount=t.recoveryAmount*e.commissionPercentage/100}if(t.recoveryOutcome&&(d.recoveryOutcome=t.recoveryOutcome),(t.notes||t.actionTaken)&&(d.agencyUpdates=o.FieldValue.arrayUnion({date:o.FieldValue.serverTimestamp(),status:t.status||"in_progress",notes:t.notes||"",actionTaken:t.actionTaken})),await a.update(d),"collected"===t.status&&t.recoveryAmount){let d=s.data();await n.db.collection("invoices").doc(d.invoiceId).update({status:"paid",paidAt:o.FieldValue.serverTimestamp(),updatedAt:o.FieldValue.serverTimestamp()});try{let a=(await n.db.collection("users").doc(d.freelancerId).get()).data();if(a){let s=t.recoveryAmount*(d.commissionPercentage/100),l=t.recoveryAmount-s,m={notificationId:(0,c.nanoid)(),userId:d.freelancerId,type:"payment_recovered",title:`Payment recovered by ${d.agencyName}!`,message:`Great news! ${d.agencyName} has successfully collected \xa3${t.recoveryAmount.toFixed(2)} for invoice ${d.invoiceId}. After ${d.commissionPercentage}% commission, you'll receive \xa3${l.toFixed(2)}.`,read:!1,actionUrl:`${process.env.NEXT_PUBLIC_APP_URL}/dashboard/collections/agency/${e}`,metadata:{handoffId:e,invoiceId:d.invoiceId,recoveryAmount:t.recoveryAmount,commissionAmount:s,netAmount:l},createdAt:o.Timestamp.now()};await n.db.collection("notifications").add(m),a.notificationPreferences?.emailNotifications&&a.email&&await (0,i.sendNotificationEmail)({toEmail:a.email,subject:"Payment Successfully Recovered!",message:`Excellent news! ${d.agencyName} has successfully recovered payment for your invoice.

**Recovery Details:**
- Invoice: ${d.invoiceId}
- Amount Recovered: \xa3${t.recoveryAmount.toFixed(2)}
- Agency Commission (${d.commissionPercentage}%): \xa3${s.toFixed(2)}
- Net Amount to You: \xa3${l.toFixed(2)}

The net amount will be transferred to your account within 5-7 business days.

Thank you for using Relay's collection services!`,actionUrl:m.actionUrl}),(0,r.logInfo)("Recovery notification sent to freelancer",{handoffId:e,freelancerId:d.freelancerId,recoveryAmount:t.recoveryAmount})}}catch(e){(0,r.logError)("Failed to send recovery notification",e)}try{let n=await (0,l.createAgencyRecoveryTransaction)({invoiceId:d.invoiceId,freelancerId:d.freelancerId,agencyHandoffId:e,agencyId:d.agencyId,grossAmount:t.recoveryAmount,agencyCommissionRate:d.commissionPercentage/100,notes:`Recovery by ${d.agencyName}. ${t.recoveryOutcome||"full_recovery"}`});n.success?(await a.update({transactionId:n.transactionId,transactionCreatedAt:o.Timestamp.now()}),(0,r.logInfo)("Agency recovery transaction created",{handoffId:e,transactionId:n.transactionId,grossAmount:t.recoveryAmount})):(0,r.logError)("Failed to create recovery transaction",Error(n.error))}catch(e){(0,r.logError)("Failed to create recovery transaction",e)}}return{success:!0}}catch(e){return(0,r.logError)("Failed to update handoff status",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function f(e){try{let t=await n.db.collection("agency_handoffs").doc(e).get();if(!t.exists)return null;return t.data()}catch(e){return(0,r.logError)("Failed to get handoff details",e),null}}async function y(e,t){try{let a=n.db.collection("agency_handoffs").where("freelancerId","==",e).orderBy("createdAt","desc");return t?.status&&(a=a.where("handoffStatus","==",t.status)),t?.limit&&(a=a.limit(t.limit)),(await a.get()).docs.map(e=>e.data())}catch(e){return(0,r.logError)("Failed to list handoffs",e),[]}}function p(e){return I.map(t=>{let a=e.amount>=t.minimumDebtAmount,n=e.amount*t.commissionPercentage/100,o=e.amount-n;return{agencyId:t.agencyId,agencyName:t.agencyName,commissionPercentage:t.commissionPercentage,commissionAmount:n,freelancerReceives:o,minimumDebtAmount:t.minimumDebtAmount,eligible:a}}).sort((e,t)=>e.commissionPercentage-t.commissionPercentage)}e.s(["checkEscalationEligibility",()=>m,"createAgencyHandoff",()=>u,"getAvailableAgencies",()=>p,"getHandoffDetails",()=>f,"listFreelancerHandoffs",()=>y,"updateHandoffStatus",()=>g]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__cb9ce3b5._.js.map