{"version":3,"sources":["../../../lib/firebase-storage.ts"],"sourcesContent":["/**\n * Firebase Storage Service\n * AUDIT TASK #5: Cloud document storage for agency handoff cases\n *\n * Handles upload and retrieval of:\n * - Invoice PDFs\n * - Communication history documents\n * - Supporting evidence for collection cases\n *\n * Security:\n * - All uploads are scoped to userId/handoffId for isolation\n * - Signed URLs expire after configurable time (default: 1 hour)\n * - Only authorized users (freelancer, agency, admin) can access\n */\n\nimport { getStorage } from 'firebase-admin/storage';\nimport { getApps } from 'firebase-admin/app';\nimport { logInfo, logError } from '@/utils/logger';\n\n/**\n * Get Firebase Storage bucket\n * Uses default bucket from Firebase project\n */\nfunction getStorageBucket() {\n  if (!getApps().length) {\n    throw new Error('Firebase is not initialized');\n  }\n\n  const storage = getStorage();\n  const bucketName = process.env.FIREBASE_STORAGE_BUCKET || `${process.env.FIREBASE_PROJECT_ID}.appspot.com`;\n  return storage.bucket(bucketName);\n}\n\n/**\n * Upload document to Firebase Storage\n *\n * @param params Upload parameters\n * @returns Public URL and storage path\n */\nexport async function uploadDocument(params: {\n  fileBuffer: Buffer;\n  fileName: string;\n  contentType: string;\n  handoffId: string;\n  freelancerId: string;\n  documentType: 'invoice' | 'communication' | 'evidence';\n}): Promise<{\n  success: boolean;\n  storagePath?: string;\n  publicUrl?: string;\n  error?: string;\n}> {\n  try {\n    const { fileBuffer, fileName, contentType, handoffId, freelancerId, documentType } = params;\n\n    // Construct storage path: documents/{freelancerId}/{handoffId}/{documentType}/{fileName}\n    const storagePath = `documents/${freelancerId}/${handoffId}/${documentType}/${fileName}`;\n\n    const bucket = getStorageBucket();\n    const file = bucket.file(storagePath);\n\n    // Upload file with metadata\n    await file.save(fileBuffer, {\n      contentType,\n      metadata: {\n        handoffId,\n        freelancerId,\n        documentType,\n        uploadedAt: new Date().toISOString(),\n      },\n    });\n\n    logInfo('Document uploaded to Firebase Storage', {\n      storagePath,\n      fileName,\n      handoffId,\n      documentType,\n    });\n\n    // Make file publicly readable (could be restricted with Firebase rules)\n    await file.makePublic();\n\n    const publicUrl = `https://storage.googleapis.com/${bucket.name}/${storagePath}`;\n\n    return {\n      success: true,\n      storagePath,\n      publicUrl,\n    };\n\n  } catch (error) {\n    logError('Failed to upload document to Firebase Storage', error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Unknown error',\n    };\n  }\n}\n\n/**\n * Generate signed URL for secure document access\n *\n * Use this instead of public URLs for sensitive documents\n *\n * @param storagePath Path to file in storage\n * @param expiresInMinutes How long the URL should be valid (default: 60 minutes)\n * @returns Signed URL\n */\nexport async function getSignedUrl(\n  storagePath: string,\n  expiresInMinutes = 60\n): Promise<{\n  success: boolean;\n  signedUrl?: string;\n  expiresAt?: Date;\n  error?: string;\n}> {\n  try {\n    const bucket = getStorageBucket();\n    const file = bucket.file(storagePath);\n\n    // Check if file exists\n    const [exists] = await file.exists();\n    if (!exists) {\n      return {\n        success: false,\n        error: 'File not found',\n      };\n    }\n\n    const expiresAt = new Date();\n    expiresAt.setMinutes(expiresAt.getMinutes() + expiresInMinutes);\n\n    // Generate signed URL\n    const [signedUrl] = await file.getSignedUrl({\n      action: 'read',\n      expires: expiresAt,\n    });\n\n    logInfo('Generated signed URL', {\n      storagePath,\n      expiresAt: expiresAt.toISOString(),\n    });\n\n    return {\n      success: true,\n      signedUrl,\n      expiresAt,\n    };\n\n  } catch (error) {\n    logError('Failed to generate signed URL', error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Unknown error',\n    };\n  }\n}\n\n/**\n * Delete document from storage\n * Used for GDPR compliance and cleanup\n *\n * @param storagePath Path to file in storage\n */\nexport async function deleteDocument(storagePath: string): Promise<{\n  success: boolean;\n  error?: string;\n}> {\n  try {\n    const bucket = getStorageBucket();\n    const file = bucket.file(storagePath);\n\n    // Check if file exists before deleting\n    const [exists] = await file.exists();\n    if (!exists) {\n      logInfo('Document already deleted or does not exist', { storagePath });\n      return { success: true };\n    }\n\n    await file.delete();\n\n    logInfo('Document deleted from Firebase Storage', { storagePath });\n\n    return { success: true };\n\n  } catch (error) {\n    logError('Failed to delete document from Firebase Storage', error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Unknown error',\n    };\n  }\n}\n\n/**\n * List all documents for a handoff case\n *\n * @param handoffId Agency handoff ID\n * @param freelancerId Freelancer user ID\n */\nexport async function listHandoffDocuments(\n  handoffId: string,\n  freelancerId: string\n): Promise<{\n  success: boolean;\n  documents?: Array<{\n    name: string;\n    storagePath: string;\n    contentType: string;\n    size: number;\n    uploadedAt: Date;\n    documentType: string;\n  }>;\n  error?: string;\n}> {\n  try {\n    const bucket = getStorageBucket();\n    const prefix = `documents/${freelancerId}/${handoffId}/`;\n\n    const [files] = await bucket.getFiles({ prefix });\n\n    const documents = files.map((file) => ({\n      name: file.name.split('/').pop() || file.name,\n      storagePath: file.name,\n      contentType: file.metadata.contentType || 'application/octet-stream',\n      size: parseInt(String(file.metadata.size || '0'), 10),\n      uploadedAt: new Date(file.metadata.timeCreated || Date.now()),\n      documentType: String(file.metadata.metadata?.documentType || 'unknown'),\n    }));\n\n    logInfo('Listed handoff documents', {\n      handoffId,\n      freelancerId,\n      documentCount: documents.length,\n    });\n\n    return {\n      success: true,\n      documents,\n    };\n\n  } catch (error) {\n    logError('Failed to list handoff documents', error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Unknown error',\n    };\n  }\n}\n\n/**\n * Upload invoice PDF for handoff case\n * Convenience wrapper for invoice uploads\n */\nexport async function uploadInvoicePDF(params: {\n  pdfBuffer: Buffer;\n  invoiceReference: string;\n  handoffId: string;\n  freelancerId: string;\n}): Promise<{\n  success: boolean;\n  storagePath?: string;\n  publicUrl?: string;\n  error?: string;\n}> {\n  const fileName = `invoice-${params.invoiceReference}.pdf`;\n\n  return uploadDocument({\n    fileBuffer: params.pdfBuffer,\n    fileName,\n    contentType: 'application/pdf',\n    handoffId: params.handoffId,\n    freelancerId: params.freelancerId,\n    documentType: 'invoice',\n  });\n}\n\n/**\n * Upload communication history document\n * Can be PDF, text, or JSON format\n */\nexport async function uploadCommunicationHistory(params: {\n  contentBuffer: Buffer;\n  fileName: string;\n  contentType: string;\n  handoffId: string;\n  freelancerId: string;\n}): Promise<{\n  success: boolean;\n  storagePath?: string;\n  publicUrl?: string;\n  error?: string;\n}> {\n  return uploadDocument({\n    fileBuffer: params.contentBuffer,\n    fileName: params.fileName,\n    contentType: params.contentType,\n    handoffId: params.handoffId,\n    freelancerId: params.freelancerId,\n    documentType: 'communication',\n  });\n}\n"],"names":[],"mappings":"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"}