{"version":3,"sources":["../../../lib/webhook-processors/twilio.ts"],"sourcesContent":["/**\n * Twilio Webhook Processing Logic\n *\n * Extracted business logic for processing Twilio webhooks.\n * Used by both the main webhook endpoints and the recovery system.\n */\n\nimport { db, Timestamp } from '@/lib/firebase';\nimport { logInfo, logError } from '@/utils/logger';\n\n/**\n * Process Twilio webhook event\n */\nexport async function processTwilioWebhook(\n  eventType: string,\n  payload: Record<string, string>\n): Promise<void> {\n  switch (eventType) {\n    case 'call.status':\n      await processCallStatus(payload);\n      break;\n\n    case 'sms.status':\n      await processSmsStatus(payload);\n      break;\n\n    case 'recording.status':\n      await processRecordingStatus(payload);\n      break;\n\n    default:\n      throw new Error(`Unknown Twilio event type: ${eventType}`);\n  }\n}\n\n/**\n * Process call status update\n */\nasync function processCallStatus(payload: Record<string, string>): Promise<void> {\n  const callSid = payload.CallSid;\n  const callStatus = payload.CallStatus;\n  const callDuration = payload.CallDuration;\n\n  if (!callSid) {\n    throw new Error('Missing CallSid in payload');\n  }\n\n  // Find corresponding collection attempt\n  const attemptsSnapshot = await db\n    .collection('collection_attempts')\n    .where('callSID', '==', callSid)\n    .limit(1)\n    .get();\n\n  if (attemptsSnapshot.empty) {\n    throw new Error(`Collection attempt not found for call SID: ${callSid}`);\n  }\n\n  const attemptDoc = attemptsSnapshot.docs[0];\n  const updateData: any = {\n    updatedAt: Timestamp.now(),\n  };\n\n  // Update based on status\n  switch (callStatus) {\n    case 'initiated':\n      updateData.callStartedAt = Timestamp.now();\n      updateData.result = 'pending';\n      break;\n\n    case 'ringing':\n      // No update needed\n      break;\n\n    case 'in-progress':\n      updateData.callStartedAt = Timestamp.now();\n      updateData.result = 'pending';\n      break;\n\n    case 'completed':\n      updateData.callEndedAt = Timestamp.now();\n      updateData.callDuration = parseInt(callDuration || '0', 10);\n      // Don't override result - it may be set by voice-ai webhook\n      if (!attemptDoc.data().result || attemptDoc.data().result === 'pending') {\n        updateData.result = 'success';\n      }\n      break;\n\n    case 'failed':\n    case 'busy':\n    case 'no-answer':\n      updateData.callEndedAt = Timestamp.now();\n      updateData.result = 'failed';\n      updateData.callOutcome = callStatus === 'busy' ? 'voicemail' : 'no_answer';\n      updateData.callErrorMessage = `Call ${callStatus}`;\n      break;\n\n    case 'canceled':\n      updateData.callEndedAt = Timestamp.now();\n      updateData.result = 'failed';\n      updateData.callErrorMessage = 'Call canceled';\n      break;\n  }\n\n  // Update attempt\n  await attemptDoc.ref.update(updateData);\n\n  logInfo('Collection attempt updated from call status', {\n    attemptId: attemptDoc.id,\n    callStatus,\n  });\n}\n\n/**\n * Process SMS status update\n */\nasync function processSmsStatus(payload: Record<string, string>): Promise<void> {\n  const messageSid = payload.MessageSid || payload.SmsSid;\n  const messageStatus = payload.MessageStatus || payload.SmsStatus;\n\n  if (!messageSid) {\n    throw new Error('Missing MessageSid in payload');\n  }\n\n  // Find corresponding collection attempt\n  const attemptsSnapshot = await db\n    .collection('collection_attempts')\n    .where('smsMessageSID', '==', messageSid)\n    .limit(1)\n    .get();\n\n  if (attemptsSnapshot.empty) {\n    throw new Error(`Collection attempt not found for SMS SID: ${messageSid}`);\n  }\n\n  const attemptDoc = attemptsSnapshot.docs[0];\n  const updateData: any = {\n    smsStatus: messageStatus,\n    updatedAt: Timestamp.now(),\n  };\n\n  // Update result based on status\n  switch (messageStatus) {\n    case 'queued':\n    case 'sending':\n    case 'sent':\n      updateData.result = 'pending';\n      break;\n\n    case 'delivered':\n      updateData.result = 'success';\n      updateData.smsDeliveredAt = Timestamp.now();\n      break;\n\n    case 'undelivered':\n    case 'failed':\n      updateData.result = 'failed';\n      updateData.smsErrorCode = payload.ErrorCode;\n      updateData.smsErrorMessage = payload.ErrorMessage;\n      break;\n  }\n\n  // Update attempt\n  await attemptDoc.ref.update(updateData);\n\n  logInfo('Collection attempt updated from SMS status', {\n    attemptId: attemptDoc.id,\n    messageStatus,\n  });\n}\n\n/**\n * Process recording status update\n */\nasync function processRecordingStatus(payload: Record<string, string>): Promise<void> {\n  const callSid = payload.CallSid;\n  const recordingUrl = payload.RecordingUrl;\n  const recordingSid = payload.RecordingSid;\n\n  if (!callSid || !recordingUrl) {\n    throw new Error('Missing CallSid or RecordingUrl in payload');\n  }\n\n  // Find corresponding collection attempt\n  const attemptsSnapshot = await db\n    .collection('collection_attempts')\n    .where('callSID', '==', callSid)\n    .limit(1)\n    .get();\n\n  if (attemptsSnapshot.empty) {\n    throw new Error(`Collection attempt not found for call SID: ${callSid}`);\n  }\n\n  const attemptDoc = attemptsSnapshot.docs[0];\n\n  // Update attempt with recording info\n  await attemptDoc.ref.update({\n    callRecordingUrl: recordingUrl,\n    callRecordingSID: recordingSid,\n    updatedAt: Timestamp.now(),\n  });\n\n  logInfo('Collection attempt updated with recording', {\n    attemptId: attemptDoc.id,\n    recordingSid,\n  });\n}\n"],"names":[],"mappings":"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"}