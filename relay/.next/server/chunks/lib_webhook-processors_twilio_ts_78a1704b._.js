module.exports=[37354,e=>e.a(async(t,a)=>{try{var l=e.i(68253),s=e.i(55742),i=e.i(69907),o=t([l,s]);async function r(e,t){switch(e){case"call.status":await c(t);break;case"sms.status":await n(t);break;case"recording.status":await d(t);break;default:throw Error(`Unknown Twilio event type: ${e}`)}}async function c(e){let t=e.CallSid,a=e.CallStatus,o=e.CallDuration;if(!t)throw Error("Missing CallSid in payload");let r=await l.db.collection("collection_attempts").where("callSID","==",t).limit(1).get();if(r.empty)throw Error(`Collection attempt not found for call SID: ${t}`);let c=r.docs[0],n={updatedAt:s.Timestamp.now()};switch(a){case"initiated":case"in-progress":n.callStartedAt=s.Timestamp.now(),n.result="pending";break;case"ringing":break;case"completed":n.callEndedAt=s.Timestamp.now(),n.callDuration=parseInt(o||"0",10),c.data().result&&"pending"!==c.data().result||(n.result="success");break;case"failed":case"busy":case"no-answer":n.callEndedAt=s.Timestamp.now(),n.result="failed",n.callOutcome="busy"===a?"voicemail":"no_answer",n.callErrorMessage=`Call ${a}`;break;case"canceled":n.callEndedAt=s.Timestamp.now(),n.result="failed",n.callErrorMessage="Call canceled"}await c.ref.update(n),(0,i.logInfo)("Collection attempt updated from call status",{attemptId:c.id,callStatus:a})}async function n(e){let t=e.MessageSid||e.SmsSid,a=e.MessageStatus||e.SmsStatus;if(!t)throw Error("Missing MessageSid in payload");let o=await l.db.collection("collection_attempts").where("smsMessageSID","==",t).limit(1).get();if(o.empty)throw Error(`Collection attempt not found for SMS SID: ${t}`);let r=o.docs[0],c={smsStatus:a,updatedAt:s.Timestamp.now()};switch(a){case"queued":case"sending":case"sent":c.result="pending";break;case"delivered":c.result="success",c.smsDeliveredAt=s.Timestamp.now();break;case"undelivered":case"failed":c.result="failed",c.smsErrorCode=e.ErrorCode,c.smsErrorMessage=e.ErrorMessage}await r.ref.update(c),(0,i.logInfo)("Collection attempt updated from SMS status",{attemptId:r.id,messageStatus:a})}async function d(e){let t=e.CallSid,a=e.RecordingUrl,o=e.RecordingSid;if(!t||!a)throw Error("Missing CallSid or RecordingUrl in payload");let r=await l.db.collection("collection_attempts").where("callSID","==",t).limit(1).get();if(r.empty)throw Error(`Collection attempt not found for call SID: ${t}`);let c=r.docs[0];await c.ref.update({callRecordingUrl:a,callRecordingSID:o,updatedAt:s.Timestamp.now()}),(0,i.logInfo)("Collection attempt updated with recording",{attemptId:c.id,recordingSid:o})}[l,s]=o.then?(await o)():o,e.s(["processTwilioWebhook",()=>r]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=lib_webhook-processors_twilio_ts_78a1704b._.js.map