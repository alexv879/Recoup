module.exports=[4446,(e,t,r)=>{t.exports=e.x("net",()=>require("net"))},55004,(e,t,r)=>{t.exports=e.x("tls",()=>require("tls"))},874,(e,t,r)=>{t.exports=e.x("buffer",()=>require("buffer"))},23469,(e,t,r)=>{var o=e.r(874),n=o.Buffer;function s(e,t){for(var r in e)t[r]=e[r]}function i(e,t,r){return n(e,t,r)}n.from&&n.alloc&&n.allocUnsafe&&n.allocUnsafeSlow?t.exports=o:(s(o,r),r.Buffer=i),i.prototype=Object.create(n.prototype),s(n,i),i.from=function(e,t,r){if("number"==typeof e)throw TypeError("Argument must not be a number");return n(e,t,r)},i.alloc=function(e,t,r){if("number"!=typeof e)throw TypeError("Argument must be a number");var o=n(e);return void 0!==t?"string"==typeof r?o.fill(t,r):o.fill(t):o.fill(0),o},i.allocUnsafe=function(e){if("number"!=typeof e)throw TypeError("Argument must be a number");return n(e)},i.allocUnsafeSlow=function(e){if("number"!=typeof e)throw TypeError("Argument must be a number");return o.SlowBuffer(e)}},45706,(e,t,r)=>{t.exports=e.x("querystring",()=>require("querystring"))},81582,e=>e.a(async(t,r)=>{try{var o=e.i(69907),n=e.i(68253),s=e.i(55742),i=e.i(74461),u=t([n,s]);async function a(e){let t=Date.now();try{let r;if(!e.recipientPhone.startsWith("+44"))throw Error("Only UK phone numbers supported (+44)");let s=await n.db.collection("users").where("phoneNumber","==",e.recipientPhone).limit(1).get();if(!s.empty){let t=s.docs[0].data();if(t.collectionsConsent?.smsOptedOut)return(0,o.logWarn)("SMS not sent: User has opted out",{phone:e.recipientPhone,optOutDate:t.collectionsConsent.smsOptOutDate}),{success:!1,error:"User has opted out of SMS communications"}}if((r=new Date().getHours())>=21||r<8)return(0,o.logError)("SMS not sent: Quiet hours (21:00-08:00)",Error("Quiet hours"),{invoiceId:e.invoiceId}),{success:!1,error:"Cannot send SMS during quiet hours (21:00-08:00)"};let u=function(e,t){let{invoiceReference:r,amount:o,dueDate:n,paymentLink:s,businessName:i}=t;return({gentle_reminder:`Hi, this is a friendly reminder from ${i} about invoice ${r} for \xa3${o.toFixed(2)}, due ${n}. ${s?`Pay now: ${s}`:"Please arrange payment at your earliest convenience."} Reply STOP to opt out.`,urgent_reminder:`URGENT: Invoice ${r} for \xa3${o.toFixed(2)} is now overdue (due ${n}). ${s?`Pay immediately: ${s}`:"Please contact us urgently."} - ${i}. Reply STOP to opt out.`,final_notice:`FINAL NOTICE: Invoice ${r} for \xa3${o.toFixed(2)} remains unpaid. This is your last reminder before further action. ${s?`Pay now: ${s}`:"Contact us immediately."} - ${i}. Reply STOP to opt out.`,payment_link:`${i}: Pay invoice ${r} (\xa3${o.toFixed(2)}) securely: ${s}. Reply STOP to opt out.`})[e]}(e.template,{invoiceReference:e.invoiceReference,amount:e.amount,dueDate:e.dueDate,paymentLink:e.paymentLink,businessName:e.businessName}),a=function(){let e=process.env.TWILIO_ACCOUNT_SID,t=process.env.TWILIO_AUTH_TOKEN;if(!e||!t)throw Error("Twilio credentials not configured");return(0,i.default)(e,t)}(),c=await a.messages.create({body:u,from:process.env.TWILIO_PHONE_NUMBER,to:e.recipientPhone,statusCallback:`${process.env.NEXT_PUBLIC_APP_URL}/api/webhooks/twilio/sms-status`}),l=Date.now()-t;return(0,o.logExternalApiCall)("Twilio SMS","send",l),{success:!0,messageSid:c.sid,status:c.status}}catch(r){let e=Date.now()-t;return(0,o.logExternalApiCall)("Twilio SMS","send",e,r),{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}async function c(e){try{let t=l(e)||e;(0,o.logInfo)("Processing SMS opt-out request",{phoneNumber:t});let r=await n.db.collection("users").where("phoneNumber","==",t).get();if(r.empty)return(0,o.logWarn)("No users found for opt-out phone number",{phoneNumber:t}),{success:!0,usersUpdated:0};let i=n.db.batch(),u=s.Timestamp.now();return r.docs.forEach(e=>{i.update(e.ref,{"collectionsConsent.smsConsent":!1,"collectionsConsent.smsOptedOut":!0,"collectionsConsent.smsOptOutDate":u,updatedAt:u})}),await i.commit(),(0,o.logInfo)("SMS opt-out processed successfully",{phoneNumber:t,usersUpdated:r.size}),{success:!0,usersUpdated:r.size}}catch(t){return(0,o.logError)("Failed to process SMS opt-out",t,{phoneNumber:e}),{success:!1,usersUpdated:0,error:t.message}}}function l(e){let t=e.replace(/[\s\-\(\)]/g,"");return t.startsWith("07")?"+44"+t.substring(1):t.startsWith("447")?"+"+t:t.startsWith("+44")?t:null}[n,s]=u.then?(await u)():u,e.s(["formatUKPhone",()=>l,"handleSMSOptOut",()=>c,"sendCollectionSMS",()=>a]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__164925b2._.js.map