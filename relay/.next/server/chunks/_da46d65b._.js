module.exports=[17608,e=>e.a(async(t,a)=>{try{var n=e.i(68253),r=e.i(55742),o=e.i(69907),s=t([n,r]);async function i(e){let t=Date.now();try{let a=e.grossAmount*e.agencyCommissionRate,s=e.grossAmount-a,i=n.db.collection("payment_transactions").doc(),c={transactionId:i.id,transactionType:"agency_recovery",invoiceId:e.invoiceId,freelancerId:e.freelancerId,agencyHandoffId:e.agencyHandoffId,agencyId:e.agencyId,grossAmount:e.grossAmount,agencyCommissionRate:e.agencyCommissionRate,agencyCommissionAmount:a,netToFreelancer:s,status:"pending",notes:e.notes,createdAt:r.Timestamp.now()};return await i.set(c),(0,o.logDbOperation)("create_agency_recovery_transaction","payment_transactions",i.id,Date.now()-t),(0,o.logInfo)("Agency recovery transaction created",{transactionId:i.id,invoiceId:e.invoiceId,grossAmount:e.grossAmount,netToFreelancer:s}),{success:!0,transactionId:i.id}}catch(e){return(0,o.logError)("Failed to create agency recovery transaction",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function c(e,t=50){let a=Date.now();try{let r=await n.db.collection("payment_transactions").where("freelancerId","==",e).orderBy("createdAt","desc").limit(t).get();return(0,o.logDbOperation)("get_freelancer_transactions","payment_transactions",void 0,Date.now()-a),r.docs.map(e=>e.data())}catch(e){return(0,o.logError)("Failed to get freelancer transactions",e),[]}}async function l(e){try{let t=(await c(e,1e3)).filter(e=>"completed"===e.status),a=t.reduce((e,t)=>e+t.grossAmount,0),n=t.reduce((e,t)=>e+t.agencyCommissionAmount,0),r=t.reduce((e,t)=>e+t.netToFreelancer,0);return{totalRecovered:a,totalCommission:n,totalNet:r,transactionCount:t.length}}catch(e){return(0,o.logError)("Failed to calculate freelancer recoveries",e),{totalRecovered:0,totalCommission:0,totalNet:0,transactionCount:0}}}[n,r]=s.then?(await s)():s,e.s(["calculateFreelancerRecoveries",()=>l,"createAgencyRecoveryTransaction",()=>i,"getFreelancerTransactions",()=>c]),a()}catch(e){a(e)}},!1),34213,e=>e.a(async(t,a)=>{try{var n=e.i(89171),r=e.i(7218),o=e.i(17608),s=e.i(69907),i=t([o]);async function c(e){try{let{userId:t}=await (0,r.auth)();if(!t)return n.NextResponse.json({error:"Unauthorized"},{status:401});let a=e.nextUrl.searchParams,s=a.get("format")||"csv",i=Math.min(parseInt(a.get("limit")||"1000"),5e3);if("csv"!==s&&"json"!==s)return n.NextResponse.json({error:"Invalid format. Use csv or json"},{status:400});let c=await (0,o.getFreelancerTransactions)(t,i);if("json"===s){let e=c.map(e=>({transactionId:e.transactionId,transactionType:e.transactionType,invoiceId:e.invoiceId,agencyHandoffId:e.agencyHandoffId,agencyId:e.agencyId,grossAmount:e.grossAmount,agencyCommissionRate:e.agencyCommissionRate,agencyCommissionAmount:e.agencyCommissionAmount,netToFreelancer:e.netToFreelancer,status:e.status,paymentMethod:e.paymentMethod||"",expectedPaymentDate:e.expectedPaymentDate?.toDate().toISOString()||"",actualPaymentDate:e.actualPaymentDate?.toDate().toISOString()||"",transferReference:e.transferReference||"",bankTransactionId:e.bankTransactionId||"",notes:e.notes||"",processedBy:e.processedBy||"",createdAt:e.createdAt.toDate().toISOString(),updatedAt:e.updatedAt?.toDate().toISOString()||"",completedAt:e.completedAt?.toDate().toISOString()||""}));return n.NextResponse.json({transactions:e,count:e.length,exportedAt:new Date().toISOString()})}{let e=[];e.push("Transaction ID,Type,Invoice ID,Agency Handoff ID,Agency ID,Gross Amount (£),Commission Rate (%),Commission Amount (£),Net to Freelancer (£),Status,Payment Method,Expected Payment Date,Actual Payment Date,Transfer Reference,Bank Transaction ID,Notes,Processed By,Created At,Updated At,Completed At"),c.forEach(t=>{e.push([t.transactionId,t.transactionType,t.invoiceId,t.agencyHandoffId||"",t.agencyId||"",t.grossAmount.toFixed(2),(100*t.agencyCommissionRate).toFixed(2),t.agencyCommissionAmount.toFixed(2),t.netToFreelancer.toFixed(2),t.status,t.paymentMethod||"",t.expectedPaymentDate?.toDate().toISOString()||"",t.actualPaymentDate?.toDate().toISOString()||"",`"${(t.transferReference||"").replace(/"/g,'""')}"`,t.bankTransactionId||"",`"${(t.notes||"").replace(/"/g,'""')}"`,t.processedBy||"",t.createdAt.toDate().toISOString(),t.updatedAt?.toDate().toISOString()||"",t.completedAt?.toDate().toISOString()||""].join(","))});let t=e.join("\n");return new n.NextResponse(t,{status:200,headers:{"Content-Type":"text/csv","Content-Disposition":`attachment; filename="relay-transactions-${new Date().toISOString().split("T")[0]}.csv"`}})}}catch(e){return(0,s.logError)("Failed to export transactions",e),n.NextResponse.json({error:"Failed to export transactions"},{status:500})}}[o]=i.then?(await i)():i,e.s(["GET",()=>c]),a()}catch(e){a(e)}},!1),88027,e=>e.a(async(t,a)=>{try{var n=e.i(47909),r=e.i(74017),o=e.i(96250),s=e.i(84243),i=e.i(61916),c=e.i(14444),l=e.i(37092),d=e.i(69741),u=e.i(16795),p=e.i(87718),m=e.i(95169),g=e.i(47587),y=e.i(66012),h=e.i(70101),f=e.i(26937),R=e.i(10372),v=e.i(93695);e.i(52474);var A=e.i(220),I=e.i(34213),w=t([I]);[I]=w.then?(await w)():w;let E=new n.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/transactions/export/route",pathname:"/api/transactions/export",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/transactions/export/route.ts",nextConfigOutput:"",userland:I}),{workAsyncStorage:T,workUnitAsyncStorage:D,serverHooks:S}=E;function x(){return(0,o.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:D})}async function C(e,t,a){E.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/transactions/export/route";n=n.replace(/\/index$/,"")||"/";let o=await E.prepare(e,t,{srcPage:n,multiZoneDraftMode:!1});if(!o)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:I,params:w,nextConfig:x,parsedUrl:C,isDraftMode:T,prerenderManifest:D,routerServerContext:S,isOnDemandRevalidate:_,revalidateOnlyGenerated:P,resolvedPathname:O,clientReferenceManifest:N,serverActionsManifest:b}=o,F=(0,d.normalizeAppPath)(n),H=!!(D.dynamicRoutes[F]||D.routes[O]),M=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,C,!1):t.end("This page could not be found"),null);if(H&&!T){let e=!!D.routes[O],t=D.dynamicRoutes[F];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await M();throw new v.NoFallbackError}}let U=null;!H||E.isDev||T||(U=O,U="/index"===U?"/":U);let k=!0===E.isDev||!H,j=H&&!k;b&&N&&(0,c.setReferenceManifestsSingleton)({page:n,clientReferenceManifest:N,serverActionsManifest:b,serverModuleMap:(0,l.createServerModuleMap)({serverActionsManifest:b})});let q=e.method||"GET",$=(0,i.getTracer)(),B=$.getActiveScopeSpan(),K={params:w,prerenderManifest:D,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:k,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,n)=>E.onRequestError(e,t,n,S)},sharedContext:{buildId:I}},G=new u.NodeNextRequest(e),L=new u.NodeNextResponse(t),V=p.NextRequestAdapter.fromNodeNextRequest(G,(0,p.signalFromNodeResponse)(t));try{let o=async e=>E.handle(V,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=$.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${q} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${n}`)}),c=!!(0,s.getRequestMeta)(e,"minimalMode"),l=async s=>{var i,l;let d=async({previousCacheEntry:r})=>{try{if(!c&&_&&P&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(s);e.fetchMetrics=K.renderOpts.fetchMetrics;let i=K.renderOpts.pendingWaitUntil;i&&a.waitUntil&&(a.waitUntil(i),i=void 0);let l=K.renderOpts.collectedTags;if(!H)return await (0,y.sendResponse)(G,L,n,K.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(n.headers);l&&(t[R.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,r=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:A.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==r?void 0:r.isStale)&&await E.onRequestError(e,t,{routerKind:"App Router",routePath:n,routeType:"route",revalidateReason:(0,g.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:_})},S),t}},u=await E.handleResponse({req:e,nextConfig:x,cacheKey:U,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:D,isRoutePPREnabled:!1,isOnDemandRevalidate:_,revalidateOnlyGenerated:P,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:c});if(!H)return null;if((null==u||null==(i=u.value)?void 0:i.kind)!==A.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});c||t.setHeader("x-nextjs-cache",_?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,h.fromNodeOutgoingHttpHeaders)(u.value.headers);return c&&H||p.delete(R.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,f.getCacheControlHeader)(u.cacheControl)),await (0,y.sendResponse)(G,L,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};B?await l(B):await $.withPropagatedContext(e.headers,()=>$.trace(m.BaseServerSpan.handleRequest,{spanName:`${q} ${n}`,kind:i.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},l))}catch(t){if(t instanceof v.NoFallbackError||await E.onRequestError(e,t,{routerKind:"App Router",routePath:F,routeType:"route",revalidateReason:(0,g.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:_})}),H)throw t;return await (0,y.sendResponse)(G,L,new Response(null,{status:500})),null}}e.s(["handler",()=>C,"patchFetch",()=>x,"routeModule",()=>E,"serverHooks",()=>S,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>D]),a()}catch(e){a(e)}},!1),29652,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__c3778b6d._.js"].map(t=>e.l(t))).then(()=>t(26445)))},6878,e=>{e.v(t=>Promise.all(["server/chunks/node_modules_next_92aaecbe._.js"].map(t=>e.l(t))).then(()=>t(93458)))}];

//# sourceMappingURL=_da46d65b._.js.map