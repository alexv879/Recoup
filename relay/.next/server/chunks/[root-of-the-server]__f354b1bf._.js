module.exports=[33405,(e,t,n)=>{t.exports=e.x("child_process",()=>require("child_process"))},65472,e=>{"use strict";var t=e.i(22880);let n=null,r=new Proxy({},{get:(e,r)=>(function(){if(!n){let e=process.env.STRIPE_SECRET_KEY;if(!e)throw Error("STRIPE_SECRET_KEY is not configured");n=new t.default(e,{typescript:!0})}return n})()[r]});async function a(e){try{return(await r.paymentLinks.create({line_items:[{price_data:{currency:(e.currency||"GBP").toLowerCase(),unit_amount:Math.round(100*e.amount),product_data:{name:`Invoice ${e.invoiceReference}`,description:`Payment for ${e.invoiceReference}`}},quantity:1}],after_completion:{type:"redirect",redirect:{url:`${process.env.NEXT_PUBLIC_APP_URL}/payment-success?invoice=${e.invoiceReference}`}},metadata:{invoiceReference:e.invoiceReference,freelancerId:e.freelancerId,clientEmail:e.clientEmail},allow_promotion_codes:!0})).url}catch(e){throw console.error("Stripe payment link creation error:",e),Error("Failed to create payment link")}}e.s(["createStripePaymentLink",()=>a])},15776,e=>{"use strict";var t=e.i(89171),n=e.i(15874);class r extends Error{statusCode;code;constructor(e,t,n){super(t),this.statusCode=e,this.code=n,this.name="ApiError"}}class a extends r{details;constructor(e,t){super(400,e,"VALIDATION_ERROR"),this.details=t}}class i extends r{constructor(e="Unauthorized"){super(401,e,"UNAUTHORIZED")}}class o extends r{constructor(e="Forbidden"){super(403,e,"FORBIDDEN")}}class s extends r{constructor(e="Not found"){super(404,e,"NOT_FOUND")}}class c extends r{retryAfter;constructor(e="Rate limit exceeded",t){super(429,e,"RATE_LIMIT"),this.retryAfter=t}}class d extends r{constructor(e="Internal server error"){super(500,e,"INTERNAL_ERROR")}}function l(e){if(e instanceof r){let n={error:e.code,message:e.message};return(e instanceof a&&e.details&&(n.details=e.details),e instanceof c&&e.retryAfter)?t.NextResponse.json(n,{status:e.statusCode,headers:{"Retry-After":e.retryAfter.toString()}}):t.NextResponse.json(n,{status:e.statusCode})}return e instanceof n.ZodError?t.NextResponse.json({error:"VALIDATION_ERROR",message:"Invalid request data",details:e.issues},{status:400}):(console.error("Unhandled error:",e),t.NextResponse.json({error:"INTERNAL_ERROR",message:"An unexpected error occurred"},{status:500}))}e.s(["NotFoundError",()=>s,"errors",0,{unauthorized:(e="Unauthorized")=>new i(e),forbidden:(e="Forbidden")=>new o(e),notFound:(e="Not found")=>new s(e),badRequest:e=>new a(e),internal:(e="Internal server error")=>new d(e),rateLimit:(e="Rate limit exceeded",t)=>new c(e,t)},"handleApiError",()=>l])},27356,e=>{"use strict";let t,n;var r=e.i(66680);function a(e=21){var i;i=e|=0,!t||t.length<i?(t=Buffer.allocUnsafe(128*i),r.webcrypto.getRandomValues(t),n=0):n+i>t.length&&(r.webcrypto.getRandomValues(t),n=0),n+=i;let o="";for(let r=n-e;r<n;r++)o+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&t[r]];return o}e.s(["nanoid",()=>a],27356)},25639,e=>{"use strict";e.s(["COLLECTIONS_DEMO_LIMIT_FREE",0,1,"COLLECTION_DAY_14_REMINDER",0,14,"COLLECTION_DAY_21_REMINDER",0,21,"COLLECTION_DAY_30_REMINDER",0,30,"COLLECTION_DAY_7_REMINDER",0,7,"PAYMENT_CONFIRMATION_TOKEN_EXPIRY_DAYS",0,30,"RELAY_COMMISSION_RATE",0,.03])},96212,e=>e.a(async(t,n)=>{try{var r=e.i(68253),a=e.i(55742),i=e.i(15776),o=e.i(69907),s=e.i(27356),c=e.i(25639),d=e.i(54799),l=t([r,a]);async function u(e,t,n,i){let l=Date.now(),u={confirmationId:(0,s.nanoid)(),invoiceId:e,freelancerId:t,clientEmail:n,confirmationToken:d.default.randomUUID(),tokenExpiresAt:a.Timestamp.fromDate(new Date(Date.now()+24*c.PAYMENT_CONFIRMATION_TOKEN_EXPIRY_DAYS*36e5)),status:"pending_client",freelancerVerifiedReceived:!1,expectedAmount:i,createdAt:a.Timestamp.now(),expiresAt:a.Timestamp.fromDate(new Date(Date.now()+24*c.PAYMENT_CONFIRMATION_TOKEN_EXPIRY_DAYS*36e5))};return await r.db.collection(r.COLLECTIONS.PAYMENT_CONFIRMATIONS).doc(u.confirmationId).set(u),(0,o.logDbOperation)("create",r.COLLECTIONS.PAYMENT_CONFIRMATIONS,u.confirmationId,Date.now()-l),u}async function p(e,t,n,s,c){let d=Date.now(),l=await r.db.collection(r.COLLECTIONS.PAYMENT_CONFIRMATIONS).where("confirmationToken","==",e).limit(1).get();if(l.empty)throw new i.NotFoundError("Invalid confirmation token");let u=l.docs[0],p=u.data();if(p.tokenExpiresAt.toDate()<new Date)throw Error("Confirmation token has expired");let m={status:"client_confirmed",clientConfirmedAt:a.Timestamp.now(),clientConfirmedAmount:t,clientPaymentMethod:n,clientConfirmedDate:s,clientNotes:c};return await u.ref.update(m),(0,o.logDbOperation)("update",r.COLLECTIONS.PAYMENT_CONFIRMATIONS,p.confirmationId,Date.now()-d),{...p,...m}}async function m(e,t){let n=Date.now(),d=await r.db.collection(r.COLLECTIONS.PAYMENT_CONFIRMATIONS).doc(e).get();if(!d.exists)throw new i.NotFoundError("Payment confirmation not found");let l=d.data();if(l.freelancerId!==t)throw new i.NotFoundError("Payment confirmation not found");if("client_confirmed"!==l.status)throw Error("Client has not confirmed payment yet");await d.ref.update({status:"both_confirmed",freelancerConfirmedAt:a.Timestamp.now(),freelancerVerifiedReceived:!0,actualAmountPaid:l.clientConfirmedAmount}),await r.db.collection(r.COLLECTIONS.INVOICES).doc(l.invoiceId).update({status:"paid",paidAt:a.Timestamp.now(),firstReminderSentAt:null,secondReminderSentAt:null});let u=l.clientConfirmedAmount||l.expectedAmount,p={transactionId:(0,s.nanoid)(),invoiceId:l.invoiceId,freelancerId:t,amount:u,paymentMethod:l.clientPaymentMethod||"bank_transfer",relayCommission:u*c.RELAY_COMMISSION_RATE,freelancerNet:u*(1-c.RELAY_COMMISSION_RATE),commissionRate:c.RELAY_COMMISSION_RATE,status:"completed",transactionDate:a.Timestamp.now(),completedAt:a.Timestamp.now(),createdAt:a.Timestamp.now()};return await r.db.collection(r.COLLECTIONS.TRANSACTIONS).doc(p.transactionId).set(p),(0,o.logDbOperation)("verify_payment",r.COLLECTIONS.PAYMENT_CONFIRMATIONS,e,Date.now()-n),{confirmation:{...l,status:"both_confirmed"},transaction:p}}async function f(e){let t=await r.db.collection(r.COLLECTIONS.PAYMENT_CONFIRMATIONS).where("confirmationToken","==",e).limit(1).get();if(t.empty)throw new i.NotFoundError("Invalid confirmation token");let n=t.docs[0].data();if(n.tokenExpiresAt.toDate()<new Date)throw Error("Confirmation token has expired");return n}[r,a]=l.then?(await l)():l,e.s(["clientConfirmPayment",()=>p,"createPaymentConfirmation",()=>u,"freelancerVerifyPayment",()=>m,"getPaymentConfirmationByToken",()=>f]),n()}catch(e){n(e)}},!1),74155,e=>e.a(async(t,n)=>{try{var r=e.i(89171),a=e.i(7218),i=e.i(65839),o=e.i(96212),s=e.i(65472),c=e.i(98941),d=e.i(68253),l=e.i(55742),u=e.i(15776),p=e.i(963),m=e.i(69907),f=e.i(27356),E=t([i,o,d,l]);async function R(e,{params:t}){let{id:n}=await t,E=Date.now();try{let e,t,{userId:R}=await (0,a.auth)();if(!R)throw u.errors.unauthorized();(0,m.logApiRequest)("POST",`/api/invoices/${n}/send`,R);let{success:I,remaining:h,reset:N}=await (0,p.checkRateLimit)(R,p.ratelimit);if(!I){let e=Math.ceil((N-Date.now())/1e3);throw u.errors.rateLimit(`Rate limit exceeded. Try again in ${e} seconds`,N)}let w=await (0,i.getInvoiceById)(n,R);if("draft"!==w.status)return r.NextResponse.json({error:"INVALID_STATUS",message:"Can only send draft invoices"},{status:400});if(!w.paymentMethods||0===w.paymentMethods.length)return r.NextResponse.json({error:"NO_PAYMENT_METHODS",message:"Invoice must have at least one payment method configured"},{status:400});if(w.paymentMethods.includes("bank_transfer")){let t=await d.db.collection(d.COLLECTIONS.USERS).doc(R).get();if(t.exists){let n=t.data();if(!(e=n?.encryptedBankDetails))return r.NextResponse.json({error:"BANK_DETAILS_REQUIRED",message:"Bank details must be configured to use bank transfer payment method"},{status:400})}}let A=await (0,o.createPaymentConfirmation)(w.invoiceId,R,w.clientEmail,w.amount);w.paymentMethods.includes("card")&&(t=await (0,s.createStripePaymentLink)({invoiceReference:w.reference,amount:w.amount,currency:w.currency||"GBP",freelancerId:R,clientEmail:w.clientEmail}));let T=`${process.env.NEXT_PUBLIC_APP_URL}/confirmation/${A.confirmationToken}`,C=await d.db.collection(d.COLLECTIONS.USERS).doc(R).get(),O=C.exists&&C.data()?.fullName||"Freelancer";await (0,c.sendInvoiceEmail)({toEmail:w.clientEmail,freelancerName:O,invoiceReference:w.reference,amount:w.amount,currency:w.currency||"GBP",dueDate:w.dueDate.toDate(),description:w.description,bankDetails:e,stripeLink:t,confirmationUrl:T}),await d.db.collection(d.COLLECTIONS.INVOICES).doc(w.invoiceId).update({status:"sent",sentAt:l.Timestamp.now(),paymentConfirmationId:A.confirmationId,stripePaymentLink:t,updatedAt:l.Timestamp.now()}),await d.db.collection(d.COLLECTIONS.EMAILS_SENT).add({emailId:(0,f.nanoid)(),userId:R,invoiceId:w.invoiceId,type:"invoice",recipient:w.clientEmail,sendgridMessageId:"",status:"sent",sentAt:l.Timestamp.now(),createdAt:l.Timestamp.now()});let _=Date.now()-E;return(0,m.logApiResponse)("POST",`/api/invoices/${n}/send`,200,_,R),r.NextResponse.json({success:!0,message:"Invoice sent successfully",invoice:{invoiceId:w.invoiceId,reference:w.reference,status:"sent",sentAt:new Date().toISOString()},confirmation:{confirmationId:A.confirmationId,confirmationUrl:T},stripePaymentLink:t,remainingRequests:h})}catch(t){let e=Date.now()-E;return(0,m.logApiResponse)("POST",`/api/invoices/${n}/send`,500,e),(0,u.handleApiError)(t)}}[i,o,d,l]=E.then?(await E)():E,e.s(["POST",()=>R,"dynamic",0,"force-dynamic"]),n()}catch(e){n(e)}},!1),40542,e=>e.a(async(t,n)=>{try{var r=e.i(47909),a=e.i(74017),i=e.i(96250),o=e.i(84243),s=e.i(61916),c=e.i(14444),d=e.i(37092),l=e.i(69741),u=e.i(16795),p=e.i(87718),m=e.i(95169),f=e.i(47587),E=e.i(66012),R=e.i(70101),I=e.i(26937),h=e.i(10372),N=e.i(93695);e.i(52474);var w=e.i(220),A=e.i(74155),T=t([A]);[A]=T.then?(await T)():T;let _=new r.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/invoices/[id]/send/route",pathname:"/api/invoices/[id]/send",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/invoices/[id]/send/route.ts",nextConfigOutput:"",userland:A}),{workAsyncStorage:v,workUnitAsyncStorage:y,serverHooks:S}=_;function C(){return(0,i.patchFetch)({workAsyncStorage:v,workUnitAsyncStorage:y})}async function O(e,t,n){_.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/invoices/[id]/send/route";r=r.replace(/\/index$/,"")||"/";let i=await _.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:A,params:T,nextConfig:C,parsedUrl:O,isDraftMode:v,prerenderManifest:y,routerServerContext:S,isOnDemandRevalidate:g,revalidateOnlyGenerated:P,resolvedPathname:D,clientReferenceManifest:L,serverActionsManifest:x}=i,M=(0,l.normalizeAppPath)(r),b=!!(y.dynamicRoutes[M]||y.routes[D]),k=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,O,!1):t.end("This page could not be found"),null);if(b&&!v){let e=!!y.routes[D],t=y.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(C.experimental.adapterPath)return await k();throw new N.NoFallbackError}}let U=null;!b||_.isDev||v||(U=D,U="/index"===U?"/":U);let F=!0===_.isDev||!b,Y=b&&!F;x&&L&&(0,c.setReferenceManifestsSingleton)({page:r,clientReferenceManifest:L,serverActionsManifest:x,serverModuleMap:(0,d.createServerModuleMap)({serverActionsManifest:x})});let q=e.method||"GET",H=(0,s.getTracer)(),$=H.getActiveScopeSpan(),j={params:T,prerenderManifest:y,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:F,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,r)=>_.onRequestError(e,t,r,S)},sharedContext:{buildId:A}},B=new u.NodeNextRequest(e),K=new u.NodeNextResponse(t),V=p.NextRequestAdapter.fromNodeNextRequest(B,(0,p.signalFromNodeResponse)(t));try{let i=async e=>_.handle(V,j).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=H.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=n.get("next.route");if(a){let t=`${q} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${r}`)}),c=!!(0,o.getRequestMeta)(e,"minimalMode"),d=async o=>{var s,d;let l=async({previousCacheEntry:a})=>{try{if(!c&&g&&P&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await i(o);e.fetchMetrics=j.renderOpts.fetchMetrics;let s=j.renderOpts.pendingWaitUntil;s&&n.waitUntil&&(n.waitUntil(s),s=void 0);let d=j.renderOpts.collectedTags;if(!b)return await (0,E.sendResponse)(B,K,r,j.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,R.toNodeOutgoingHttpHeaders)(r.headers);d&&(t[h.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==j.renderOpts.collectedRevalidate&&!(j.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&j.renderOpts.collectedRevalidate,a=void 0===j.renderOpts.collectedExpire||j.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:j.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:a}}}}catch(t){throw(null==a?void 0:a.isStale)&&await _.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:Y,isOnDemandRevalidate:g})},S),t}},u=await _.handleResponse({req:e,nextConfig:C,cacheKey:U,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:g,revalidateOnlyGenerated:P,responseGenerator:l,waitUntil:n.waitUntil,isMinimalMode:c});if(!b)return null;if((null==u||null==(s=u.value)?void 0:s.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});c||t.setHeader("x-nextjs-cache",g?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),v&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,R.fromNodeOutgoingHttpHeaders)(u.value.headers);return c&&b||p.delete(h.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,I.getCacheControlHeader)(u.cacheControl)),await (0,E.sendResponse)(B,K,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};$?await d($):await H.withPropagatedContext(e.headers,()=>H.trace(m.BaseServerSpan.handleRequest,{spanName:`${q} ${r}`,kind:s.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},d))}catch(t){if(t instanceof N.NoFallbackError||await _.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:Y,isOnDemandRevalidate:g})}),b)throw t;return await (0,E.sendResponse)(B,K,new Response(null,{status:500})),null}}e.s(["handler",()=>O,"patchFetch",()=>C,"routeModule",()=>_,"serverHooks",()=>S,"workAsyncStorage",()=>v,"workUnitAsyncStorage",()=>y]),n()}catch(e){n(e)}},!1),29652,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__c3778b6d._.js"].map(t=>e.l(t))).then(()=>t(26445)))},6878,e=>{e.v(t=>Promise.all(["server/chunks/node_modules_next_92aaecbe._.js"].map(t=>e.l(t))).then(()=>t(93458)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__f354b1bf._.js.map