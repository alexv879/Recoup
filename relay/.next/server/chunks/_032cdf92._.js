module.exports=[64857,e=>e.a(async(t,a)=>{try{var r=e.i(68253),n=e.i(55742),o=e.i(69907),i=t([r,n]);async function l(e){let t=Date.now();try{let[a,n,i,l]=await Promise.all([s(e),c(e),u(e),d(e)]);return(0,o.logDbOperation)("analyze_user_behavior",r.COLLECTIONS.USER_BEHAVIOR_PROFILE,e,Date.now()-t),{invoicingPattern:a,paymentPattern:n,engagementScore:i,churnRisk:l}}catch(e){throw(0,o.logError)("Failed to analyze user behavior",e),e}}async function s(e){let t=Date.now();try{let a=new Date;a.setMonth(a.getMonth()-6);let i=(await r.db.collection(r.COLLECTIONS.INVOICES).where("freelancerId","==",e).where("createdAt",">=",n.Timestamp.fromDate(a)).get()).docs.map(e=>e.data());if(0===i.length)return{frequency:"inactive",avgAmount:0,topClients:[]};let l=i.reduce((e,t)=>e+t.amount,0)/i.length,s=i[i.length-1],c=Math.max(1,Math.floor((Date.now()-s.createdAt.toDate().getTime())/864e5)),u=Math.max(1,c/7),d=i.length/u,p={};i.forEach(e=>{p[e.clientName]=(p[e.clientName]||0)+1});let h=Object.entries(p).sort((e,t)=>t[1]-e[1]).slice(0,3).map(([e])=>e);return(0,o.logDbOperation)("calculate_invoicing_pattern",r.COLLECTIONS.INVOICES,e,Date.now()-t),{frequency:d>=3?"very_active":d>=1?"active":d>=.5?"moderate":"low",avgAmount:Math.round(l),topClients:h}}catch(e){throw(0,o.logError)("Failed to calculate invoicing pattern",e),e}}async function c(e){let t=Date.now();try{let a=new Date;a.setMonth(a.getMonth()-6);let i=(await r.db.collection(r.COLLECTIONS.INVOICES).where("freelancerId","==",e).where("status","==","paid").where("paidAt",">=",n.Timestamp.fromDate(a)).get()).docs.map(e=>e.data());if(0===i.length)return{avgDays:0,consistency:"insufficient_data",reliability:0};let l=i.map(e=>{let t=e.dueDate.toDate(),a=e.paidAt.toDate();return Math.floor((a.getTime()-t.getTime())/864e5)}),s=l.reduce((e,t)=>e+t,0)/l.length,c=l.reduce((e,t)=>e+Math.pow(t-s,2),0)/l.length,u=Math.sqrt(c),d=l.filter(e=>e<=7).length/i.length*100;return(0,o.logDbOperation)("calculate_payment_pattern",r.COLLECTIONS.INVOICES,e,Date.now()-t),{avgDays:Math.round(10*s)/10,consistency:u<3?"very_consistent":u<7?"consistent":u<14?"variable":"unpredictable",reliability:Math.round(d)}}catch(e){throw(0,o.logError)("Failed to calculate payment pattern",e),e}}async function u(e){let t=Date.now();try{let a=new Date;a.setDate(a.getDate()-30);let i=(await r.db.collection(r.COLLECTIONS.USER_EVENTS).where("userId","==",e).where("timestamp",">=",n.Timestamp.fromDate(a)).get()).docs.map(e=>e.data());if(0===i.length)return 0;let l=0,s=i.filter(e=>"login"===e.eventType).length,c=i.filter(e=>"invoice_created"===e.eventType).length,u=i.filter(e=>"feature_used"===e.eventType).length;return l+=Math.min(2*s,30),l+=Math.min(5*c,40),l+=Math.min(3*u,30),(0,o.logDbOperation)("calculate_engagement_score",r.COLLECTIONS.USER_EVENTS,e,Date.now()-t),Math.min(l,100)}catch(e){return(0,o.logError)("Failed to calculate engagement score",e),0}}async function d(e){let t=Date.now();try{let a=await r.db.collection(r.COLLECTIONS.USERS).doc(e).get();if(!a.exists)return{risk:"high",score:100};let n=a.data(),i=0,l=n.lastLoginAt?Math.floor((Date.now()-n.lastLoginAt.toDate().getTime())/864e5):999;l>30?i+=30:l>14?i+=20:l>7&&(i+=10);let c=await u(e);i+=Math.max(0,30-c/3);let d=await s(e);return"inactive"===d.frequency?i+=40:"low"===d.frequency?i+=30:"moderate"===d.frequency&&(i+=15),(0,o.logDbOperation)("predict_churn",r.COLLECTIONS.USERS,e,Date.now()-t),{risk:i>=60?"high":i>=30?"medium":"low",score:Math.round(i)}}catch(e){return(0,o.logError)("Failed to predict churn",e),{risk:"high",score:100}}}[r,n]=i.then?(await i)():i,e.s(["analyzeUserBehavior",()=>l]),a()}catch(e){a(e)}},!1),1380,e=>e.a(async(t,a)=>{try{var r=e.i(89171),n=e.i(68253),o=e.i(55742),i=e.i(64857),l=e.i(69907),s=t([n,o,i]);async function c(e){let t=Date.now();try{if(e.headers.get("authorization")!==`Bearer ${process.env.CRON_SECRET}`)return r.NextResponse.json({error:"Unauthorized"},{status:401});(0,l.logInfo)("Starting behavior analysis cron job");let a=new Date;a.setDate(a.getDate()-30);let s=await n.db.collection(n.COLLECTIONS.USERS).where("isActive","==",!0).where("lastActiveAt",">=",o.Timestamp.fromDate(a)).get();(0,l.logInfo)(`Found ${s.size} active users to analyze`);let c=0,u=0,d=s.docs.map(e=>e.id);for(let e=0;e<d.length;e+=50){let t=d.slice(e,e+50);await Promise.all(t.map(async e=>{try{let t=await (0,i.analyzeUserBehavior)(e);await n.db.collection(n.COLLECTIONS.USER_BEHAVIOR_PROFILE).doc(e).set({userId:e,lastUpdated:o.Timestamp.now(),invoicing:{averagePerMonth:0,averagePerWeek:0,daysOfWeekPreferred:[],timeOfDayPreferred:"",averageAmount:t.invoicingPattern.avgAmount,lastInvoiceDate:o.Timestamp.now(),invoicingGaps:[]},payments:{averageDaysToPayment:t.paymentPattern.avgDays,bestPayingClients:[],worstPayingClients:[],seasonality:{},paymentReliability:t.paymentPattern.reliability},engagement:{averageOpenPerWeek:0,lastOpenDate:o.Timestamp.now(),daysOfWeekMostActive:[],featureUsage:{}},currentContext:{daysWithoutInvoice:0,invoiceDebtStatus:"",recentSuccesses:0,churnRiskScore:t.churnRisk.score}},{merge:!0}),c++}catch(t){(0,l.logError)(`Failed to analyze user ${e}`,t),u++}}))}let p=new Date().toISOString().split("T")[0];await n.db.collection(n.COLLECTIONS.DAILY_SUMMARIES).doc(p).set({date:p,activeUsers:d.length,usersAnalyzed:c,analysisErrors:u,timestamp:o.Timestamp.now()});let h=Date.now()-t;return(0,l.logInfo)("Behavior analysis complete",{analyzed:c,errors:u,duration:`${(h/1e3).toFixed(2)}s`}),r.NextResponse.json({success:!0,analyzed:c,errors:u,duration:h})}catch(e){return(0,l.logError)("Behavior analysis cron job failed",e),r.NextResponse.json({error:"Failed to analyze behavior"},{status:500})}}[n,o,i]=s.then?(await s)():s,e.s(["POST",()=>c,"dynamic",0,"force-dynamic"]),a()}catch(e){a(e)}},!1),24586,e=>e.a(async(t,a)=>{try{var r=e.i(47909),n=e.i(74017),o=e.i(96250),i=e.i(84243),l=e.i(61916),s=e.i(14444),c=e.i(37092),u=e.i(69741),d=e.i(16795),p=e.i(87718),h=e.i(95169),g=e.i(47587),m=e.i(66012),y=e.i(70101),v=e.i(26937),w=e.i(10372),f=e.i(93695);e.i(52474);var E=e.i(220),R=e.i(1380),C=t([R]);[R]=C.then?(await C)():C;let S=new r.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/cron/analyze-behavior/route",pathname:"/api/cron/analyze-behavior",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/cron/analyze-behavior/route.ts",nextConfigOutput:"",userland:R}),{workAsyncStorage:T,workUnitAsyncStorage:b,serverHooks:I}=S;function O(){return(0,o.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:b})}async function D(e,t,a){S.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/cron/analyze-behavior/route";r=r.replace(/\/index$/,"")||"/";let o=await S.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!o)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:R,params:C,nextConfig:O,parsedUrl:D,isDraftMode:T,prerenderManifest:b,routerServerContext:I,isOnDemandRevalidate:A,revalidateOnlyGenerated:N,resolvedPathname:_,clientReferenceManifest:x,serverActionsManifest:M}=o,P=(0,u.normalizeAppPath)(r),L=!!(b.dynamicRoutes[P]||b.routes[_]),U=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,D,!1):t.end("This page could not be found"),null);if(L&&!T){let e=!!b.routes[_],t=b.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(O.experimental.adapterPath)return await U();throw new f.NoFallbackError}}let k=null;!L||S.isDev||T||(k=_,k="/index"===k?"/":k);let q=!0===S.isDev||!L,F=L&&!q;M&&x&&(0,s.setReferenceManifestsSingleton)({page:r,clientReferenceManifest:x,serverActionsManifest:M,serverModuleMap:(0,c.createServerModuleMap)({serverActionsManifest:M})});let H=e.method||"GET",z=(0,l.getTracer)(),j=z.getActiveScopeSpan(),$={params:C,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!O.experimental.authInterrupts},cacheComponents:!!O.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:O.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>S.onRequestError(e,t,r,I)},sharedContext:{buildId:R}},B=new d.NodeNextRequest(e),V=new d.NodeNextResponse(t),K=p.NextRequestAdapter.fromNodeNextRequest(B,(0,p.signalFromNodeResponse)(t));try{let o=async e=>S.handle(K,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=z.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==h.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=a.get("next.route");if(n){let t=`${H} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${r}`)}),s=!!(0,i.getRequestMeta)(e,"minimalMode"),c=async i=>{var l,c;let u=async({previousCacheEntry:n})=>{try{if(!s&&A&&N&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await o(i);e.fetchMetrics=$.renderOpts.fetchMetrics;let l=$.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let c=$.renderOpts.collectedTags;if(!L)return await (0,m.sendResponse)(B,V,r,$.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,y.toNodeOutgoingHttpHeaders)(r.headers);c&&(t[w.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,n=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:E.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await S.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,g.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:A})},I),t}},d=await S.handleResponse({req:e,nextConfig:O,cacheKey:k,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:N,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:s});if(!L)return null;if((null==d||null==(l=d.value)?void 0:l.kind)!==E.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(c=d.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",A?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,y.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&L||p.delete(w.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,v.getCacheControlHeader)(d.cacheControl)),await (0,m.sendResponse)(B,V,new Response(d.value.body,{headers:p,status:d.value.status||200})),null};j?await c(j):await z.withPropagatedContext(e.headers,()=>z.trace(h.BaseServerSpan.handleRequest,{spanName:`${H} ${r}`,kind:l.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},c))}catch(t){if(t instanceof f.NoFallbackError||await S.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,g.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:A})}),L)throw t;return await (0,m.sendResponse)(B,V,new Response(null,{status:500})),null}}e.s(["handler",()=>D,"patchFetch",()=>O,"routeModule",()=>S,"serverHooks",()=>I,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>b]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=_032cdf92._.js.map