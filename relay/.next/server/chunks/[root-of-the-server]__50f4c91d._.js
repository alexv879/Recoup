module.exports=[15776,e=>{"use strict";var t=e.i(89171),r=e.i(15874);class n extends Error{statusCode;code;constructor(e,t,r){super(t),this.statusCode=e,this.code=r,this.name="ApiError"}}class a extends n{details;constructor(e,t){super(400,e,"VALIDATION_ERROR"),this.details=t}}class o extends n{constructor(e="Unauthorized"){super(401,e,"UNAUTHORIZED")}}class i extends n{constructor(e="Forbidden"){super(403,e,"FORBIDDEN")}}class s extends n{constructor(e="Not found"){super(404,e,"NOT_FOUND")}}class l extends n{retryAfter;constructor(e="Rate limit exceeded",t){super(429,e,"RATE_LIMIT"),this.retryAfter=t}}class c extends n{constructor(e="Internal server error"){super(500,e,"INTERNAL_ERROR")}}function u(e){if(e instanceof n){let r={error:e.code,message:e.message};return(e instanceof a&&e.details&&(r.details=e.details),e instanceof l&&e.retryAfter)?t.NextResponse.json(r,{status:e.statusCode,headers:{"Retry-After":e.retryAfter.toString()}}):t.NextResponse.json(r,{status:e.statusCode})}return e instanceof r.ZodError?t.NextResponse.json({error:"VALIDATION_ERROR",message:"Invalid request data",details:e.issues},{status:400}):(console.error("Unhandled error:",e),t.NextResponse.json({error:"INTERNAL_ERROR",message:"An unexpected error occurred"},{status:500}))}e.s(["NotFoundError",()=>s,"errors",0,{unauthorized:(e="Unauthorized")=>new o(e),forbidden:(e="Forbidden")=>new i(e),notFound:(e="Not found")=>new s(e),badRequest:e=>new a(e),internal:(e="Internal server error")=>new c(e),rateLimit:(e="Rate limit exceeded",t)=>new l(e,t)},"handleApiError",()=>u])},4446,(e,t,r)=>{t.exports=e.x("net",()=>require("net"))},55004,(e,t,r)=>{t.exports=e.x("tls",()=>require("tls"))},874,(e,t,r)=>{t.exports=e.x("buffer",()=>require("buffer"))},23469,(e,t,r)=>{var n=e.r(874),a=n.Buffer;function o(e,t){for(var r in e)t[r]=e[r]}function i(e,t,r){return a(e,t,r)}a.from&&a.alloc&&a.allocUnsafe&&a.allocUnsafeSlow?t.exports=n:(o(n,r),r.Buffer=i),i.prototype=Object.create(a.prototype),o(a,i),i.from=function(e,t,r){if("number"==typeof e)throw TypeError("Argument must not be a number");return a(e,t,r)},i.alloc=function(e,t,r){if("number"!=typeof e)throw TypeError("Argument must be a number");var n=a(e);return void 0!==t?"string"==typeof r?n.fill(t,r):n.fill(t):n.fill(0),n},i.allocUnsafe=function(e){if("number"!=typeof e)throw TypeError("Argument must be a number");return a(e)},i.allocUnsafeSlow=function(e){if("number"!=typeof e)throw TypeError("Argument must be a number");return n.SlowBuffer(e)}},45706,(e,t,r)=>{t.exports=e.x("querystring",()=>require("querystring"))},33405,(e,t,r)=>{t.exports=e.x("child_process",()=>require("child_process"))},65472,e=>{"use strict";var t=e.i(22880);let r=null,n=new Proxy({},{get:(e,n)=>(function(){if(!r){let e=process.env.STRIPE_SECRET_KEY;if(!e)throw Error("STRIPE_SECRET_KEY is not configured");r=new t.default(e,{typescript:!0})}return r})()[n]});async function a(e){try{return(await n.paymentLinks.create({line_items:[{price_data:{currency:(e.currency||"GBP").toLowerCase(),unit_amount:Math.round(100*e.amount),product_data:{name:`Invoice ${e.invoiceReference}`,description:`Payment for ${e.invoiceReference}`}},quantity:1}],after_completion:{type:"redirect",redirect:{url:`${process.env.NEXT_PUBLIC_APP_URL}/payment-success?invoice=${e.invoiceReference}`}},metadata:{invoiceReference:e.invoiceReference,freelancerId:e.freelancerId,clientEmail:e.clientEmail},allow_promotion_codes:!0})).url}catch(e){throw console.error("Stripe payment link creation error:",e),Error("Failed to create payment link")}}e.s(["createStripePaymentLink",()=>a])},41310,e=>{"use strict";var t=e.i(69907),r=e.i(65472),n=e.i(74461);function a(){return(0,n.default)(process.env.TWILIO_ACCOUNT_SID,process.env.TWILIO_AUTH_TOKEN)}async function o(e){let r=Date.now();try{if(!e.recipientPhone.startsWith("+44"))throw Error("Only UK phone numbers supported");let n=new Date().getHours();if(n>=21||n<8)throw Error("Cannot call during quiet hours (21:00-08:00)");let o={recipientName:e.recipientName,invoiceReference:e.invoiceReference,amount:e.amount,dueDate:e.dueDate,daysPastDue:e.daysPastDue,businessName:e.businessName,invoiceId:e.invoiceId,freelancerId:e.freelancerId},i=a(),s=await i.calls.create({to:e.recipientPhone,from:process.env.TWILIO_PHONE_NUMBER,url:`${process.env.NEXT_PUBLIC_APP_URL}/api/webhooks/twilio/voice-ai?context=${encodeURIComponent(JSON.stringify(o))}`,statusCallback:`${process.env.NEXT_PUBLIC_APP_URL}/api/webhooks/twilio/call-status`,statusCallbackEvent:["initiated","ringing","answered","completed"],record:!0,recordingStatusCallback:`${process.env.NEXT_PUBLIC_APP_URL}/api/webhooks/twilio/recording-status`}),l=Date.now()-r;return(0,t.logExternalApiCall)("Twilio Voice AI","initiate",l),{success:!0,callSid:s.sid}}catch(n){let e=Date.now()-r;return(0,t.logExternalApiCall)("Twilio Voice AI","initiate",e,n),{success:!1,error:n instanceof Error?n.message:"Unknown error"}}}async function i(e){let n=Date.now();try{let o=await (0,r.createStripePaymentLink)({amount:e.amount,invoiceReference:e.invoiceReference,clientEmail:"payment-via-call@relay.app",freelancerId:e.freelancerId,currency:"GBP"}),i=a(),s=await i.messages.create({to:e.recipientPhone,from:process.env.TWILIO_PHONE_NUMBER,body:`Payment link for invoice ${e.invoiceReference}: Pay \xa3${e.amount.toFixed(2)} securely at ${o}. This link expires in 24 hours.`,statusCallback:`${process.env.NEXT_PUBLIC_APP_URL}/api/webhooks/twilio/sms-status`}),l=Date.now()-n;return(0,t.logExternalApiCall)("Twilio SMS","send_payment_link",l),(0,t.logInfo)("Payment SMS sent during AI call",{invoiceReference:e.invoiceReference,recipientPhone:e.recipientPhone.substring(0,7)+"***",messageSid:s.sid}),{success:!0,paymentLink:o,messageSid:s.sid}}catch(r){let e=Date.now()-n;return(0,t.logExternalApiCall)("Twilio SMS","send_payment_link",e,r),(0,t.logError)("Failed to send payment link during call",r),{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}function s(e){let{estimatedDurationMinutes:t,includeSMS:r=!1,includeRecording:n=!0}=e,a=.02*t,o=.3*t,i=.04*!!r,s=.01*!!n;return{twilioVoice:a,openaiRealtime:o,sms:i,recording:s,total:a+o+i+s}}e.s(["estimateAICallCost",()=>s,"initiateAICollectionCall",()=>o,"sendPaymentLinkDuringCall",()=>i])},54241,e=>e.a(async(t,r)=>{try{var n=e.i(89171),a=e.i(7218),o=e.i(68253),i=e.i(55742),s=e.i(41310),l=e.i(15776),c=e.i(69907),u=t([o,i]);async function d(e){let t=Date.now();try{let{userId:r}=await (0,a.auth)();if(!r)throw l.errors.unauthorized();(0,c.logApiRequest)("POST","/api/collections/ai-call/send-payment-link",r);let{invoiceId:u,callSid:d,recipientPhone:p,amount:m}=await e.json();if(!u||!d||!p)throw l.errors.badRequest("Missing required fields: invoiceId, callSid, recipientPhone");let f=await o.db.collection("invoices").doc(u).get();if(!f.exists)throw l.errors.notFound("Invoice not found");let h=f.data();if(h?.freelancerId!==r)throw l.errors.forbidden("You do not have access to this invoice");let R=m||h?.amount;if(!R||R<=0)throw l.errors.badRequest("Invalid payment amount");if(R<h?.amount*.25)throw l.errors.badRequest("Partial payment must be at least 25% of invoice amount");let y=await (0,s.sendPaymentLinkDuringCall)({recipientPhone:p,amount:R,invoiceReference:h?.reference,freelancerId:r,invoiceId:u});if(!y.success)throw Error(y.error||"Failed to send payment link");let v=await o.db.collection("collection_attempts").where("callSID","==",d).limit(1).get();if(!v.empty){let e=v.docs[0];await e.ref.update({paymentLinkSentInCall:!0,paymentMethod:"sms_link",partialAmountAgreed:R<h?.amount?R:null,updatedAt:i.FieldValue.serverTimestamp()})}(0,c.logInfo)("Payment link sent during AI call",{invoiceId:u,callSid:d,amount:R,isPartialPayment:R<h?.amount});let w=Date.now()-t;return(0,c.logApiResponse)("POST","/api/collections/ai-call/send-payment-link",200,w,r),n.NextResponse.json({success:!0,message:"Payment link sent via SMS",paymentLink:y.paymentLink,amount:R,isPartialPayment:R<h?.amount,messageSid:y.messageSid})}catch(r){let e=Date.now()-t;return(0,c.logApiResponse)("POST","/api/collections/ai-call/send-payment-link",r.statusCode||500,e),(0,l.handleApiError)(r)}}[o,i]=u.then?(await u)():u,e.s(["POST",()=>d,"dynamic",0,"force-dynamic"]),r()}catch(e){r(e)}},!1),42398,e=>e.a(async(t,r)=>{try{var n=e.i(47909),a=e.i(74017),o=e.i(96250),i=e.i(84243),s=e.i(61916),l=e.i(14444),c=e.i(37092),u=e.i(69741),d=e.i(16795),p=e.i(87718),m=e.i(95169),f=e.i(47587),h=e.i(66012),R=e.i(70101),y=e.i(26937),v=e.i(10372),w=e.i(93695);e.i(52474);var E=e.i(220),g=e.i(54241),_=t([g]);[g]=_.then?(await _)():_;let I=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/collections/ai-call/send-payment-link/route",pathname:"/api/collections/ai-call/send-payment-link",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/collections/ai-call/send-payment-link/route.ts",nextConfigOutput:"",userland:g}),{workAsyncStorage:x,workUnitAsyncStorage:b,serverHooks:C}=I;function P(){return(0,o.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:b})}async function A(e,t,r){I.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/collections/ai-call/send-payment-link/route";n=n.replace(/\/index$/,"")||"/";let o=await I.prepare(e,t,{srcPage:n,multiZoneDraftMode:!1});if(!o)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:g,params:_,nextConfig:P,parsedUrl:A,isDraftMode:x,prerenderManifest:b,routerServerContext:C,isOnDemandRevalidate:T,revalidateOnlyGenerated:N,resolvedPathname:S,clientReferenceManifest:k,serverActionsManifest:O}=o,U=(0,u.normalizeAppPath)(n),D=!!(b.dynamicRoutes[U]||b.routes[S]),L=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,A,!1):t.end("This page could not be found"),null);if(D&&!x){let e=!!b.routes[S],t=b.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(P.experimental.adapterPath)return await L();throw new w.NoFallbackError}}let q=null;!D||I.isDev||x||(q=S,q="/index"===q?"/":q);let M=!0===I.isDev||!D,H=D&&!M;O&&k&&(0,l.setReferenceManifestsSingleton)({page:n,clientReferenceManifest:k,serverActionsManifest:O,serverModuleMap:(0,c.createServerModuleMap)({serverActionsManifest:O})});let $=e.method||"GET",F=(0,s.getTracer)(),j=F.getActiveScopeSpan(),B={params:_,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!P.experimental.authInterrupts},cacheComponents:!!P.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:P.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>I.onRequestError(e,t,n,C)},sharedContext:{buildId:g}},K=new d.NodeNextRequest(e),V=new d.NodeNextResponse(t),X=p.NextRequestAdapter.fromNodeNextRequest(K,(0,p.signalFromNodeResponse)(t));try{let o=async e=>I.handle(X,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${$} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${n}`)}),l=!!(0,i.getRequestMeta)(e,"minimalMode"),c=async i=>{var s,c;let u=async({previousCacheEntry:a})=>{try{if(!l&&T&&N&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(i);e.fetchMetrics=B.renderOpts.fetchMetrics;let s=B.renderOpts.pendingWaitUntil;s&&r.waitUntil&&(r.waitUntil(s),s=void 0);let c=B.renderOpts.collectedTags;if(!D)return await (0,h.sendResponse)(K,V,n,B.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,R.toNodeOutgoingHttpHeaders)(n.headers);c&&(t[v.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=v.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,a=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=v.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:E.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==a?void 0:a.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:n,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:T})},C),t}},d=await I.handleResponse({req:e,nextConfig:P,cacheKey:q,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:N,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:l});if(!D)return null;if((null==d||null==(s=d.value)?void 0:s.kind)!==E.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(c=d.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",T?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,R.fromNodeOutgoingHttpHeaders)(d.value.headers);return l&&D||p.delete(v.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,y.getCacheControlHeader)(d.cacheControl)),await (0,h.sendResponse)(K,V,new Response(d.value.body,{headers:p,status:d.value.status||200})),null};j?await c(j):await F.withPropagatedContext(e.headers,()=>F.trace(m.BaseServerSpan.handleRequest,{spanName:`${$} ${n}`,kind:s.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},c))}catch(t){if(t instanceof w.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:T})}),D)throw t;return await (0,h.sendResponse)(K,V,new Response(null,{status:500})),null}}e.s(["handler",()=>A,"patchFetch",()=>P,"routeModule",()=>I,"serverHooks",()=>C,"workAsyncStorage",()=>x,"workUnitAsyncStorage",()=>b]),r()}catch(e){r(e)}},!1),29652,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__c3778b6d._.js"].map(t=>e.l(t))).then(()=>t(26445)))},6878,e=>{e.v(t=>Promise.all(["server/chunks/node_modules_next_92aaecbe._.js"].map(t=>e.l(t))).then(()=>t(93458)))},25040,e=>{e.v(t=>Promise.all(["server/chunks/lib_openai_ts_24ed19b5._.js"].map(t=>e.l(t))).then(()=>t(35686)))},11890,e=>{e.v(t=>Promise.all(["server/chunks/lib_firebase_ts_96f21a7b._.js"].map(t=>e.l(t))).then(()=>t(57660)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__50f4c91d._.js.map