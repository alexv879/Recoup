module.exports=[15776,e=>{"use strict";var t=e.i(89171),r=e.i(15874);class s extends Error{statusCode;code;constructor(e,t,r){super(t),this.statusCode=e,this.code=r,this.name="ApiError"}}class n extends s{details;constructor(e,t){super(400,e,"VALIDATION_ERROR"),this.details=t}}class a extends s{constructor(e="Unauthorized"){super(401,e,"UNAUTHORIZED")}}class o extends s{constructor(e="Forbidden"){super(403,e,"FORBIDDEN")}}class i extends s{constructor(e="Not found"){super(404,e,"NOT_FOUND")}}class l extends s{retryAfter;constructor(e="Rate limit exceeded",t){super(429,e,"RATE_LIMIT"),this.retryAfter=t}}class c extends s{constructor(e="Internal server error"){super(500,e,"INTERNAL_ERROR")}}function d(e){if(e instanceof s){let r={error:e.code,message:e.message};return(e instanceof n&&e.details&&(r.details=e.details),e instanceof l&&e.retryAfter)?t.NextResponse.json(r,{status:e.statusCode,headers:{"Retry-After":e.retryAfter.toString()}}):t.NextResponse.json(r,{status:e.statusCode})}return e instanceof r.ZodError?t.NextResponse.json({error:"VALIDATION_ERROR",message:"Invalid request data",details:e.issues},{status:400}):(console.error("Unhandled error:",e),t.NextResponse.json({error:"INTERNAL_ERROR",message:"An unexpected error occurred"},{status:500}))}e.s(["NotFoundError",()=>i,"errors",0,{unauthorized:(e="Unauthorized")=>new a(e),forbidden:(e="Forbidden")=>new o(e),notFound:(e="Not found")=>new i(e),badRequest:e=>new n(e),internal:(e="Internal server error")=>new c(e),rateLimit:(e="Rate limit exceeded",t)=>new l(e,t)},"handleApiError",()=>d])},21517,(e,t,r)=>{t.exports=e.x("http",()=>require("http"))},24836,(e,t,r)=>{t.exports=e.x("https",()=>require("https"))},22734,(e,t,r)=>{t.exports=e.x("fs",()=>require("fs"))},54799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},27699,(e,t,r)=>{t.exports=e.x("events",()=>require("events"))},24361,(e,t,r)=>{t.exports=e.x("util",()=>require("util"))},14747,(e,t,r)=>{t.exports=e.x("path",()=>require("path"))},92509,(e,t,r)=>{t.exports=e.x("url",()=>require("url"))},45706,(e,t,r)=>{t.exports=e.x("querystring",()=>require("querystring"))},874,(e,t,r)=>{t.exports=e.x("buffer",()=>require("buffer"))},4446,(e,t,r)=>{t.exports=e.x("net",()=>require("net"))},55004,(e,t,r)=>{t.exports=e.x("tls",()=>require("tls"))},23469,(e,t,r)=>{var s=e.r(874),n=s.Buffer;function a(e,t){for(var r in e)t[r]=e[r]}function o(e,t,r){return n(e,t,r)}n.from&&n.alloc&&n.allocUnsafe&&n.allocUnsafeSlow?t.exports=s:(a(s,r),r.Buffer=o),o.prototype=Object.create(n.prototype),a(n,o),o.from=function(e,t,r){if("number"==typeof e)throw TypeError("Argument must not be a number");return n(e,t,r)},o.alloc=function(e,t,r){if("number"!=typeof e)throw TypeError("Argument must be a number");var s=n(e);return void 0!==t?"string"==typeof r?s.fill(t,r):s.fill(t):s.fill(0),s},o.allocUnsafe=function(e){if("number"!=typeof e)throw TypeError("Argument must be a number");return n(e)},o.allocUnsafeSlow=function(e){if("number"!=typeof e)throw TypeError("Argument must be a number");return s.SlowBuffer(e)}},9053,e=>e.a(async(t,r)=>{try{var s=e.i(68253),n=e.i(69907),a=t([s]);[s]=a.then?(await a)():a;let c={sms_reminders:"paid",physical_letters:"paid",ai_voice_calls:"paid",agency_handoff:"paid",advanced_analytics:"paid",priority_support:"paid",unlimited_collections:"paid"},d={sms_reminders:{perUse:.04,description:"SMS reminder sent to client"},physical_letters:{perUse:1.2,description:"Physical letter sent by post"},ai_voice_calls:{perUse:1.5,description:"5-minute AI collection call"},agency_handoff:{perUse:0,description:"Escalation to collection agency"},advanced_analytics:{perUse:0,description:"Access to advanced analytics dashboard"},priority_support:{perUse:0,description:"24/7 priority email support"},unlimited_collections:{perUse:0,description:"Unlimited automated collection reminders"}};async function o(e,t){try{let r=await s.db.collection("users").doc(e).get();if(!r.exists)return{hasAccess:!1,reason:"User not found"};let n=r.data(),a=c[t];if("paid"===a&&"free"===n.subscriptionTier)return{hasAccess:!1,reason:"This feature requires a paid subscription",upgradeRequired:!0};if(!n.collectionsEnabled)return{hasAccess:!1,reason:"Collections features are disabled for your account"};if("free"===n.subscriptionTier&&"unlimited_collections"===t){let t=new Date().getMonth();if(n.lastDemoResetDate?.toDate().getMonth()!==t&&await s.db.collection("users").doc(e).update({collectionsDemoUsedThisMonth:0,lastDemoResetDate:new Date}),n.collectionsDemoUsedThisMonth>=2)return{hasAccess:!1,reason:"Free tier demo limit reached (2 per month)",upgradeRequired:!0}}return{hasAccess:!0}}catch(r){return(0,n.logWarn)("Premium access check failed",{userId:e,feature:t,error:r}),{hasAccess:!1,reason:"Unable to verify subscription status"}}}async function i(e,t){let r=await o(e,t);if(!r.hasAccess){let e=Error(r.reason||"Access denied");throw e.statusCode=402,e.upgradeRequired=r.upgradeRequired,e}}async function l(e){try{await s.db.collection("premium_feature_usage").add({userId:e.userId,feature:e.feature,invoiceId:e.invoiceId,cost:e.cost||d[e.feature].perUse,timestamp:new Date})}catch(t){(0,n.logWarn)("Failed to log premium feature usage",e)}}e.s(["logPremiumFeatureUsage",()=>l,"requirePremiumAccess",()=>i]),r()}catch(e){r(e)}},!1),38851,e=>e.a(async(t,r)=>{try{var s=e.i(68253),n=e.i(55742),a=e.i(69907),o=t([s,n]);async function i(e){try{let t=await s.db.collection("users").doc(e).get();if(!t.exists)return null;let r=t.data().collectionsConsent,n=!r||!r.consentVersion||"v1.0.0"!==r.consentVersion;return{smsConsent:r?.smsConsent||!1,callConsent:r?.callConsent||!1,callRecordingConsent:r?.callRecordingConsent||!1,physicalMailConsent:r?.physicalMailConsent||!1,dataStorageConsent:r?.dataStorageConsent||!1,consentDate:r?.consentDate?.toDate(),consentVersion:r?.consentVersion,needsUpdate:n}}catch(e){return(0,a.logError)("Failed to get user consent",e),null}}async function l(e,t){try{let r=await i(e);if(!r)return!1;switch(t){case"sms":return r.smsConsent;case"call":return r.callConsent;case"call_recording":return r.callRecordingConsent;case"physical_mail":return r.physicalMailConsent;case"data_storage":return r.dataStorageConsent;default:return!1}}catch(e){return(0,a.logError)("Failed to check consent",e),!1}}async function c(e,t){let r=await i(e);if(!r)throw Error("User consent status not found");if(r.needsUpdate)throw Error("Consent requires update to current version");for(let r of t)if(!await l(e,r))throw Error(`User has not given consent for: ${r}`)}[s,n]=o.then?(await o)():o,e.s(["validateConsentOrThrow",()=>c]),r()}catch(e){r(e)}},!1),51559,e=>e.a(async(t,r)=>{try{var s=e.i(89171),n=e.i(7218),a=e.i(68253),o=e.i(55742),i=e.i(32530),l=e.i(9053),c=e.i(38851),d=e.i(15776),u=e.i(69907),p=t([a,o,l,c]);async function f(e){let t=Date.now();try{let{userId:r}=await (0,n.auth)();if(!r)throw d.errors.unauthorized();(0,u.logApiRequest)("POST","/api/collections/letter",r),await (0,l.requirePremiumAccess)(r,"physical_letters"),await (0,c.validateConsentOrThrow)(r,["physical_mail","data_storage"]);let{invoiceId:p,recipientAddress:f,template:h="gentle",sendCertified:m=!1}=await e.json();if(!p||!f)throw d.errors.badRequest("Missing required fields: invoiceId, recipientAddress");if(!f.recipientName||!f.line1||!f.city||!f.postcode)throw d.errors.badRequest("Incomplete recipient address");let y=await a.db.collection("invoices").doc(p).get();if(!y.exists)throw d.errors.notFound("Invoice not found");let g=y.data();if(g.freelancerId!==r)throw d.errors.forbidden("You do not have access to this invoice");if("paid"===g.status)throw d.errors.badRequest("Invoice is already paid");let R=(await a.db.collection("users").doc(r).get()).data(),v=R?.businessName||R?.name||"Your Freelancer",w=R?.businessAddress;if(!w||!w.addressLine1||!w.city||!w.postcode)throw d.errors.badRequest("Business address not configured. Please update your address in Settings before sending letters.");let x=[w.companyName||v,w.addressLine1,w.addressLine2,w.city,w.postcode,w.country||"United Kingdom"].filter(Boolean).join("\n"),A=Math.floor((Date.now()-g.dueDate.toMillis())/864e5);if("lba"===h&&A<90)throw d.errors.badRequest("Letter Before Action should only be sent after 90+ days overdue");let b=await (0,i.sendCollectionLetter)({recipient:f,invoiceReference:g.reference,amount:g.amount,dueDate:g.dueDate.toDate().toLocaleDateString("en-GB"),daysPastDue:A,invoiceDate:g.invoiceDate.toDate().toLocaleDateString("en-GB"),template:h,businessName:v,businessAddress:x,invoiceId:p,freelancerId:r,sendCertified:m});if(!b.success)throw Error(b.error||"Failed to send letter");let E=a.db.collection("collection_attempts").doc();await E.set({attemptId:E.id,invoiceId:p,freelancerId:r,attemptType:"physical_letter",attemptDate:o.FieldValue.serverTimestamp(),attemptNumber:g.collectionsAttempts+1,result:"pending",resultDetails:`Physical letter sent via Lob (${h})`,letterApiRef:b.letterId,letterSentAt:o.FieldValue.serverTimestamp(),letterStatus:"sent",templateUsed:h,recipientAddress:{line1:f.line1,line2:f.line2,city:f.city,postcode:f.postcode,country:f.country},letterTrackingUrl:b.trackingUrl,letterExpectedDelivery:b.expectedDeliveryDate?new Date(b.expectedDeliveryDate):null,isPremiumFeature:!0,consentGiven:!0,createdAt:o.FieldValue.serverTimestamp()}),await a.db.collection("invoices").doc(p).update({collectionsAttempts:o.FieldValue.increment(1),updatedAt:o.FieldValue.serverTimestamp()});let _=m?2.7:1.2;await (0,l.logPremiumFeatureUsage)({userId:r,feature:"physical_letters",invoiceId:p,cost:_}),(0,u.logInfo)("Physical letter sent",{invoiceId:p,letterId:b.letterId,template:h,certified:m});let C=Date.now()-t;return(0,u.logApiResponse)("POST","/api/collections/letter",200,C,r),s.NextResponse.json({success:!0,message:"Physical letter sent successfully",attemptId:E.id,letterId:b.letterId,trackingUrl:b.trackingUrl,expectedDelivery:b.expectedDeliveryDate,cost:_})}catch(r){let e=Date.now()-t;if((0,u.logApiResponse)("POST","/api/collections/letter",r.statusCode||500,e),402===r.statusCode)return s.NextResponse.json({error:r.message,upgradeRequired:!0,upgradeUrl:"/settings/billing/upgrade"},{status:402});return(0,d.handleApiError)(r)}}[a,o,l,c]=p.then?(await p)():p,e.s(["POST",()=>f,"dynamic",0,"force-dynamic"]),r()}catch(e){r(e)}},!1),16572,e=>e.a(async(t,r)=>{try{var s=e.i(47909),n=e.i(74017),a=e.i(96250),o=e.i(84243),i=e.i(61916),l=e.i(14444),c=e.i(37092),d=e.i(69741),u=e.i(16795),p=e.i(87718),f=e.i(95169),h=e.i(47587),m=e.i(66012),y=e.i(70101),g=e.i(26937),R=e.i(10372),v=e.i(93695);e.i(52474);var w=e.i(220),x=e.i(51559),A=t([x]);[x]=A.then?(await A)():A;let _=new s.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/collections/letter/route",pathname:"/api/collections/letter",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/collections/letter/route.ts",nextConfigOutput:"",userland:x}),{workAsyncStorage:C,workUnitAsyncStorage:D,serverHooks:T}=_;function b(){return(0,a.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:D})}async function E(e,t,r){_.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let s="/api/collections/letter/route";s=s.replace(/\/index$/,"")||"/";let a=await _.prepare(e,t,{srcPage:s,multiZoneDraftMode:!1});if(!a)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:x,params:A,nextConfig:b,parsedUrl:E,isDraftMode:C,prerenderManifest:D,routerServerContext:T,isOnDemandRevalidate:U,revalidateOnlyGenerated:I,resolvedPathname:q,clientReferenceManifest:N,serverActionsManifest:P}=a,O=(0,d.normalizeAppPath)(s),S=!!(D.dynamicRoutes[O]||D.routes[q]),F=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,E,!1):t.end("This page could not be found"),null);if(S&&!C){let e=!!D.routes[q],t=D.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(b.experimental.adapterPath)return await F();throw new v.NoFallbackError}}let M=null;!S||_.isDev||C||(M=q,M="/index"===M?"/":M);let k=!0===_.isDev||!S,j=S&&!k;P&&N&&(0,l.setReferenceManifestsSingleton)({page:s,clientReferenceManifest:N,serverActionsManifest:P,serverModuleMap:(0,c.createServerModuleMap)({serverActionsManifest:P})});let L=e.method||"GET",H=(0,i.getTracer)(),B=H.getActiveScopeSpan(),V={params:A,prerenderManifest:D,renderOpts:{experimental:{authInterrupts:!!b.experimental.authInterrupts},cacheComponents:!!b.cacheComponents,supportsDynamicResponse:k,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:b.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,s)=>_.onRequestError(e,t,s,T)},sharedContext:{buildId:x}},$=new u.NodeNextRequest(e),K=new u.NodeNextResponse(t),G=p.NextRequestAdapter.fromNodeNextRequest($,(0,p.signalFromNodeResponse)(t));try{let a=async e=>_.handle(G,V).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=H.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==f.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${L} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${L} ${s}`)}),l=!!(0,o.getRequestMeta)(e,"minimalMode"),c=async o=>{var i,c;let d=async({previousCacheEntry:n})=>{try{if(!l&&U&&I&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await a(o);e.fetchMetrics=V.renderOpts.fetchMetrics;let i=V.renderOpts.pendingWaitUntil;i&&r.waitUntil&&(r.waitUntil(i),i=void 0);let c=V.renderOpts.collectedTags;if(!S)return await (0,m.sendResponse)($,K,s,V.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,y.toNodeOutgoingHttpHeaders)(s.headers);c&&(t[R.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==V.renderOpts.collectedRevalidate&&!(V.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&V.renderOpts.collectedRevalidate,n=void 0===V.renderOpts.collectedExpire||V.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:V.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await _.onRequestError(e,t,{routerKind:"App Router",routePath:s,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:U})},T),t}},u=await _.handleResponse({req:e,nextConfig:b,cacheKey:M,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:D,isRoutePPREnabled:!1,isOnDemandRevalidate:U,revalidateOnlyGenerated:I,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:l});if(!S)return null;if((null==u||null==(i=u.value)?void 0:i.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(c=u.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",U?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,y.fromNodeOutgoingHttpHeaders)(u.value.headers);return l&&S||p.delete(R.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,g.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)($,K,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};B?await c(B):await H.withPropagatedContext(e.headers,()=>H.trace(f.BaseServerSpan.handleRequest,{spanName:`${L} ${s}`,kind:i.SpanKind.SERVER,attributes:{"http.method":L,"http.target":e.url}},c))}catch(t){if(t instanceof v.NoFallbackError||await _.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:U})}),S)throw t;return await (0,m.sendResponse)($,K,new Response(null,{status:500})),null}}e.s(["handler",()=>E,"patchFetch",()=>b,"routeModule",()=>_,"serverHooks",()=>T,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>D]),r()}catch(e){r(e)}},!1),29652,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__c3778b6d._.js"].map(t=>e.l(t))).then(()=>t(26445)))},6878,e=>{e.v(t=>Promise.all(["server/chunks/node_modules_next_92aaecbe._.js"].map(t=>e.l(t))).then(()=>t(93458)))},71124,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__4595132f._.js"].map(t=>e.l(t))).then(()=>t(53515)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__5cfe5b24._.js.map