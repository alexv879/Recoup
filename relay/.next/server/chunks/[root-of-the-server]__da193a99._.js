module.exports=[15155,e=>e.a(async(t,n)=>{try{var r=e.i(68253),a=e.i(55742),o=e.i(69907),i=e.i(98941),s=e.i(27356),c=e.i(53515),l=e.i(17608),d=t([r,a,c,l]);[r,a,c,l]=d.then?(await d)():d;let h=[{agencyId:"agency_lowell_uk",agencyName:"Lowell Financial Ltd",agencyContactEmail:"handoffs@lowellfinancial.co.uk",agencyContactPhone:"+44 113 281 8820",commissionPercentage:25,minimumDebtAmount:100,specialties:["consumer","small_business"]},{agencyId:"agency_cabot_uk",agencyName:"Cabot Credit Management",agencyContactEmail:"newcases@cabotcm.co.uk",agencyContactPhone:"+44 113 234 5678",commissionPercentage:30,minimumDebtAmount:250,specialties:["consumer","high_value"]},{agencyId:"agency_intrum_uk",agencyName:"Intrum UK",agencyContactEmail:"uk.handoffs@intrum.com",agencyContactPhone:"+44 161 923 4000",commissionPercentage:20,minimumDebtAmount:50,specialties:["consumer","small_business","international"]}];async function u(e){try{let t=await r.db.collection("invoices").doc(e).get();if(!t.exists)return{eligible:!1,reason:"Invoice not found"};let n=t.data();if("paid"===n.status)return{eligible:!1,reason:"Invoice already paid"};if("in_collections"===n.status&&!(await r.db.collection("agency_handoffs").where("invoiceId","==",e).where("handoffStatus","in",["pending","in_progress"]).get()).empty)return{eligible:!1,reason:"Already escalated to agency"};if(n.amount<50)return{eligible:!1,reason:"Amount too low for agency escalation (minimum £50)"};if((await r.db.collection("collection_attempts").where("invoiceId","==",e).orderBy("createdAt","desc").get()).size<3)return{eligible:!1,reason:"Insufficient collection attempts (minimum 3 required)"};if(60>Math.floor((Date.now()-n.dueDate.toMillis())/864e5))return{eligible:!1,reason:"Not enough time passed (minimum 60 days overdue)"};let a="agency_intrum_uk";return n.amount>=250?a="agency_cabot_uk":n.amount>=100&&(a="agency_lowell_uk"),{eligible:!0,recommendedAgency:a}}catch(e){return(0,o.logError)("Failed to check escalation eligibility",e),{eligible:!1,reason:"System error"}}}async function m(e){try{let t=await u(e.invoiceId);if(!t.eligible)return{success:!1,error:t.reason||"Not eligible for escalation"};let n=(await r.db.collection("invoices").doc(e.invoiceId).get()).data(),l=(await r.db.collection("collection_attempts").where("invoiceId","==",e.invoiceId).orderBy("createdAt","desc").get()).docs.map(e=>e.data()),d=h.find(t=>t.agencyId===e.agencyId);if(!d)return{success:!1,error:"Agency not found"};if(n.amount<d.minimumDebtAmount)return{success:!1,error:`Amount below agency minimum (\xa3${d.minimumDebtAmount})`};let m=Math.floor((Date.now()-n.dueDate.toMillis())/864e5),f=l.map(e=>{let t="email";return t="sms_reminder"===e.attemptType?"sms":"physical_letter"===e.attemptType?"letter":"ai_call"===e.attemptType?"call":"email",{date:e.createdAt,type:t,summary:`${e.attemptType}: ${e.result}${e.resultDetails?" - "+e.resultDetails:""}`}}),g=r.db.collection("agency_handoffs").doc(),p={handoffId:g.id,invoiceId:e.invoiceId,freelancerId:e.freelancerId,agencyId:e.agencyId,handoffDate:a.FieldValue.serverTimestamp(),handoffStatus:"pending",agencyName:d.agencyName,agencyContactEmail:d.agencyContactEmail,agencyContactPhone:d.agencyContactPhone,originalAmount:n.amount,outstandingAmount:n.amount,daysPastDue:m,documents:[],communicationHistory:f,commissionPercentage:d.commissionPercentage,notes:e.notes,agencyUpdates:[],createdAt:a.FieldValue.serverTimestamp()};await g.set(p),await r.db.collection("invoices").doc(e.invoiceId).update({status:"in_collections",updatedAt:a.FieldValue.serverTimestamp()});let y=r.db.collection("collection_attempts").doc();await y.set({attemptId:y.id,invoiceId:e.invoiceId,freelancerId:e.freelancerId,attemptType:"manual_contact",attemptDate:a.FieldValue.serverTimestamp(),attemptNumber:l.length+1,result:"pending",resultDetails:`Escalated to ${d.agencyName}`,escalatedToAgency:!0,agencyHandoffId:g.id,escalationDate:a.FieldValue.serverTimestamp(),isPremiumFeature:!0,createdAt:a.FieldValue.serverTimestamp()});try{await (0,i.sendNotificationEmail)({toEmail:d.agencyContactEmail,subject:`New Collection Case: ${n.reference} - \xa3${n.amount.toFixed(2)}`,message:`A new collection case has been assigned to ${d.agencyName}.

**Invoice Details:**
- Invoice Number: ${n.reference}
- Client: ${n.clientName}
- Amount: \xa3${n.amount.toFixed(2)}
- Days Past Due: ${m}
- Original Invoice Date: ${n.invoiceDate.toDate().toLocaleDateString()}

**Case Summary:**
${f.length} collection attempts have been made:
${f.slice(0,5).map(e=>`- ${e.type}: ${e.summary}`).join("\n")}

**Next Steps:**
1. Review the case details in your agency portal
2. Download supporting documents (invoice PDFs, communication history)
3. Begin collection process per your standard procedures

Commission: ${d.commissionPercentage}% of recovered amount

Case ID: ${g.id}`,actionUrl:`${process.env.NEXT_PUBLIC_APP_URL}/agency/cases/${g.id}`}),(0,o.logInfo)("Agency notification email sent",{handoffId:g.id,agencyEmail:d.agencyContactEmail})}catch(e){(0,o.logError)("Failed to send agency notification email",e)}try{let t=(await r.db.collection("users").doc(e.freelancerId).get()).data();if(t){let c={notificationId:(0,s.nanoid)(),userId:e.freelancerId,type:"agency_handoff",title:"Invoice escalated to collection agency",message:`Invoice ${n.reference} (${n.clientName}) has been escalated to ${d.agencyName} for professional collection. You'll be notified of any updates.`,read:!1,actionUrl:`${process.env.NEXT_PUBLIC_APP_URL}/dashboard/collections/agency/${g.id}`,metadata:{handoffId:g.id,invoiceId:e.invoiceId,agencyName:d.agencyName},createdAt:a.Timestamp.now()};await r.db.collection("notifications").add(c),t.notificationPreferences?.emailNotifications&&t.email&&await (0,i.sendNotificationEmail)({toEmail:t.email,subject:"Invoice Escalated to Collection Agency",message:`Your invoice ${n.reference} for ${n.clientName} (\xa3${n.amount.toFixed(2)}) has been escalated to ${d.agencyName}.

**What happens next:**
1. ${d.agencyName} will take over the collection process
2. You'll receive updates on their progress
3. If payment is recovered, the commission (${d.commissionPercentage}%) will be automatically deducted

**You don't need to do anything** - the agency will handle all communication with the client.

We'll notify you of any developments.`,actionUrl:c.actionUrl}),(0,o.logInfo)("Freelancer notification sent",{handoffId:g.id,freelancerId:e.freelancerId})}}catch(e){(0,o.logError)("Failed to send freelancer notification",e)}try{let t=[],r={handoffId:g.id,invoiceId:e.invoiceId,generatedAt:new Date().toISOString(),attempts:f,summary:{totalAttempts:f.length,attemptTypes:{email:f.filter(e=>"email"===e.type).length,sms:f.filter(e=>"sms"===e.type).length,call:f.filter(e=>"call"===e.type).length,letter:f.filter(e=>"letter"===e.type).length},daysPastDue:m,originalAmount:n.amount}},i=Buffer.from(JSON.stringify(r,null,2),"utf-8"),s=await (0,c.uploadCommunicationHistory)({contentBuffer:i,fileName:`communication-history-${Date.now()}.json`,contentType:"application/json",handoffId:g.id,freelancerId:e.freelancerId});s.success&&s.storagePath&&(t.push(s.storagePath),await g.update({documents:t,documentUrls:t.map(e=>({storagePath:e,uploadedAt:a.Timestamp.now(),documentType:"communication_history"}))}),(0,o.logInfo)("Communication history uploaded to storage",{handoffId:g.id,storagePath:s.storagePath}))}catch(e){(0,o.logError)("Failed to upload documents to storage",e)}return(0,o.logInfo)("Agency handoff created",{handoffId:g.id,invoiceId:e.invoiceId,agencyId:e.agencyId}),{success:!0,handoffId:g.id}}catch(e){return(0,o.logError)("Failed to create agency handoff",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function f(e,t){try{let n=r.db.collection("agency_handoffs").doc(e),c=await n.get();if(!c.exists)return{success:!1,error:"Handoff not found"};let d={lastUpdate:a.FieldValue.serverTimestamp(),updatedAt:a.FieldValue.serverTimestamp()};if(t.status&&(d.handoffStatus=t.status,"closed"===t.status&&(d.closedAt=a.FieldValue.serverTimestamp())),void 0!==t.recoveryAmount){d.recoveryAmount=t.recoveryAmount,d.recoveryDate=a.FieldValue.serverTimestamp();let e=c.data();d.commissionAmount=t.recoveryAmount*e.commissionPercentage/100}if(t.recoveryOutcome&&(d.recoveryOutcome=t.recoveryOutcome),(t.notes||t.actionTaken)&&(d.agencyUpdates=a.FieldValue.arrayUnion({date:a.FieldValue.serverTimestamp(),status:t.status||"in_progress",notes:t.notes||"",actionTaken:t.actionTaken})),await n.update(d),"collected"===t.status&&t.recoveryAmount){let d=c.data();await r.db.collection("invoices").doc(d.invoiceId).update({status:"paid",paidAt:a.FieldValue.serverTimestamp(),updatedAt:a.FieldValue.serverTimestamp()});try{let n=(await r.db.collection("users").doc(d.freelancerId).get()).data();if(n){let c=t.recoveryAmount*(d.commissionPercentage/100),l=t.recoveryAmount-c,u={notificationId:(0,s.nanoid)(),userId:d.freelancerId,type:"payment_recovered",title:`Payment recovered by ${d.agencyName}!`,message:`Great news! ${d.agencyName} has successfully collected \xa3${t.recoveryAmount.toFixed(2)} for invoice ${d.invoiceId}. After ${d.commissionPercentage}% commission, you'll receive \xa3${l.toFixed(2)}.`,read:!1,actionUrl:`${process.env.NEXT_PUBLIC_APP_URL}/dashboard/collections/agency/${e}`,metadata:{handoffId:e,invoiceId:d.invoiceId,recoveryAmount:t.recoveryAmount,commissionAmount:c,netAmount:l},createdAt:a.Timestamp.now()};await r.db.collection("notifications").add(u),n.notificationPreferences?.emailNotifications&&n.email&&await (0,i.sendNotificationEmail)({toEmail:n.email,subject:"Payment Successfully Recovered!",message:`Excellent news! ${d.agencyName} has successfully recovered payment for your invoice.

**Recovery Details:**
- Invoice: ${d.invoiceId}
- Amount Recovered: \xa3${t.recoveryAmount.toFixed(2)}
- Agency Commission (${d.commissionPercentage}%): \xa3${c.toFixed(2)}
- Net Amount to You: \xa3${l.toFixed(2)}

The net amount will be transferred to your account within 5-7 business days.

Thank you for using Relay's collection services!`,actionUrl:u.actionUrl}),(0,o.logInfo)("Recovery notification sent to freelancer",{handoffId:e,freelancerId:d.freelancerId,recoveryAmount:t.recoveryAmount})}}catch(e){(0,o.logError)("Failed to send recovery notification",e)}try{let r=await (0,l.createAgencyRecoveryTransaction)({invoiceId:d.invoiceId,freelancerId:d.freelancerId,agencyHandoffId:e,agencyId:d.agencyId,grossAmount:t.recoveryAmount,agencyCommissionRate:d.commissionPercentage/100,notes:`Recovery by ${d.agencyName}. ${t.recoveryOutcome||"full_recovery"}`});r.success?(await n.update({transactionId:r.transactionId,transactionCreatedAt:a.Timestamp.now()}),(0,o.logInfo)("Agency recovery transaction created",{handoffId:e,transactionId:r.transactionId,grossAmount:t.recoveryAmount})):(0,o.logError)("Failed to create recovery transaction",Error(r.error))}catch(e){(0,o.logError)("Failed to create recovery transaction",e)}}return{success:!0}}catch(e){return(0,o.logError)("Failed to update handoff status",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function g(e){try{let t=await r.db.collection("agency_handoffs").doc(e).get();if(!t.exists)return null;return t.data()}catch(e){return(0,o.logError)("Failed to get handoff details",e),null}}async function p(e,t){try{let n=r.db.collection("agency_handoffs").where("freelancerId","==",e).orderBy("createdAt","desc");return t?.status&&(n=n.where("handoffStatus","==",t.status)),t?.limit&&(n=n.limit(t.limit)),(await n.get()).docs.map(e=>e.data())}catch(e){return(0,o.logError)("Failed to list handoffs",e),[]}}function y(e){return h.map(t=>{let n=e.amount>=t.minimumDebtAmount,r=e.amount*t.commissionPercentage/100,a=e.amount-r;return{agencyId:t.agencyId,agencyName:t.agencyName,commissionPercentage:t.commissionPercentage,commissionAmount:r,freelancerReceives:a,minimumDebtAmount:t.minimumDebtAmount,eligible:n}}).sort((e,t)=>e.commissionPercentage-t.commissionPercentage)}e.s(["checkEscalationEligibility",()=>u,"createAgencyHandoff",()=>m,"getAvailableAgencies",()=>y,"getHandoffDetails",()=>g,"listFreelancerHandoffs",()=>p,"updateHandoffStatus",()=>f]),n()}catch(e){n(e)}},!1),56300,e=>e.a(async(t,n)=>{try{let t=await e.y("firebase-admin/app");e.n(t),n()}catch(e){n(e)}},!0),69907,e=>{"use strict";let t=process.env.LOG_LEVEL||"info",n={debug:0,info:1,warn:2,error:3};function r(e){return n[e]>=n[t]}let a={info:(e,t)=>{r("info")&&(t&&Object.keys(t).length>0?console.log(`[INFO] ${e}`,t):console.log(`[INFO] ${e}`))},error:(e,t)=>{r("error")&&(t&&Object.keys(t).length>0?console.error(`[ERROR] ${e}`,t):console.error(`[ERROR] ${e}`))},warn:(e,t)=>{r("warn")&&(t&&Object.keys(t).length>0?console.warn(`[WARN] ${e}`,t):console.warn(`[WARN] ${e}`))},debug:(e,t)=>{r("debug")&&(t&&Object.keys(t).length>0?console.log(`[DEBUG] ${e}`,t):console.log(`[DEBUG] ${e}`))}};function o(e,t){a.info(e,t)}function i(e,t,n){a.error(e,{...n,error:t instanceof Error?{message:t.message,stack:t.stack,name:t.name}:t})}function s(e,t){a.warn(e,t)}function c(e,t,n){a.info("API Request",{method:e,path:t,userId:n})}function l(e,t,n,r,o){a.info(`API Response ${n}`,{method:e,path:t,status:n,duration:r,userId:o})}function d(e,t,n,r){a.debug("Database Operation",{operation:e,collection:t,documentId:n,duration:r})}function u(e,t,n,r){r?a.error(`External API Error: ${e}`,{service:e,operation:t,duration:n,error:r.message}):a.info(`External API Call: ${e}`,{service:e,operation:t,duration:n})}e.s(["logApiRequest",()=>c,"logApiResponse",()=>l,"logDbOperation",()=>d,"logError",()=>i,"logExternalApiCall",()=>u,"logInfo",()=>o,"logWarn",()=>s,"logger",0,a])},55742,e=>e.a(async(t,n)=>{try{let t=await e.y("firebase-admin/firestore");e.n(t),n()}catch(e){n(e)}},!0),68253,e=>e.a(async(t,n)=>{try{var r=e.i(56300),a=e.i(55742),o=t([r,a]);if([r,a]=o.then?(await o)():o,!(0,r.getApps)().length)try{let e=process.env.FIREBASE_PROJECT_ID,t=process.env.FIREBASE_CLIENT_EMAIL,n=process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g,"\n");e&&t&&n?((0,r.initializeApp)({credential:(0,r.cert)({projectId:e,clientEmail:t,privateKey:n})}),console.log("✅ Firebase Admin initialized successfully")):console.warn("⚠️  Firebase credentials not configured - app will not function at runtime")}catch(e){console.error("❌ Firebase Admin initialization error:",e)}let l=null,d=new Proxy({},{get:(e,t)=>(function(){if(!l){if(!(0,r.getApps)().length)throw Error("Firebase is not initialized. Make sure environment variables are configured.");l=(0,a.getFirestore)()}return l})()[t]});function i(e){return e?e.toDate():null}function s(e){return e?"string"==typeof e?a.Timestamp.fromDate(new Date(e)):a.Timestamp.fromDate(e):null}function c(){return a.FieldValue.serverTimestamp()}e.s(["COLLECTIONS",0,{USERS:"users",INVOICES:"invoices",PAYMENT_CONFIRMATIONS:"payment_confirmations",COLLECTION_ATTEMPTS:"collection_attempts",NOTIFICATIONS:"notifications",TRANSACTIONS:"transactions",REFERRALS:"referrals",REFERRAL_CREDITS:"referral_credits",REFERRAL_PAYOUTS:"referral_payouts",USER_BEHAVIOR_PROFILE:"user_behavior_profile",USER_STATS:"user_stats",USER_EVENTS:"user_events",DAILY_SUMMARIES:"daily_summaries",EMAILS_SENT:"emails_sent",ONBOARDING_PROGRESS:"onboarding_progress",AGENCY_HANDOFFS:"agency_handoffs"},"dateToTimestamp",()=>s,"db",0,d,"serverTimestamp",()=>c,"timestampToDate",()=>i]),n()}catch(e){n(e)}},!1),18622,(e,t,n)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,n)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,n)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,n)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},93695,(e,t,n)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},42315,(e,t,n)=>{"use strict";t.exports=e.r(18622)},47540,(e,t,n)=>{"use strict";t.exports=e.r(42315).vendored["react-rsc"].React},19481,(e,t,n)=>{"use strict";var r=Object.defineProperty,a=Object.getOwnPropertyDescriptor,o=Object.getOwnPropertyNames,i=Object.prototype.hasOwnProperty,s={},c={RequestCookies:()=>p,ResponseCookies:()=>y,parseCookie:()=>u,parseSetCookie:()=>m,stringifyCookie:()=>d};for(var l in c)r(s,l,{get:c[l],enumerable:!0});function d(e){var t;let n=["path"in e&&e.path&&`Path=${e.path}`,"expires"in e&&(e.expires||0===e.expires)&&`Expires=${("number"==typeof e.expires?new Date(e.expires):e.expires).toUTCString()}`,"maxAge"in e&&"number"==typeof e.maxAge&&`Max-Age=${e.maxAge}`,"domain"in e&&e.domain&&`Domain=${e.domain}`,"secure"in e&&e.secure&&"Secure","httpOnly"in e&&e.httpOnly&&"HttpOnly","sameSite"in e&&e.sameSite&&`SameSite=${e.sameSite}`,"partitioned"in e&&e.partitioned&&"Partitioned","priority"in e&&e.priority&&`Priority=${e.priority}`].filter(Boolean),r=`${e.name}=${encodeURIComponent(null!=(t=e.value)?t:"")}`;return 0===n.length?r:`${r}; ${n.join("; ")}`}function u(e){let t=new Map;for(let n of e.split(/; */)){if(!n)continue;let e=n.indexOf("=");if(-1===e){t.set(n,"true");continue}let[r,a]=[n.slice(0,e),n.slice(e+1)];try{t.set(r,decodeURIComponent(null!=a?a:"true"))}catch{}}return t}function m(e){if(!e)return;let[[t,n],...r]=u(e),{domain:a,expires:o,httponly:i,maxage:s,path:c,samesite:l,secure:d,partitioned:m,priority:p}=Object.fromEntries(r.map(([e,t])=>[e.toLowerCase().replace(/-/g,""),t]));{var y,h,v={name:t,value:decodeURIComponent(n),domain:a,...o&&{expires:new Date(o)},...i&&{httpOnly:!0},..."string"==typeof s&&{maxAge:Number(s)},path:c,...l&&{sameSite:f.includes(y=(y=l).toLowerCase())?y:void 0},...d&&{secure:!0},...p&&{priority:g.includes(h=(h=p).toLowerCase())?h:void 0},...m&&{partitioned:!0}};let e={};for(let t in v)v[t]&&(e[t]=v[t]);return e}}t.exports=((e,t,n,s)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let n of o(t))i.call(e,n)||void 0===n||r(e,n,{get:()=>t[n],enumerable:!(s=a(t,n))||s.enumerable});return e})(r({},"__esModule",{value:!0}),s);var f=["strict","lax","none"],g=["low","medium","high"],p=class{constructor(e){this._parsed=new Map,this._headers=e;const t=e.get("cookie");if(t)for(const[e,n]of u(t))this._parsed.set(e,{name:e,value:n})}[Symbol.iterator](){return this._parsed[Symbol.iterator]()}get size(){return this._parsed.size}get(...e){let t="string"==typeof e[0]?e[0]:e[0].name;return this._parsed.get(t)}getAll(...e){var t;let n=Array.from(this._parsed);if(!e.length)return n.map(([e,t])=>t);let r="string"==typeof e[0]?e[0]:null==(t=e[0])?void 0:t.name;return n.filter(([e])=>e===r).map(([e,t])=>t)}has(e){return this._parsed.has(e)}set(...e){let[t,n]=1===e.length?[e[0].name,e[0].value]:e,r=this._parsed;return r.set(t,{name:t,value:n}),this._headers.set("cookie",Array.from(r).map(([e,t])=>d(t)).join("; ")),this}delete(e){let t=this._parsed,n=Array.isArray(e)?e.map(e=>t.delete(e)):t.delete(e);return this._headers.set("cookie",Array.from(t).map(([e,t])=>d(t)).join("; ")),n}clear(){return this.delete(Array.from(this._parsed.keys())),this}[Symbol.for("edge-runtime.inspect.custom")](){return`RequestCookies ${JSON.stringify(Object.fromEntries(this._parsed))}`}toString(){return[...this._parsed.values()].map(e=>`${e.name}=${encodeURIComponent(e.value)}`).join("; ")}},y=class{constructor(e){var t,n,r;this._parsed=new Map,this._headers=e;const a=null!=(r=null!=(n=null==(t=e.getSetCookie)?void 0:t.call(e))?n:e.get("set-cookie"))?r:[];for(const e of Array.isArray(a)?a:function(e){if(!e)return[];var t,n,r,a,o,i=[],s=0;function c(){for(;s<e.length&&/\s/.test(e.charAt(s));)s+=1;return s<e.length}for(;s<e.length;){for(t=s,o=!1;c();)if(","===(n=e.charAt(s))){for(r=s,s+=1,c(),a=s;s<e.length&&"="!==(n=e.charAt(s))&&";"!==n&&","!==n;)s+=1;s<e.length&&"="===e.charAt(s)?(o=!0,s=a,i.push(e.substring(t,r)),t=s):s=r+1}else s+=1;(!o||s>=e.length)&&i.push(e.substring(t,e.length))}return i}(a)){const t=m(e);t&&this._parsed.set(t.name,t)}}get(...e){let t="string"==typeof e[0]?e[0]:e[0].name;return this._parsed.get(t)}getAll(...e){var t;let n=Array.from(this._parsed.values());if(!e.length)return n;let r="string"==typeof e[0]?e[0]:null==(t=e[0])?void 0:t.name;return n.filter(e=>e.name===r)}has(e){return this._parsed.has(e)}set(...e){let[t,n,r]=1===e.length?[e[0].name,e[0].value,e[0]]:e,a=this._parsed;return a.set(t,function(e={name:"",value:""}){return"number"==typeof e.expires&&(e.expires=new Date(e.expires)),e.maxAge&&(e.expires=new Date(Date.now()+1e3*e.maxAge)),(null===e.path||void 0===e.path)&&(e.path="/"),e}({name:t,value:n,...r})),function(e,t){for(let[,n]of(t.delete("set-cookie"),e)){let e=d(n);t.append("set-cookie",e)}}(a,this._headers),this}delete(...e){let[t,n]="string"==typeof e[0]?[e[0]]:[e[0].name,e[0]];return this.set({...n,name:t,value:"",expires:new Date(0)})}[Symbol.for("edge-runtime.inspect.custom")](){return`ResponseCookies ${JSON.stringify(Object.fromEntries(this._parsed))}`}toString(){return[...this._parsed.values()].map(d).join("; ")}}},66680,(e,t,n)=>{t.exports=e.x("node:crypto",()=>require("node:crypto"))},54799,(e,t,n)=>{t.exports=e.x("crypto",()=>require("crypto"))},27356,e=>{"use strict";let t,n;var r=e.i(66680);function a(e=21){var o;o=e|=0,!t||t.length<o?(t=Buffer.allocUnsafe(128*o),r.webcrypto.getRandomValues(t),n=0):n+o>t.length&&(r.webcrypto.getRandomValues(t),n=0),n+=o;let i="";for(let r=n-e;r<n;r++)i+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&t[r]];return i}e.s(["nanoid",()=>a],27356)},17608,e=>e.a(async(t,n)=>{try{var r=e.i(68253),a=e.i(55742),o=e.i(69907),i=t([r,a]);async function s(e){let t=Date.now();try{let n=e.grossAmount*e.agencyCommissionRate,i=e.grossAmount-n,s=r.db.collection("payment_transactions").doc(),c={transactionId:s.id,transactionType:"agency_recovery",invoiceId:e.invoiceId,freelancerId:e.freelancerId,agencyHandoffId:e.agencyHandoffId,agencyId:e.agencyId,grossAmount:e.grossAmount,agencyCommissionRate:e.agencyCommissionRate,agencyCommissionAmount:n,netToFreelancer:i,status:"pending",notes:e.notes,createdAt:a.Timestamp.now()};return await s.set(c),(0,o.logDbOperation)("create_agency_recovery_transaction","payment_transactions",s.id,Date.now()-t),(0,o.logInfo)("Agency recovery transaction created",{transactionId:s.id,invoiceId:e.invoiceId,grossAmount:e.grossAmount,netToFreelancer:i}),{success:!0,transactionId:s.id}}catch(e){return(0,o.logError)("Failed to create agency recovery transaction",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function c(e,t=50){let n=Date.now();try{let a=await r.db.collection("payment_transactions").where("freelancerId","==",e).orderBy("createdAt","desc").limit(t).get();return(0,o.logDbOperation)("get_freelancer_transactions","payment_transactions",void 0,Date.now()-n),a.docs.map(e=>e.data())}catch(e){return(0,o.logError)("Failed to get freelancer transactions",e),[]}}async function l(e){try{let t=(await c(e,1e3)).filter(e=>"completed"===e.status),n=t.reduce((e,t)=>e+t.grossAmount,0),r=t.reduce((e,t)=>e+t.agencyCommissionAmount,0),a=t.reduce((e,t)=>e+t.netToFreelancer,0);return{totalRecovered:n,totalCommission:r,totalNet:a,transactionCount:t.length}}catch(e){return(0,o.logError)("Failed to calculate freelancer recoveries",e),{totalRecovered:0,totalCommission:0,totalNet:0,transactionCount:0}}}[r,a]=i.then?(await i)():i,e.s(["calculateFreelancerRecoveries",()=>l,"createAgencyRecoveryTransaction",()=>s,"getFreelancerTransactions",()=>c]),n()}catch(e){n(e)}},!1),94222,e=>e.a(async(t,n)=>{try{let t=await e.y("firebase-admin/storage");e.n(t),n()}catch(e){n(e)}},!0),53515,e=>e.a(async(t,n)=>{try{var r=e.i(94222),a=e.i(56300),o=e.i(69907),i=t([r,a]);function s(){if(!(0,a.getApps)().length)throw Error("Firebase is not initialized");let e=(0,r.getStorage)(),t=process.env.FIREBASE_STORAGE_BUCKET||`${process.env.FIREBASE_PROJECT_ID}.appspot.com`;return e.bucket(t)}async function c(e){try{let{fileBuffer:t,fileName:n,contentType:r,handoffId:a,freelancerId:i,documentType:c}=e,l=`documents/${i}/${a}/${c}/${n}`,d=s(),u=d.file(l);await u.save(t,{contentType:r,metadata:{handoffId:a,freelancerId:i,documentType:c,uploadedAt:new Date().toISOString()}}),(0,o.logInfo)("Document uploaded to Firebase Storage",{storagePath:l,fileName:n,handoffId:a,documentType:c}),await u.makePublic();let m=`https://storage.googleapis.com/${d.name}/${l}`;return{success:!0,storagePath:l,publicUrl:m}}catch(e){return(0,o.logError)("Failed to upload document to Firebase Storage",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function l(e,t=60){try{let n=s().file(e),[r]=await n.exists();if(!r)return{success:!1,error:"File not found"};let a=new Date;a.setMinutes(a.getMinutes()+t);let[i]=await n.getSignedUrl({action:"read",expires:a});return(0,o.logInfo)("Generated signed URL",{storagePath:e,expiresAt:a.toISOString()}),{success:!0,signedUrl:i,expiresAt:a}}catch(e){return(0,o.logError)("Failed to generate signed URL",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function d(e){try{let t=s().file(e),[n]=await t.exists();if(!n)return(0,o.logInfo)("Document already deleted or does not exist",{storagePath:e}),{success:!0};return await t.delete(),(0,o.logInfo)("Document deleted from Firebase Storage",{storagePath:e}),{success:!0}}catch(e){return(0,o.logError)("Failed to delete document from Firebase Storage",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function u(e,t){try{let n=s(),r=`documents/${t}/${e}/`,[a]=await n.getFiles({prefix:r}),i=a.map(e=>({name:e.name.split("/").pop()||e.name,storagePath:e.name,contentType:e.metadata.contentType||"application/octet-stream",size:parseInt(String(e.metadata.size||"0"),10),uploadedAt:new Date(e.metadata.timeCreated||Date.now()),documentType:String(e.metadata.metadata?.documentType||"unknown")}));return(0,o.logInfo)("Listed handoff documents",{handoffId:e,freelancerId:t,documentCount:i.length}),{success:!0,documents:i}}catch(e){return(0,o.logError)("Failed to list handoff documents",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function m(e){let t=`invoice-${e.invoiceReference}.pdf`;return c({fileBuffer:e.pdfBuffer,fileName:t,contentType:"application/pdf",handoffId:e.handoffId,freelancerId:e.freelancerId,documentType:"invoice"})}async function f(e){return c({fileBuffer:e.contentBuffer,fileName:e.fileName,contentType:e.contentType,handoffId:e.handoffId,freelancerId:e.freelancerId,documentType:"communication"})}[r,a]=i.then?(await i)():i,e.s(["deleteDocument",()=>d,"getSignedUrl",()=>l,"listHandoffDocuments",()=>u,"uploadCommunicationHistory",()=>f,"uploadDocument",()=>c,"uploadInvoicePDF",()=>m]),n()}catch(e){n(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__da193a99._.js.map