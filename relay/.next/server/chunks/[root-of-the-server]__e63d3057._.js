module.exports=[15776,e=>{"use strict";var t=e.i(89171),r=e.i(15874);class s extends Error{statusCode;code;constructor(e,t,r){super(t),this.statusCode=e,this.code=r,this.name="ApiError"}}class n extends s{details;constructor(e,t){super(400,e,"VALIDATION_ERROR"),this.details=t}}class o extends s{constructor(e="Unauthorized"){super(401,e,"UNAUTHORIZED")}}class a extends s{constructor(e="Forbidden"){super(403,e,"FORBIDDEN")}}class i extends s{constructor(e="Not found"){super(404,e,"NOT_FOUND")}}class l extends s{retryAfter;constructor(e="Rate limit exceeded",t){super(429,e,"RATE_LIMIT"),this.retryAfter=t}}class c extends s{constructor(e="Internal server error"){super(500,e,"INTERNAL_ERROR")}}function u(e){if(e instanceof s){let r={error:e.code,message:e.message};return(e instanceof n&&e.details&&(r.details=e.details),e instanceof l&&e.retryAfter)?t.NextResponse.json(r,{status:e.statusCode,headers:{"Retry-After":e.retryAfter.toString()}}):t.NextResponse.json(r,{status:e.statusCode})}return e instanceof r.ZodError?t.NextResponse.json({error:"VALIDATION_ERROR",message:"Invalid request data",details:e.issues},{status:400}):(console.error("Unhandled error:",e),t.NextResponse.json({error:"INTERNAL_ERROR",message:"An unexpected error occurred"},{status:500}))}e.s(["NotFoundError",()=>i,"errors",0,{unauthorized:(e="Unauthorized")=>new o(e),forbidden:(e="Forbidden")=>new a(e),notFound:(e="Not found")=>new i(e),badRequest:e=>new n(e),internal:(e="Internal server error")=>new c(e),rateLimit:(e="Rate limit exceeded",t)=>new l(e,t)},"handleApiError",()=>u])},4446,(e,t,r)=>{t.exports=e.x("net",()=>require("net"))},55004,(e,t,r)=>{t.exports=e.x("tls",()=>require("tls"))},874,(e,t,r)=>{t.exports=e.x("buffer",()=>require("buffer"))},23469,(e,t,r)=>{var s=e.r(874),n=s.Buffer;function o(e,t){for(var r in e)t[r]=e[r]}function a(e,t,r){return n(e,t,r)}n.from&&n.alloc&&n.allocUnsafe&&n.allocUnsafeSlow?t.exports=s:(o(s,r),r.Buffer=a),a.prototype=Object.create(n.prototype),o(n,a),a.from=function(e,t,r){if("number"==typeof e)throw TypeError("Argument must not be a number");return n(e,t,r)},a.alloc=function(e,t,r){if("number"!=typeof e)throw TypeError("Argument must be a number");var s=n(e);return void 0!==t?"string"==typeof r?s.fill(t,r):s.fill(t):s.fill(0),s},a.allocUnsafe=function(e){if("number"!=typeof e)throw TypeError("Argument must be a number");return n(e)},a.allocUnsafeSlow=function(e){if("number"!=typeof e)throw TypeError("Argument must be a number");return s.SlowBuffer(e)}},45706,(e,t,r)=>{t.exports=e.x("querystring",()=>require("querystring"))},81582,e=>e.a(async(t,r)=>{try{var s=e.i(69907),n=e.i(68253),o=e.i(55742),a=e.i(74461),i=t([n,o]);async function l(e){let t=Date.now();try{let r;if(!e.recipientPhone.startsWith("+44"))throw Error("Only UK phone numbers supported (+44)");let o=await n.db.collection("users").where("phoneNumber","==",e.recipientPhone).limit(1).get();if(!o.empty){let t=o.docs[0].data();if(t.collectionsConsent?.smsOptedOut)return(0,s.logWarn)("SMS not sent: User has opted out",{phone:e.recipientPhone,optOutDate:t.collectionsConsent.smsOptOutDate}),{success:!1,error:"User has opted out of SMS communications"}}if((r=new Date().getHours())>=21||r<8)return(0,s.logError)("SMS not sent: Quiet hours (21:00-08:00)",Error("Quiet hours"),{invoiceId:e.invoiceId}),{success:!1,error:"Cannot send SMS during quiet hours (21:00-08:00)"};let i=function(e,t){let{invoiceReference:r,amount:s,dueDate:n,paymentLink:o,businessName:a}=t;return({gentle_reminder:`Hi, this is a friendly reminder from ${a} about invoice ${r} for \xa3${s.toFixed(2)}, due ${n}. ${o?`Pay now: ${o}`:"Please arrange payment at your earliest convenience."} Reply STOP to opt out.`,urgent_reminder:`URGENT: Invoice ${r} for \xa3${s.toFixed(2)} is now overdue (due ${n}). ${o?`Pay immediately: ${o}`:"Please contact us urgently."} - ${a}. Reply STOP to opt out.`,final_notice:`FINAL NOTICE: Invoice ${r} for \xa3${s.toFixed(2)} remains unpaid. This is your last reminder before further action. ${o?`Pay now: ${o}`:"Contact us immediately."} - ${a}. Reply STOP to opt out.`,payment_link:`${a}: Pay invoice ${r} (\xa3${s.toFixed(2)}) securely: ${o}. Reply STOP to opt out.`})[e]}(e.template,{invoiceReference:e.invoiceReference,amount:e.amount,dueDate:e.dueDate,paymentLink:e.paymentLink,businessName:e.businessName}),l=function(){let e=process.env.TWILIO_ACCOUNT_SID,t=process.env.TWILIO_AUTH_TOKEN;if(!e||!t)throw Error("Twilio credentials not configured");return(0,a.default)(e,t)}(),c=await l.messages.create({body:i,from:process.env.TWILIO_PHONE_NUMBER,to:e.recipientPhone,statusCallback:`${process.env.NEXT_PUBLIC_APP_URL}/api/webhooks/twilio/sms-status`}),u=Date.now()-t;return(0,s.logExternalApiCall)("Twilio SMS","send",u),{success:!0,messageSid:c.sid,status:c.status}}catch(r){let e=Date.now()-t;return(0,s.logExternalApiCall)("Twilio SMS","send",e,r),{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}async function c(e){try{let t=u(e)||e;(0,s.logInfo)("Processing SMS opt-out request",{phoneNumber:t});let r=await n.db.collection("users").where("phoneNumber","==",t).get();if(r.empty)return(0,s.logWarn)("No users found for opt-out phone number",{phoneNumber:t}),{success:!0,usersUpdated:0};let a=n.db.batch(),i=o.Timestamp.now();return r.docs.forEach(e=>{a.update(e.ref,{"collectionsConsent.smsConsent":!1,"collectionsConsent.smsOptedOut":!0,"collectionsConsent.smsOptOutDate":i,updatedAt:i})}),await a.commit(),(0,s.logInfo)("SMS opt-out processed successfully",{phoneNumber:t,usersUpdated:r.size}),{success:!0,usersUpdated:r.size}}catch(t){return(0,s.logError)("Failed to process SMS opt-out",t,{phoneNumber:e}),{success:!1,usersUpdated:0,error:t.message}}}function u(e){let t=e.replace(/[\s\-\(\)]/g,"");return t.startsWith("07")?"+44"+t.substring(1):t.startsWith("447")?"+"+t:t.startsWith("+44")?t:null}[n,o]=i.then?(await i)():i,e.s(["formatUKPhone",()=>u,"handleSMSOptOut",()=>c,"sendCollectionSMS",()=>l]),r()}catch(e){r(e)}},!1),9053,e=>e.a(async(t,r)=>{try{var s=e.i(68253),n=e.i(69907),o=t([s]);[s]=o.then?(await o)():o;let c={sms_reminders:"paid",physical_letters:"paid",ai_voice_calls:"paid",agency_handoff:"paid",advanced_analytics:"paid",priority_support:"paid",unlimited_collections:"paid"},u={sms_reminders:{perUse:.04,description:"SMS reminder sent to client"},physical_letters:{perUse:1.2,description:"Physical letter sent by post"},ai_voice_calls:{perUse:1.5,description:"5-minute AI collection call"},agency_handoff:{perUse:0,description:"Escalation to collection agency"},advanced_analytics:{perUse:0,description:"Access to advanced analytics dashboard"},priority_support:{perUse:0,description:"24/7 priority email support"},unlimited_collections:{perUse:0,description:"Unlimited automated collection reminders"}};async function a(e,t){try{let r=await s.db.collection("users").doc(e).get();if(!r.exists)return{hasAccess:!1,reason:"User not found"};let n=r.data(),o=c[t];if("paid"===o&&"free"===n.subscriptionTier)return{hasAccess:!1,reason:"This feature requires a paid subscription",upgradeRequired:!0};if(!n.collectionsEnabled)return{hasAccess:!1,reason:"Collections features are disabled for your account"};if("free"===n.subscriptionTier&&"unlimited_collections"===t){let t=new Date().getMonth();if(n.lastDemoResetDate?.toDate().getMonth()!==t&&await s.db.collection("users").doc(e).update({collectionsDemoUsedThisMonth:0,lastDemoResetDate:new Date}),n.collectionsDemoUsedThisMonth>=2)return{hasAccess:!1,reason:"Free tier demo limit reached (2 per month)",upgradeRequired:!0}}return{hasAccess:!0}}catch(r){return(0,n.logWarn)("Premium access check failed",{userId:e,feature:t,error:r}),{hasAccess:!1,reason:"Unable to verify subscription status"}}}async function i(e,t){let r=await a(e,t);if(!r.hasAccess){let e=Error(r.reason||"Access denied");throw e.statusCode=402,e.upgradeRequired=r.upgradeRequired,e}}async function l(e){try{await s.db.collection("premium_feature_usage").add({userId:e.userId,feature:e.feature,invoiceId:e.invoiceId,cost:e.cost||u[e.feature].perUse,timestamp:new Date})}catch(t){(0,n.logWarn)("Failed to log premium feature usage",e)}}e.s(["logPremiumFeatureUsage",()=>l,"requirePremiumAccess",()=>i]),r()}catch(e){r(e)}},!1),38851,e=>e.a(async(t,r)=>{try{var s=e.i(68253),n=e.i(55742),o=e.i(69907),a=t([s,n]);async function i(e){try{let t=await s.db.collection("users").doc(e).get();if(!t.exists)return null;let r=t.data().collectionsConsent,n=!r||!r.consentVersion||"v1.0.0"!==r.consentVersion;return{smsConsent:r?.smsConsent||!1,callConsent:r?.callConsent||!1,callRecordingConsent:r?.callRecordingConsent||!1,physicalMailConsent:r?.physicalMailConsent||!1,dataStorageConsent:r?.dataStorageConsent||!1,consentDate:r?.consentDate?.toDate(),consentVersion:r?.consentVersion,needsUpdate:n}}catch(e){return(0,o.logError)("Failed to get user consent",e),null}}async function l(e,t){try{let r=await i(e);if(!r)return!1;switch(t){case"sms":return r.smsConsent;case"call":return r.callConsent;case"call_recording":return r.callRecordingConsent;case"physical_mail":return r.physicalMailConsent;case"data_storage":return r.dataStorageConsent;default:return!1}}catch(e){return(0,o.logError)("Failed to check consent",e),!1}}async function c(e,t){let r=await i(e);if(!r)throw Error("User consent status not found");if(r.needsUpdate)throw Error("Consent requires update to current version");for(let r of t)if(!await l(e,r))throw Error(`User has not given consent for: ${r}`)}[s,n]=a.then?(await a)():a,e.s(["validateConsentOrThrow",()=>c]),r()}catch(e){r(e)}},!1),99295,e=>e.a(async(t,r)=>{try{var s=e.i(89171),n=e.i(7218),o=e.i(68253),a=e.i(55742),i=e.i(81582),l=e.i(9053),c=e.i(38851),u=e.i(15776),d=e.i(69907),p=t([o,a,i,l,c]);async function m(e){let t=Date.now();try{let{userId:r}=await (0,n.auth)();if(!r)throw u.errors.unauthorized();(0,d.logApiRequest)("POST","/api/collections/sms",r),await (0,l.requirePremiumAccess)(r,"sms_reminders"),await (0,c.validateConsentOrThrow)(r,["sms","data_storage"]);let{invoiceId:p,recipientPhone:m,template:f="gentle_reminder"}=await e.json();if(!p||!m)throw u.errors.badRequest("Missing required fields: invoiceId, recipientPhone");let h=await o.db.collection("invoices").doc(p).get();if(!h.exists)throw u.errors.notFound("Invoice not found");let g=h.data();if(g.freelancerId!==r)throw u.errors.forbidden("You do not have access to this invoice");if("paid"===g.status)throw u.errors.badRequest("Invoice is already paid");let y=await o.db.collection("users").doc(r).get(),w=y.data()?.businessName||y.data()?.name||"Your Freelancer";Date.now(),g.dueDate.toMillis();let R=await (0,i.sendCollectionSMS)({recipientPhone:m,invoiceReference:g.reference,amount:g.amount,dueDate:g.dueDate.toDate().toLocaleDateString("en-GB"),template:f,paymentLink:g.stripePaymentLinkUrl,businessName:w,invoiceId:p,freelancerId:r});if(!R.success)throw Error(R.error||"Failed to send SMS");let v=o.db.collection("collection_attempts").doc();await v.set({attemptId:v.id,invoiceId:p,freelancerId:r,attemptType:"sms_reminder",attemptDate:a.FieldValue.serverTimestamp(),attemptNumber:g.collectionsAttempts+1,result:"pending",resultDetails:`SMS sent via Twilio (${f})`,twilioMessageId:R.messageSid,smsSentAt:a.FieldValue.serverTimestamp(),smsStatus:R.status,isPremiumFeature:!0,consentGiven:!0,createdAt:a.FieldValue.serverTimestamp()}),await o.db.collection("invoices").doc(p).update({collectionsAttempts:a.FieldValue.increment(1),updatedAt:a.FieldValue.serverTimestamp()}),await (0,l.logPremiumFeatureUsage)({userId:r,feature:"sms_reminders",invoiceId:p,cost:.04}),(0,d.logInfo)("SMS collection reminder sent",{invoiceId:p,messageSid:R.messageSid,template:f});let b=Date.now()-t;return(0,d.logApiResponse)("POST","/api/collections/sms",200,b,r),s.NextResponse.json({success:!0,message:"SMS reminder sent successfully",attemptId:v.id,messageSid:R.messageSid,cost:.04})}catch(r){let e=Date.now()-t;if((0,d.logApiResponse)("POST","/api/collections/sms",r.statusCode||500,e),402===r.statusCode)return s.NextResponse.json({error:r.message,upgradeRequired:!0,upgradeUrl:"/settings/billing/upgrade"},{status:402});return(0,u.handleApiError)(r)}}[o,a,i,l,c]=p.then?(await p)():p,e.s(["POST",()=>m,"dynamic",0,"force-dynamic"]),r()}catch(e){r(e)}},!1),22846,e=>e.a(async(t,r)=>{try{var s=e.i(47909),n=e.i(74017),o=e.i(96250),a=e.i(84243),i=e.i(61916),l=e.i(14444),c=e.i(37092),u=e.i(69741),d=e.i(16795),p=e.i(87718),m=e.i(95169),f=e.i(47587),h=e.i(66012),g=e.i(70101),y=e.i(26937),w=e.i(10372),R=e.i(93695);e.i(52474);var v=e.i(220),b=e.i(99295),E=t([b]);[b]=E.then?(await E)():E;let A=new s.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/collections/sms/route",pathname:"/api/collections/sms",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/collections/sms/route.ts",nextConfigOutput:"",userland:b}),{workAsyncStorage:_,workUnitAsyncStorage:T,serverHooks:x}=A;function C(){return(0,o.patchFetch)({workAsyncStorage:_,workUnitAsyncStorage:T})}async function S(e,t,r){A.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let s="/api/collections/sms/route";s=s.replace(/\/index$/,"")||"/";let o=await A.prepare(e,t,{srcPage:s,multiZoneDraftMode:!1});if(!o)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:b,params:E,nextConfig:C,parsedUrl:S,isDraftMode:_,prerenderManifest:T,routerServerContext:x,isOnDemandRevalidate:O,revalidateOnlyGenerated:U,resolvedPathname:N,clientReferenceManifest:I,serverActionsManifest:P}=o,D=(0,u.normalizeAppPath)(s),M=!!(T.dynamicRoutes[D]||T.routes[N]),q=async()=>((null==x?void 0:x.render404)?await x.render404(e,t,S,!1):t.end("This page could not be found"),null);if(M&&!_){let e=!!T.routes[N],t=T.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(C.experimental.adapterPath)return await q();throw new R.NoFallbackError}}let F=null;!M||A.isDev||_||(F=N,F="/index"===F?"/":F);let $=!0===A.isDev||!M,k=M&&!$;P&&I&&(0,l.setReferenceManifestsSingleton)({page:s,clientReferenceManifest:I,serverActionsManifest:P,serverModuleMap:(0,c.createServerModuleMap)({serverActionsManifest:P})});let H=e.method||"GET",L=(0,i.getTracer)(),j=L.getActiveScopeSpan(),V={params:E,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:$,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,s)=>A.onRequestError(e,t,s,x)},sharedContext:{buildId:b}},W=new d.NodeNextRequest(e),B=new d.NodeNextResponse(t),K=p.NextRequestAdapter.fromNodeNextRequest(W,(0,p.signalFromNodeResponse)(t));try{let o=async e=>A.handle(K,V).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=L.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${H} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${s}`)}),l=!!(0,a.getRequestMeta)(e,"minimalMode"),c=async a=>{var i,c;let u=async({previousCacheEntry:n})=>{try{if(!l&&O&&U&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await o(a);e.fetchMetrics=V.renderOpts.fetchMetrics;let i=V.renderOpts.pendingWaitUntil;i&&r.waitUntil&&(r.waitUntil(i),i=void 0);let c=V.renderOpts.collectedTags;if(!M)return await (0,h.sendResponse)(W,B,s,V.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(s.headers);c&&(t[w.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==V.renderOpts.collectedRevalidate&&!(V.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&V.renderOpts.collectedRevalidate,n=void 0===V.renderOpts.collectedExpire||V.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:V.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:s,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:O})},x),t}},d=await A.handleResponse({req:e,nextConfig:C,cacheKey:F,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:O,revalidateOnlyGenerated:U,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:l});if(!M)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(c=d.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",O?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),_&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,g.fromNodeOutgoingHttpHeaders)(d.value.headers);return l&&M||p.delete(w.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,y.getCacheControlHeader)(d.cacheControl)),await (0,h.sendResponse)(W,B,new Response(d.value.body,{headers:p,status:d.value.status||200})),null};j?await c(j):await L.withPropagatedContext(e.headers,()=>L.trace(m.BaseServerSpan.handleRequest,{spanName:`${H} ${s}`,kind:i.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},c))}catch(t){if(t instanceof R.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:O})}),M)throw t;return await (0,h.sendResponse)(W,B,new Response(null,{status:500})),null}}e.s(["handler",()=>S,"patchFetch",()=>C,"routeModule",()=>A,"serverHooks",()=>x,"workAsyncStorage",()=>_,"workUnitAsyncStorage",()=>T]),r()}catch(e){r(e)}},!1),29652,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__c3778b6d._.js"].map(t=>e.l(t))).then(()=>t(26445)))},6878,e=>{e.v(t=>Promise.all(["server/chunks/node_modules_next_92aaecbe._.js"].map(t=>e.l(t))).then(()=>t(93458)))},71124,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__4595132f._.js"].map(t=>e.l(t))).then(()=>t(53515)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__e63d3057._.js.map