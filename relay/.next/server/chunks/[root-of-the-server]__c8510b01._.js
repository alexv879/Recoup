module.exports=[15776,e=>{"use strict";var r=e.i(89171),t=e.i(15874);class n extends Error{statusCode;code;constructor(e,r,t){super(r),this.statusCode=e,this.code=t,this.name="ApiError"}}class s extends n{details;constructor(e,r){super(400,e,"VALIDATION_ERROR"),this.details=r}}class o extends n{constructor(e="Unauthorized"){super(401,e,"UNAUTHORIZED")}}class i extends n{constructor(e="Forbidden"){super(403,e,"FORBIDDEN")}}class a extends n{constructor(e="Not found"){super(404,e,"NOT_FOUND")}}class c extends n{retryAfter;constructor(e="Rate limit exceeded",r){super(429,e,"RATE_LIMIT"),this.retryAfter=r}}class l extends n{constructor(e="Internal server error"){super(500,e,"INTERNAL_ERROR")}}function u(e){if(e instanceof n){let t={error:e.code,message:e.message};return(e instanceof s&&e.details&&(t.details=e.details),e instanceof c&&e.retryAfter)?r.NextResponse.json(t,{status:e.statusCode,headers:{"Retry-After":e.retryAfter.toString()}}):r.NextResponse.json(t,{status:e.statusCode})}return e instanceof t.ZodError?r.NextResponse.json({error:"VALIDATION_ERROR",message:"Invalid request data",details:e.issues},{status:400}):(console.error("Unhandled error:",e),r.NextResponse.json({error:"INTERNAL_ERROR",message:"An unexpected error occurred"},{status:500}))}e.s(["NotFoundError",()=>a,"errors",0,{unauthorized:(e="Unauthorized")=>new o(e),forbidden:(e="Forbidden")=>new i(e),notFound:(e="Not found")=>new a(e),badRequest:e=>new s(e),internal:(e="Internal server error")=>new l(e),rateLimit:(e="Rate limit exceeded",r)=>new c(e,r)},"handleApiError",()=>u])},4446,(e,r,t)=>{r.exports=e.x("net",()=>require("net"))},55004,(e,r,t)=>{r.exports=e.x("tls",()=>require("tls"))},874,(e,r,t)=>{r.exports=e.x("buffer",()=>require("buffer"))},23469,(e,r,t)=>{var n=e.r(874),s=n.Buffer;function o(e,r){for(var t in e)r[t]=e[t]}function i(e,r,t){return s(e,r,t)}s.from&&s.alloc&&s.allocUnsafe&&s.allocUnsafeSlow?r.exports=n:(o(n,t),t.Buffer=i),i.prototype=Object.create(s.prototype),o(s,i),i.from=function(e,r,t){if("number"==typeof e)throw TypeError("Argument must not be a number");return s(e,r,t)},i.alloc=function(e,r,t){if("number"!=typeof e)throw TypeError("Argument must be a number");var n=s(e);return void 0!==r?"string"==typeof t?n.fill(r,t):n.fill(r):n.fill(0),n},i.allocUnsafe=function(e){if("number"!=typeof e)throw TypeError("Argument must be a number");return s(e)},i.allocUnsafeSlow=function(e){if("number"!=typeof e)throw TypeError("Argument must be a number");return n.SlowBuffer(e)}},45706,(e,r,t)=>{r.exports=e.x("querystring",()=>require("querystring"))},33405,(e,r,t)=>{r.exports=e.x("child_process",()=>require("child_process"))},9053,e=>e.a(async(r,t)=>{try{var n=e.i(68253),s=e.i(69907),o=r([n]);[n]=o.then?(await o)():o;let l={sms_reminders:"paid",physical_letters:"paid",ai_voice_calls:"paid",agency_handoff:"paid",advanced_analytics:"paid",priority_support:"paid",unlimited_collections:"paid"},u={sms_reminders:{perUse:.04,description:"SMS reminder sent to client"},physical_letters:{perUse:1.2,description:"Physical letter sent by post"},ai_voice_calls:{perUse:1.5,description:"5-minute AI collection call"},agency_handoff:{perUse:0,description:"Escalation to collection agency"},advanced_analytics:{perUse:0,description:"Access to advanced analytics dashboard"},priority_support:{perUse:0,description:"24/7 priority email support"},unlimited_collections:{perUse:0,description:"Unlimited automated collection reminders"}};async function i(e,r){try{let t=await n.db.collection("users").doc(e).get();if(!t.exists)return{hasAccess:!1,reason:"User not found"};let s=t.data(),o=l[r];if("paid"===o&&"free"===s.subscriptionTier)return{hasAccess:!1,reason:"This feature requires a paid subscription",upgradeRequired:!0};if(!s.collectionsEnabled)return{hasAccess:!1,reason:"Collections features are disabled for your account"};if("free"===s.subscriptionTier&&"unlimited_collections"===r){let r=new Date().getMonth();if(s.lastDemoResetDate?.toDate().getMonth()!==r&&await n.db.collection("users").doc(e).update({collectionsDemoUsedThisMonth:0,lastDemoResetDate:new Date}),s.collectionsDemoUsedThisMonth>=2)return{hasAccess:!1,reason:"Free tier demo limit reached (2 per month)",upgradeRequired:!0}}return{hasAccess:!0}}catch(t){return(0,s.logWarn)("Premium access check failed",{userId:e,feature:r,error:t}),{hasAccess:!1,reason:"Unable to verify subscription status"}}}async function a(e,r){let t=await i(e,r);if(!t.hasAccess){let e=Error(t.reason||"Access denied");throw e.statusCode=402,e.upgradeRequired=t.upgradeRequired,e}}async function c(e){try{await n.db.collection("premium_feature_usage").add({userId:e.userId,feature:e.feature,invoiceId:e.invoiceId,cost:e.cost||u[e.feature].perUse,timestamp:new Date})}catch(r){(0,s.logWarn)("Failed to log premium feature usage",e)}}e.s(["logPremiumFeatureUsage",()=>c,"requirePremiumAccess",()=>a]),t()}catch(e){t(e)}},!1),38851,e=>e.a(async(r,t)=>{try{var n=e.i(68253),s=e.i(55742),o=e.i(69907),i=r([n,s]);async function a(e){try{let r=await n.db.collection("users").doc(e).get();if(!r.exists)return null;let t=r.data().collectionsConsent,s=!t||!t.consentVersion||"v1.0.0"!==t.consentVersion;return{smsConsent:t?.smsConsent||!1,callConsent:t?.callConsent||!1,callRecordingConsent:t?.callRecordingConsent||!1,physicalMailConsent:t?.physicalMailConsent||!1,dataStorageConsent:t?.dataStorageConsent||!1,consentDate:t?.consentDate?.toDate(),consentVersion:t?.consentVersion,needsUpdate:s}}catch(e){return(0,o.logError)("Failed to get user consent",e),null}}async function c(e,r){try{let t=await a(e);if(!t)return!1;switch(r){case"sms":return t.smsConsent;case"call":return t.callConsent;case"call_recording":return t.callRecordingConsent;case"physical_mail":return t.physicalMailConsent;case"data_storage":return t.dataStorageConsent;default:return!1}}catch(e){return(0,o.logError)("Failed to check consent",e),!1}}async function l(e,r){let t=await a(e);if(!t)throw Error("User consent status not found");if(t.needsUpdate)throw Error("Consent requires update to current version");for(let t of r)if(!await c(e,t))throw Error(`User has not given consent for: ${t}`)}[n,s]=i.then?(await i)():i,e.s(["validateConsentOrThrow",()=>l]),t()}catch(e){t(e)}},!1),65472,e=>{"use strict";var r=e.i(22880);let t=null,n=new Proxy({},{get:(e,n)=>(function(){if(!t){let e=process.env.STRIPE_SECRET_KEY;if(!e)throw Error("STRIPE_SECRET_KEY is not configured");t=new r.default(e,{typescript:!0})}return t})()[n]});async function s(e){try{return(await n.paymentLinks.create({line_items:[{price_data:{currency:(e.currency||"GBP").toLowerCase(),unit_amount:Math.round(100*e.amount),product_data:{name:`Invoice ${e.invoiceReference}`,description:`Payment for ${e.invoiceReference}`}},quantity:1}],after_completion:{type:"redirect",redirect:{url:`${process.env.NEXT_PUBLIC_APP_URL}/payment-success?invoice=${e.invoiceReference}`}},metadata:{invoiceReference:e.invoiceReference,freelancerId:e.freelancerId,clientEmail:e.clientEmail},allow_promotion_codes:!0})).url}catch(e){throw console.error("Stripe payment link creation error:",e),Error("Failed to create payment link")}}e.s(["createStripePaymentLink",()=>s])},41310,e=>{"use strict";var r=e.i(69907),t=e.i(65472),n=e.i(74461);function s(){return(0,n.default)(process.env.TWILIO_ACCOUNT_SID,process.env.TWILIO_AUTH_TOKEN)}async function o(e){let t=Date.now();try{if(!e.recipientPhone.startsWith("+44"))throw Error("Only UK phone numbers supported");let n=new Date().getHours();if(n>=21||n<8)throw Error("Cannot call during quiet hours (21:00-08:00)");let o={recipientName:e.recipientName,invoiceReference:e.invoiceReference,amount:e.amount,dueDate:e.dueDate,daysPastDue:e.daysPastDue,businessName:e.businessName,invoiceId:e.invoiceId,freelancerId:e.freelancerId},i=s(),a=await i.calls.create({to:e.recipientPhone,from:process.env.TWILIO_PHONE_NUMBER,url:`${process.env.NEXT_PUBLIC_APP_URL}/api/webhooks/twilio/voice-ai?context=${encodeURIComponent(JSON.stringify(o))}`,statusCallback:`${process.env.NEXT_PUBLIC_APP_URL}/api/webhooks/twilio/call-status`,statusCallbackEvent:["initiated","ringing","answered","completed"],record:!0,recordingStatusCallback:`${process.env.NEXT_PUBLIC_APP_URL}/api/webhooks/twilio/recording-status`}),c=Date.now()-t;return(0,r.logExternalApiCall)("Twilio Voice AI","initiate",c),{success:!0,callSid:a.sid}}catch(n){let e=Date.now()-t;return(0,r.logExternalApiCall)("Twilio Voice AI","initiate",e,n),{success:!1,error:n instanceof Error?n.message:"Unknown error"}}}async function i(e){let n=Date.now();try{let o=await (0,t.createStripePaymentLink)({amount:e.amount,invoiceReference:e.invoiceReference,clientEmail:"payment-via-call@relay.app",freelancerId:e.freelancerId,currency:"GBP"}),i=s(),a=await i.messages.create({to:e.recipientPhone,from:process.env.TWILIO_PHONE_NUMBER,body:`Payment link for invoice ${e.invoiceReference}: Pay \xa3${e.amount.toFixed(2)} securely at ${o}. This link expires in 24 hours.`,statusCallback:`${process.env.NEXT_PUBLIC_APP_URL}/api/webhooks/twilio/sms-status`}),c=Date.now()-n;return(0,r.logExternalApiCall)("Twilio SMS","send_payment_link",c),(0,r.logInfo)("Payment SMS sent during AI call",{invoiceReference:e.invoiceReference,recipientPhone:e.recipientPhone.substring(0,7)+"***",messageSid:a.sid}),{success:!0,paymentLink:o,messageSid:a.sid}}catch(t){let e=Date.now()-n;return(0,r.logExternalApiCall)("Twilio SMS","send_payment_link",e,t),(0,r.logError)("Failed to send payment link during call",t),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}function a(e){let{estimatedDurationMinutes:r,includeSMS:t=!1,includeRecording:n=!0}=e,s=.02*r,o=.3*r,i=.04*!!t,a=.01*!!n;return{twilioVoice:s,openaiRealtime:o,sms:i,recording:a,total:s+o+i+a}}e.s(["estimateAICallCost",()=>a,"initiateAICollectionCall",()=>o,"sendPaymentLinkDuringCall",()=>i])},29652,e=>{e.v(r=>Promise.all(["server/chunks/[root-of-the-server]__c3778b6d._.js"].map(r=>e.l(r))).then(()=>r(26445)))},6878,e=>{e.v(r=>Promise.all(["server/chunks/node_modules_next_92aaecbe._.js"].map(r=>e.l(r))).then(()=>r(93458)))},25040,e=>{e.v(r=>Promise.all(["server/chunks/lib_openai_ts_24ed19b5._.js"].map(r=>e.l(r))).then(()=>r(35686)))},11890,e=>{e.v(r=>Promise.all(["server/chunks/lib_firebase_ts_96f21a7b._.js"].map(r=>e.l(r))).then(()=>r(57660)))},71124,e=>{e.v(r=>Promise.all(["server/chunks/[root-of-the-server]__4595132f._.js"].map(r=>e.l(r))).then(()=>r(53515)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__c8510b01._.js.map