{"version":3,"sources":["../../../lib/webhook-processors/lob.ts"],"sourcesContent":["/**\n * Lob Webhook Processing Logic\n *\n * Extracted business logic for processing Lob webhooks.\n * Used by both the main webhook endpoints and the recovery system.\n */\n\nimport { db, Timestamp } from '@/lib/firebase';\nimport { logInfo, logError } from '@/utils/logger';\n\n/**\n * Process Lob webhook event\n */\nexport async function processLobWebhook(\n  eventType: string,\n  payload: any\n): Promise<void> {\n  const letter = payload.body || payload;\n\n  if (!letter?.id) {\n    throw new Error('Missing letter ID in payload');\n  }\n\n  // Find corresponding collection attempt\n  const attemptsSnapshot = await db\n    .collection('collection_attempts')\n    .where('letterApiRef', '==', letter.id)\n    .limit(1)\n    .get();\n\n  if (attemptsSnapshot.empty) {\n    throw new Error(`Collection attempt not found for letter ID: ${letter.id}`);\n  }\n\n  const attemptDoc = attemptsSnapshot.docs[0];\n  const updateData: any = {\n    updatedAt: Timestamp.now(),\n  };\n\n  // Update based on event type\n  switch (eventType) {\n    case 'letter.created':\n      updateData.letterStatus = 'sent';\n      updateData.letterSentAt = Timestamp.now();\n      updateData.result = 'pending';\n      break;\n\n    case 'letter.rendered_pdf':\n      // PDF ready, no status change\n      break;\n\n    case 'letter.in_transit':\n      updateData.letterStatus = 'sent';\n      if (letter.expected_delivery_date) {\n        updateData.letterExpectedDelivery = Timestamp.fromDate(\n          new Date(letter.expected_delivery_date)\n        );\n      }\n      break;\n\n    case 'letter.in_local_area':\n      // Letter is near destination\n      updateData.letterStatus = 'sent';\n      break;\n\n    case 'letter.processed_for_delivery':\n      // Letter is being delivered today\n      updateData.letterStatus = 'sent';\n      break;\n\n    case 'letter.delivered':\n      updateData.letterStatus = 'delivered';\n      updateData.result = 'success';\n      break;\n\n    case 'letter.returned_to_sender':\n      updateData.letterStatus = 'returned';\n      updateData.result = 'failed';\n      updateData.resultDetails = 'Letter returned to sender - bad address';\n      break;\n\n    case 'letter.failed':\n      updateData.letterStatus = 'failed';\n      updateData.result = 'failed';\n      updateData.resultDetails = letter.failure_reason || 'Letter failed to send';\n      break;\n  }\n\n  // Add tracking info if available\n  if (letter.tracking_events && letter.tracking_events.length > 0) {\n    updateData.letterTrackingUrl = letter.tracking_url;\n  }\n\n  // Update attempt\n  await attemptDoc.ref.update(updateData);\n\n  logInfo('Collection attempt updated from letter status', {\n    attemptId: attemptDoc.id,\n    eventType,\n    letterStatus: updateData.letterStatus,\n  });\n}\n"],"names":[],"mappings":"4CAOA,IAAA,EAAA,EAAA,CAAA,CAAA,OAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,kBAKO,eAAe,EACpB,CAAiB,CACjB,CAAY,EAEZ,IAAM,EAAS,EAAQ,IAAI,EAAI,EAE/B,GAAI,CAAC,GAAQ,GACX,CADe,KACT,AAAI,MAAM,gCAIlB,IAAM,EAAmB,MAAM,EAAA,EAAE,CAC9B,UAAU,CAAC,uBACX,KAAK,CAAC,eAAgB,KAAM,EAAO,EAAE,EACrC,KAAK,CAAC,GACN,GAAG,GAEN,GAAI,EAAiB,KAAK,CACxB,CAD0B,KACpB,AAAI,MAAM,CAAC,4CAA4C,EAAE,EAAO,EAAE,CAAA,CAAE,EAG5E,IAAM,EAAa,EAAiB,IAAI,CAAC,EAAE,CACrC,EAAkB,CACtB,UAAW,EAAA,SAAS,CAAC,GAAG,EAC1B,EAGA,OAAQ,GACN,IAAK,iBACH,EAAW,YAAY,CAAG,OAC1B,EAAW,YAAY,CAAG,EAAA,SAAS,CAAC,GAAG,GACvC,EAAW,MAAM,CAAG,UACpB,KAEF,KAAK,sBAEH,KAEF,KAAK,oBACH,EAAW,YAAY,CAAG,OACtB,EAAO,sBAAsB,EAAE,CACjC,EAAW,sBAAsB,CAAG,EAAA,SAAS,CAAC,QAAQ,CACpD,IAAI,KAAK,EAAO,sBAAsB,EAAA,EAG1C,KAEF,KAAK,uBAKL,IAAK,gCAHH,EAAW,YAAY,CAAG,OAC1B,KAOF,KAAK,mBACH,EAAW,YAAY,CAAG,YAC1B,EAAW,MAAM,CAAG,UACpB,KAEF,KAAK,4BACH,EAAW,YAAY,CAAG,WAC1B,EAAW,MAAM,CAAG,SACpB,EAAW,aAAa,CAAG,0CAC3B,KAEF,KAAK,gBACH,EAAW,YAAY,CAAG,SAC1B,EAAW,MAAM,CAAG,SACpB,EAAW,aAAa,CAAG,EAAO,cAAc,EAAI,uBAExD,CAGI,EAAO,eAAe,EAAI,EAAO,eAAe,CAAC,MAAM,CAAG,GAAG,CAC/D,EAAW,iBAAiB,CAAG,EAAO,YAAA,AAAY,EAIpD,MAAM,EAAW,GAAG,CAAC,MAAM,CAAC,GAE5B,CAAA,EAAA,EAAA,OAAA,AAAO,EAAC,gDAAiD,CACvD,UAAW,EAAW,EAAE,WACxB,EACA,aAAc,EAAW,YAAY,AACvC,EACF"}