module.exports=[54799,(e,t,n)=>{t.exports=e.x("crypto",()=>require("crypto"))},15776,e=>{"use strict";var t=e.i(89171),n=e.i(15874);class r extends Error{statusCode;code;constructor(e,t,n){super(t),this.statusCode=e,this.code=n,this.name="ApiError"}}class a extends r{details;constructor(e,t){super(400,e,"VALIDATION_ERROR"),this.details=t}}class o extends r{constructor(e="Unauthorized"){super(401,e,"UNAUTHORIZED")}}class i extends r{constructor(e="Forbidden"){super(403,e,"FORBIDDEN")}}class s extends r{constructor(e="Not found"){super(404,e,"NOT_FOUND")}}class c extends r{retryAfter;constructor(e="Rate limit exceeded",t){super(429,e,"RATE_LIMIT"),this.retryAfter=t}}class d extends r{constructor(e="Internal server error"){super(500,e,"INTERNAL_ERROR")}}function l(e){if(e instanceof r){let n={error:e.code,message:e.message};return(e instanceof a&&e.details&&(n.details=e.details),e instanceof c&&e.retryAfter)?t.NextResponse.json(n,{status:e.statusCode,headers:{"Retry-After":e.retryAfter.toString()}}):t.NextResponse.json(n,{status:e.statusCode})}return e instanceof n.ZodError?t.NextResponse.json({error:"VALIDATION_ERROR",message:"Invalid request data",details:e.issues},{status:400}):(console.error("Unhandled error:",e),t.NextResponse.json({error:"INTERNAL_ERROR",message:"An unexpected error occurred"},{status:500}))}e.s(["NotFoundError",()=>s,"errors",0,{unauthorized:(e="Unauthorized")=>new o(e),forbidden:(e="Forbidden")=>new i(e),notFound:(e="Not found")=>new s(e),badRequest:e=>new a(e),internal:(e="Internal server error")=>new d(e),rateLimit:(e="Rate limit exceeded",t)=>new c(e,t)},"handleApiError",()=>l])},27356,e=>{"use strict";let t,n;var r=e.i(66680);function a(e=21){var o;o=e|=0,!t||t.length<o?(t=Buffer.allocUnsafe(128*o),r.webcrypto.getRandomValues(t),n=0):n+o>t.length&&(r.webcrypto.getRandomValues(t),n=0),n+=o;let i="";for(let r=n-e;r<n;r++)i+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&t[r]];return i}e.s(["nanoid",()=>a],27356)},25639,e=>{"use strict";e.s(["COLLECTIONS_DEMO_LIMIT_FREE",0,1,"COLLECTION_DAY_14_REMINDER",0,14,"COLLECTION_DAY_21_REMINDER",0,21,"COLLECTION_DAY_30_REMINDER",0,30,"COLLECTION_DAY_7_REMINDER",0,7,"PAYMENT_CONFIRMATION_TOKEN_EXPIRY_DAYS",0,30,"RELAY_COMMISSION_RATE",0,.03])},96212,e=>e.a(async(t,n)=>{try{var r=e.i(68253),a=e.i(55742),o=e.i(15776),i=e.i(69907),s=e.i(27356),c=e.i(25639),d=e.i(54799),l=t([r,a]);async function u(e,t,n,o){let l=Date.now(),u={confirmationId:(0,s.nanoid)(),invoiceId:e,freelancerId:t,clientEmail:n,confirmationToken:d.default.randomUUID(),tokenExpiresAt:a.Timestamp.fromDate(new Date(Date.now()+24*c.PAYMENT_CONFIRMATION_TOKEN_EXPIRY_DAYS*36e5)),status:"pending_client",freelancerVerifiedReceived:!1,expectedAmount:o,createdAt:a.Timestamp.now(),expiresAt:a.Timestamp.fromDate(new Date(Date.now()+24*c.PAYMENT_CONFIRMATION_TOKEN_EXPIRY_DAYS*36e5))};return await r.db.collection(r.COLLECTIONS.PAYMENT_CONFIRMATIONS).doc(u.confirmationId).set(u),(0,i.logDbOperation)("create",r.COLLECTIONS.PAYMENT_CONFIRMATIONS,u.confirmationId,Date.now()-l),u}async function p(e,t,n,s,c){let d=Date.now(),l=await r.db.collection(r.COLLECTIONS.PAYMENT_CONFIRMATIONS).where("confirmationToken","==",e).limit(1).get();if(l.empty)throw new o.NotFoundError("Invalid confirmation token");let u=l.docs[0],p=u.data();if(p.tokenExpiresAt.toDate()<new Date)throw Error("Confirmation token has expired");let m={status:"client_confirmed",clientConfirmedAt:a.Timestamp.now(),clientConfirmedAmount:t,clientPaymentMethod:n,clientConfirmedDate:s,clientNotes:c};return await u.ref.update(m),(0,i.logDbOperation)("update",r.COLLECTIONS.PAYMENT_CONFIRMATIONS,p.confirmationId,Date.now()-d),{...p,...m}}async function m(e,t){let n=Date.now(),d=await r.db.collection(r.COLLECTIONS.PAYMENT_CONFIRMATIONS).doc(e).get();if(!d.exists)throw new o.NotFoundError("Payment confirmation not found");let l=d.data();if(l.freelancerId!==t)throw new o.NotFoundError("Payment confirmation not found");if("client_confirmed"!==l.status)throw Error("Client has not confirmed payment yet");await d.ref.update({status:"both_confirmed",freelancerConfirmedAt:a.Timestamp.now(),freelancerVerifiedReceived:!0,actualAmountPaid:l.clientConfirmedAmount}),await r.db.collection(r.COLLECTIONS.INVOICES).doc(l.invoiceId).update({status:"paid",paidAt:a.Timestamp.now(),firstReminderSentAt:null,secondReminderSentAt:null});let u=l.clientConfirmedAmount||l.expectedAmount,p={transactionId:(0,s.nanoid)(),invoiceId:l.invoiceId,freelancerId:t,amount:u,paymentMethod:l.clientPaymentMethod||"bank_transfer",relayCommission:u*c.RELAY_COMMISSION_RATE,freelancerNet:u*(1-c.RELAY_COMMISSION_RATE),commissionRate:c.RELAY_COMMISSION_RATE,status:"completed",transactionDate:a.Timestamp.now(),completedAt:a.Timestamp.now(),createdAt:a.Timestamp.now()};return await r.db.collection(r.COLLECTIONS.TRANSACTIONS).doc(p.transactionId).set(p),(0,i.logDbOperation)("verify_payment",r.COLLECTIONS.PAYMENT_CONFIRMATIONS,e,Date.now()-n),{confirmation:{...l,status:"both_confirmed"},transaction:p}}async function f(e){let t=await r.db.collection(r.COLLECTIONS.PAYMENT_CONFIRMATIONS).where("confirmationToken","==",e).limit(1).get();if(t.empty)throw new o.NotFoundError("Invalid confirmation token");let n=t.docs[0].data();if(n.tokenExpiresAt.toDate()<new Date)throw Error("Confirmation token has expired");return n}[r,a]=l.then?(await l)():l,e.s(["clientConfirmPayment",()=>p,"createPaymentConfirmation",()=>u,"freelancerVerifyPayment",()=>m,"getPaymentConfirmationByToken",()=>f]),n()}catch(e){n(e)}},!1),80324,e=>e.a(async(t,n)=>{try{var r=e.i(89171),a=e.i(7218),o=e.i(96212),i=e.i(15776),s=e.i(963),c=e.i(69907),d=t([o]);async function l(e,{params:t}){let{id:n}=await t,d=Date.now();try{let{userId:e}=await (0,a.auth)();if(!e)throw i.errors.unauthorized();(0,c.logApiRequest)("POST",`/api/payment-confirmation/${n}/verify`,e);let{success:t,remaining:l,reset:u}=await (0,s.checkRateLimit)(e,s.ratelimit);if(!t){let e=Math.ceil((u-Date.now())/1e3);throw i.errors.rateLimit(`Rate limit exceeded. Try again in ${e} seconds`,u)}let p=await (0,o.freelancerVerifyPayment)(n,e),m=Date.now()-d;return(0,c.logApiResponse)("POST",`/api/payment-confirmation/${n}/verify`,200,m,e),r.NextResponse.json({success:!0,message:"Payment verified successfully. Transaction has been recorded.",confirmation:{confirmationId:p.confirmation.confirmationId,status:p.confirmation.status,freelancerConfirmedAt:p.confirmation.freelancerConfirmedAt},transaction:{transactionId:p.transaction.transactionId,amount:p.transaction.amount,relayCommission:p.transaction.relayCommission,freelancerNet:p.transaction.freelancerNet,commissionRate:p.transaction.commissionRate,status:p.transaction.status,transactionDate:p.transaction.transactionDate.toDate().toISOString()},remainingRequests:l})}catch(t){let e=Date.now()-d;return(0,c.logApiResponse)("POST",`/api/payment-confirmation/${n}/verify`,500,e),(0,i.handleApiError)(t)}}[o]=d.then?(await d)():d,e.s(["POST",()=>l,"dynamic",0,"force-dynamic"]),n()}catch(e){n(e)}},!1),89008,e=>e.a(async(t,n)=>{try{var r=e.i(47909),a=e.i(74017),o=e.i(96250),i=e.i(84243),s=e.i(61916),c=e.i(14444),d=e.i(37092),l=e.i(69741),u=e.i(16795),p=e.i(87718),m=e.i(95169),f=e.i(47587),R=e.i(66012),E=e.i(70101),h=e.i(26937),N=e.i(10372),A=e.i(93695);e.i(52474);var I=e.i(220),O=e.i(80324),C=t([O]);[O]=C.then?(await C)():C;let y=new r.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/payment-confirmation/[id]/verify/route",pathname:"/api/payment-confirmation/[id]/verify",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/payment-confirmation/[id]/verify/route.ts",nextConfigOutput:"",userland:O}),{workAsyncStorage:_,workUnitAsyncStorage:v,serverHooks:g}=y;function w(){return(0,o.patchFetch)({workAsyncStorage:_,workUnitAsyncStorage:v})}async function T(e,t,n){y.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/payment-confirmation/[id]/verify/route";r=r.replace(/\/index$/,"")||"/";let o=await y.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!o)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:O,params:C,nextConfig:w,parsedUrl:T,isDraftMode:_,prerenderManifest:v,routerServerContext:g,isOnDemandRevalidate:D,revalidateOnlyGenerated:S,resolvedPathname:x,clientReferenceManifest:M,serverActionsManifest:P}=o,L=(0,l.normalizeAppPath)(r),b=!!(v.dynamicRoutes[L]||v.routes[x]),F=async()=>((null==g?void 0:g.render404)?await g.render404(e,t,T,!1):t.end("This page could not be found"),null);if(b&&!_){let e=!!v.routes[x],t=v.dynamicRoutes[L];if(t&&!1===t.fallback&&!e){if(w.experimental.adapterPath)return await F();throw new A.NoFallbackError}}let k=null;!b||y.isDev||_||(k=x,k="/index"===k?"/":k);let U=!0===y.isDev||!b,Y=b&&!U;P&&M&&(0,c.setReferenceManifestsSingleton)({page:r,clientReferenceManifest:M,serverActionsManifest:P,serverModuleMap:(0,d.createServerModuleMap)({serverActionsManifest:P})});let q=e.method||"GET",H=(0,s.getTracer)(),j=H.getActiveScopeSpan(),V={params:C,prerenderManifest:v,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,r)=>y.onRequestError(e,t,r,g)},sharedContext:{buildId:O}},$=new u.NodeNextRequest(e),K=new u.NodeNextResponse(t),B=p.NextRequestAdapter.fromNodeNextRequest($,(0,p.signalFromNodeResponse)(t));try{let o=async e=>y.handle(B,V).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=H.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=n.get("next.route");if(a){let t=`${q} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${r}`)}),c=!!(0,i.getRequestMeta)(e,"minimalMode"),d=async i=>{var s,d;let l=async({previousCacheEntry:a})=>{try{if(!c&&D&&S&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await o(i);e.fetchMetrics=V.renderOpts.fetchMetrics;let s=V.renderOpts.pendingWaitUntil;s&&n.waitUntil&&(n.waitUntil(s),s=void 0);let d=V.renderOpts.collectedTags;if(!b)return await (0,R.sendResponse)($,K,r,V.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,E.toNodeOutgoingHttpHeaders)(r.headers);d&&(t[N.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==V.renderOpts.collectedRevalidate&&!(V.renderOpts.collectedRevalidate>=N.INFINITE_CACHE)&&V.renderOpts.collectedRevalidate,a=void 0===V.renderOpts.collectedExpire||V.renderOpts.collectedExpire>=N.INFINITE_CACHE?void 0:V.renderOpts.collectedExpire;return{value:{kind:I.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:a}}}}catch(t){throw(null==a?void 0:a.isStale)&&await y.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:Y,isOnDemandRevalidate:D})},g),t}},u=await y.handleResponse({req:e,nextConfig:w,cacheKey:k,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:v,isRoutePPREnabled:!1,isOnDemandRevalidate:D,revalidateOnlyGenerated:S,responseGenerator:l,waitUntil:n.waitUntil,isMinimalMode:c});if(!b)return null;if((null==u||null==(s=u.value)?void 0:s.kind)!==I.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});c||t.setHeader("x-nextjs-cache",D?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),_&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,E.fromNodeOutgoingHttpHeaders)(u.value.headers);return c&&b||p.delete(N.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,h.getCacheControlHeader)(u.cacheControl)),await (0,R.sendResponse)($,K,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};j?await d(j):await H.withPropagatedContext(e.headers,()=>H.trace(m.BaseServerSpan.handleRequest,{spanName:`${q} ${r}`,kind:s.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},d))}catch(t){if(t instanceof A.NoFallbackError||await y.onRequestError(e,t,{routerKind:"App Router",routePath:L,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:Y,isOnDemandRevalidate:D})}),b)throw t;return await (0,R.sendResponse)($,K,new Response(null,{status:500})),null}}e.s(["handler",()=>T,"patchFetch",()=>w,"routeModule",()=>y,"serverHooks",()=>g,"workAsyncStorage",()=>_,"workUnitAsyncStorage",()=>v]),n()}catch(e){n(e)}},!1),29652,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__c3778b6d._.js"].map(t=>e.l(t))).then(()=>t(26445)))},6878,e=>{e.v(t=>Promise.all(["server/chunks/node_modules_next_92aaecbe._.js"].map(t=>e.l(t))).then(()=>t(93458)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__ce5718fd._.js.map