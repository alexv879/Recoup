{"version":3,"sources":["../../../node_modules/safe-buffer/index.js","../../../lib/twilio-sms.ts"],"sourcesContent":["/*! safe-buffer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */\n/* eslint-disable node/no-deprecated-api */\nvar buffer = require('buffer')\nvar Buffer = buffer.Buffer\n\n// alternative to using Object.keys for old browsers\nfunction copyProps (src, dst) {\n  for (var key in src) {\n    dst[key] = src[key]\n  }\n}\nif (Buffer.from && Buffer.alloc && Buffer.allocUnsafe && Buffer.allocUnsafeSlow) {\n  module.exports = buffer\n} else {\n  // Copy properties from require('buffer')\n  copyProps(buffer, exports)\n  exports.Buffer = SafeBuffer\n}\n\nfunction SafeBuffer (arg, encodingOrOffset, length) {\n  return Buffer(arg, encodingOrOffset, length)\n}\n\nSafeBuffer.prototype = Object.create(Buffer.prototype)\n\n// Copy static methods from Buffer\ncopyProps(Buffer, SafeBuffer)\n\nSafeBuffer.from = function (arg, encodingOrOffset, length) {\n  if (typeof arg === 'number') {\n    throw new TypeError('Argument must not be a number')\n  }\n  return Buffer(arg, encodingOrOffset, length)\n}\n\nSafeBuffer.alloc = function (size, fill, encoding) {\n  if (typeof size !== 'number') {\n    throw new TypeError('Argument must be a number')\n  }\n  var buf = Buffer(size)\n  if (fill !== undefined) {\n    if (typeof encoding === 'string') {\n      buf.fill(fill, encoding)\n    } else {\n      buf.fill(fill)\n    }\n  } else {\n    buf.fill(0)\n  }\n  return buf\n}\n\nSafeBuffer.allocUnsafe = function (size) {\n  if (typeof size !== 'number') {\n    throw new TypeError('Argument must be a number')\n  }\n  return Buffer(size)\n}\n\nSafeBuffer.allocUnsafeSlow = function (size) {\n  if (typeof size !== 'number') {\n    throw new TypeError('Argument must be a number')\n  }\n  return buffer.SlowBuffer(size)\n}\n","/**\n * PREMIUM FEATURE: Twilio SMS Service\n *\n * Handles sending SMS reminders for invoice collections.\n * Requires paid subscription tier to use.\n *\n * Setup Instructions:\n * 1. Sign up for Twilio account at https://www.twilio.com\n * 2. Get Account SID and Auth Token from console\n * 3. Purchase a UK phone number with SMS capabilities\n * 4. Add to .env.local:\n *    TWILIO_ACCOUNT_SID=your_account_sid\n *    TWILIO_AUTH_TOKEN=your_auth_token\n *    TWILIO_PHONE_NUMBER=+44xxxxxxxxxx\n * 5. Install package: npm install twilio\n *\n * UK SMS Compliance:\n * - Must have explicit consent from recipient\n * - Must include opt-out instructions\n * - Must respect quiet hours (typically 21:00 - 08:00)\n * - Must not exceed rate limits\n *\n * Twilio UK Pricing (as of 2025):\n * - SMS to UK mobiles: ~£0.04 per message\n * - Phone number rental: ~£1/month\n */\n\nimport { logError, logExternalApiCall, logInfo, logWarn } from '@/utils/logger';\nimport { db, Timestamp } from '@/lib/firebase';\nimport twilio from 'twilio';\n\n/**\n * Initialize Twilio client\n * Only runs in production or when explicitly enabled\n */\nfunction getTwilioClient() {\n  const accountSid = process.env.TWILIO_ACCOUNT_SID;\n  const authToken = process.env.TWILIO_AUTH_TOKEN;\n\n  if (!accountSid || !authToken) {\n    throw new Error('Twilio credentials not configured');\n  }\n\n  return twilio(accountSid, authToken);\n}\n\n/**\n * SMS Template Types\n */\nexport type SMSTemplate = 'gentle_reminder' | 'urgent_reminder' | 'final_notice' | 'payment_link';\n\n/**\n * Get SMS template text\n */\nfunction getSMSTemplate(\n  template: SMSTemplate,\n  params: {\n    invoiceReference: string;\n    amount: number;\n    dueDate: string;\n    paymentLink?: string;\n    businessName: string;\n  }\n): string {\n  const { invoiceReference, amount, dueDate, paymentLink, businessName } = params;\n\n  const templates = {\n    gentle_reminder: `Hi, this is a friendly reminder from ${businessName} about invoice ${invoiceReference} for £${amount.toFixed(2)}, due ${dueDate}. ${paymentLink ? `Pay now: ${paymentLink}` : 'Please arrange payment at your earliest convenience.'} Reply STOP to opt out.`,\n\n    urgent_reminder: `URGENT: Invoice ${invoiceReference} for £${amount.toFixed(2)} is now overdue (due ${dueDate}). ${paymentLink ? `Pay immediately: ${paymentLink}` : 'Please contact us urgently.'} - ${businessName}. Reply STOP to opt out.`,\n\n    final_notice: `FINAL NOTICE: Invoice ${invoiceReference} for £${amount.toFixed(2)} remains unpaid. This is your last reminder before further action. ${paymentLink ? `Pay now: ${paymentLink}` : 'Contact us immediately.'} - ${businessName}. Reply STOP to opt out.`,\n\n    payment_link: `${businessName}: Pay invoice ${invoiceReference} (£${amount.toFixed(2)}) securely: ${paymentLink}. Reply STOP to opt out.`,\n  };\n\n  return templates[template];\n}\n\n/**\n * Check if within UK quiet hours\n */\nfunction isQuietHours(): boolean {\n  const now = new Date();\n  const hour = now.getHours();\n\n  // Quiet hours: 21:00 (9 PM) to 08:00 (8 AM)\n  return hour >= 21 || hour < 8;\n}\n\n/**\n * Send SMS reminder for invoice collection\n *\n * @param params SMS parameters\n * @returns Twilio message SID or null if failed\n */\nexport async function sendCollectionSMS(params: {\n  recipientPhone: string; // E.164 format: +44xxxxxxxxxx\n  invoiceReference: string;\n  amount: number;\n  dueDate: string;\n  template: SMSTemplate;\n  paymentLink?: string;\n  businessName: string;\n  // Internal tracking\n  invoiceId: string;\n  freelancerId: string;\n}): Promise<{\n  success: boolean;\n  messageSid?: string;\n  error?: string;\n  status?: 'queued' | 'sent' | 'failed';\n}> {\n  const startTime = Date.now();\n\n  try {\n    // 1. Validate phone number format\n    if (!params.recipientPhone.startsWith('+44')) {\n      throw new Error('Only UK phone numbers supported (+44)');\n    }\n\n    // 2. Check if user has opted out (PECR compliance)\n    const userSnapshot = await db\n      .collection('users')\n      .where('phoneNumber', '==', params.recipientPhone)\n      .limit(1)\n      .get();\n\n    if (!userSnapshot.empty) {\n      const user = userSnapshot.docs[0].data();\n      if (user.collectionsConsent?.smsOptedOut) {\n        logWarn('SMS not sent: User has opted out', {\n          phone: params.recipientPhone,\n          optOutDate: user.collectionsConsent.smsOptOutDate,\n        });\n        return {\n          success: false,\n          error: 'User has opted out of SMS communications',\n        };\n      }\n    }\n\n    // 3. Check quiet hours\n    if (isQuietHours()) {\n      logError('SMS not sent: Quiet hours (21:00-08:00)', new Error('Quiet hours'), {\n        invoiceId: params.invoiceId,\n      });\n      return {\n        success: false,\n        error: 'Cannot send SMS during quiet hours (21:00-08:00)',\n      };\n    }\n\n    // 4. Get SMS text\n    const messageBody = getSMSTemplate(params.template, {\n      invoiceReference: params.invoiceReference,\n      amount: params.amount,\n      dueDate: params.dueDate,\n      paymentLink: params.paymentLink,\n      businessName: params.businessName,\n    });\n\n    // 4. Send via Twilio\n    const client = getTwilioClient();\n    const message = await client.messages.create({\n      body: messageBody,\n      from: process.env.TWILIO_PHONE_NUMBER,\n      to: params.recipientPhone,\n      // Status callback for delivery tracking\n      statusCallback: `${process.env.NEXT_PUBLIC_APP_URL}/api/webhooks/twilio/sms-status`,\n    });\n\n    const duration = Date.now() - startTime;\n    logExternalApiCall('Twilio SMS', 'send', duration);\n\n    return {\n      success: true,\n      messageSid: message.sid,\n      status: message.status as 'queued' | 'sent' | 'failed',\n    };\n\n  } catch (error) {\n    const duration = Date.now() - startTime;\n    logExternalApiCall('Twilio SMS', 'send', duration, error as Error);\n\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Unknown error',\n    };\n  }\n}\n\n/**\n * Get SMS delivery status from Twilio\n *\n * @param messageSid Twilio message SID\n * @returns Message status\n */\nexport async function getSMSStatus(messageSid: string): Promise<{\n  status: 'queued' | 'sending' | 'sent' | 'delivered' | 'undelivered' | 'failed';\n  errorCode?: string;\n  errorMessage?: string;\n}> {\n  try {\n    const client = getTwilioClient();\n    const message = await client.messages(messageSid).fetch();\n\n    return {\n      status: message.status as any,\n      errorCode: message.errorCode?.toString(),\n      errorMessage: message.errorMessage || undefined,\n    };\n  } catch (error) {\n    logError('Failed to fetch SMS status', error);\n    return {\n      status: 'failed',\n      errorMessage: error instanceof Error ? error.message : 'Unknown error',\n    };\n  }\n}\n\n/**\n * Handle SMS opt-out (STOP replies)\n *\n * This should be called from the Twilio webhook when a user replies STOP\n * UK law (PECR) requires honoring opt-out requests immediately\n *\n * PECR Requirement: Must stop sending marketing messages within 28 days\n * Best practice: Honor immediately\n */\nexport async function handleSMSOptOut(phoneNumber: string): Promise<{\n  success: boolean;\n  usersUpdated: number;\n  error?: string;\n}> {\n  try {\n    // Normalize phone number to E.164 format\n    const normalizedPhone = formatUKPhone(phoneNumber) || phoneNumber;\n\n    logInfo('Processing SMS opt-out request', { phoneNumber: normalizedPhone });\n\n    // Find all users with this phone number (could be multiple if phone shared)\n    const usersSnapshot = await db\n      .collection('users')\n      .where('phoneNumber', '==', normalizedPhone)\n      .get();\n\n    if (usersSnapshot.empty) {\n      logWarn('No users found for opt-out phone number', { phoneNumber: normalizedPhone });\n      return {\n        success: true,\n        usersUpdated: 0,\n      };\n    }\n\n    // Update all matching users\n    const batch = db.batch();\n    const now = Timestamp.now();\n\n    usersSnapshot.docs.forEach((doc) => {\n      batch.update(doc.ref, {\n        'collectionsConsent.smsConsent': false,\n        'collectionsConsent.smsOptedOut': true,\n        'collectionsConsent.smsOptOutDate': now,\n        updatedAt: now,\n      });\n    });\n\n    await batch.commit();\n\n    logInfo('SMS opt-out processed successfully', {\n      phoneNumber: normalizedPhone,\n      usersUpdated: usersSnapshot.size,\n    });\n\n    return {\n      success: true,\n      usersUpdated: usersSnapshot.size,\n    };\n  } catch (error: any) {\n    logError('Failed to process SMS opt-out', error, { phoneNumber });\n    return {\n      success: false,\n      usersUpdated: 0,\n      error: error.message,\n    };\n  }\n}\n\n/**\n * Validate phone number format\n */\nexport function isValidUKPhone(phone: string): boolean {\n  // Basic UK phone validation (E.164 format)\n  const ukPhoneRegex = /^\\+44[1-9]\\d{9,10}$/;\n  return ukPhoneRegex.test(phone);\n}\n\n/**\n * Format UK phone to E.164\n * Converts various UK formats to +44xxxxxxxxxx\n */\nexport function formatUKPhone(phone: string): string | null {\n  // Remove all spaces, dashes, parentheses\n  const cleaned = phone.replace(/[\\s\\-\\(\\)]/g, '');\n\n  // Convert 07xxx to +447xxx\n  if (cleaned.startsWith('07')) {\n    return '+44' + cleaned.substring(1);\n  }\n\n  // Convert 447xxx to +447xxx\n  if (cleaned.startsWith('447')) {\n    return '+' + cleaned;\n  }\n\n  // Already in E.164 format\n  if (cleaned.startsWith('+44')) {\n    return cleaned;\n  }\n\n  return null;\n}\n"],"names":[],"mappings":"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","ignoreList":[0]}