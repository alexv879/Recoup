module.exports=[4446,(e,t,o)=>{t.exports=e.x("net",()=>require("net"))},55004,(e,t,o)=>{t.exports=e.x("tls",()=>require("tls"))},874,(e,t,o)=>{t.exports=e.x("buffer",()=>require("buffer"))},23469,(e,t,o)=>{var r=e.r(874),n=r.Buffer;function s(e,t){for(var o in e)t[o]=e[o]}function i(e,t,o){return n(e,t,o)}n.from&&n.alloc&&n.allocUnsafe&&n.allocUnsafeSlow?t.exports=r:(s(r,o),o.Buffer=i),i.prototype=Object.create(n.prototype),s(n,i),i.from=function(e,t,o){if("number"==typeof e)throw TypeError("Argument must not be a number");return n(e,t,o)},i.alloc=function(e,t,o){if("number"!=typeof e)throw TypeError("Argument must be a number");var r=n(e);return void 0!==t?"string"==typeof o?r.fill(t,o):r.fill(t):r.fill(0),r},i.allocUnsafe=function(e){if("number"!=typeof e)throw TypeError("Argument must be a number");return n(e)},i.allocUnsafeSlow=function(e){if("number"!=typeof e)throw TypeError("Argument must be a number");return r.SlowBuffer(e)}},45706,(e,t,o)=>{t.exports=e.x("querystring",()=>require("querystring"))},81582,e=>e.a(async(t,o)=>{try{var r=e.i(69907),n=e.i(68253),s=e.i(55742),i=e.i(74461),a=t([n,s]);async function c(e){let t=Date.now();try{let o;if(!e.recipientPhone.startsWith("+44"))throw Error("Only UK phone numbers supported (+44)");let s=await n.db.collection("users").where("phoneNumber","==",e.recipientPhone).limit(1).get();if(!s.empty){let t=s.docs[0].data();if(t.collectionsConsent?.smsOptedOut)return(0,r.logWarn)("SMS not sent: User has opted out",{phone:e.recipientPhone,optOutDate:t.collectionsConsent.smsOptOutDate}),{success:!1,error:"User has opted out of SMS communications"}}if((o=new Date().getHours())>=21||o<8)return(0,r.logError)("SMS not sent: Quiet hours (21:00-08:00)",Error("Quiet hours"),{invoiceId:e.invoiceId}),{success:!1,error:"Cannot send SMS during quiet hours (21:00-08:00)"};let a=function(e,t){let{invoiceReference:o,amount:r,dueDate:n,paymentLink:s,businessName:i}=t;return({gentle_reminder:`Hi, this is a friendly reminder from ${i} about invoice ${o} for \xa3${r.toFixed(2)}, due ${n}. ${s?`Pay now: ${s}`:"Please arrange payment at your earliest convenience."} Reply STOP to opt out.`,urgent_reminder:`URGENT: Invoice ${o} for \xa3${r.toFixed(2)} is now overdue (due ${n}). ${s?`Pay immediately: ${s}`:"Please contact us urgently."} - ${i}. Reply STOP to opt out.`,final_notice:`FINAL NOTICE: Invoice ${o} for \xa3${r.toFixed(2)} remains unpaid. This is your last reminder before further action. ${s?`Pay now: ${s}`:"Contact us immediately."} - ${i}. Reply STOP to opt out.`,payment_link:`${i}: Pay invoice ${o} (\xa3${r.toFixed(2)}) securely: ${s}. Reply STOP to opt out.`})[e]}(e.template,{invoiceReference:e.invoiceReference,amount:e.amount,dueDate:e.dueDate,paymentLink:e.paymentLink,businessName:e.businessName}),c=function(){let e=process.env.TWILIO_ACCOUNT_SID,t=process.env.TWILIO_AUTH_TOKEN;if(!e||!t)throw Error("Twilio credentials not configured");return(0,i.default)(e,t)}(),l=await c.messages.create({body:a,from:process.env.TWILIO_PHONE_NUMBER,to:e.recipientPhone,statusCallback:`${process.env.NEXT_PUBLIC_APP_URL}/api/webhooks/twilio/sms-status`}),d=Date.now()-t;return(0,r.logExternalApiCall)("Twilio SMS","send",d),{success:!0,messageSid:l.sid,status:l.status}}catch(o){let e=Date.now()-t;return(0,r.logExternalApiCall)("Twilio SMS","send",e,o),{success:!1,error:o instanceof Error?o.message:"Unknown error"}}}async function l(e){try{let t=d(e)||e;(0,r.logInfo)("Processing SMS opt-out request",{phoneNumber:t});let o=await n.db.collection("users").where("phoneNumber","==",t).get();if(o.empty)return(0,r.logWarn)("No users found for opt-out phone number",{phoneNumber:t}),{success:!0,usersUpdated:0};let i=n.db.batch(),a=s.Timestamp.now();return o.docs.forEach(e=>{i.update(e.ref,{"collectionsConsent.smsConsent":!1,"collectionsConsent.smsOptedOut":!0,"collectionsConsent.smsOptOutDate":a,updatedAt:a})}),await i.commit(),(0,r.logInfo)("SMS opt-out processed successfully",{phoneNumber:t,usersUpdated:o.size}),{success:!0,usersUpdated:o.size}}catch(t){return(0,r.logError)("Failed to process SMS opt-out",t,{phoneNumber:e}),{success:!1,usersUpdated:0,error:t.message}}}function d(e){let t=e.replace(/[\s\-\(\)]/g,"");return t.startsWith("07")?"+44"+t.substring(1):t.startsWith("447")?"+"+t:t.startsWith("+44")?t:null}[n,s]=a.then?(await a)():a,e.s(["formatUKPhone",()=>d,"handleSMSOptOut",()=>l,"sendCollectionSMS",()=>c]),o()}catch(e){o(e)}},!1),15776,e=>{"use strict";var t=e.i(89171),o=e.i(15874);class r extends Error{statusCode;code;constructor(e,t,o){super(t),this.statusCode=e,this.code=o,this.name="ApiError"}}class n extends r{details;constructor(e,t){super(400,e,"VALIDATION_ERROR"),this.details=t}}class s extends r{constructor(e="Unauthorized"){super(401,e,"UNAUTHORIZED")}}class i extends r{constructor(e="Forbidden"){super(403,e,"FORBIDDEN")}}class a extends r{constructor(e="Not found"){super(404,e,"NOT_FOUND")}}class c extends r{retryAfter;constructor(e="Rate limit exceeded",t){super(429,e,"RATE_LIMIT"),this.retryAfter=t}}class l extends r{constructor(e="Internal server error"){super(500,e,"INTERNAL_ERROR")}}function d(e){if(e instanceof r){let o={error:e.code,message:e.message};return(e instanceof n&&e.details&&(o.details=e.details),e instanceof c&&e.retryAfter)?t.NextResponse.json(o,{status:e.statusCode,headers:{"Retry-After":e.retryAfter.toString()}}):t.NextResponse.json(o,{status:e.statusCode})}return e instanceof o.ZodError?t.NextResponse.json({error:"VALIDATION_ERROR",message:"Invalid request data",details:e.issues},{status:400}):(console.error("Unhandled error:",e),t.NextResponse.json({error:"INTERNAL_ERROR",message:"An unexpected error occurred"},{status:500}))}e.s(["NotFoundError",()=>a,"errors",0,{unauthorized:(e="Unauthorized")=>new s(e),forbidden:(e="Forbidden")=>new i(e),notFound:(e="Not found")=>new a(e),badRequest:e=>new n(e),internal:(e="Internal server error")=>new l(e),rateLimit:(e="Rate limit exceeded",t)=>new c(e,t)},"handleApiError",()=>d])},27356,e=>{"use strict";let t,o;var r=e.i(66680);function n(e=21){var s;s=e|=0,!t||t.length<s?(t=Buffer.allocUnsafe(128*s),r.webcrypto.getRandomValues(t),o=0):o+s>t.length&&(r.webcrypto.getRandomValues(t),o=0),o+=s;let i="";for(let r=o-e;r<o;r++)i+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&t[r]];return i}e.s(["nanoid",()=>n],27356)},25639,e=>{"use strict";e.s(["COLLECTIONS_DEMO_LIMIT_FREE",0,1,"COLLECTION_DAY_14_REMINDER",0,14,"COLLECTION_DAY_21_REMINDER",0,21,"COLLECTION_DAY_30_REMINDER",0,30,"COLLECTION_DAY_7_REMINDER",0,7,"PAYMENT_CONFIRMATION_TOKEN_EXPIRY_DAYS",0,30,"RELAY_COMMISSION_RATE",0,.03])},58026,e=>e.a(async(t,o)=>{try{var r=e.i(68253),n=e.i(55742),s=e.i(98941),i=e.i(81582),a=e.i(32530),c=e.i(15776),l=e.i(69907),d=e.i(27356),u=e.i(25639),f=t([r,n,i]);async function m(e){let t=Date.now(),o=await r.db.collection(r.COLLECTIONS.USERS).doc(e).get();if(!o.exists)throw new c.NotFoundError("User not found");let s=o.data();if("paid"===s.subscriptionTier)return{canUse:!0,remaining:-1,resetDate:new Date};let i=new Date,a=i.getMonth(),d=i.getFullYear(),f=new Date(d,a+1,1),m=s.collectionsDemoUsedThisMonth||0,p=s.lastDemoResetDate?.toDate(),I=m;if(p){let t=p.getMonth(),o=p.getFullYear();(t!==a||o!==d)&&(I=0,await r.db.collection(r.COLLECTIONS.USERS).doc(e).update({collectionsDemoUsedThisMonth:0,lastDemoResetDate:n.Timestamp.fromDate(new Date(d,a,1))}))}else await r.db.collection(r.COLLECTIONS.USERS).doc(e).update({collectionsDemoUsedThisMonth:0,lastDemoResetDate:n.Timestamp.fromDate(new Date(d,a,1))}),I=0;let E=Math.max(0,u.COLLECTIONS_DEMO_LIMIT_FREE-I),O=I<u.COLLECTIONS_DEMO_LIMIT_FREE;return(0,l.logDbOperation)("check_collections_quota",r.COLLECTIONS.USERS,e,Date.now()-t),{canUse:O,remaining:E,resetDate:f,reason:O?void 0:"Monthly collections limit reached. Upgrade to Premium for unlimited collections."}}async function p(e,t){let o=Date.now(),s=await r.db.collection(r.COLLECTIONS.INVOICES).doc(e).get();if(!s.exists)throw new c.NotFoundError("Invoice not found");let i=s.data();if(i.freelancerId!==t)throw new c.NotFoundError("Invoice not found");if(i.collectionsEnabled)throw Error("Collections already enabled for this invoice");let a=await m(t);if(!a.canUse)throw Error(a.reason||"Cannot enable collections");return await s.ref.update({collectionsEnabled:!0,collectionsEnabledAt:n.Timestamp.now(),updatedAt:n.Timestamp.now()}),await r.db.collection(r.COLLECTIONS.USERS).doc(t).update({collectionsDemoUsedThisMonth:n.FieldValue.increment(1)}),(0,l.logDbOperation)("enable_collections",r.COLLECTIONS.INVOICES,e,Date.now()-o),{...i,collectionsEnabled:!0}}async function I(){let e=Date.now(),t=n.Timestamp.now(),o=[],c=0,f=0;try{let m=await r.db.collection(r.COLLECTIONS.INVOICES).where("status","==","overdue").where("collectionsEnabled","==",!0).get();for(let e of((0,l.logInfo)("Processing overdue invoices for collections",{invoiceCount:m.size}),m.docs)){let m=e.data();try{let o=m.dueDate.toDate(),p=Math.floor((t.toDate().getTime()-o.getTime())/864e5);if((0,l.logInfo)("Invoice overdue check",{invoiceRef:m.reference,daysOverdue:p}),p>=u.COLLECTION_DAY_7_REMINDER&&!m.firstReminderSentAt){(0,l.logInfo)("Sending day 7 reminder",{invoiceRef:m.reference});let o=await r.db.collection(r.COLLECTIONS.USERS).doc(m.freelancerId).get(),i=o.exists&&o.data()?.fullName||"Freelancer";await (0,s.sendReminderDay7Email)({toEmail:m.clientEmail,freelancerName:i,invoiceReference:m.reference,amount:m.amount,currency:m.currency||"GBP",dueDate:m.dueDate.toDate(),daysOverdue:p}),await r.db.collection(r.COLLECTIONS.COLLECTION_ATTEMPTS).add({attemptId:(0,d.nanoid)(),invoiceId:m.invoiceId,freelancerId:m.freelancerId,attemptType:"email_reminder",attemptDate:t,attemptNumber:1,result:"success",createdAt:t}),await e.ref.update({firstReminderSentAt:t,collectionsAttempts:n.FieldValue.increment(1),updatedAt:t}),c++}if(p>=u.COLLECTION_DAY_14_REMINDER&&(await r.db.collection(r.COLLECTIONS.COLLECTION_ATTEMPTS).where("invoiceId","==",m.invoiceId).where("sms_day_14_sent","==",!0).limit(1).get()).empty){(0,l.logInfo)("Checking Day 14 SMS eligibility",{invoiceRef:m.reference});let e=await r.db.collection(r.COLLECTIONS.USERS).doc(m.freelancerId).get();if(e.exists){let o=e.data(),n=o.collectionsConsent?.smsConsent&&!o.collectionsConsent?.smsOptedOut,s="paid"===o.subscriptionTier;if(n&&s&&o.phoneNumber)try{let e=await (0,i.sendCollectionSMS)({recipientPhone:o.phoneNumber,invoiceReference:m.reference,amount:m.amount,dueDate:m.dueDate.toDate().toLocaleDateString("en-GB"),template:"urgent_reminder",paymentLink:m.stripePaymentLinkUrl,businessName:o.businessName||"Relay",invoiceId:m.invoiceId,freelancerId:m.freelancerId});e.success?(await r.db.collection(r.COLLECTIONS.COLLECTION_ATTEMPTS).add({attemptId:(0,d.nanoid)(),invoiceId:m.invoiceId,freelancerId:m.freelancerId,attemptType:"sms_reminder",attemptDate:t,attemptNumber:2,result:"success",sms_day_14_sent:!0,sms_day_14_sid:e.messageSid,sms_day_14_sent_at:t,createdAt:t}),(0,l.logInfo)("SMS Day 14 sent successfully",{invoiceRef:m.reference,messageSid:e.messageSid})):(0,l.logError)("SMS Day 14 failed",Error(e.error||"Unknown error"),{invoiceRef:m.reference})}catch(e){(0,l.logError)("SMS Day 14 exception",e,{invoiceRef:m.reference})}else(0,l.logInfo)("SMS Day 14 skipped - no consent or not paid tier",{invoiceRef:m.reference,hasConsent:n,isPaidUser:s,hasPhone:!!o.phoneNumber})}else(0,l.logError)("User not found for SMS",Error("User not found"),{userId:m.freelancerId})}if(p>=u.COLLECTION_DAY_21_REMINDER&&!m.secondReminderSentAt){(0,l.logInfo)("Sending day 21 reminder",{invoiceRef:m.reference});let o=await r.db.collection(r.COLLECTIONS.USERS).doc(m.freelancerId).get(),i=o.exists&&o.data()?.fullName||"Freelancer";await (0,s.sendReminderDay21Email)({toEmail:m.clientEmail,freelancerName:i,invoiceReference:m.reference,amount:m.amount,currency:m.currency||"GBP",dueDate:m.dueDate.toDate(),daysOverdue:p}),await r.db.collection(r.COLLECTIONS.COLLECTION_ATTEMPTS).add({attemptId:(0,d.nanoid)(),invoiceId:m.invoiceId,freelancerId:m.freelancerId,attemptType:"email_reminder",attemptDate:t,attemptNumber:2,result:"success",createdAt:t}),await e.ref.update({secondReminderSentAt:t,collectionsAttempts:n.FieldValue.increment(1),updatedAt:t,status:"in_collections"}),f++}if(p>=u.COLLECTION_DAY_30_REMINDER&&(await r.db.collection(r.COLLECTIONS.COLLECTION_ATTEMPTS).where("invoiceId","==",m.invoiceId).where("letter_day_30_sent","==",!0).limit(1).get()).empty){(0,l.logInfo)("Checking Day 30 Letter eligibility",{invoiceRef:m.reference});let e=await r.db.collection(r.COLLECTIONS.USERS).doc(m.freelancerId).get();if(e.exists){let o=e.data(),n=o.collectionsConsent?.physicalMailConsent&&!o.collectionsConsent?.physicalMailOptedOut,s="paid"===o.subscriptionTier,i=!!o.businessAddress;if(i)if(n&&s&&o.businessAddress)try{let e=await (0,a.sendCollectionLetter)({recipient:{recipientName:m.clientName,line1:o.businessAddress.addressLine1,line2:o.businessAddress.addressLine2,city:o.businessAddress.city,postcode:o.businessAddress.postcode,country:"GB"},invoiceReference:m.reference,amount:m.amount,dueDate:m.dueDate.toDate().toLocaleDateString("en-GB"),daysPastDue:p,invoiceDate:m.invoiceDate.toDate().toLocaleDateString("en-GB"),template:"final_warning",businessName:o.businessName||"Relay",businessAddress:`${o.businessAddress.addressLine1}
${o.businessAddress.addressLine2||""}
${o.businessAddress.city}
${o.businessAddress.postcode}`,invoiceId:m.invoiceId,freelancerId:m.freelancerId});e.success?(await r.db.collection(r.COLLECTIONS.COLLECTION_ATTEMPTS).add({attemptId:(0,d.nanoid)(),invoiceId:m.invoiceId,freelancerId:m.freelancerId,attemptType:"physical_letter",attemptDate:t,attemptNumber:3,result:"success",letter_day_30_sent:!0,letter_day_30_lob_id:e.letterId,letter_day_30_sent_at:t,letterTrackingUrl:e.trackingUrl,createdAt:t}),(0,l.logInfo)("Letter Day 30 sent successfully",{invoiceRef:m.reference,letterId:e.letterId})):(0,l.logError)("Letter Day 30 failed",Error(e.error||"Unknown error"),{invoiceRef:m.reference})}catch(e){(0,l.logError)("Letter Day 30 exception",e,{invoiceRef:m.reference})}else(0,l.logInfo)("Letter Day 30 skipped - no consent or not paid tier",{invoiceRef:m.reference,hasConsent:n,isPaidUser:s,hasAddress:i});else(0,l.logInfo)("Day 30 Letter skipped - no business address",{invoiceRef:m.reference})}else(0,l.logError)("User not found for letter",Error("User not found"),{userId:m.freelancerId})}}catch(t){let e=`Failed to process invoice ${m.reference}: ${t instanceof Error?t.message:"Unknown error"}`;(0,l.logError)(e,t),o.push(e)}}return(0,l.logDbOperation)("process_collections",r.COLLECTIONS.INVOICES,void 0,Date.now()-e),(0,l.logInfo)("Collections processing complete",{day7Count:c,day21Count:f}),{day7Count:c,day21Count:f,errors:o}}catch(e){throw(0,l.logError)("Collections processing failed",e),e}}async function E(e,t){let o=Date.now(),n=await r.db.collection(r.COLLECTIONS.INVOICES).doc(e).get();if(!n.exists||n.data().freelancerId!==t)throw new c.NotFoundError("Invoice not found");let s=await r.db.collection(r.COLLECTIONS.COLLECTION_ATTEMPTS).where("invoiceId","==",e).orderBy("sentAt","desc").get();return(0,l.logDbOperation)("get_collections_history",r.COLLECTIONS.COLLECTION_ATTEMPTS,void 0,Date.now()-o),s.docs.map(e=>e.data())}async function O(e,t){let o=Date.now(),s=await r.db.collection(r.COLLECTIONS.INVOICES).doc(e).get();if(!s.exists)throw new c.NotFoundError("Invoice not found");let i=s.data();if(i.freelancerId!==t)throw new c.NotFoundError("Invoice not found");return await s.ref.update({collectionsEnabled:!1,updatedAt:n.Timestamp.now()}),(0,l.logDbOperation)("disable_collections",r.COLLECTIONS.INVOICES,e,Date.now()-o),{...i,collectionsEnabled:!1}}[r,n,i]=f.then?(await f)():f,e.s(["canUseCollectionsDemo",()=>m,"disableCollections",()=>O,"enableCollections",()=>p,"getCollectionsHistory",()=>E,"processCollections",()=>I]),o()}catch(e){o(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__17e48bea._.js.map