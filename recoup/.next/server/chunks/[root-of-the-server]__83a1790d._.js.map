{"version":3,"sources":["turbopack:///[project]/node_modules/next/package.json","../../../middleware/premiumGating.ts","../../../services/consentService.ts"],"sourcesContent":["{\"name\":\"next\",\"version\":\"16.0.3\",\"description\":\"The React Framework\",\"main\":\"./dist/server/next.js\",\"license\":\"MIT\",\"repository\":\"vercel/next.js\",\"bugs\":\"https://github.com/vercel/next.js/issues\",\"homepage\":\"https://nextjs.org\",\"types\":\"index.d.ts\",\"files\":[\"dist\",\"app.js\",\"app.d.ts\",\"babel.js\",\"babel.d.ts\",\"client.js\",\"client.d.ts\",\"compat\",\"cache.js\",\"cache.d.ts\",\"constants.js\",\"constants.d.ts\",\"document.js\",\"document.d.ts\",\"dynamic.js\",\"dynamic.d.ts\",\"error.js\",\"error.d.ts\",\"future\",\"legacy\",\"script.js\",\"script.d.ts\",\"server.js\",\"server.d.ts\",\"head.js\",\"head.d.ts\",\"image.js\",\"image.d.ts\",\"link.js\",\"link.d.ts\",\"form.js\",\"form.d.ts\",\"router.js\",\"router.d.ts\",\"jest.js\",\"jest.d.ts\",\"og.js\",\"og.d.ts\",\"root-params.js\",\"root-params.d.ts\",\"types.d.ts\",\"types.js\",\"index.d.ts\",\"types/global.d.ts\",\"types/compiled.d.ts\",\"image-types/global.d.ts\",\"navigation-types/navigation.d.ts\",\"navigation-types/compat/navigation.d.ts\",\"font\",\"navigation.js\",\"navigation.d.ts\",\"headers.js\",\"headers.d.ts\",\"navigation-types\",\"web-vitals.js\",\"web-vitals.d.ts\",\"experimental/testing/server.js\",\"experimental/testing/server.d.ts\",\"experimental/testmode/playwright.js\",\"experimental/testmode/playwright.d.ts\",\"experimental/testmode/playwright/msw.js\",\"experimental/testmode/playwright/msw.d.ts\",\"experimental/testmode/proxy.js\",\"experimental/testmode/proxy.d.ts\"],\"bin\":{\"next\":\"./dist/bin/next\"},\"scripts\":{\"dev\":\"cross-env NEXT_SERVER_NO_MANGLE=1 taskr\",\"release\":\"taskr release\",\"build\":\"pnpm release\",\"prepublishOnly\":\"cd ../../ && turbo run build\",\"types\":\"tsc --project tsconfig.build.json --declaration --emitDeclarationOnly --stripInternal --declarationDir dist\",\"typescript\":\"tsec --noEmit\",\"ncc-compiled\":\"taskr ncc\",\"storybook\":\"BROWSER=none storybook dev -p 6006\",\"build-storybook\":\"storybook build\",\"test-storybook\":\"test-storybook\"},\"taskr\":{\"requires\":[\"./taskfile-webpack.js\",\"./taskfile-ncc.js\",\"./taskfile-swc.js\",\"./taskfile-watch.js\"]},\"dependencies\":{\"@next/env\":\"16.0.3\",\"@swc/helpers\":\"0.5.15\",\"caniuse-lite\":\"^1.0.30001579\",\"postcss\":\"8.4.31\",\"styled-jsx\":\"5.1.6\"},\"peerDependencies\":{\"@opentelemetry/api\":\"^1.1.0\",\"@playwright/test\":\"^1.51.1\",\"babel-plugin-react-compiler\":\"*\",\"react\":\"^18.2.0 || 19.0.0-rc-de68d2f4-20241204 || ^19.0.0\",\"react-dom\":\"^18.2.0 || 19.0.0-rc-de68d2f4-20241204 || ^19.0.0\",\"sass\":\"^1.3.0\"},\"peerDependenciesMeta\":{\"babel-plugin-react-compiler\":{\"optional\":true},\"sass\":{\"optional\":true},\"@opentelemetry/api\":{\"optional\":true},\"@playwright/test\":{\"optional\":true}},\"optionalDependencies\":{\"sharp\":\"^0.34.4\",\"@next/swc-darwin-arm64\":\"16.0.3\",\"@next/swc-darwin-x64\":\"16.0.3\",\"@next/swc-linux-arm64-gnu\":\"16.0.3\",\"@next/swc-linux-arm64-musl\":\"16.0.3\",\"@next/swc-linux-x64-gnu\":\"16.0.3\",\"@next/swc-linux-x64-musl\":\"16.0.3\",\"@next/swc-win32-arm64-msvc\":\"16.0.3\",\"@next/swc-win32-x64-msvc\":\"16.0.3\"},\"devDependencies\":{\"@babel/code-frame\":\"7.26.2\",\"@babel/core\":\"7.26.10\",\"@babel/eslint-parser\":\"7.24.6\",\"@babel/generator\":\"7.27.0\",\"@babel/plugin-syntax-bigint\":\"7.8.3\",\"@babel/plugin-syntax-dynamic-import\":\"7.8.3\",\"@babel/plugin-syntax-import-attributes\":\"7.26.0\",\"@babel/plugin-syntax-jsx\":\"7.25.9\",\"@babel/plugin-syntax-typescript\":\"7.25.4\",\"@babel/plugin-transform-class-properties\":\"7.25.9\",\"@babel/plugin-transform-export-namespace-from\":\"7.25.9\",\"@babel/plugin-transform-modules-commonjs\":\"7.26.3\",\"@babel/plugin-transform-numeric-separator\":\"7.25.9\",\"@babel/plugin-transform-object-rest-spread\":\"7.25.9\",\"@babel/plugin-transform-runtime\":\"7.26.10\",\"@babel/preset-env\":\"7.26.9\",\"@babel/preset-react\":\"7.26.3\",\"@babel/preset-typescript\":\"7.27.0\",\"@babel/runtime\":\"7.27.0\",\"@babel/traverse\":\"7.27.0\",\"@babel/types\":\"7.27.0\",\"@base-ui-components/react\":\"1.0.0-beta.2\",\"@capsizecss/metrics\":\"3.4.0\",\"@edge-runtime/cookies\":\"6.0.0\",\"@edge-runtime/ponyfill\":\"4.0.0\",\"@edge-runtime/primitives\":\"6.0.0\",\"@hapi/accept\":\"5.0.2\",\"@jest/transform\":\"29.5.0\",\"@jest/types\":\"29.5.0\",\"@modelcontextprotocol/sdk\":\"1.18.1\",\"@mswjs/interceptors\":\"0.23.0\",\"@napi-rs/triples\":\"1.2.0\",\"@next/font\":\"16.0.3\",\"@next/polyfill-module\":\"16.0.3\",\"@next/polyfill-nomodule\":\"16.0.3\",\"@next/react-refresh-utils\":\"16.0.3\",\"@next/swc\":\"16.0.3\",\"@opentelemetry/api\":\"1.6.0\",\"@playwright/test\":\"1.51.1\",\"@rspack/core\":\"1.6.0\",\"@storybook/addon-a11y\":\"8.6.0\",\"@storybook/addon-essentials\":\"8.6.0\",\"@storybook/addon-interactions\":\"8.6.0\",\"@storybook/addon-webpack5-compiler-swc\":\"3.0.0\",\"@storybook/blocks\":\"8.6.0\",\"@storybook/react\":\"8.6.0\",\"@storybook/react-webpack5\":\"8.6.0\",\"@storybook/test\":\"8.6.0\",\"@storybook/test-runner\":\"0.21.0\",\"@swc/core\":\"1.11.24\",\"@swc/types\":\"0.1.7\",\"@taskr/clear\":\"1.1.0\",\"@taskr/esnext\":\"1.1.0\",\"@types/babel__code-frame\":\"7.0.6\",\"@types/babel__core\":\"7.20.5\",\"@types/babel__generator\":\"7.27.0\",\"@types/babel__template\":\"7.4.4\",\"@types/babel__traverse\":\"7.20.7\",\"@types/bytes\":\"3.1.1\",\"@types/ci-info\":\"2.0.0\",\"@types/compression\":\"0.0.36\",\"@types/content-disposition\":\"0.5.4\",\"@types/content-type\":\"1.1.3\",\"@types/cookie\":\"0.3.3\",\"@types/cross-spawn\":\"6.0.0\",\"@types/debug\":\"4.1.5\",\"@types/express-serve-static-core\":\"4.17.33\",\"@types/fresh\":\"0.5.0\",\"@types/glob\":\"7.1.1\",\"@types/jsonwebtoken\":\"9.0.0\",\"@types/lodash\":\"4.14.198\",\"@types/lodash.curry\":\"4.1.6\",\"@types/path-to-regexp\":\"1.7.0\",\"@types/picomatch\":\"2.3.3\",\"@types/platform\":\"1.3.4\",\"@types/react\":\"19.0.8\",\"@types/react-dom\":\"19.0.3\",\"@types/react-is\":\"18.2.4\",\"@types/semver\":\"7.3.1\",\"@types/send\":\"0.14.4\",\"@types/shell-quote\":\"1.7.1\",\"@types/tar\":\"6.1.5\",\"@types/text-table\":\"0.2.1\",\"@types/ua-parser-js\":\"0.7.36\",\"@types/webpack-sources1\":\"npm:@types/webpack-sources@0.1.5\",\"@types/ws\":\"8.2.0\",\"@vercel/ncc\":\"0.34.0\",\"@vercel/nft\":\"0.27.1\",\"@vercel/routing-utils\":\"5.2.0\",\"@vercel/turbopack-ecmascript-runtime\":\"*\",\"acorn\":\"8.14.0\",\"anser\":\"1.4.9\",\"arg\":\"4.1.0\",\"assert\":\"2.0.0\",\"async-retry\":\"1.2.3\",\"async-sema\":\"3.0.0\",\"axe-playwright\":\"2.0.3\",\"babel-loader\":\"10.0.0\",\"babel-plugin-react-compiler\":\"0.0.0-experimental-3fde738-20250918\",\"babel-plugin-transform-define\":\"2.0.0\",\"babel-plugin-transform-react-remove-prop-types\":\"0.4.24\",\"browserify-zlib\":\"0.2.0\",\"browserslist\":\"4.26.2\",\"buffer\":\"5.6.0\",\"busboy\":\"1.6.0\",\"bytes\":\"3.1.1\",\"ci-info\":\"watson/ci-info#f43f6a1cefff47fb361c88cf4b943fdbcaafe540\",\"cli-select\":\"1.1.2\",\"client-only\":\"0.0.1\",\"commander\":\"12.1.0\",\"comment-json\":\"3.0.3\",\"compression\":\"1.7.4\",\"conf\":\"5.0.0\",\"constants-browserify\":\"1.0.0\",\"content-disposition\":\"0.5.3\",\"content-type\":\"1.0.4\",\"cookie\":\"0.4.1\",\"cross-env\":\"6.0.3\",\"cross-spawn\":\"7.0.3\",\"crypto-browserify\":\"3.12.0\",\"css-loader\":\"7.1.2\",\"css.escape\":\"1.5.1\",\"cssnano-preset-default\":\"7.0.6\",\"data-uri-to-buffer\":\"3.0.1\",\"debug\":\"4.1.1\",\"devalue\":\"2.0.1\",\"domain-browser\":\"4.19.0\",\"edge-runtime\":\"4.0.1\",\"events\":\"3.3.0\",\"find-up\":\"4.1.0\",\"fresh\":\"0.5.2\",\"glob\":\"7.1.7\",\"gzip-size\":\"5.1.1\",\"http-proxy\":\"1.18.1\",\"http-proxy-agent\":\"5.0.0\",\"https-browserify\":\"1.0.0\",\"https-proxy-agent\":\"5.0.1\",\"icss-utils\":\"5.1.0\",\"ignore-loader\":\"0.1.2\",\"image-size\":\"1.2.1\",\"ipaddr.js\":\"2.2.0\",\"is-docker\":\"2.0.0\",\"is-wsl\":\"2.2.0\",\"jest-worker\":\"27.5.1\",\"json5\":\"2.2.3\",\"jsonwebtoken\":\"9.0.0\",\"loader-runner\":\"4.3.0\",\"loader-utils2\":\"npm:loader-utils@2.0.4\",\"loader-utils3\":\"npm:loader-utils@3.1.3\",\"lodash.curry\":\"4.1.1\",\"mini-css-extract-plugin\":\"2.4.4\",\"msw\":\"2.3.0\",\"nanoid\":\"3.1.32\",\"native-url\":\"0.3.4\",\"neo-async\":\"2.6.1\",\"node-html-parser\":\"5.3.3\",\"ora\":\"4.0.4\",\"os-browserify\":\"0.3.0\",\"p-limit\":\"3.1.0\",\"p-queue\":\"6.6.2\",\"path-browserify\":\"1.0.1\",\"path-to-regexp\":\"6.3.0\",\"picomatch\":\"4.0.1\",\"postcss-flexbugs-fixes\":\"5.0.2\",\"postcss-modules-extract-imports\":\"3.0.0\",\"postcss-modules-local-by-default\":\"4.2.0\",\"postcss-modules-scope\":\"3.0.0\",\"postcss-modules-values\":\"4.0.0\",\"postcss-preset-env\":\"7.4.3\",\"postcss-safe-parser\":\"6.0.0\",\"postcss-scss\":\"4.0.3\",\"postcss-value-parser\":\"4.2.0\",\"process\":\"0.11.10\",\"punycode\":\"2.1.1\",\"querystring-es3\":\"0.2.1\",\"raw-body\":\"2.4.1\",\"react-refresh\":\"0.12.0\",\"recast\":\"0.23.11\",\"regenerator-runtime\":\"0.13.4\",\"safe-stable-stringify\":\"2.5.0\",\"sass-loader\":\"16.0.5\",\"schema-utils2\":\"npm:schema-utils@2.7.1\",\"schema-utils3\":\"npm:schema-utils@3.0.0\",\"semver\":\"7.3.2\",\"send\":\"0.18.0\",\"server-only\":\"0.0.1\",\"setimmediate\":\"1.0.5\",\"shell-quote\":\"1.7.3\",\"source-map\":\"0.6.1\",\"source-map-loader\":\"5.0.0\",\"source-map08\":\"npm:source-map@0.8.0-beta.0\",\"stacktrace-parser\":\"0.1.10\",\"storybook\":\"8.6.0\",\"stream-browserify\":\"3.0.0\",\"stream-http\":\"3.1.1\",\"strict-event-emitter\":\"0.5.0\",\"string-hash\":\"1.1.3\",\"string_decoder\":\"1.3.0\",\"strip-ansi\":\"6.0.0\",\"style-loader\":\"4.0.0\",\"superstruct\":\"1.0.3\",\"tar\":\"6.1.15\",\"taskr\":\"1.1.0\",\"terser\":\"5.27.0\",\"terser-webpack-plugin\":\"5.3.9\",\"text-table\":\"0.2.0\",\"timers-browserify\":\"2.0.12\",\"tty-browserify\":\"0.0.1\",\"typescript\":\"5.9.2\",\"ua-parser-js\":\"1.0.35\",\"unistore\":\"3.4.1\",\"util\":\"0.12.4\",\"vm-browserify\":\"1.1.2\",\"watchpack\":\"2.4.0\",\"web-vitals\":\"4.2.1\",\"webpack\":\"5.98.0\",\"webpack-sources1\":\"npm:webpack-sources@1.4.3\",\"webpack-sources3\":\"npm:webpack-sources@3.2.3\",\"ws\":\"8.2.3\",\"zod\":\"3.25.76\",\"zod-validation-error\":\"3.4.0\"},\"keywords\":[\"react\",\"framework\",\"nextjs\",\"web\",\"server\",\"node\",\"front-end\",\"backend\",\"cli\",\"vercel\"],\"engines\":{\"node\":\">=20.9.0\"}}","/**\n * Premium Feature Gating Middleware\n * Controls access to premium features based on user subscription\n */\n\nimport { NextRequest, NextResponse } from 'next/server';\n\nexport interface PremiumFeature {\n    name: string;\n    description: string;\n    monthlyLimit?: number;\n    requiresUpgrade: boolean;\n}\n\nexport interface PremiumAccessResult {\n    hasAccess: boolean;\n    isPremium: boolean;\n    remainingUses?: number;\n    upgradeRequired: boolean;\n    error?: string;\n}\n\n/**\n * Check if user has access to premium feature\n * This is a placeholder - in production, integrate with payment provider\n */\nexport async function requirePremiumAccess(\n    userId: string,\n    feature: string\n): Promise<PremiumAccessResult> {\n    try {\n        // Placeholder implementation\n        // In production, check subscription status from database/payment provider\n\n        console.log(`Checking premium access for user ${userId}, feature: ${feature}`);\n\n        // Simulate premium check\n        const isPremium = Math.random() > 0.5; // Random for demo\n\n        if (isPremium) {\n            return {\n                hasAccess: true,\n                isPremium: true,\n                remainingUses: 100, // Unlimited for premium\n                upgradeRequired: false,\n            };\n        } else {\n            return {\n                hasAccess: false,\n                isPremium: false,\n                upgradeRequired: true,\n                error: 'Premium subscription required for this feature',\n            };\n        }\n    } catch (error) {\n        console.error('Premium access check failed:', error);\n        return {\n            hasAccess: false,\n            isPremium: false,\n            upgradeRequired: true,\n            error: 'Unable to verify premium access',\n        };\n    }\n}\n\n/**\n * Log premium feature usage for analytics\n */\nexport async function logPremiumFeatureUsage(params: {\n    userId: string;\n    feature: string;\n    invoiceId?: string;\n    cost?: number;\n}): Promise<void> {\n    try {\n        console.log('Logging premium feature usage:', params);\n        // In production, log to analytics database\n    } catch (error) {\n        console.error('Failed to log premium feature usage:', error);\n    }\n}","/**\n * CONSENT MANAGEMENT SERVICE\n *\n * Handles user consent for premium collections features.\n * Ensures GDPR and UK Communications Law compliance.\n *\n * UK Legal Requirements:\n * - GDPR: Explicit consent required for processing personal data\n * - Privacy and Electronic Communications Regulations (PECR): Consent for SMS/calls\n * - Recording calls: Must inform and get consent\n * - Data retention: Must honor data deletion requests\n * - Opt-out: Must honor immediately\n *\n * Consent Types:\n * 1. SMS Consent: Receiving SMS collection reminders\n * 2. Call Consent: Receiving AI voice collection calls\n * 3. Call Recording Consent: Recording and storing call audio\n * 4. Physical Mail Consent: Sending physical letters\n * 5. Data Storage Consent: Storing transcripts/recordings\n */\n\nimport { db, FieldValue } from '@/lib/firebase';\nimport { User } from '@/types/models';\nimport { logError, logInfo } from '@/utils/logger';\n\n/**\n * Consent types\n */\nexport type ConsentType =\n  | 'sms'\n  | 'call'\n  | 'call_recording'\n  | 'physical_mail'\n  | 'data_storage';\n\n/**\n * Current consent version\n * Increment when terms change to require re-consent\n */\nconst CURRENT_CONSENT_VERSION = 'v1.0.0';\n\n/**\n * Get user's current consent status\n */\nexport async function getUserConsent(userId: string): Promise<{\n  smsConsent: boolean;\n  callConsent: boolean;\n  callRecordingConsent: boolean;\n  physicalMailConsent: boolean;\n  dataStorageConsent: boolean;\n  consentDate?: Date;\n  consentVersion?: string;\n  needsUpdate: boolean;\n} | null> {\n  try {\n    const userDoc = await db.collection('users').doc(userId).get();\n\n    if (!userDoc.exists) {\n      return null;\n    }\n\n    const user = userDoc.data() as User;\n    const consent = user.collectionsConsent;\n\n    // Check if consent exists and is current version\n    const needsUpdate = !consent ||\n      !consent.consentVersion ||\n      consent.consentVersion !== CURRENT_CONSENT_VERSION;\n\n    return {\n      smsConsent: consent?.smsConsent || false,\n      callConsent: consent?.callConsent || false,\n      callRecordingConsent: consent?.callRecordingConsent || false,\n      physicalMailConsent: consent?.physicalMailConsent || false,\n      dataStorageConsent: consent?.dataStorageConsent || false,\n      consentDate: consent?.consentDate?.toDate(),\n      consentVersion: consent?.consentVersion,\n      needsUpdate,\n    };\n\n  } catch (error) {\n    logError('Failed to get user consent', error);\n    return null;\n  }\n}\n\n/**\n * Update user consent\n */\nexport async function updateUserConsent(params: {\n  userId: string;\n  smsConsent: boolean;\n  callConsent: boolean;\n  callRecordingConsent: boolean;\n  physicalMailConsent: boolean;\n  dataStorageConsent: boolean;\n  ipAddress?: string;\n}): Promise<{ success: boolean; error?: string }> {\n  try {\n    const userRef = db.collection('users').doc(params.userId);\n    const userDoc = await userRef.get();\n\n    if (!userDoc.exists) {\n      return { success: false, error: 'User not found' };\n    }\n\n    // Update consent\n    await userRef.update({\n      'collectionsConsent.smsConsent': params.smsConsent,\n      'collectionsConsent.callConsent': params.callConsent,\n      'collectionsConsent.callRecordingConsent': params.callRecordingConsent,\n      'collectionsConsent.physicalMailConsent': params.physicalMailConsent,\n      'collectionsConsent.dataStorageConsent': params.dataStorageConsent,\n      'collectionsConsent.consentDate': FieldValue.serverTimestamp(),\n      'collectionsConsent.consentVersion': CURRENT_CONSENT_VERSION,\n      'collectionsConsent.ipAddress': params.ipAddress,\n      updatedAt: FieldValue.serverTimestamp(),\n    });\n\n    // Log consent change for audit trail\n    await db.collection('consent_audit_log').add({\n      userId: params.userId,\n      smsConsent: params.smsConsent,\n      callConsent: params.callConsent,\n      callRecordingConsent: params.callRecordingConsent,\n      physicalMailConsent: params.physicalMailConsent,\n      dataStorageConsent: params.dataStorageConsent,\n      consentVersion: CURRENT_CONSENT_VERSION,\n      ipAddress: params.ipAddress,\n      timestamp: FieldValue.serverTimestamp(),\n    });\n\n    logInfo('User consent updated', { userId: params.userId });\n\n    return { success: true };\n\n  } catch (error) {\n    logError('Failed to update user consent', error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Unknown error',\n    };\n  }\n}\n\n/**\n * Check if user has given specific consent\n */\nexport async function checkConsent(\n  userId: string,\n  consentType: ConsentType\n): Promise<boolean> {\n  try {\n    const consent = await getUserConsent(userId);\n\n    if (!consent) {\n      return false;\n    }\n\n    // Map consent type to field\n    switch (consentType) {\n      case 'sms':\n        return consent.smsConsent;\n      case 'call':\n        return consent.callConsent;\n      case 'call_recording':\n        return consent.callRecordingConsent;\n      case 'physical_mail':\n        return consent.physicalMailConsent;\n      case 'data_storage':\n        return consent.dataStorageConsent;\n      default:\n        return false;\n    }\n\n  } catch (error) {\n    logError('Failed to check consent', error);\n    return false;\n  }\n}\n\n/**\n * Revoke specific consent (opt-out)\n */\nexport async function revokeConsent(\n  userId: string,\n  consentType: ConsentType\n): Promise<{ success: boolean; error?: string }> {\n  try {\n    const userRef = db.collection('users').doc(userId);\n\n    const updateField = `collectionsConsent.${getConsentFieldName(consentType)}`;\n\n    await userRef.update({\n      [updateField]: false,\n      updatedAt: FieldValue.serverTimestamp(),\n    });\n\n    // Log revocation\n    await db.collection('consent_audit_log').add({\n      userId,\n      action: 'revoke',\n      consentType,\n      timestamp: FieldValue.serverTimestamp(),\n    });\n\n    logInfo('Consent revoked', { userId, consentType });\n\n    return { success: true };\n\n  } catch (error) {\n    logError('Failed to revoke consent', error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Unknown error',\n    };\n  }\n}\n\n/**\n * Request data deletion (GDPR Right to Erasure)\n * Deletes all recordings, transcripts, and personal data\n */\nexport async function requestDataDeletion(userId: string): Promise<{\n  success: boolean;\n  error?: string;\n}> {\n  try {\n    // 1. Revoke all consents\n    await db.collection('users').doc(userId).update({\n      'collectionsConsent.smsConsent': false,\n      'collectionsConsent.callConsent': false,\n      'collectionsConsent.callRecordingConsent': false,\n      'collectionsConsent.physicalMailConsent': false,\n      'collectionsConsent.dataStorageConsent': false,\n      updatedAt: FieldValue.serverTimestamp(),\n    });\n\n    // 2. Mark collection attempts for deletion\n    const attempts = await db\n      .collection('collection_attempts')\n      .where('freelancerId', '==', userId)\n      .get();\n\n    const batch = db.batch();\n\n    attempts.docs.forEach(doc => {\n      // Delete recording URLs and transcripts\n      batch.update(doc.ref, {\n        callRecordingUrl: FieldValue.delete(),\n        callTranscript: FieldValue.delete(),\n        callNotes: FieldValue.delete(),\n        updatedAt: FieldValue.serverTimestamp(),\n      });\n    });\n\n    await batch.commit();\n\n    // 3. Log deletion request\n    await db.collection('data_deletion_requests').add({\n      userId,\n      requestDate: FieldValue.serverTimestamp(),\n      status: 'completed',\n      itemsDeleted: attempts.size,\n    });\n\n    // AUDIT TASK #7: Delete files from Firebase Storage (GDPR compliance)\n    try {\n      // Import storage utilities\n      const { listHandoffDocuments, deleteDocument } = await import('@/lib/firebase-storage');\n\n      // Find all handoffs for this user to get document references\n      const handoffsSnapshot = await db\n        .collection('agency_handoffs')\n        .where('freelancerId', '==', userId)\n        .get();\n\n      let filesDeleted = 0;\n\n      for (const handoffDoc of handoffsSnapshot.docs) {\n        const handoffId = handoffDoc.id;\n\n        // List all documents for this handoff\n        const docsResult = await listHandoffDocuments(handoffId, userId);\n\n        if (docsResult.success && docsResult.documents) {\n          // Delete each document\n          for (const doc of docsResult.documents) {\n            const deleteResult = await deleteDocument(doc.storagePath);\n            if (deleteResult.success) {\n              filesDeleted++;\n            }\n          }\n        }\n      }\n\n      logInfo('Cloud storage files deleted', {\n        userId,\n        filesDeleted,\n        handoffsProcessed: handoffsSnapshot.size,\n      });\n\n    } catch (storageError) {\n      logError('Failed to delete cloud storage files', storageError);\n      // Continue - file deletion failure shouldn't block the consent removal\n      // Files will have 30-day TTL and be automatically cleaned up\n    }\n\n    logInfo('Data deletion completed', { userId, itemsDeleted: attempts.size });\n\n    return { success: true };\n\n  } catch (error) {\n    logError('Failed to delete user data', error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Unknown error',\n    };\n  }\n}\n\n/**\n * Export user data (GDPR Right to Data Portability)\n */\nexport async function exportUserData(userId: string): Promise<{\n  success: boolean;\n  data?: any;\n  error?: string;\n}> {\n  try {\n    // 1. Get user profile\n    const userDoc = await db.collection('users').doc(userId).get();\n    const user = userDoc.data();\n\n    // 2. Get collection attempts\n    const attemptsSnapshot = await db\n      .collection('collection_attempts')\n      .where('freelancerId', '==', userId)\n      .get();\n\n    const attempts = attemptsSnapshot.docs.map(doc => doc.data());\n\n    // 3. Get agency handoffs\n    const handoffsSnapshot = await db\n      .collection('agency_handoffs')\n      .where('freelancerId', '==', userId)\n      .get();\n\n    const handoffs = handoffsSnapshot.docs.map(doc => doc.data());\n\n    // 4. Package data\n    const exportData = {\n      exportDate: new Date().toISOString(),\n      user: {\n        email: user?.email,\n        name: user?.name,\n        businessName: user?.businessName,\n        collectionsConsent: user?.collectionsConsent,\n      },\n      collectionAttempts: attempts.map(a => ({\n        date: a.attemptDate,\n        type: a.attemptType,\n        result: a.result,\n        // Exclude sensitive data like full transcripts\n        summary: a.callNotes || a.resultDetails,\n      })),\n      agencyHandoffs: handoffs.map(h => ({\n        agencyName: h.agencyName,\n        handoffDate: h.handoffDate,\n        status: h.handoffStatus,\n        recoveryAmount: h.recoveryAmount,\n      })),\n    };\n\n    logInfo('User data exported', { userId });\n\n    return {\n      success: true,\n      data: exportData,\n    };\n\n  } catch (error) {\n    logError('Failed to export user data', error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Unknown error',\n    };\n  }\n}\n\n/**\n * Generate consent dialogue text for UI\n */\nexport function getConsentDialogue(consentType: ConsentType): {\n  title: string;\n  description: string;\n  legalBasis: string;\n} {\n  const dialogues = {\n    sms: {\n      title: 'SMS Collection Reminders',\n      description: 'Allow Recoup to send SMS text messages to your clients for invoice collection reminders. Messages will only be sent during reasonable hours (08:00-21:00) and clients can opt out at any time.',\n      legalBasis: 'Privacy and Electronic Communications Regulations (PECR) 2003. You can withdraw consent at any time.',\n    },\n    call: {\n      title: 'AI Voice Collection Calls',\n      description: 'Allow Recoup to make automated AI-powered phone calls to your clients for invoice collections. Calls are professional, empathetic, and UK-regulation compliant. Calls only occur during reasonable hours (08:00-21:00).',\n      legalBasis: 'Privacy and Electronic Communications Regulations (PECR) 2003 and FCA Debt Collection Rules. You can withdraw consent at any time.',\n    },\n    call_recording: {\n      title: 'Call Recording',\n      description: 'Allow Recoup to record collection calls for quality assurance, training, and dispute resolution. Recordings are stored securely and can be deleted upon request.',\n      legalBasis: 'GDPR Article 6(1)(a) - Consent. Recordings are kept for 6 months unless required for disputes. You can request deletion at any time.',\n    },\n    physical_mail: {\n      title: 'Physical Mail Collection Letters',\n      description: 'Allow Recoup to send physical collection letters via postal mail on your behalf. Letters follow UK debt collection regulations and escalate from gentle reminders to formal notices.',\n      legalBasis: 'Legitimate interest under GDPR Article 6(1)(f) for debt collection. Letters comply with Consumer Credit Act 1974 and FCA rules.',\n    },\n    data_storage: {\n      title: 'Call Transcript and Recording Storage',\n      description: 'Allow Recoup to store call transcripts, recordings, and related data for your records and analytics. All data is encrypted and stored securely in UK/EU data centers.',\n      legalBasis: 'GDPR Article 6(1)(a) - Consent and Article 6(1)(f) - Legitimate interest for contract performance. Data retention: 6 months, or upon request for deletion.',\n    },\n  };\n\n  return dialogues[consentType];\n}\n\n/**\n * Helper: Map consent type to field name\n */\nfunction getConsentFieldName(consentType: ConsentType): string {\n  const mapping = {\n    sms: 'smsConsent',\n    call: 'callConsent',\n    call_recording: 'callRecordingConsent',\n    physical_mail: 'physicalMailConsent',\n    data_storage: 'dataStorageConsent',\n  };\n\n  return mapping[consentType];\n}\n\n/**\n * Validate consent before premium action\n * Throws error if consent not given\n */\nexport async function validateConsentOrThrow(\n  userId: string,\n  requiredConsents: ConsentType[]\n): Promise<void> {\n  const consent = await getUserConsent(userId);\n\n  if (!consent) {\n    throw new Error('User consent status not found');\n  }\n\n  // Check if consent version is current\n  if (consent.needsUpdate) {\n    throw new Error('Consent requires update to current version');\n  }\n\n  // Check each required consent\n  for (const consentType of requiredConsents) {\n    const hasConsent = await checkConsent(userId, consentType);\n\n    if (!hasConsent) {\n      throw new Error(`User has not given consent for: ${consentType}`);\n    }\n  }\n}\n"],"names":[],"mappings":"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"}