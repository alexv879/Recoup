module.exports=[341030,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),n=e.i(759756),o=e.i(561916),i=e.i(114444),s=e.i(837092),l=e.i(869741),c=e.i(316795),d=e.i(487718),u=e.i(995169),p=e.i(47587),h=e.i(666012),f=e.i(570101),m=e.i(626937),g=e.i(10372),w=e.i(193695);e.i(52474);var v=e.i(600220),E=e.i(89171),y=e.i(707218),R=e.i(169907);async function x(e,t={}){let r=Date.now();try{let a=process.env.NEXT_PUBLIC_DEEPGRAM_API_KEY;if(!a)throw Error("DEEPGRAM_API_KEY not configured");let{language:n="en-GB",model:o="nova-2",punctuate:i=!0,diarize:s=!1}=t,l=await e.arrayBuffer(),c=Buffer.from(l),d=await fetch("https://api.deepgram.com/v1/listen",{method:"POST",headers:{Authorization:`Token ${a}`,"Content-Type":"audio/webm"},body:c});if(!d.ok){let e=await d.text();throw Error(`Deepgram API error: ${d.status} - ${e}`)}let u=await d.json(),p=Date.now()-r,h=u.results?.channels?.[0],f=h?.alternatives?.[0];if(!f?.transcript)throw Error("No transcript returned from Deepgram");let m={transcript:f.transcript,confidence:f.confidence||0,latency:p,provider:"deepgram",metadata:{words:f.words||[]}};return(0,R.logInfo)("Deepgram transcription successful",{latency:p,confidence:f.confidence,transcriptLength:f.transcript.length,provider:"deepgram"}),p>1500&&(0,R.logError)("Deepgram latency exceeded 1.5s target",Error(`Latency: ${p}ms`)),m}catch(r){return Date.now(),(0,R.logError)("Deepgram transcription failed",r),(0,R.logInfo)("Falling back to Whisper transcription"),A(e,t)}}async function A(e,t={}){let r=Date.now();try{let a=process.env.OPENAI_API_KEY;if(!a)throw Error("OPENAI_API_KEY not configured");let{language:n="en"}=t,o=new FormData;o.append("file",e,"audio.webm"),o.append("model","whisper-1"),o.append("language",n),o.append("response_format","verbose_json");let i=await fetch("https://api.openai.com/v1/audio/transcriptions",{method:"POST",headers:{Authorization:`Bearer ${a}`},body:o});if(!i.ok){let e=await i.text();throw Error(`Whisper API error: ${i.status} - ${e}`)}let s=await i.json(),l=Date.now()-r;if(!s.text)throw Error("No transcript returned from Whisper");let c={transcript:s.text,confidence:1,latency:l,provider:"whisper",metadata:{words:s.words||[]}};return(0,R.logInfo)("Whisper transcription successful",{latency:l,transcriptLength:s.text.length,provider:"whisper"}),c}catch(e){throw Date.now(),(0,R.logError)("Whisper transcription failed",e),Error("All transcription providers failed. Please try again or type manually.")}}async function _(e){let t=[];return e.size>0x1900000&&t.push(`Audio file too large: ${(e.size/1024/1024).toFixed(2)}MB (max 25MB)`),e.size<1024&&t.push("Audio too short. Please speak for at least 1 second."),["audio/webm","audio/wav","audio/mp3","audio/mpeg","audio/ogg"].some(t=>e.type.includes(t))||t.push(`Unsupported audio format: ${e.type}`),{valid:0===t.length,errors:t}}var P=e.i(340688),D=e.i(15776);async function b(e){let t=Date.now();try{let r,{userId:a}=await (0,y.auth)(),n=await e.formData(),o=n.get("audio"),i=n.get("provider")||"auto",s="true"===n.get("parseInvoice");if(!o)throw new D.BadRequestError("Missing audio file");let l=new Blob([await o.arrayBuffer()],{type:o.type}),c=await _(l);if(!c.valid)throw new D.BadRequestError(`Invalid audio: ${c.errors.join(", ")}`);if((0,R.logInfo)("Voice transcription started",{userId:a||"anonymous",audioSize:l.size,audioType:l.type,provider:i}),"whisper"===i)r=await A(l);else if("deepgram"===i)r=await x(l);else try{r=await x(l)}catch(e){(0,R.logError)("Deepgram failed, falling back to Whisper",e),r=await A(l)}let d=null;s&&r.transcript&&(d=function(e){let t={rawTranscript:e,clientName:void 0,amount:void 0,currency:"GBP",description:void 0,dueDate:void 0},r=e.match(/(?:for|to)\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)/i);r&&(t.clientName=r[1].trim());let a=e.match(/£?(\d+(?:,\d{3})*(?:\.\d{2})?)\s*(?:pounds?|gbp|£)?/i),n=e.match(/(one|two|three|four|five|six|seven|eight|nine|ten|hundred|thousand)\s*(?:hundred|thousand)?\s*(?:pounds?|gbp|£)?/i);a?t.amount=parseFloat(a[1].replace(/,/g,"")):n&&(t.amount=({one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9,ten:10,hundred:100,thousand:1e3})[n[1].toLowerCase()]||void 0),e.match(/(?:dollars?|usd|\$)/i)?t.currency="USD":e.match(/(?:euros?|eur|€)/i)&&(t.currency="EUR");let o=e.match(/(?:for|regarding)\s+([^.]+?)(?:\s+due|\.|$)/i);if(o&&(t.description=o[1].trim()),e.match(/(?:due|by)\s+(?:next\s+)?week/i)){let e=new Date;e.setDate(e.getDate()+7),t.dueDate=e.toISOString().split("T")[0]}else if(e.match(/(?:due|by)\s+(?:next\s+)?month/i)){let e=new Date;e.setMonth(e.getMonth()+1),t.dueDate=e.toISOString().split("T")[0]}return t}(r.transcript));let u=Date.now()-t;return a&&(0,P.trackEvent)("voice_transcript_finalized",{segments:r.transcript.split(" ").length,latency_ms_avg:r.latency,device_type:"web",network_type:"unknown"}),(0,R.logInfo)("Voice transcription successful",{userId:a||"anonymous",provider:r.provider,latency:r.latency,totalLatency:u,confidence:r.confidence,transcriptLength:r.transcript.length}),r.latency>1500&&(0,R.logError)("Voice transcription latency exceeded 1.5s target",Error(`Latency: ${r.latency}ms`)),E.NextResponse.json({success:!0,transcript:r.transcript,confidence:r.confidence,latency:r.latency,totalLatency:u,provider:r.provider,invoiceData:d,metadata:r.metadata})}catch(a){Date.now(),(0,R.logError)("Voice transcription failed",a);let{userId:e}=await (0,y.auth)();e&&(0,P.trackEvent)("error_occurred",{feature:"voice_transcription",severity:"medium",trace_id:`voice_error_${Date.now()}`});let{status:t,body:r}=await (0,D.handleApiError)(a);return E.NextResponse.json(r,{status:t})}}async function C(e){try{let e=!!process.env.NEXT_PUBLIC_DEEPGRAM_API_KEY,t=!!process.env.OPENAI_API_KEY;return E.NextResponse.json({success:!0,message:"Voice transcription service",capabilities:{deepgram:e,whisper:t,streaming:e,invoiceParsing:!0},providers:{primary:e?"deepgram":t?"whisper":null,fallback:t?"whisper":null},limits:{maxFileSize:0x1900000,maxDuration:30,supportedFormats:["audio/webm","audio/wav","audio/mp3","audio/mpeg","audio/ogg"]},performance:{targetLatency:1500,targetWER:7}})}catch(r){let{status:e,body:t}=await (0,D.handleApiError)(r);return E.NextResponse.json(t,{status:e})}}e.s(["GET",()=>C,"POST",()=>b,"dynamic",0,"force-dynamic","maxDuration",0,30],823143);var I=e.i(823143);let N=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/voice/transcribe/route",pathname:"/api/voice/transcribe",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/voice/transcribe/route.ts",nextConfigOutput:"",userland:I}),{workAsyncStorage:T,workUnitAsyncStorage:S,serverHooks:O}=N;function k(){return(0,a.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:S})}async function M(e,t,a){N.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let E="/api/voice/transcribe/route";E=E.replace(/\/index$/,"")||"/";let y=await N.prepare(e,t,{srcPage:E,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:R,params:x,nextConfig:A,parsedUrl:_,isDraftMode:P,prerenderManifest:D,routerServerContext:b,isOnDemandRevalidate:C,revalidateOnlyGenerated:I,resolvedPathname:T,clientReferenceManifest:S,serverActionsManifest:O}=y,k=(0,l.normalizeAppPath)(E),M=!!(D.dynamicRoutes[k]||D.routes[T]),$=async()=>((null==b?void 0:b.render404)?await b.render404(e,t,_,!1):t.end("This page could not be found"),null);if(M&&!P){let e=!!D.routes[T],t=D.dynamicRoutes[k];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await $();throw new w.NoFallbackError}}let U=null;!M||N.isDev||P||(U="/index"===(U=T)?"/":U);let B=!0===N.isDev||!M,H=M&&!B;O&&S&&(0,i.setReferenceManifestsSingleton)({page:E,clientReferenceManifest:S,serverActionsManifest:O,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:O})});let q=e.method||"GET",j=(0,o.getTracer)(),F=j.getActiveScopeSpan(),K={params:x,prerenderManifest:D,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:B,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>N.onRequestError(e,t,a,b)},sharedContext:{buildId:R}},L=new c.NodeNextRequest(e),z=new c.NodeNextResponse(t),G=d.NextRequestAdapter.fromNodeNextRequest(L,(0,d.signalFromNodeResponse)(t));try{let i=async e=>N.handle(G,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=j.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${q} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${E}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var o,l;let c=async({previousCacheEntry:r})=>{try{if(!s&&C&&I&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await i(n);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let c=K.renderOpts.collectedTags;if(!M)return await (0,h.sendResponse)(L,z,o,K.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(o.headers);c&&(t[g.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,a=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await N.onRequestError(e,t,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:C})},b),t}},d=await N.handleResponse({req:e,nextConfig:A,cacheKey:U,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:D,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:I,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:s});if(!M)return null;if((null==d||null==(o=d.value)?void 0:o.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",C?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),P&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,f.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&M||u.delete(g.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,m.getCacheControlHeader)(d.cacheControl)),await (0,h.sendResponse)(L,z,new Response(d.value.body,{headers:u,status:d.value.status||200})),null};F?await l(F):await j.withPropagatedContext(e.headers,()=>j.trace(u.BaseServerSpan.handleRequest,{spanName:`${q} ${E}`,kind:o.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},l))}catch(t){if(t instanceof w.NoFallbackError||await N.onRequestError(e,t,{routerKind:"App Router",routePath:k,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:C})}),M)throw t;return await (0,h.sendResponse)(L,z,new Response(null,{status:500})),null}}e.s(["handler",()=>M,"patchFetch",()=>k,"routeModule",()=>N,"serverHooks",()=>O,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>S],341030)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_409eba3b.js.map