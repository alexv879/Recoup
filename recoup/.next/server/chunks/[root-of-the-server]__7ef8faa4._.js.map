{"version":3,"sources":["../../../lib/firebase.ts","../../../utils/logger.ts","../../../utils/error.ts","../../../utils/constants.ts","../../../middleware/clerkPremiumGating.ts"],"sourcesContent":["import { initializeApp, getApps, cert } from 'firebase-admin/app';\nimport { getFirestore, Timestamp, FieldValue } from 'firebase-admin/firestore';\nimport { getStorage } from 'firebase-admin/storage';\n\n// Only initialize Firebase on the server side\nif (typeof window === 'undefined') {\n  // Initialize Firebase Admin SDK (only once)\n  // During build, Firebase may not be fully configured - this is expected\n  if (!getApps().length) {\n    try {\n      const projectId = process.env.FIREBASE_PROJECT_ID;\n      const clientEmail = process.env.FIREBASE_CLIENT_EMAIL;\n      const privateKey = process.env.FIREBASE_PRIVATE_KEY?.replace(/\\\\n/g, '\\n');\n\n      // Only initialize if credentials are provided\n      if (projectId && clientEmail && privateKey) {\n        initializeApp({\n          credential: cert({\n            projectId,\n            clientEmail,\n            privateKey,\n          }),\n        });\n        console.log('✅ Firebase Admin initialized successfully');\n      } else {\n        console.warn('⚠️  Firebase credentials not configured - app will not function at runtime');\n      }\n    } catch (error) {\n      console.error('❌ Firebase Admin initialization error:', error);\n      // Don't throw during build - allow build to complete\n      if (process.env.NODE_ENV !== 'production') {\n        console.warn('⚠️  Continuing despite Firebase error (build mode)');\n      }\n    }\n  }\n}\n\n// Export Firestore instance with lazy initialization\nlet dbInstance: ReturnType<typeof getFirestore> | null = null;\n\nfunction getDb() {\n  if (typeof window !== 'undefined') {\n    throw new Error('Firebase Admin SDK cannot be used on the client side');\n  }\n\n  if (!dbInstance) {\n    if (!getApps().length) {\n      throw new Error('Firebase is not initialized. Make sure environment variables are configured.');\n    }\n    dbInstance = getFirestore();\n  }\n  return dbInstance;\n}\n\nexport const db = new Proxy({} as ReturnType<typeof getFirestore>, {\n  get(target, prop) {\n    return (getDb() as any)[prop];\n  }\n});\n\n// Alias for backward compatibility\nexport const firestore = db;\n\n// Export Timestamp and FieldValue for convenience\nexport { Timestamp, FieldValue };\n\n// Export Firebase Storage instance (server-side only)\nexport const storage = typeof window === 'undefined' ? getStorage() : null;\n\n// Collection names (for type safety)\nexport const COLLECTIONS = {\n  USERS: 'users',\n  INVOICES: 'invoices',\n  PAYMENT_CONFIRMATIONS: 'payment_confirmations',\n  PAYMENT_CLAIMS: 'payment_claims',\n  COLLECTION_ATTEMPTS: 'collection_attempts',\n  CLIENTS: 'clients',\n  NOTIFICATIONS: 'notifications',\n  TRANSACTIONS: 'transactions',\n  REFERRALS: 'referrals',\n  REFERRAL_CREDITS: 'referral_credits',\n  REFERRAL_PAYOUTS: 'referral_payouts',\n  USER_BEHAVIOR_PROFILE: 'user_behavior_profile',\n  USER_STATS: 'user_stats',\n  USER_EVENTS: 'user_events',\n  DAILY_SUMMARIES: 'daily_summaries',\n  EMAILS_SENT: 'emails_sent',\n  ONBOARDING_PROGRESS: 'onboarding_progress',\n  AGENCY_HANDOFFS: 'agency_handoffs',\n} as const;\n\n// Helper function to convert Firestore Timestamp to Date\nexport function timestampToDate(timestamp: Timestamp | null | undefined): Date | null {\n  if (!timestamp) return null;\n  return timestamp.toDate();\n}\n\n// Helper function to convert Date to Firestore Timestamp\nexport function dateToTimestamp(date: Date | string | null | undefined): Timestamp | null {\n  if (!date) return null;\n  if (typeof date === 'string') {\n    return Timestamp.fromDate(new Date(date));\n  }\n  return Timestamp.fromDate(date);\n}\n\n// Server timestamp helper\nexport function serverTimestamp() {\n  return FieldValue.serverTimestamp();\n}\n","// Simple logger for development - replace with proper logging service in production\nexport const logger = {\n    info: (data: any, message?: string) => {\n        if (message) {\n            console.log(`[INFO] ${message}`, data);\n        } else {\n            console.log('[INFO]', data);\n        }\n    },\n    error: (data: any, message?: string) => {\n        if (message) {\n            console.error(`[ERROR] ${message}`, data);\n        } else {\n            console.error('[ERROR]', data);\n        }\n    },\n    warn: (data: any, message?: string) => {\n        if (message) {\n            console.warn(`[WARN] ${message}`, data);\n        } else {\n            console.warn('[WARN]', data);\n        }\n    },\n};\n\n// Convenience functions for logging\nexport const logInfo = (message: string, data?: any) => {\n    logger.info(data, message);\n};\n\nexport const logError = (message: string, error?: any) => {\n    logger.error(error, message);\n};\n\nexport const logWarn = (message: string, data?: any) => {\n    logger.warn(data, message);\n};\n\nexport const logApiRequest = (method: string, url: string, data?: any) => {\n    logger.info({ method, url, ...data }, 'API Request');\n};\n\nexport const logApiResponse = (method: string, url: string, status: number, data?: any) => {\n    logger.info({ method, url, status, ...data }, 'API Response');\n};\n\nexport const logDbOperation = (operation: string, collection: string, data?: any) => {\n    logger.info({ operation, collection, ...data }, 'Database Operation');\n};","import { logger } from './logger';\nimport { ZodError } from 'zod';\n\nexport class CustomError extends Error {\n    constructor(\n        public code: string,\n        message: string,\n        public statusCode: number = 500\n    ) {\n        super(message);\n        this.name = 'CustomError';\n    }\n}\n\nexport class ValidationError extends CustomError {\n    constructor(message: string) {\n        super('VALIDATION_ERROR', message, 400);\n    }\n}\n\nexport class UnauthorizedError extends CustomError {\n    constructor(message: string = 'Unauthorized') {\n        super('UNAUTHORIZED', message, 401);\n    }\n}\n\nexport class ForbiddenError extends CustomError {\n    constructor(message: string = 'Forbidden') {\n        super('FORBIDDEN', message, 403);\n    }\n}\n\nexport class NotFoundError extends CustomError {\n    constructor(message: string = 'Not found') {\n        super('NOT_FOUND', message, 404);\n    }\n}\n\nexport class BadRequestError extends CustomError {\n    constructor(message: string = 'Bad request') {\n        super('BAD_REQUEST', message, 400);\n    }\n}\n\nexport class RateLimitError extends CustomError {\n    constructor(message: string = 'Rate limit exceeded') {\n        super('RATE_LIMIT', message, 429);\n    }\n}\n\n// Error constants for API responses\nexport const errors = {\n    VALIDATION_ERROR: 'VALIDATION_ERROR',\n    UNAUTHORIZED: 'UNAUTHORIZED',\n    FORBIDDEN: 'FORBIDDEN',\n    NOT_FOUND: 'NOT_FOUND',\n    INTERNAL_ERROR: 'INTERNAL_ERROR',\n};\n\nexport async function handleError(error: unknown) {\n    if (error instanceof ZodError) {\n        const fieldErrors = error.errors.reduce((acc, e) => {\n            const field = e.path.join('.');\n            acc[field] = e.message;\n            return acc;\n        }, {} as Record<string, string>);\n\n        return {\n            status: 400,\n            body: {\n                error: 'VALIDATION_ERROR',\n                message: 'The request body is invalid.',\n                fields: fieldErrors,\n            },\n        };\n    }\n\n    if (error instanceof CustomError) {\n        return {\n            status: error.statusCode,\n            body: {\n                error: error.code,\n                message: error.message,\n            },\n        };\n    }\n\n    // Log the unexpected error for debugging purposes\n    logger.error({ err: error }, 'An unknown error occurred in handleError');\n\n    return {\n        status: 500,\n        body: {\n            error: 'INTERNAL_ERROR',\n            message: 'An unexpected error occurred',\n        },\n    };\n}\n\n// Alias for handleError to match expected API naming\nexport const handleApiError = handleError;","// ============ APPLICATION CONSTANTS ============\n\nexport const APP_NAME = 'Recoup';\nexport const APP_DESCRIPTION = 'Smart invoicing and payment tracking for freelancers';\n\n// ============ COMMISSION & PRICING ============\n\nexport const RECOUP_COMMISSION_RATE = 0.03; // 3%\nexport const COLLECTIONS_DEMO_LIMIT_FREE = 1; // 1 free collection per month\n\n// ============ TIMING CONSTANTS ============\n\nexport const COLLECTION_DAY_5_REMINDER = 5; // Days after due date (Email - Friendly)\nexport const COLLECTION_DAY_15_REMINDER = 15; // Days after due date (Email + SMS - Firm)\nexport const COLLECTION_DAY_30_REMINDER = 30; // Days after due date (Email + SMS + Letter - Final/Physical Letter - PREMIUM)\nexport const COLLECTION_DAY_45_AGENCY_HANDOFF = 45; // Days after due date (Agency Escalation - PREMIUM)\nexport const PAYMENT_CONFIRMATION_TOKEN_EXPIRY_DAYS = 30;\nexport const NOTIFICATION_EXPIRY_DAYS = 30;\n\n// ============ NOTIFICATION CONSTANTS ============\n\nexport const NOTIFICATION_TYPES = {\n  INVOICE_DROUGHT: 'invoice_drought',\n  PAYMENT_DELAY: 'payment_delay',\n  WIN: 'win',\n  PREDICTION: 'prediction',\n  OPPORTUNITY: 'opportunity',\n  DAILY_DIGEST: 'daily_digest',\n} as const;\n\nexport const MAX_NOTIFICATIONS_PER_DAY = 3;\nexport const NOTIFICATION_CONFIDENCE_THRESHOLD = 0.6;\n\n// ============ STATUS CONSTANTS ============\n\nexport const INVOICE_STATUS = {\n  DRAFT: 'draft',\n  SENT: 'sent',\n  PAID: 'paid',\n  OVERDUE: 'overdue',\n  IN_COLLECTIONS: 'in_collections',\n  DISPUTED: 'disputed',\n  CANCELLED: 'cancelled',\n} as const;\n\nexport const PAYMENT_CONFIRMATION_STATUS = {\n  PENDING_CLIENT: 'pending_client',\n  CLIENT_CONFIRMED: 'client_confirmed',\n  BOTH_CONFIRMED: 'both_confirmed',\n  EXPIRED: 'expired',\n  CANCELLED: 'cancelled',\n} as const;\n\nexport const USER_STATUS = {\n  ACTIVE: 'active',\n  SUSPENDED: 'suspended',\n  DELETED: 'deleted',\n} as const;\n\n// ============ PAYMENT METHODS ============\n\nexport const PAYMENT_METHODS = {\n  BANK_TRANSFER: 'bank_transfer',\n  CARD: 'card',\n} as const;\n\n// ============ SUBSCRIPTION TIERS ============\n\nexport const SUBSCRIPTION_TIERS = {\n  FREE: 'free',\n  PAID: 'paid',        // ✅ KEPT for backward compatibility\n  STARTER: 'starter',  // ✨ NEW - £19 founding / £38 standard\n  GROWTH: 'growth',    // ✨ NEW - £39 founding / £78 standard (Most Popular)\n  PRO: 'pro'           // ✨ NEW - £75 founding / £150 standard\n} as const;\n\n// Type helper for subscription tiers\nexport type SubscriptionTier = typeof SUBSCRIPTION_TIERS[keyof typeof SUBSCRIPTION_TIERS];\n\n/**\n * Normalize legacy 'paid' tier to new tier system\n * Maps old 'paid' tier to 'pro' (default paid tier)\n * @param tier - User's subscription tier\n * @returns Normalized tier string\n */\nexport function normalizeTier(tier: string): SubscriptionTier {\n  if (tier === 'paid') return 'pro'; // Legacy support: paid → pro\n  return tier as SubscriptionTier;\n}\n\n/**\n * Tier hierarchy levels (for upgrade logic)\n * Higher number = higher tier\n */\nexport const TIER_LEVELS = {\n  free: 0,\n  starter: 1,\n  growth: 2,\n  pro: 3,\n  // Legacy support\n  paid: 2, // Map old 'paid' to 'growth' level\n} as const;\n\n/**\n * Collection limits per tier (monthly)\n * Based on invoice volume percentiles from business plan\n */\nexport const COLLECTIONS_LIMITS = {\n  free: 1,           // 1 demo collection per month\n  starter: 10,       // 50th percentile: 6-8 invoices/month\n  growth: 25,        // 75th percentile: 12-15 invoices/month\n  pro: Number.MAX_SAFE_INTEGER, // 90th percentile: 20+ invoices/month (unlimited)\n  // Legacy support\n  paid: 25,          // Old 'paid' tier gets growth limits\n} as const;\n\n/**\n * Founding member pricing (50% off for life)\n * First 50 signups lock in these prices forever\n */\nexport const FOUNDING_MEMBER_PRICING = {\n  starter: 9.50,  // £9.50/month (vs £19 standard)\n  growth: 19.50,  // £19.50/month (vs £39 standard)\n  pro: 37.50,     // £37.50/month (vs £75 standard)\n} as const;\n\n/**\n * Standard pricing (after founding 50)\n */\nexport const STANDARD_PRICING = {\n  starter: 19,   // £19/month\n  growth: 39,   // £39/month\n  pro: 75,      // £75/month\n} as const;\n\n/**\n * Founding member program limit\n */\nexport const FOUNDING_MEMBER_LIMIT = 50;\n\n// ============ BUSINESS TYPES ============\n\nexport const BUSINESS_TYPES = {\n  FREELANCER: 'freelancer',\n  AGENCY: 'agency',\n  CONSULTANT: 'consultant',\n} as const;\n\n// ============ GAMIFICATION CONSTANTS ============\n\nexport const ACHIEVEMENTS = {\n  FIRST_INVOICE: {\n    id: 'first_invoice',\n    name: 'First Invoice',\n    description: 'Created your first invoice',\n    threshold: 500,\n  },\n  COLLECTOR_5K: {\n    id: 'collector_5k',\n    name: 'Collector 5K',\n    description: 'Collected £5,000',\n    threshold: 5000,\n  },\n  COLLECTOR_50K: {\n    id: 'collector_50k',\n    name: 'Collector 50K',\n    description: 'Collected £50,000',\n    threshold: 50000,\n  },\n  RELIABLE: {\n    id: 'reliable',\n    name: 'Reliable',\n    description: '90% on-time payments',\n    threshold: 90,\n  },\n  WEEK_STREAK: {\n    id: 'week_streak',\n    name: 'Week Streak',\n    description: '7 days without overdue',\n    threshold: 7,\n  },\n  MONTH_STREAK: {\n    id: 'month_streak',\n    name: 'Month Streak',\n    description: '30 days without overdue',\n    threshold: 30,\n  },\n  TOP_100: {\n    id: 'top_100',\n    name: 'Top 100',\n    description: 'Ranked in top 100 users',\n    threshold: 100,\n  },\n} as const;\n\nexport const POINTS_PER_1000_COLLECTED = 1;\nexport const POINTS_PER_STREAK_DAY = 1;\nexport const POINTS_PER_BADGE = 10;\nexport const POINTS_PER_LEVEL = 100;\n\n// ============ REFERRAL CONSTANTS ============\n\nexport const REFERRAL_CREDIT_REFERRER = 5; // £5\nexport const REFERRAL_CREDIT_REFERRED = 5; // £5\n\n// ============ RATE LIMITING ============\n\nexport const RATE_LIMIT = {\n  GENERAL: { requests: 10, window: '10s' },\n  AUTH: { requests: 5, window: '60s' },\n  AI: { requests: 3, window: '60s' },\n} as const;\n\n// ============ CURRENCY ============\n\nexport const DEFAULT_CURRENCY = 'GBP';\nexport const SUPPORTED_CURRENCIES = ['GBP', 'USD', 'EUR'] as const;\n\n// ============ LANGUAGES ============\n\nexport const SUPPORTED_LANGUAGES = ['en', 'es', 'fr'] as const;\nexport const DEFAULT_LANGUAGE = 'en';\n\n// ============ TIMEZONES ============\n\nexport const DEFAULT_TIMEZONE = 'Europe/London';\n\n// ============ DEFAULT QUIET HOURS ============\n\nexport const DEFAULT_QUIET_HOURS = {\n  start: '21:00',\n  end: '08:00',\n} as const;\n\n// ============ EMAIL TEMPLATES ============\n\nexport const EMAIL_TEMPLATES = {\n  INVOICE: 'invoice',\n  REMINDER_DAY_7: 'reminder_day_7',\n  REMINDER_DAY_21: 'reminder_day_21',\n  PAYMENT_CONFIRMED: 'payment_confirmed',\n  NOTIFICATION: 'notification',\n} as const;\n\n// ============ VALIDATION CONSTANTS ============\n\nexport const VALIDATION = {\n  MAX_INVOICE_DESCRIPTION_LENGTH: 500,\n  MAX_CLIENT_NAME_LENGTH: 100,\n  MAX_BUSINESS_NAME_LENGTH: 100,\n  MAX_NOTE_LENGTH: 1000,\n  MIN_INVOICE_AMOUNT: 0.01,\n  MAX_INVOICE_AMOUNT: 1000000,\n  UK_ACCOUNT_NUMBER_LENGTH: 8,\n  UK_SORT_CODE_LENGTH: 6,\n} as const;\n","/**\n * CLERK BILLING PREMIUM GATING\n *\n * Uses Clerk's built-in subscription features (has() helper) combined with\n * local usage quota tracking to enforce feature access and collection limits.\n *\n * Subscription Tiers (4-tier freemium model):\n * - FREE: Unlimited invoices, 1 email reminder/month (demo), BACS button\n * - STARTER (£19/£38): 10 collections/month, email reminders only\n * - GROWTH (£39/£78): 25 collections/month, email + SMS + 15 AI calls\n * - PRO (£75/£150): Unlimited collections, SMS + letters + 50 AI calls\n *\n * Premium Features (defined in Clerk Dashboard):\n * - sms_reminders: Available on Pro+ tiers\n * - ai_voice_calls_5_per_month: Available on Pro tier\n * - ai_voice_calls_20_per_month: Available on Business tier\n * - physical_letters_15_per_month: Available on Business tier\n * - collections_limit_10: Starter tier\n * - collections_limit_25: Pro tier\n * - collections_unlimited: Business tier\n * - advanced_analytics: Pro+ tiers\n */\n\nimport { auth } from '@clerk/nextjs/server';\nimport { db, FieldValue } from '@/lib/firebase';\nimport { User } from '@/types/models';\nimport { errors } from '@/utils/error';\nimport { COLLECTIONS_LIMITS, TIER_LEVELS, normalizeTier, SubscriptionTier } from '@/utils/constants';\nimport { logError, logInfo, logWarn } from '@/utils/logger';\n\n/**\n * Feature slugs matching Clerk dashboard configuration\n * These should be created as features in Clerk Dashboard > Subscription Plans\n */\nexport type ClerkFeature =\n  | 'sms_reminders'\n  | 'ai_voice_calls_5_per_month'\n  | 'ai_voice_calls_20_per_month'\n  | 'physical_letters_15_per_month'\n  | 'collections_limit_10'\n  | 'collections_limit_25'\n  | 'collections_unlimited'\n  | 'advanced_analytics'\n  | 'priority_support'\n  | 'dedicated_account_manager';\n\n/**\n * Check if user has access to a Clerk Billing feature\n * Combines Clerk's subscription check with local usage quota tracking\n *\n * @param userId - Clerk user ID\n * @param feature - Feature slug from Clerk dashboard\n * @returns Access status with reason and upgrade suggestion\n */\nexport async function checkClerkFeatureAccess(\n  userId: string,\n  feature: ClerkFeature\n): Promise<{\n  hasAccess: boolean;\n  reason?: string;\n  upgradeRequired?: boolean;\n  suggestedTier?: SubscriptionTier;\n  quotaInfo?: {\n    used: number;\n    limit: number;\n    remaining: number;\n  };\n}> {\n  try {\n    // 1. Check Clerk subscription status using has() helper\n    const { has } = await auth();\n\n    if (!has) {\n      logWarn('Clerk auth not available in checkClerkFeatureAccess', { userId });\n      throw errors.unauthorized('User not authenticated');\n    }\n\n    const hasFeature = has({ feature });\n\n    // 2. Get user from Firestore for usage tracking\n    const userDoc = await db.collection('users').doc(userId).get();\n\n    if (!userDoc.exists) {\n      return {\n        hasAccess: false,\n        reason: 'User not found',\n      };\n    }\n\n    const user = userDoc.data() as User;\n    const tier = normalizeTier(user.subscriptionTier);\n\n    // 3. Check usage quota for collection features\n    if (feature.startsWith('collections_limit_')) {\n      const limit = COLLECTIONS_LIMITS[tier as keyof typeof COLLECTIONS_LIMITS];\n      const used = user.collectionsUsedThisMonth || 0;\n      const remaining = limit === Infinity ? Infinity : Math.max(0, limit - used);\n\n      // Check if quota exceeded\n      if (limit !== Infinity && used >= limit) {\n        return {\n          hasAccess: false,\n          reason: `Monthly quota exceeded (${used}/${limit} collections used this month)`,\n          upgradeRequired: true,\n          suggestedTier: getSuggestedTierForUpgrade(tier),\n          quotaInfo: {\n            used,\n            limit,\n            remaining: 0,\n          },\n        };\n      }\n\n      // Has access, return quota info\n      return {\n        hasAccess: true,\n        quotaInfo: {\n          used,\n          limit: limit === Infinity ? 999999 : limit,\n          remaining: limit === Infinity ? 999999 : remaining,\n        },\n      };\n    }\n\n    // 4. For non-quota features, return Clerk's feature check result\n    if (!hasFeature) {\n      return {\n        hasAccess: false,\n        reason: `Feature '${feature}' not available on your ${tier} plan`,\n        upgradeRequired: true,\n        suggestedTier: getSuggestedTierForFeature(feature),\n      };\n    }\n\n    return {\n      hasAccess: true,\n    };\n  } catch (error) {\n    logError('Error checking Clerk feature access', error as Error, {\n      userId,\n      feature,\n    });\n    return {\n      hasAccess: false,\n      reason: 'Error checking subscription status',\n    };\n  }\n}\n\n/**\n * Require Clerk feature access or throw 402 Payment Required error\n * Use this in API routes to enforce premium features\n *\n * @param userId - Clerk user ID\n * @param feature - Feature slug from Clerk dashboard\n * @throws PaymentRequiredError if user doesn't have access\n */\nexport async function requireClerkFeature(\n  userId: string,\n  feature: ClerkFeature\n): Promise<void> {\n  const { hasAccess, reason, suggestedTier, quotaInfo } = await checkClerkFeatureAccess(\n    userId,\n    feature\n  );\n\n  if (!hasAccess) {\n    throw errors.paymentRequired(reason || 'Upgrade required to access this feature', {\n      feature,\n      suggestedTier,\n      quotaInfo,\n    });\n  }\n\n  logInfo('Premium feature access granted', {\n    userId,\n    feature,\n    quotaInfo,\n  });\n}\n\n/**\n * Increment usage counter for collections\n * Call this AFTER a collection action succeeds (SMS sent, AI call made, letter sent)\n *\n * @param userId - Clerk user ID\n * @param usageType - Type of usage to increment\n */\nexport async function incrementUsageCounter(\n  userId: string,\n  usageType: 'collection' | 'ai_call' | 'letter'\n): Promise<void> {\n  try {\n    const userRef = db.collection('users').doc(userId);\n\n    await userRef.update({\n      collectionsUsedThisMonth: FieldValue.increment(1),\n      updatedAt: FieldValue.serverTimestamp(),\n    });\n\n    logInfo('Usage counter incremented', {\n      userId,\n      usageType,\n    });\n  } catch (error) {\n    logError('Error incrementing usage counter', error as Error, {\n      userId,\n      usageType,\n    });\n    // Don't throw - usage tracking failure shouldn't block the operation\n  }\n}\n\n/**\n * Reset monthly usage counters (called by cron job on 1st of month)\n *\n * @param userId - Clerk user ID (optional - if not provided, resets all users)\n */\nexport async function resetMonthlyUsage(userId?: string): Promise<void> {\n  try {\n    if (userId) {\n      // Reset single user\n      await db.collection('users').doc(userId).update({\n        collectionsUsedThisMonth: 0,\n        monthlyUsageResetDate: FieldValue.serverTimestamp(),\n        updatedAt: FieldValue.serverTimestamp(),\n      });\n      logInfo('Monthly usage reset for user', { userId });\n    } else {\n      // Reset all users (batch operation)\n      const usersSnapshot = await db.collection('users').get();\n      const batch = db.batch();\n\n      usersSnapshot.docs.forEach((doc) => {\n        batch.update(doc.ref, {\n          collectionsUsedThisMonth: 0,\n          monthlyUsageResetDate: FieldValue.serverTimestamp(),\n          updatedAt: FieldValue.serverTimestamp(),\n        });\n      });\n\n      await batch.commit();\n      logInfo('Monthly usage reset for all users', {\n        totalUsers: usersSnapshot.size,\n      });\n    }\n  } catch (error) {\n    logError('Error resetting monthly usage', error as Error, { userId });\n    throw error;\n  }\n}\n\n/**\n * Get user's current usage quota info\n *\n * @param userId - Clerk user ID\n * @returns Quota information\n */\nexport async function getUserQuotaInfo(userId: string): Promise<{\n  tier: SubscriptionTier;\n  used: number;\n  limit: number;\n  remaining: number;\n  percentageUsed: number;\n  isNearLimit: boolean;\n}> {\n  const userDoc = await db.collection('users').doc(userId).get();\n\n  if (!userDoc.exists) {\n    throw errors.notFound('User not found');\n  }\n\n  const user = userDoc.data() as User;\n  const tier = normalizeTier(user.subscriptionTier);\n  const limit = COLLECTIONS_LIMITS[tier as keyof typeof COLLECTIONS_LIMITS];\n  const used = user.collectionsUsedThisMonth || 0;\n  const remaining = limit === Infinity ? Infinity : Math.max(0, limit - used);\n  const percentageUsed = limit === Infinity ? 0 : (used / limit) * 100;\n  const isNearLimit = percentageUsed >= 80;\n\n  return {\n    tier,\n    used,\n    limit: limit === Infinity ? 999999 : limit,\n    remaining: limit === Infinity ? 999999 : remaining,\n    percentageUsed,\n    isNearLimit,\n  };\n}\n\n/**\n * Helper: Suggest next tier for upgrade based on current tier\n */\nfunction getSuggestedTierForUpgrade(currentTier: SubscriptionTier): SubscriptionTier {\n  const tierOrder: SubscriptionTier[] = ['free', 'starter', 'growth', 'pro'];\n  const currentIndex = tierOrder.indexOf(currentTier);\n\n  if (currentIndex === -1 || currentIndex >= tierOrder.length - 1) {\n    return 'business'; // Already at top or unknown tier\n  }\n\n  return tierOrder[currentIndex + 1];\n}\n\n/**\n * Helper: Suggest tier based on feature requirement\n */\nfunction getSuggestedTierForFeature(feature: ClerkFeature): SubscriptionTier {\n  if (\n    feature === 'physical_letters_15_per_month' ||\n    feature === 'ai_voice_calls_20_per_month' ||\n    feature === 'collections_unlimited' ||\n    feature === 'dedicated_account_manager'\n  ) {\n    return 'business';\n  }\n\n  if (\n    feature === 'sms_reminders' ||\n    feature === 'ai_voice_calls_5_per_month' ||\n    feature === 'collections_limit_25' ||\n    feature === 'advanced_analytics'\n  ) {\n    return 'pro';\n  }\n\n  if (feature === 'collections_limit_10') {\n    return 'starter';\n  }\n\n  return 'pro'; // Default to Pro for unknown features\n}\n\n/**\n * Check if user can upgrade to a specific tier\n * Used to validate upgrade paths (can't downgrade, founding members locked in)\n */\nexport async function canUpgradeToTier(\n  userId: string,\n  targetTier: SubscriptionTier\n): Promise<{\n  canUpgrade: boolean;\n  reason?: string;\n}> {\n  const userDoc = await db.collection('users').doc(userId).get();\n\n  if (!userDoc.exists) {\n    return {\n      canUpgrade: false,\n      reason: 'User not found',\n    };\n  }\n\n  const user = userDoc.data() as User;\n  const currentTier = normalizeTier(user.subscriptionTier);\n  const currentLevel = TIER_LEVELS[currentTier as keyof typeof TIER_LEVELS];\n  const targetLevel = TIER_LEVELS[targetTier as keyof typeof TIER_LEVELS];\n\n  // Can't downgrade\n  if (targetLevel <= currentLevel) {\n    return {\n      canUpgrade: false,\n      reason: 'Cannot downgrade to a lower tier. Please contact support to change your plan.',\n    };\n  }\n\n  // Founding members are locked into their pricing but can still upgrade\n  if (user.isFoundingMember) {\n    return {\n      canUpgrade: true,\n      reason: 'As a founding member, you will keep your 50% discount on the new tier.',\n    };\n  }\n\n  return {\n    canUpgrade: true,\n  };\n}\n"],"names":[],"mappings":"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"}