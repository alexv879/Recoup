module.exports=[997953,(e,t,n)=>{"use strict";t.exports=e.r(442315).vendored["react-rsc"].ReactServerDOMTurbopackServer},57598,e=>{"use strict";var t=e.i(997953);let n=(0,t.registerClientReference)(function(){throw Error("Attempted to call the default export of [project]/lib/analytics.ts <module evaluation> from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","default"),o=(0,t.registerClientReference)(function(){throw Error("Attempted to call identifyUser() from the server but identifyUser is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","identifyUser"),a=(0,t.registerClientReference)(function(){throw Error("Attempted to call incrementUserProperty() from the server but incrementUserProperty is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","incrementUserProperty"),r=(0,t.registerClientReference)(function(){throw Error("Attempted to call initializeAnalytics() from the server but initializeAnalytics is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","initializeAnalytics"),i=(0,t.registerClientReference)(function(){throw Error("Attempted to call resetAnalytics() from the server but resetAnalytics is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","resetAnalytics"),s=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackActivationFunnel() from the server but trackActivationFunnel is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","trackActivationFunnel"),l=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackAhaMoment() from the server but trackAhaMoment is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","trackAhaMoment"),c=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackEvent() from the server but trackEvent is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","trackEvent"),d=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackPageView() from the server but trackPageView is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","trackPageView"),u=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackSignupFunnel() from the server but trackSignupFunnel is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","trackSignupFunnel"),p=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackUpgradeFunnel() from the server but trackUpgradeFunnel is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","trackUpgradeFunnel"),m=(0,t.registerClientReference)(function(){throw Error("Attempted to call updateUserProperties() from the server but updateUserProperties is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","updateUserProperties"),f=(0,t.registerClientReference)(function(){throw Error("Attempted to call useTrack() from the server but useTrack is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","useTrack"),v=(0,t.registerClientReference)(function(){throw Error("Attempted to call useTrackMount() from the server but useTrackMount is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","useTrackMount"),h=(0,t.registerClientReference)(function(){throw Error("Attempted to call useTrackPageView() from the server but useTrackPageView is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","useTrackPageView");e.s(["default",0,n,"identifyUser",0,o,"incrementUserProperty",0,a,"initializeAnalytics",0,r,"resetAnalytics",0,i,"trackActivationFunnel",0,s,"trackAhaMoment",0,l,"trackEvent",0,c,"trackPageView",0,d,"trackSignupFunnel",0,u,"trackUpgradeFunnel",0,p,"updateUserProperties",0,m,"useTrack",0,f,"useTrackMount",0,v,"useTrackPageView",0,h])},625953,e=>{"use strict";var t=e.i(997953);let n=(0,t.registerClientReference)(function(){throw Error("Attempted to call the default export of [project]/lib/analytics.ts from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","default"),o=(0,t.registerClientReference)(function(){throw Error("Attempted to call identifyUser() from the server but identifyUser is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","identifyUser"),a=(0,t.registerClientReference)(function(){throw Error("Attempted to call incrementUserProperty() from the server but incrementUserProperty is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","incrementUserProperty"),r=(0,t.registerClientReference)(function(){throw Error("Attempted to call initializeAnalytics() from the server but initializeAnalytics is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","initializeAnalytics"),i=(0,t.registerClientReference)(function(){throw Error("Attempted to call resetAnalytics() from the server but resetAnalytics is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","resetAnalytics"),s=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackActivationFunnel() from the server but trackActivationFunnel is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","trackActivationFunnel"),l=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackAhaMoment() from the server but trackAhaMoment is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","trackAhaMoment"),c=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackEvent() from the server but trackEvent is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","trackEvent"),d=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackPageView() from the server but trackPageView is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","trackPageView"),u=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackSignupFunnel() from the server but trackSignupFunnel is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","trackSignupFunnel"),p=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackUpgradeFunnel() from the server but trackUpgradeFunnel is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","trackUpgradeFunnel"),m=(0,t.registerClientReference)(function(){throw Error("Attempted to call updateUserProperties() from the server but updateUserProperties is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","updateUserProperties"),f=(0,t.registerClientReference)(function(){throw Error("Attempted to call useTrack() from the server but useTrack is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","useTrack"),v=(0,t.registerClientReference)(function(){throw Error("Attempted to call useTrackMount() from the server but useTrackMount is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","useTrackMount"),h=(0,t.registerClientReference)(function(){throw Error("Attempted to call useTrackPageView() from the server but useTrackPageView is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","useTrackPageView");e.s(["default",0,n,"identifyUser",0,o,"incrementUserProperty",0,a,"initializeAnalytics",0,r,"resetAnalytics",0,i,"trackActivationFunnel",0,s,"trackAhaMoment",0,l,"trackEvent",0,c,"trackPageView",0,d,"trackSignupFunnel",0,u,"trackUpgradeFunnel",0,p,"updateUserProperties",0,m,"useTrack",0,f,"useTrackMount",0,v,"useTrackPageView",0,h])},340688,e=>{"use strict";e.i(57598);var t=e.i(625953);e.n(t)},146366,e=>{"use strict";function t(e){return e>=60?"agency":e>=30?"final":e>=15?"firm":e>=5?"gentle":"pending"}function n(e,n){let o=t(n),a=["pending","gentle","firm","final","agency"],r=a.indexOf(e);return a.indexOf(o)>r}e.s(["ESCALATION_CONFIGS",0,{pending:{level:"pending",daysMin:0,daysMax:4,badgeText:"Pending",badgeColor:"#0891B2",badgeIcon:"⏳",tone:"neutral",channels:["email"],description:"Invoice sent, awaiting payment"},gentle:{level:"gentle",daysMin:5,daysMax:14,badgeText:"Gentle Reminder",badgeColor:"#CA8A04",badgeIcon:"⚠️",tone:"friendly",channels:["email"],description:"First collection activity - friendly tone"},firm:{level:"firm",daysMin:15,daysMax:29,badgeText:"Firm Notice",badgeColor:"#EA580C",badgeIcon:"⚠️",tone:"direct",channels:["email","sms"],description:"Escalated to firm language - professional"},final:{level:"final",daysMin:30,daysMax:59,badgeText:"Final Demand",badgeColor:"#991B1B",badgeIcon:"⚡",tone:"serious",channels:["email","phone"],description:"Last chance before agency escalation"},agency:{level:"agency",daysMin:60,daysMax:null,badgeText:"Agency Handoff",badgeColor:"#7F1D1D",badgeIcon:"⚖️",tone:"external",channels:["agency"],description:"Escalated to collections agency"}},"calculateEscalationLevel",()=>t,"shouldEscalate",()=>n])},581742,e=>e.a(async(t,n)=>{try{var o=e.i(868253),a=e.i(155742),r=e.i(146366),i=e.i(598941),s=e.i(340688),l=e.i(169907),c=t([o,a,i]);[o,a,i]=c.then?(await c)():c;let w="users",E="invoices",k="escalation_states",A="escalation_timeline";async function d(){let e=Date.now(),t={scannedCount:0,escalatedCount:0,pausedCount:0,skippedCount:0,errors:[]};try{(0,l.logInfo)("Starting collections escalation worker");let n=a.Timestamp.now(),i=await o.db.collection(E).where("status","in",["overdue","in_collections"]).get();for(let e of(t.scannedCount=i.size,(0,l.logInfo)(`Found ${t.scannedCount} overdue invoices to process`),i.docs))try{let o=e.data(),a=o.dueDate.toMillis?o.dueDate.toMillis():o.dueDate.getTime(),i=Math.floor((n.toMillis()-a)/864e5);if(i<0){t.skippedCount++;continue}let s=await u(o.invoiceId,i);if(s.isPaused)if(s.pauseUntil&&n.toMillis()>s.pauseUntil.getTime())await C(o.invoiceId,"auto_resume_deadline_passed"),(0,l.logInfo)(`Auto-resumed escalation for invoice ${o.reference}`,{invoiceId:o.invoiceId});else{t.pausedCount++;continue}let c=await p(o.freelancerId);if(!c.enabled){t.skippedCount++;continue}let d=(0,r.calculateEscalationLevel)(i);(0,r.shouldEscalate)(s.currentLevel,i)?(await m(o,d,i,c,s),t.escalatedCount++):t.skippedCount++}catch(o){let n=`Failed to process invoice ${e.id}: ${o.message}`;(0,l.logError)(n,o),t.errors.push(n)}let s=Date.now()-e;return(0,l.logInfo)("Collections escalation worker completed",{...t,durationMs:s}),t}catch(e){throw(0,l.logError)("Collections escalation worker failed",e),e}}async function u(e,t){let n=await o.db.collection(k).doc(e).get();if(n.exists){let t=n.data();return{invoiceId:e,currentLevel:t.currentLevel,isPaused:t.isPaused||!1,pauseReason:t.pauseReason,pausedAt:t.pausedAt?.toDate(),pauseUntil:t.pauseUntil?.toDate(),lastEscalatedAt:t.lastEscalatedAt.toDate(),nextEscalationDue:t.nextEscalationDue?.toDate(),timeline:[]}}let i=(0,r.calculateEscalationLevel)(t),s={invoiceId:e,currentLevel:i,isPaused:!1,lastEscalatedAt:new Date,timeline:[]};return await o.db.collection(k).doc(e).set({currentLevel:i,isPaused:!1,lastEscalatedAt:a.FieldValue.serverTimestamp(),createdAt:a.FieldValue.serverTimestamp(),updatedAt:a.FieldValue.serverTimestamp()}),await g(e,{eventId:`${e}-init-${Date.now()}`,invoiceId:e,escalationLevel:i,eventType:"escalated",timestamp:new Date,message:`Collections started at ${r.ESCALATION_CONFIGS[i].badgeText} level`,metadata:{daysOverdue:t}}),s}async function p(e){let t=(await o.db.collection(w).doc(e).get()).data();return{enabled:t?.collectionsEnabled??!0,userId:e,channels:{emailEnabled:!0,smsEnabled:!1,phoneEnabled:!1,agencyEnabled:!1},pauseConditions:{onPaymentClaim:!0,onDispute:!0}}}async function m(e,t,n,i,c){let d=r.ESCALATION_CONFIGS[t];(0,l.logInfo)(`Escalating invoice ${e.reference} to ${t}`,{invoiceId:e.invoiceId,from:c.currentLevel,to:t,daysOverdue:n}),await o.db.collection(k).doc(e.invoiceId).update({currentLevel:t,lastEscalatedAt:a.FieldValue.serverTimestamp(),updatedAt:a.FieldValue.serverTimestamp()}),"pending"!==t&&await o.db.collection(E).doc(e.invoiceId).update({status:"in_collections",escalationLevel:t,updatedAt:a.FieldValue.serverTimestamp()}),await g(e.invoiceId,{eventId:`${e.invoiceId}-escalate-${Date.now()}`,invoiceId:e.invoiceId,escalationLevel:t,eventType:"escalated",timestamp:new Date,message:`Escalated to ${d.badgeText} (${n} days overdue)`,metadata:{previousLevel:c.currentLevel,daysOverdue:n,tone:d.tone,channels:d.channels}}),d.channels.includes("email")&&i.channels.emailEnabled&&await f(e,t,n),d.channels.includes("sms")&&i.channels.smsEnabled&&await v(e,t,n),await (0,s.trackEvent)("collections_escalated",{invoice_id:e.invoiceId,invoice_reference:e.reference,escalation_level:t,days_overdue:n,previous_level:c.currentLevel,amount:e.amount,freelancer_id:e.freelancerId}),(0,l.logInfo)(`Successfully escalated invoice ${e.reference} to ${t}`)}async function f(e,t,n){try{let o=5;"final"===t||"agency"===t?o=30:"firm"===t&&(o=15);let a=5===o?"day5":15===o?"day15":"day30",l=await (0,i.sendReminderEmail)({invoiceId:e.invoiceId,level:a,clientEmail:e.clientEmail});l.messageId&&(await g(e.invoiceId,{eventId:`${e.invoiceId}-email-${Date.now()}`,invoiceId:e.invoiceId,escalationLevel:t,eventType:"reminder_sent",channel:"email",timestamp:new Date,message:`${r.ESCALATION_CONFIGS[t].badgeText} reminder sent via email`,metadata:{messageId:l.messageId,templateLevel:o,daysOverdue:n}}),await (0,s.trackEvent)("email_sent",{email_type:"collections_reminder",escalation_level:t,invoice_id:e.invoiceId,template_level:o.toString(),days_overdue:n}))}catch(t){throw(0,l.logError)(`Failed to send escalation email for ${e.reference}`,t),t}}async function v(e,t,n){try{(await o.db.collection(w).doc(e.freelancerId).get()).data(),(0,l.logWarn)(`SMS reminders not implemented yet - skipping for user ${e.freelancerId}`);return}catch(t){(0,l.logError)(`Failed to send escalation SMS for ${e.reference}`,t)}}async function h(e,t,n){await o.db.collection(k).doc(e).update({isPaused:!0,pauseReason:t,pausedAt:a.FieldValue.serverTimestamp(),pauseUntil:n?a.Timestamp.fromDate(n):null,updatedAt:a.FieldValue.serverTimestamp()}),await g(e,{eventId:`${e}-pause-${Date.now()}`,invoiceId:e,escalationLevel:"pending",eventType:"paused",timestamp:new Date,message:`Collections paused due to ${t.replace("_"," ")}`,metadata:{reason:t,pauseUntil:n?.toISOString()}}),(0,l.logInfo)(`Paused escalation for invoice ${e}`,{reason:t,pauseUntil:n})}async function C(e,t){await o.db.collection(k).doc(e).update({isPaused:!1,pauseReason:null,pausedAt:null,pauseUntil:null,updatedAt:a.FieldValue.serverTimestamp()}),await g(e,{eventId:`${e}-resume-${Date.now()}`,invoiceId:e,escalationLevel:"pending",eventType:"resumed",timestamp:new Date,message:`Collections resumed: ${t}`,metadata:{reason:t}}),(0,l.logInfo)(`Resumed escalation for invoice ${e}`,{reason:t})}async function g(e,t){await o.db.collection(A).doc(t.eventId).set({...t,timestamp:a.Timestamp.fromDate(t.timestamp),createdAt:a.FieldValue.serverTimestamp()})}async function b(e){return(await o.db.collection(A).where("invoiceId","==",e).orderBy("timestamp","desc").get()).docs.map(e=>{let t=e.data();return{eventId:t.eventId,invoiceId:t.invoiceId,escalationLevel:t.escalationLevel,eventType:t.eventType,channel:t.channel,timestamp:t.timestamp.toDate(),message:t.message,metadata:t.metadata}})}async function y(e){let t=await o.db.collection(k).doc(e).get();if(!t.exists)return null;let n=t.data(),a=await b(e);return{invoiceId:e,currentLevel:n.currentLevel,isPaused:n.isPaused||!1,pauseReason:n.pauseReason,pausedAt:n.pausedAt?.toDate(),pauseUntil:n.pauseUntil?.toDate(),lastEscalatedAt:n.lastEscalatedAt.toDate(),nextEscalationDue:n.nextEscalationDue?.toDate(),timeline:a}}e.s(["getEscalationState",()=>y,"getEscalationTimeline",()=>b,"pauseEscalation",()=>h,"resumeEscalation",()=>C,"runEscalationWorker",()=>d]),n()}catch(e){n(e)}},!1),586135,e=>e.a(async(t,n)=>{try{var o=e.i(89171),a=e.i(581742),r=e.i(169907),i=t([a]);async function s(e){let t=Date.now();try{let n=e.headers.get("authorization"),i=process.env.CRON_SECRET;if(!i)throw Error("CRON_SECRET not configured");if(n!==`Bearer ${i}`)return(0,r.logError)("Unauthorized cron job attempt",Error("Invalid cron secret")),o.NextResponse.json({error:"Unauthorized"},{status:401});(0,r.logInfo)("Starting collections escalation cron job");let s=await (0,a.runEscalationWorker)(),l=Date.now()-t;return(0,r.logInfo)("Collections escalation cron job completed",{...s,durationMs:l}),o.NextResponse.json({success:!0,...s,duration:`${l}ms`,timestamp:new Date().toISOString()})}catch(n){let e=Date.now()-t;return(0,r.logError)("Collections escalation cron job failed",n),o.NextResponse.json({success:!1,error:n.message,duration:`${e}ms`,timestamp:new Date().toISOString()},{status:500})}}[a]=i.then?(await i)():i,e.s(["GET",()=>s,"dynamic",0,"force-dynamic","maxDuration",0,300,"runtime",0,"nodejs"]),n()}catch(e){n(e)}},!1),198636,e=>e.a(async(t,n)=>{try{var o=e.i(747909),a=e.i(174017),r=e.i(996250),i=e.i(759756),s=e.i(561916),l=e.i(114444),c=e.i(837092),d=e.i(869741),u=e.i(316795),p=e.i(487718),m=e.i(995169),f=e.i(47587),v=e.i(666012),h=e.i(570101),C=e.i(626937),g=e.i(10372),b=e.i(193695);e.i(52474);var y=e.i(600220),w=e.i(586135),E=t([w]);[w]=E.then?(await E)():E;let I=new o.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/cron/process-escalations/route",pathname:"/api/cron/process-escalations",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/cron/process-escalations/route.ts",nextConfigOutput:"",userland:w}),{workAsyncStorage:R,workUnitAsyncStorage:T,serverHooks:P}=I;function k(){return(0,r.patchFetch)({workAsyncStorage:R,workUnitAsyncStorage:T})}async function A(e,t,n){I.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let o="/api/cron/process-escalations/route";o=o.replace(/\/index$/,"")||"/";let r=await I.prepare(e,t,{srcPage:o,multiZoneDraftMode:!1});if(!r)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:w,params:E,nextConfig:k,parsedUrl:A,isDraftMode:R,prerenderManifest:T,routerServerContext:P,isOnDemandRevalidate:x,revalidateOnlyGenerated:U,resolvedPathname:D,clientReferenceManifest:S,serverActionsManifest:F}=r,M=(0,d.normalizeAppPath)(o),_=!!(T.dynamicRoutes[M]||T.routes[D]),j=async()=>((null==P?void 0:P.render404)?await P.render404(e,t,A,!1):t.end("This page could not be found"),null);if(_&&!R){let e=!!T.routes[D],t=T.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(k.experimental.adapterPath)return await j();throw new b.NoFallbackError}}let $=null;!_||I.isDev||R||($=D,$="/index"===$?"/":$);let N=!0===I.isDev||!_,O=_&&!N;F&&S&&(0,l.setReferenceManifestsSingleton)({page:o,clientReferenceManifest:S,serverActionsManifest:F,serverModuleMap:(0,c.createServerModuleMap)({serverActionsManifest:F})});let L=e.method||"GET",V=(0,s.getTracer)(),H=V.getActiveScopeSpan(),q={params:E,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!k.experimental.authInterrupts},cacheComponents:!!k.cacheComponents,supportsDynamicResponse:N,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:k.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,o)=>I.onRequestError(e,t,o,P)},sharedContext:{buildId:w}},z=new u.NodeNextRequest(e),B=new u.NodeNextResponse(t),G=p.NextRequestAdapter.fromNodeNextRequest(z,(0,p.signalFromNodeResponse)(t));try{let r=async e=>I.handle(G,q).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=V.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=n.get("next.route");if(a){let t=`${L} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${L} ${o}`)}),l=!!(0,i.getRequestMeta)(e,"minimalMode"),c=async i=>{var s,c;let d=async({previousCacheEntry:a})=>{try{if(!l&&x&&U&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await r(i);e.fetchMetrics=q.renderOpts.fetchMetrics;let s=q.renderOpts.pendingWaitUntil;s&&n.waitUntil&&(n.waitUntil(s),s=void 0);let c=q.renderOpts.collectedTags;if(!_)return await (0,v.sendResponse)(z,B,o,q.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(o.headers);c&&(t[g.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==q.renderOpts.collectedRevalidate&&!(q.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&q.renderOpts.collectedRevalidate,a=void 0===q.renderOpts.collectedExpire||q.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:q.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:a}}}}catch(t){throw(null==a?void 0:a.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:o,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:O,isOnDemandRevalidate:x})},P),t}},u=await I.handleResponse({req:e,nextConfig:k,cacheKey:$,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:x,revalidateOnlyGenerated:U,responseGenerator:d,waitUntil:n.waitUntil,isMinimalMode:l});if(!_)return null;if((null==u||null==(s=u.value)?void 0:s.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(c=u.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",x?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),R&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,h.fromNodeOutgoingHttpHeaders)(u.value.headers);return l&&_||p.delete(g.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,C.getCacheControlHeader)(u.cacheControl)),await (0,v.sendResponse)(z,B,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};H?await c(H):await V.withPropagatedContext(e.headers,()=>V.trace(m.BaseServerSpan.handleRequest,{spanName:`${L} ${o}`,kind:s.SpanKind.SERVER,attributes:{"http.method":L,"http.target":e.url}},c))}catch(t){if(t instanceof b.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:O,isOnDemandRevalidate:x})}),_)throw t;return await (0,v.sendResponse)(z,B,new Response(null,{status:500})),null}}e.s(["handler",()=>A,"patchFetch",()=>k,"routeModule",()=>I,"serverHooks",()=>P,"workAsyncStorage",()=>R,"workUnitAsyncStorage",()=>T]),n()}catch(e){n(e)}},!1)];

//# sourceMappingURL=_f8eb3db0._.js.map