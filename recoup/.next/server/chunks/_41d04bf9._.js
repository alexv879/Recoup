module.exports=[997953,(e,t,n)=>{"use strict";t.exports=e.r(442315).vendored["react-rsc"].ReactServerDOMTurbopackServer},57598,e=>{"use strict";var t=e.i(997953);let n=(0,t.registerClientReference)(function(){throw Error("Attempted to call the default export of [project]/lib/analytics.ts <module evaluation> from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","default"),o=(0,t.registerClientReference)(function(){throw Error("Attempted to call identifyUser() from the server but identifyUser is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","identifyUser"),a=(0,t.registerClientReference)(function(){throw Error("Attempted to call incrementUserProperty() from the server but incrementUserProperty is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","incrementUserProperty"),r=(0,t.registerClientReference)(function(){throw Error("Attempted to call initializeAnalytics() from the server but initializeAnalytics is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","initializeAnalytics"),i=(0,t.registerClientReference)(function(){throw Error("Attempted to call resetAnalytics() from the server but resetAnalytics is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","resetAnalytics"),s=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackActivationFunnel() from the server but trackActivationFunnel is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","trackActivationFunnel"),l=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackAhaMoment() from the server but trackAhaMoment is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","trackAhaMoment"),c=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackEvent() from the server but trackEvent is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","trackEvent"),d=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackPageView() from the server but trackPageView is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","trackPageView"),p=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackSignupFunnel() from the server but trackSignupFunnel is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","trackSignupFunnel"),u=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackUpgradeFunnel() from the server but trackUpgradeFunnel is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","trackUpgradeFunnel"),m=(0,t.registerClientReference)(function(){throw Error("Attempted to call updateUserProperties() from the server but updateUserProperties is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","updateUserProperties"),f=(0,t.registerClientReference)(function(){throw Error("Attempted to call useTrack() from the server but useTrack is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","useTrack"),v=(0,t.registerClientReference)(function(){throw Error("Attempted to call useTrackMount() from the server but useTrackMount is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","useTrackMount"),b=(0,t.registerClientReference)(function(){throw Error("Attempted to call useTrackPageView() from the server but useTrackPageView is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts <module evaluation>","useTrackPageView");e.s(["default",0,n,"identifyUser",0,o,"incrementUserProperty",0,a,"initializeAnalytics",0,r,"resetAnalytics",0,i,"trackActivationFunnel",0,s,"trackAhaMoment",0,l,"trackEvent",0,c,"trackPageView",0,d,"trackSignupFunnel",0,p,"trackUpgradeFunnel",0,u,"updateUserProperties",0,m,"useTrack",0,f,"useTrackMount",0,v,"useTrackPageView",0,b])},625953,e=>{"use strict";var t=e.i(997953);let n=(0,t.registerClientReference)(function(){throw Error("Attempted to call the default export of [project]/lib/analytics.ts from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","default"),o=(0,t.registerClientReference)(function(){throw Error("Attempted to call identifyUser() from the server but identifyUser is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","identifyUser"),a=(0,t.registerClientReference)(function(){throw Error("Attempted to call incrementUserProperty() from the server but incrementUserProperty is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","incrementUserProperty"),r=(0,t.registerClientReference)(function(){throw Error("Attempted to call initializeAnalytics() from the server but initializeAnalytics is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","initializeAnalytics"),i=(0,t.registerClientReference)(function(){throw Error("Attempted to call resetAnalytics() from the server but resetAnalytics is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","resetAnalytics"),s=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackActivationFunnel() from the server but trackActivationFunnel is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","trackActivationFunnel"),l=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackAhaMoment() from the server but trackAhaMoment is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","trackAhaMoment"),c=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackEvent() from the server but trackEvent is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","trackEvent"),d=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackPageView() from the server but trackPageView is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","trackPageView"),p=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackSignupFunnel() from the server but trackSignupFunnel is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","trackSignupFunnel"),u=(0,t.registerClientReference)(function(){throw Error("Attempted to call trackUpgradeFunnel() from the server but trackUpgradeFunnel is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","trackUpgradeFunnel"),m=(0,t.registerClientReference)(function(){throw Error("Attempted to call updateUserProperties() from the server but updateUserProperties is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","updateUserProperties"),f=(0,t.registerClientReference)(function(){throw Error("Attempted to call useTrack() from the server but useTrack is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","useTrack"),v=(0,t.registerClientReference)(function(){throw Error("Attempted to call useTrackMount() from the server but useTrackMount is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","useTrackMount"),b=(0,t.registerClientReference)(function(){throw Error("Attempted to call useTrackPageView() from the server but useTrackPageView is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/lib/analytics.ts","useTrackPageView");e.s(["default",0,n,"identifyUser",0,o,"incrementUserProperty",0,a,"initializeAnalytics",0,r,"resetAnalytics",0,i,"trackActivationFunnel",0,s,"trackAhaMoment",0,l,"trackEvent",0,c,"trackPageView",0,d,"trackSignupFunnel",0,p,"trackUpgradeFunnel",0,u,"updateUserProperties",0,m,"useTrack",0,f,"useTrackMount",0,v,"useTrackPageView",0,b])},340688,e=>{"use strict";e.i(57598);var t=e.i(625953);e.n(t)},146366,e=>{"use strict";function t(e){return e>=60?"agency":e>=30?"final":e>=15?"firm":e>=5?"gentle":"pending"}function n(e,n){let o=t(n),a=["pending","gentle","firm","final","agency"],r=a.indexOf(e);return a.indexOf(o)>r}e.s(["ESCALATION_CONFIGS",0,{pending:{level:"pending",daysMin:0,daysMax:4,badgeText:"Pending",badgeColor:"#0891B2",badgeIcon:"⏳",tone:"neutral",channels:["email"],description:"Invoice sent, awaiting payment"},gentle:{level:"gentle",daysMin:5,daysMax:14,badgeText:"Gentle Reminder",badgeColor:"#CA8A04",badgeIcon:"⚠️",tone:"friendly",channels:["email"],description:"First collection activity - friendly tone"},firm:{level:"firm",daysMin:15,daysMax:29,badgeText:"Firm Notice",badgeColor:"#EA580C",badgeIcon:"⚠️",tone:"direct",channels:["email","sms"],description:"Escalated to firm language - professional"},final:{level:"final",daysMin:30,daysMax:59,badgeText:"Final Demand",badgeColor:"#991B1B",badgeIcon:"⚡",tone:"serious",channels:["email","phone"],description:"Last chance before agency escalation"},agency:{level:"agency",daysMin:60,daysMax:null,badgeText:"Agency Handoff",badgeColor:"#7F1D1D",badgeIcon:"⚖️",tone:"external",channels:["agency"],description:"Escalated to collections agency"}},"calculateEscalationLevel",()=>t,"shouldEscalate",()=>n])},581742,e=>e.a(async(t,n)=>{try{var o=e.i(868253),a=e.i(155742),r=e.i(146366),i=e.i(598941),s=e.i(340688),l=e.i(169907),c=t([o,a,i]);[o,a,i]=c.then?(await c)():c;let k="users",w="invoices",A="escalation_states",I="escalation_timeline";async function d(){let e=Date.now(),t={scannedCount:0,escalatedCount:0,pausedCount:0,skippedCount:0,errors:[]};try{(0,l.logInfo)("Starting collections escalation worker");let n=a.Timestamp.now(),i=await o.db.collection(w).where("status","in",["overdue","in_collections"]).get();for(let e of(t.scannedCount=i.size,(0,l.logInfo)(`Found ${t.scannedCount} overdue invoices to process`),i.docs))try{let o=e.data(),a=o.dueDate.toMillis?o.dueDate.toMillis():o.dueDate.getTime(),i=Math.floor((n.toMillis()-a)/864e5);if(i<0){t.skippedCount++;continue}let s=await p(o.invoiceId,i);if(s.isPaused)if(s.pauseUntil&&n.toMillis()>s.pauseUntil.getTime())await h(o.invoiceId,"auto_resume_deadline_passed"),(0,l.logInfo)(`Auto-resumed escalation for invoice ${o.reference}`,{invoiceId:o.invoiceId});else{t.pausedCount++;continue}let c=await u(o.freelancerId);if(!c.enabled){t.skippedCount++;continue}let d=(0,r.calculateEscalationLevel)(i);(0,r.shouldEscalate)(s.currentLevel,i)?(await m(o,d,i,c,s),t.escalatedCount++):t.skippedCount++}catch(o){let n=`Failed to process invoice ${e.id}: ${o.message}`;(0,l.logError)(n,o),t.errors.push(n)}let s=Date.now()-e;return(0,l.logInfo)("Collections escalation worker completed",{...t,durationMs:s}),t}catch(e){throw(0,l.logError)("Collections escalation worker failed",e),e}}async function p(e,t){let n=await o.db.collection(A).doc(e).get();if(n.exists){let t=n.data();return{invoiceId:e,currentLevel:t.currentLevel,isPaused:t.isPaused||!1,pauseReason:t.pauseReason,pausedAt:t.pausedAt?.toDate(),pauseUntil:t.pauseUntil?.toDate(),lastEscalatedAt:t.lastEscalatedAt.toDate(),nextEscalationDue:t.nextEscalationDue?.toDate(),timeline:[]}}let i=(0,r.calculateEscalationLevel)(t),s={invoiceId:e,currentLevel:i,isPaused:!1,lastEscalatedAt:new Date,timeline:[]};return await o.db.collection(A).doc(e).set({currentLevel:i,isPaused:!1,lastEscalatedAt:a.FieldValue.serverTimestamp(),createdAt:a.FieldValue.serverTimestamp(),updatedAt:a.FieldValue.serverTimestamp()}),await y(e,{eventId:`${e}-init-${Date.now()}`,invoiceId:e,escalationLevel:i,eventType:"escalated",timestamp:new Date,message:`Collections started at ${r.ESCALATION_CONFIGS[i].badgeText} level`,metadata:{daysOverdue:t}}),s}async function u(e){let t=(await o.db.collection(k).doc(e).get()).data();return{enabled:t?.collectionsEnabled??!0,userId:e,channels:{emailEnabled:!0,smsEnabled:!1,phoneEnabled:!1,agencyEnabled:!1},pauseConditions:{onPaymentClaim:!0,onDispute:!0}}}async function m(e,t,n,i,c){let d=r.ESCALATION_CONFIGS[t];(0,l.logInfo)(`Escalating invoice ${e.reference} to ${t}`,{invoiceId:e.invoiceId,from:c.currentLevel,to:t,daysOverdue:n}),await o.db.collection(A).doc(e.invoiceId).update({currentLevel:t,lastEscalatedAt:a.FieldValue.serverTimestamp(),updatedAt:a.FieldValue.serverTimestamp()}),"pending"!==t&&await o.db.collection(w).doc(e.invoiceId).update({status:"in_collections",escalationLevel:t,updatedAt:a.FieldValue.serverTimestamp()}),await y(e.invoiceId,{eventId:`${e.invoiceId}-escalate-${Date.now()}`,invoiceId:e.invoiceId,escalationLevel:t,eventType:"escalated",timestamp:new Date,message:`Escalated to ${d.badgeText} (${n} days overdue)`,metadata:{previousLevel:c.currentLevel,daysOverdue:n,tone:d.tone,channels:d.channels}}),d.channels.includes("email")&&i.channels.emailEnabled&&await f(e,t,n),d.channels.includes("sms")&&i.channels.smsEnabled&&await v(e,t,n),await (0,s.trackEvent)("collections_escalated",{invoice_id:e.invoiceId,invoice_reference:e.reference,escalation_level:t,days_overdue:n,previous_level:c.currentLevel,amount:e.amount,freelancer_id:e.freelancerId}),(0,l.logInfo)(`Successfully escalated invoice ${e.reference} to ${t}`)}async function f(e,t,n){try{let o=5;"final"===t||"agency"===t?o=30:"firm"===t&&(o=15);let a=5===o?"day5":15===o?"day15":"day30",l=await (0,i.sendReminderEmail)({invoiceId:e.invoiceId,level:a,clientEmail:e.clientEmail});l.messageId&&(await y(e.invoiceId,{eventId:`${e.invoiceId}-email-${Date.now()}`,invoiceId:e.invoiceId,escalationLevel:t,eventType:"reminder_sent",channel:"email",timestamp:new Date,message:`${r.ESCALATION_CONFIGS[t].badgeText} reminder sent via email`,metadata:{messageId:l.messageId,templateLevel:o,daysOverdue:n}}),await (0,s.trackEvent)("email_sent",{email_type:"collections_reminder",escalation_level:t,invoice_id:e.invoiceId,template_level:o.toString(),days_overdue:n}))}catch(t){throw(0,l.logError)(`Failed to send escalation email for ${e.reference}`,t),t}}async function v(e,t,n){try{(await o.db.collection(k).doc(e.freelancerId).get()).data(),(0,l.logWarn)(`SMS reminders not implemented yet - skipping for user ${e.freelancerId}`);return}catch(t){(0,l.logError)(`Failed to send escalation SMS for ${e.reference}`,t)}}async function b(e,t,n){await o.db.collection(A).doc(e).update({isPaused:!0,pauseReason:t,pausedAt:a.FieldValue.serverTimestamp(),pauseUntil:n?a.Timestamp.fromDate(n):null,updatedAt:a.FieldValue.serverTimestamp()}),await y(e,{eventId:`${e}-pause-${Date.now()}`,invoiceId:e,escalationLevel:"pending",eventType:"paused",timestamp:new Date,message:`Collections paused due to ${t.replace("_"," ")}`,metadata:{reason:t,pauseUntil:n?.toISOString()}}),(0,l.logInfo)(`Paused escalation for invoice ${e}`,{reason:t,pauseUntil:n})}async function h(e,t){await o.db.collection(A).doc(e).update({isPaused:!1,pauseReason:null,pausedAt:null,pauseUntil:null,updatedAt:a.FieldValue.serverTimestamp()}),await y(e,{eventId:`${e}-resume-${Date.now()}`,invoiceId:e,escalationLevel:"pending",eventType:"resumed",timestamp:new Date,message:`Collections resumed: ${t}`,metadata:{reason:t}}),(0,l.logInfo)(`Resumed escalation for invoice ${e}`,{reason:t})}async function y(e,t){await o.db.collection(I).doc(t.eventId).set({...t,timestamp:a.Timestamp.fromDate(t.timestamp),createdAt:a.FieldValue.serverTimestamp()})}async function C(e){return(await o.db.collection(I).where("invoiceId","==",e).orderBy("timestamp","desc").get()).docs.map(e=>{let t=e.data();return{eventId:t.eventId,invoiceId:t.invoiceId,escalationLevel:t.escalationLevel,eventType:t.eventType,channel:t.channel,timestamp:t.timestamp.toDate(),message:t.message,metadata:t.metadata}})}async function g(e){let t=await o.db.collection(A).doc(e).get();if(!t.exists)return null;let n=t.data(),a=await C(e);return{invoiceId:e,currentLevel:n.currentLevel,isPaused:n.isPaused||!1,pauseReason:n.pauseReason,pausedAt:n.pausedAt?.toDate(),pauseUntil:n.pauseUntil?.toDate(),lastEscalatedAt:n.lastEscalatedAt.toDate(),nextEscalationDue:n.nextEscalationDue?.toDate(),timeline:a}}e.s(["getEscalationState",()=>g,"getEscalationTimeline",()=>C,"pauseEscalation",()=>b,"resumeEscalation",()=>h,"runEscalationWorker",()=>d]),n()}catch(e){n(e)}},!1)];

//# sourceMappingURL=_41d04bf9._.js.map