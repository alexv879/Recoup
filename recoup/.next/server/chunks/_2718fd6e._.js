module.exports=[842259,e=>e.a(async(t,o)=>{try{var r=e.i(89171),a=e.i(493458),n=e.i(412616),s=e.i(868253),i=e.i(155742),l=e.i(169907),c=t([s,i]);async function d(e){let t=Date.now();(0,l.logInfo)("[webhook/clerk] Received webhook request");try{let o,s=await (0,a.headers)(),i=s.get("svix-id"),c=s.get("svix-timestamp"),d=s.get("svix-signature");if(!i||!c||!d)return(0,l.logError)("[webhook/clerk] Missing svix headers"),r.NextResponse.json({error:"Missing svix headers"},{status:400});let g=await e.text(),f=process.env.CLERK_WEBHOOK_SECRET;if(!f)return(0,l.logError)("[webhook/clerk] CLERK_WEBHOOK_SECRET not configured"),r.NextResponse.json({error:"Webhook secret not configured"},{status:500});let E=new n.Webhook(f);try{o=E.verify(g,{"svix-id":i,"svix-timestamp":c,"svix-signature":d})}catch(e){return(0,l.logError)("[webhook/clerk] Error verifying webhook:",e),r.NextResponse.json({error:"Invalid signature"},{status:400})}switch((0,l.logInfo)(`[webhook/clerk] Event type: ${o.type}`),o.type){case"user.created":await u(o.data);break;case"user.updated":await p(o.data);break;case"user.deleted":await h(o.data);break;case"session.created":await w(o.data);break;case"session.ended":await m(o.data);break;default:(0,l.logInfo)(`[webhook/clerk] Unhandled event type: ${o.type}`)}let k=Date.now()-t;return(0,l.logInfo)(`[webhook/clerk] Webhook processed in ${k}ms`),r.NextResponse.json({received:!0})}catch(e){return Date.now(),(0,l.logError)("[webhook/clerk] Error processing webhook:",e),r.NextResponse.json({error:"Webhook handler failed"},{status:500})}}async function u(e){(0,l.logInfo)(`[webhook/clerk] Processing user.created: ${e.id}`);try{let t=e.id,o=e.email_addresses?.[0]?.email_address||"",r=e.first_name||"",a=e.last_name||"",n=`${r} ${a}`.trim()||o.split("@")[0],c=function(){let e="ABCDEFGHJKLMNPQRSTUVWXYZ23456789",t="REL-";for(let o=0;o<6;o++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}(),d={userId:t,email:o,name:n,firstName:r,lastName:a,businessName:"",businessType:"freelancer",subscriptionTier:"free",subscriptionStatus:"active",collectionsEnabled:!1,collectionsDemoUsedThisMonth:0,referralCode:c,profilePicture:e.image_url||"",timezone:"Europe/London",language:"en",notifications:{emailNotifications:!0,inAppNotifications:!0,quietHoursStart:"21:00",quietHoursEnd:"08:00",notificationTypes:["invoice_drought","payment_delay","opportunity"],onVacation:!1},isActive:!0,status:"active",createdAt:i.Timestamp.now(),updatedAt:i.Timestamp.now(),lastLoginAt:i.Timestamp.now(),lastActiveAt:i.Timestamp.now()};await s.db.collection(s.COLLECTIONS.USERS).doc(t).set(d),await s.db.collection(s.COLLECTIONS.USER_STATS).doc(t).set({userId:t,totalInvoiced:0,totalCollected:0,totalOutstanding:0,averageInvoiceAmount:0,averagePaymentDays:0,onTimePercentage:0,totalInvoices:0,paidInvoices:0,overdueInvoices:0,draftInvoices:0,collectionsEnabled:0,successfulCollections:0,collectionsRevenue:0,xp:0,level:1,streak:0,badges:[],rank:0,achievements:[],daysActivePastMonth:0,sessionsThisMonth:0,avgSessionDuration:0,lastActiveAt:i.Timestamp.now(),churnRiskScore:0,engagementLevel:"low",calculatedAt:i.Timestamp.now(),createdAt:i.Timestamp.now(),updatedAt:i.Timestamp.now()}),(0,l.logInfo)(`[webhook/clerk] User created successfully: ${t}`)}catch(e){throw(0,l.logError)("[webhook/clerk] Error creating user:",e),e}}async function p(e){(0,l.logInfo)(`[webhook/clerk] Processing user.updated: ${e.id}`);try{let t=e.id,o=e.email_addresses?.[0]?.email_address||"",r=e.first_name||"",a=e.last_name||"",n=`${r} ${a}`.trim()||o.split("@")[0];if(!(await s.db.collection(s.COLLECTIONS.USERS).doc(t).get()).exists){(0,l.logInfo)(`[webhook/clerk] User not found, creating: ${t}`),await u(e);return}await s.db.collection(s.COLLECTIONS.USERS).doc(t).update({email:o,name:n,firstName:r,lastName:a,profilePicture:e.image_url||"",updatedAt:i.Timestamp.now()}),(0,l.logInfo)(`[webhook/clerk] User updated successfully: ${t}`)}catch(e){throw(0,l.logError)("[webhook/clerk] Error updating user:",e),e}}async function h(e){(0,l.logInfo)(`[webhook/clerk] Processing user.deleted: ${e.id}`);try{let t=e.id;await s.db.collection(s.COLLECTIONS.USERS).doc(t).update({isActive:!1,status:"deleted",email:`deleted_${t}@relay.com`,name:"Deleted User",firstName:"Deleted",lastName:"User",encryptedBankDetails:null,updatedAt:i.Timestamp.now()});let o=await s.db.collection(s.COLLECTIONS.INVOICES).where("freelancerId","==",t).get(),r=s.db.batch();o.docs.forEach(e=>{r.update(e.ref,{status:"cancelled",updatedAt:i.Timestamp.now()})}),await r.commit(),(0,l.logInfo)(`[webhook/clerk] User deleted successfully: ${t}`)}catch(e){throw(0,l.logError)("[webhook/clerk] Error deleting user:",e),e}}async function w(e){let t=e.user_id;if(t){(0,l.logInfo)(`[webhook/clerk] Processing session.created for user: ${t}`);try{await s.db.collection(s.COLLECTIONS.USERS).doc(t).update({lastLoginAt:i.Timestamp.now(),lastActiveAt:i.Timestamp.now(),updatedAt:i.Timestamp.now()}),await s.db.collection(s.COLLECTIONS.USER_STATS).doc(t).update({sessionsThisMonth:i.FieldValue.increment(1),daysActivePastMonth:i.FieldValue.increment(1),updatedAt:i.Timestamp.now()}),(0,l.logInfo)(`[webhook/clerk] Session tracked for user: ${t}`)}catch(e){(0,l.logError)("[webhook/clerk] Error tracking session:",e)}}}async function m(e){let t=e.user_id;if(t){(0,l.logInfo)(`[webhook/clerk] Processing session.ended for user: ${t}`);try{(0,l.logInfo)(`[webhook/clerk] Session ended for user: ${t}`)}catch(e){(0,l.logError)("[webhook/clerk] Error handling session end:",e)}}}[s,i]=c.then?(await c)():c,e.s(["POST",()=>d,"dynamic",0,"force-dynamic"]),o()}catch(e){o(e)}},!1),416875,e=>e.a(async(t,o)=>{try{var r=e.i(747909),a=e.i(174017),n=e.i(996250),s=e.i(759756),i=e.i(561916),l=e.i(114444),c=e.i(837092),d=e.i(869741),u=e.i(316795),p=e.i(487718),h=e.i(995169),w=e.i(47587),m=e.i(666012),g=e.i(570101),f=e.i(626937),E=e.i(10372),k=e.i(193695);e.i(52474);var v=e.i(600220),R=e.i(842259),b=t([R]);[R]=b.then?(await b)():b;let C=new r.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/webhook/clerk/route",pathname:"/api/webhook/clerk",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/webhook/clerk/route.ts",nextConfigOutput:"",userland:R}),{workAsyncStorage:A,workUnitAsyncStorage:S,serverHooks:I}=C;function y(){return(0,n.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:S})}async function T(e,t,o){C.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/webhook/clerk/route";r=r.replace(/\/index$/,"")||"/";let n=await C.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==o.waitUntil||o.waitUntil.call(o,Promise.resolve()),null;let{buildId:R,params:b,nextConfig:y,parsedUrl:T,isDraftMode:A,prerenderManifest:S,routerServerContext:I,isOnDemandRevalidate:x,revalidateOnlyGenerated:O,resolvedPathname:N,clientReferenceManifest:_,serverActionsManifest:P}=n,U=(0,d.normalizeAppPath)(r),L=!!(S.dynamicRoutes[U]||S.routes[N]),$=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,T,!1):t.end("This page could not be found"),null);if(L&&!A){let e=!!S.routes[N],t=S.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await $();throw new k.NoFallbackError}}let M=null;!L||C.isDev||A||(M=N,M="/index"===M?"/":M);let D=!0===C.isDev||!L,H=L&&!D;P&&_&&(0,l.setReferenceManifestsSingleton)({page:r,clientReferenceManifest:_,serverActionsManifest:P,serverModuleMap:(0,c.createServerModuleMap)({serverActionsManifest:P})});let q=e.method||"GET",K=(0,i.getTracer)(),j=K.getActiveScopeSpan(),F={params:b,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:o.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,o,r)=>C.onRequestError(e,t,r,I)},sharedContext:{buildId:R}},B=new u.NodeNextRequest(e),W=new u.NodeNextResponse(t),V=p.NextRequestAdapter.fromNodeNextRequest(B,(0,p.signalFromNodeResponse)(t));try{let n=async e=>C.handle(V,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let o=K.getRootSpanAttributes();if(!o)return;if(o.get("next.span_type")!==h.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${o.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=o.get("next.route");if(a){let t=`${q} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${r}`)}),l=!!(0,s.getRequestMeta)(e,"minimalMode"),c=async s=>{var i,c;let d=async({previousCacheEntry:a})=>{try{if(!l&&x&&O&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await n(s);e.fetchMetrics=F.renderOpts.fetchMetrics;let i=F.renderOpts.pendingWaitUntil;i&&o.waitUntil&&(o.waitUntil(i),i=void 0);let c=F.renderOpts.collectedTags;if(!L)return await (0,m.sendResponse)(B,W,r,F.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(r.headers);c&&(t[E.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let o=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=E.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,a=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=E.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:o,expire:a}}}}catch(t){throw(null==a?void 0:a.isStale)&&await C.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,w.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:x})},I),t}},u=await C.handleResponse({req:e,nextConfig:y,cacheKey:M,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:x,revalidateOnlyGenerated:O,responseGenerator:d,waitUntil:o.waitUntil,isMinimalMode:l});if(!L)return null;if((null==u||null==(i=u.value)?void 0:i.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(c=u.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",x?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,g.fromNodeOutgoingHttpHeaders)(u.value.headers);return l&&L||p.delete(E.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,f.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)(B,W,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};j?await c(j):await K.withPropagatedContext(e.headers,()=>K.trace(h.BaseServerSpan.handleRequest,{spanName:`${q} ${r}`,kind:i.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},c))}catch(t){if(t instanceof k.NoFallbackError||await C.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,w.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:x})}),L)throw t;return await (0,m.sendResponse)(B,W,new Response(null,{status:500})),null}}e.s(["handler",()=>T,"patchFetch",()=>y,"routeModule",()=>C,"serverHooks",()=>I,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>S]),o()}catch(e){o(e)}},!1)];

//# sourceMappingURL=_2718fd6e._.js.map