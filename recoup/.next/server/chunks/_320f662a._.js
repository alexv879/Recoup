module.exports=[382667,e=>{"use strict";var t=e.i(169907);let r=process.env.MIXPANEL_TOKEN||process.env.NEXT_PUBLIC_MIXPANEL_TOKEN;async function a(r,a,n){try{let{db:i}=await e.A(180785),o={event:r,user_id:a,properties:n,timestamp:Date.now(),created_at:new Date};await i.collection("analytics_events").add(o),(0,t.logInfo)("Event saved to Firestore",{event:r,userId:a})}catch(e){(0,t.logError)("Failed to save event to Firestore",e)}}let n=null;async function i(){if(n)return n;if(!r)return(0,t.logError)("MIXPANEL_TOKEN not configured",Error("Missing env var")),null;try{return n=(await e.A(957948)).init(r,{protocol:"https"}),(0,t.logInfo)("Mixpanel server-side initialized"),n}catch(e){return(0,t.logError)("Failed to initialize Mixpanel server-side",e),null}}async function o(e,r,n){try{let o={...r,timestamp:Date.now(),server_side:!0};await a(e,n,o);let s=await i();s&&n&&s.track(e,{distinct_id:n,...o}),(0,t.logInfo)("Server event tracked",{event:e,userId:n,properties:o})}catch(e){(0,t.logError)("Failed to track server event",e)}}e.s(["trackServerEvent",()=>o])},402945,e=>e.a(async(t,r)=>{try{var a=e.i(868253),n=e.i(598941),i=e.i(382667),o=e.i(169907),s=t([a,n]);[a,n]=s.then?(await s)():s;let f=[{level:"day5",minDays:5,displayName:"Day 5 Friendly"},{level:"day15",minDays:15,displayName:"Day 15 Firm"},{level:"day30",minDays:30,displayName:"Day 30 Legal"}];function l(e){let t=new Date,r=new Date(e),a=t.getTime()-r.getTime(),n=Math.floor(a/864e5);return Math.max(0,n)}async function c(e,t){let r=a.firestore.collection("emailEvents").where("invoiceId","==",e).where("level","==",t).where("deliveryStatus","in",["queued","sent","delivered"]).limit(1);return!(await r.get()).empty}async function d(e){let t=a.firestore.collection("emailEvents");return(await t.add({...e,sentAt:e.sentAt,createdAt:new Date})).id}async function u(e){let t,r=l(e.dueDate);if(r<5)return null;for(let s of(t=[],r>=30&&t.push(f[2]),r>=15&&t.push(f[1]),r>=5&&t.push(f[0]),t))if(!await c(e.id,s.level))try{(0,o.logInfo)(`Sending ${s.displayName} reminder for invoice ${e.invoiceNumber}`,{invoiceId:e.id,daysOverdue:r,level:s.level});let t=await d({invoiceId:e.id,userId:e.userId,level:s.level,sentAt:new Date,deliveryStatus:"queued",metadata:{clientEmail:e.clientEmail,invoiceNumber:e.invoiceNumber,amount:e.amount,daysOverdue:r}}),l=await (0,n.sendReminderEmail)({invoiceId:e.id,level:s.level,clientEmail:e.clientEmail});return await a.firestore.collection("emailEvents").doc(t).update({deliveryStatus:"sent",sendgridMessageId:l.messageId}),await (0,i.trackServerEvent)("email_sent",{invoice_id:e.id,reminder_level:s.level,days_overdue:r,recipient_email:e.clientEmail,amount:e.amount/100}),(0,o.logInfo)(`Successfully sent ${s.displayName} reminder`,{invoiceId:e.id,messageId:l.messageId}),s.level}catch(t){(0,o.logError)(`Failed to send ${s.displayName} reminder`,{invoiceId:e.id,error:t instanceof Error?t.message:String(t)}),await d({invoiceId:e.id,userId:e.userId,level:s.level,sentAt:new Date,deliveryStatus:"failed",error:t instanceof Error?t.message:String(t),metadata:{clientEmail:e.clientEmail,invoiceNumber:e.invoiceNumber,amount:e.amount,daysOverdue:r}}),await (0,i.trackServerEvent)("email_failed",{invoice_id:e.id,reminder_level:s.level,error_message:t instanceof Error?t.message:String(t)});break}return null}async function m(){let e=Date.now();(0,o.logInfo)("Email sequence worker started");let t=0,r=0,n=0;try{let i=a.firestore.collection("invoices").where("status","in",["sent","overdue"]).where("dueDate","<",new Date),s=await i.get();for(let e of((0,o.logInfo)(`Found ${s.size} potentially overdue invoices to process`),s.docs)){let a={id:e.id,...e.data()};t++,await u(a)?r++:n++}let l=Date.now()-e;return(0,o.logInfo)("Email sequence worker completed",{processed:t,sent:r,skipped:n,failed:0,durationMs:l}),{processed:t,sent:r,skipped:n,failed:0}}catch(e){throw(0,o.logError)("Email sequence worker failed",{error:e instanceof Error?e.message:String(e)}),e}}async function v(e,t,r=!1){try{let o=await a.firestore.collection("invoices").doc(e).get();if(!o.exists)return{success:!1,error:"Invoice not found"};let s={id:o.id,...o.data()};if(!r&&await c(e,t))return{success:!1,error:"This reminder has already been sent"};let u=l(s.dueDate),m=await d({invoiceId:s.id,userId:s.userId,level:t,sentAt:new Date,deliveryStatus:"queued",metadata:{clientEmail:s.clientEmail,invoiceNumber:s.invoiceNumber,amount:s.amount,daysOverdue:u}}),v=await (0,n.sendReminderEmail)({invoiceId:s.id,level:t,clientEmail:s.clientEmail});return await a.firestore.collection("emailEvents").doc(m).update({deliveryStatus:"sent",sendgridMessageId:v.messageId}),await (0,i.trackServerEvent)("email_sent",{invoice_id:s.id,reminder_level:t,days_overdue:u,recipient_email:s.clientEmail,amount:s.amount/100,manual_trigger:!0}),{success:!0,messageId:v.messageId,recipientEmail:s.clientEmail,invoiceAmount:s.amount/100}}catch(r){return(0,o.logError)("Failed to send manual reminder",{invoiceId:e,level:t,error:r instanceof Error?r.message:String(r)}),{success:!1,error:r instanceof Error?r.message:"Failed to send email"}}}async function p(e){let t=a.firestore.collection("emailEvents").where("invoiceId","==",e).orderBy("sentAt","desc");return(await t.get()).docs.map(e=>({id:e.id,...e.data()}))}e.s(["getInvoiceEmailHistory",()=>p,"runEmailSequenceWorker",()=>m,"sendManualReminder",()=>v]),r()}catch(e){r(e)}},!1),530842,e=>e.a(async(t,r)=>{try{var a=e.i(89171),n=e.i(402945),i=e.i(169907),o=t([n]);async function s(e){try{let t=e.headers.get("authorization"),r=process.env.CRON_SECRET;if(r&&t!==`Bearer ${r}`)return(0,i.logWarn)("Unauthorized cron job access attempt"),a.NextResponse.json({error:"Unauthorized"},{status:401});(0,i.logInfo)("Email sequence cron job started");let o=await (0,n.runEmailSequenceWorker)();return(0,i.logInfo)("Email sequence cron job completed",o),a.NextResponse.json({success:!0,...o})}catch(e){return(0,i.logError)("Email sequence cron job failed",{error:e instanceof Error?e.message:String(e)}),a.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function l(e){return s(e)}[n]=o.then?(await o)():o,e.s(["GET",()=>s,"POST",()=>l]),r()}catch(e){r(e)}},!1),95520,e=>e.a(async(t,r)=>{try{var a=e.i(747909),n=e.i(174017),i=e.i(996250),o=e.i(759756),s=e.i(561916),l=e.i(114444),c=e.i(837092),d=e.i(869741),u=e.i(316795),m=e.i(487718),v=e.i(995169),p=e.i(47587),f=e.i(666012),E=e.i(570101),h=e.i(626937),g=e.i(10372),w=e.i(193695);e.i(52474);var y=e.i(600220),R=e.i(530842),_=t([R]);[R]=_.then?(await _)():_;let A=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/cron/process-email-sequence/route",pathname:"/api/cron/process-email-sequence",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/cron/process-email-sequence/route.ts",nextConfigOutput:"",userland:R}),{workAsyncStorage:S,workUnitAsyncStorage:x,serverHooks:C}=A;function I(){return(0,i.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:x})}async function N(e,t,r){A.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/cron/process-email-sequence/route";a=a.replace(/\/index$/,"")||"/";let i=await A.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:R,params:_,nextConfig:I,parsedUrl:N,isDraftMode:S,prerenderManifest:x,routerServerContext:C,isOnDemandRevalidate:b,revalidateOnlyGenerated:D,resolvedPathname:T,clientReferenceManifest:k,serverActionsManifest:P}=i,q=(0,d.normalizeAppPath)(a),M=!!(x.dynamicRoutes[q]||x.routes[T]),O=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,N,!1):t.end("This page could not be found"),null);if(M&&!S){let e=!!x.routes[T],t=x.dynamicRoutes[q];if(t&&!1===t.fallback&&!e){if(I.experimental.adapterPath)return await O();throw new w.NoFallbackError}}let U=null;!M||A.isDev||S||(U=T,U="/index"===U?"/":U);let F=!0===A.isDev||!M,H=M&&!F;P&&k&&(0,l.setReferenceManifestsSingleton)({page:a,clientReferenceManifest:k,serverActionsManifest:P,serverModuleMap:(0,c.createServerModuleMap)({serverActionsManifest:P})});let j=e.method||"GET",$=(0,s.getTracer)(),K=$.getActiveScopeSpan(),L={params:_,prerenderManifest:x,renderOpts:{experimental:{authInterrupts:!!I.experimental.authInterrupts},cacheComponents:!!I.cacheComponents,supportsDynamicResponse:F,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:I.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>A.onRequestError(e,t,a,C)},sharedContext:{buildId:R}},B=new u.NodeNextRequest(e),z=new u.NodeNextResponse(t),X=m.NextRequestAdapter.fromNodeNextRequest(B,(0,m.signalFromNodeResponse)(t));try{let i=async e=>A.handle(X,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=$.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==v.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${j} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${a}`)}),l=!!(0,o.getRequestMeta)(e,"minimalMode"),c=async o=>{var s,c;let d=async({previousCacheEntry:n})=>{try{if(!l&&b&&D&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await i(o);e.fetchMetrics=L.renderOpts.fetchMetrics;let s=L.renderOpts.pendingWaitUntil;s&&r.waitUntil&&(r.waitUntil(s),s=void 0);let c=L.renderOpts.collectedTags;if(!M)return await (0,f.sendResponse)(B,z,a,L.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,E.toNodeOutgoingHttpHeaders)(a.headers);c&&(t[g.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,n=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:b})},C),t}},u=await A.handleResponse({req:e,nextConfig:I,cacheKey:U,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:x,isRoutePPREnabled:!1,isOnDemandRevalidate:b,revalidateOnlyGenerated:D,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:l});if(!M)return null;if((null==u||null==(s=u.value)?void 0:s.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(c=u.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",b?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,E.fromNodeOutgoingHttpHeaders)(u.value.headers);return l&&M||m.delete(g.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,h.getCacheControlHeader)(u.cacheControl)),await (0,f.sendResponse)(B,z,new Response(u.value.body,{headers:m,status:u.value.status||200})),null};K?await c(K):await $.withPropagatedContext(e.headers,()=>$.trace(v.BaseServerSpan.handleRequest,{spanName:`${j} ${a}`,kind:s.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},c))}catch(t){if(t instanceof w.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:q,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:b})}),M)throw t;return await (0,f.sendResponse)(B,z,new Response(null,{status:500})),null}}e.s(["handler",()=>N,"patchFetch",()=>I,"routeModule",()=>A,"serverHooks",()=>C,"workAsyncStorage",()=>S,"workUnitAsyncStorage",()=>x]),r()}catch(e){r(e)}},!1),180785,e=>{e.v(t=>Promise.all(["server/chunks/lib_firebaseAdmin_ts_6f154e3c._.js"].map(t=>e.l(t))).then(()=>t(157491)))},957948,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__6a18c72d._.js","server/chunks/[root-of-the-server]__c740643f._.js"].map(t=>e.l(t))).then(()=>t(424109)))}];

//# sourceMappingURL=_320f662a._.js.map