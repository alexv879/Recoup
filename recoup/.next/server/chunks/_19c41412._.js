module.exports=[17608,e=>{"use strict";async function t(e){return console.log("Creating agency recovery transaction:",e),{id:`txn_${Math.random().toString(36).substring(2,15)}`,invoiceId:e.invoiceId,amount:e.amount,agencyId:e.agencyId,status:"pending",createdAt:new Date}}e.s(["createAgencyRecoveryTransaction",()=>t])},615155,e=>e.a(async(t,a)=>{try{var n=e.i(868253),o=e.i(155742),i=e.i(169907),r=e.i(598941),c=e.i(527356),s=e.i(453515);e.i(17608);var l=t([n,o,r,s]);[n,o,r,s]=l.then?(await l)():l;let g=[{agencyId:"agency_lowell_uk",agencyName:"Lowell Financial Ltd",agencyContactEmail:"handoffs@lowellfinancial.co.uk",agencyContactPhone:"+44 113 281 8820",commissionPercentage:25,minimumDebtAmount:100,specialties:["consumer","small_business"]},{agencyId:"agency_cabot_uk",agencyName:"Cabot Credit Management",agencyContactEmail:"newcases@cabotcm.co.uk",agencyContactPhone:"+44 113 234 5678",commissionPercentage:30,minimumDebtAmount:250,specialties:["consumer","high_value"]},{agencyId:"agency_intrum_uk",agencyName:"Intrum UK",agencyContactEmail:"uk.handoffs@intrum.com",agencyContactPhone:"+44 161 923 4000",commissionPercentage:20,minimumDebtAmount:50,specialties:["consumer","small_business","international"]}];async function d(e){try{let t=await n.db.collection("invoices").doc(e).get();if(!t.exists)return{eligible:!1,reason:"Invoice not found"};let a=t.data();if("paid"===a.status)return{eligible:!1,reason:"Invoice already paid"};if("in_collections"===a.status&&!(await n.db.collection("agency_handoffs").where("invoiceId","==",e).where("handoffStatus","in",["pending","in_progress"]).get()).empty)return{eligible:!1,reason:"Already escalated to agency"};if(a.amount<50)return{eligible:!1,reason:"Amount too low for agency escalation (minimum Â£50)"};if((await n.db.collection("collection_attempts").where("invoiceId","==",e).orderBy("createdAt","desc").get()).size<3)return{eligible:!1,reason:"Insufficient collection attempts (minimum 3 required)"};if(60>Math.floor((Date.now()-a.dueDate.toMillis())/864e5))return{eligible:!1,reason:"Not enough time passed (minimum 60 days overdue)"};let o="agency_intrum_uk";return a.amount>=250?o="agency_cabot_uk":a.amount>=100&&(o="agency_lowell_uk"),{eligible:!0,recommendedAgency:o}}catch(e){return(0,i.logError)("Failed to check escalation eligibility",e),{eligible:!1,reason:"System error"}}}async function u(e){try{let t=await d(e.invoiceId);if(!t.eligible)return{success:!1,error:t.reason||"Not eligible for escalation"};let a=(await n.db.collection("invoices").doc(e.invoiceId).get()).data(),l=(await n.db.collection("collection_attempts").where("invoiceId","==",e.invoiceId).orderBy("createdAt","desc").get()).docs.map(e=>e.data()),u=g.find(t=>t.agencyId===e.agencyId);if(!u)return{success:!1,error:"Agency not found"};if(a.amount<u.minimumDebtAmount)return{success:!1,error:`Amount below agency minimum (\xa3${u.minimumDebtAmount})`};let m=Math.floor((Date.now()-a.dueDate.toMillis())/864e5),f=l.map(e=>{let t="email";return t="sms_reminder"===e.attemptType?"sms":"physical_letter"===e.attemptType?"letter":"ai_call"===e.attemptType?"call":"email",{date:e.createdAt,type:t,summary:`${e.attemptType}: ${e.result}${e.resultDetails?" - "+e.resultDetails:""}`}}),p=n.db.collection("agency_handoffs").doc(),h={handoffId:p.id,invoiceId:e.invoiceId,freelancerId:e.freelancerId,agencyId:e.agencyId,handoffDate:o.FieldValue.serverTimestamp(),handoffStatus:"pending",agencyName:u.agencyName,agencyContactEmail:u.agencyContactEmail,agencyContactPhone:u.agencyContactPhone,originalAmount:a.amount,outstandingAmount:a.amount,daysPastDue:m,documents:[],communicationHistory:f,commissionPercentage:u.commissionPercentage,notes:e.notes,agencyUpdates:[],createdAt:o.FieldValue.serverTimestamp()};await p.set(h),await n.db.collection("invoices").doc(e.invoiceId).update({status:"in_collections",updatedAt:o.FieldValue.serverTimestamp()});let y=n.db.collection("collection_attempts").doc();await y.set({attemptId:y.id,invoiceId:e.invoiceId,freelancerId:e.freelancerId,attemptType:"manual_contact",attemptDate:o.FieldValue.serverTimestamp(),attemptNumber:l.length+1,result:"pending",resultDetails:`Escalated to ${u.agencyName}`,escalatedToAgency:!0,agencyHandoffId:p.id,escalationDate:o.FieldValue.serverTimestamp(),isPremiumFeature:!0,createdAt:o.FieldValue.serverTimestamp()});try{await (0,r.sendNotificationEmail)({toEmail:u.agencyContactEmail,subject:`New Collection Case: ${a.reference} - \xa3${a.amount.toFixed(2)}`,message:`A new collection case has been assigned to ${u.agencyName}.

**Invoice Details:**
- Invoice Number: ${a.reference}
- Client: ${a.clientName}
- Amount: \xa3${a.amount.toFixed(2)}
- Days Past Due: ${m}
- Original Invoice Date: ${a.invoiceDate.toDate().toLocaleDateString()}

**Case Summary:**
${f.length} collection attempts have been made:
${f.slice(0,5).map(e=>`- ${e.type}: ${e.summary}`).join("\n")}

**Next Steps:**
1. Review the case details in your agency portal
2. Download supporting documents (invoice PDFs, communication history)
3. Begin collection process per your standard procedures

Commission: ${u.commissionPercentage}% of recovered amount

Case ID: ${p.id}`,actionUrl:`${process.env.NEXT_PUBLIC_APP_URL}/agency/cases/${p.id}`}),(0,i.logInfo)("Agency notification email sent",{handoffId:p.id,agencyEmail:u.agencyContactEmail})}catch(e){(0,i.logError)("Failed to send agency notification email",e)}try{let t=(await n.db.collection("users").doc(e.freelancerId).get()).data();if(t){let s={notificationId:(0,c.nanoid)(),userId:e.freelancerId,type:"agency_handoff",title:"Invoice escalated to collection agency",message:`Invoice ${a.reference} (${a.clientName}) has been escalated to ${u.agencyName} for professional collection. You'll be notified of any updates.`,read:!1,actionUrl:`${process.env.NEXT_PUBLIC_APP_URL}/dashboard/collections/agency/${p.id}`,metadata:{handoffId:p.id,invoiceId:e.invoiceId,agencyName:u.agencyName},createdAt:o.Timestamp.now()};await n.db.collection("notifications").add(s),t.notificationPreferences?.emailNotifications&&t.email&&await (0,r.sendNotificationEmail)({toEmail:t.email,subject:"Invoice Escalated to Collection Agency",message:`Your invoice ${a.reference} for ${a.clientName} (\xa3${a.amount.toFixed(2)}) has been escalated to ${u.agencyName}.

**What happens next:**
1. ${u.agencyName} will take over the collection process
2. You'll receive updates on their progress
3. If payment is recovered, the commission (${u.commissionPercentage}%) will be automatically deducted

**You don't need to do anything** - the agency will handle all communication with the client.

We'll notify you of any developments.`,actionUrl:s.actionUrl}),(0,i.logInfo)("Freelancer notification sent",{handoffId:p.id,freelancerId:e.freelancerId})}}catch(e){(0,i.logError)("Failed to send freelancer notification",e)}try{let t=[],n={handoffId:p.id,invoiceId:e.invoiceId,generatedAt:new Date().toISOString(),attempts:f,summary:{totalAttempts:f.length,attemptTypes:{email:f.filter(e=>"email"===e.type).length,sms:f.filter(e=>"sms"===e.type).length,call:f.filter(e=>"call"===e.type).length,letter:f.filter(e=>"letter"===e.type).length},daysPastDue:m,originalAmount:a.amount}},r=Buffer.from(JSON.stringify(n,null,2),"utf-8"),c=await (0,s.uploadCommunicationHistory)({contentBuffer:r,fileName:`communication-history-${Date.now()}.json`,contentType:"application/json",handoffId:p.id,freelancerId:e.freelancerId});c.success&&c.storagePath&&(t.push(c.storagePath),await p.update({documents:t,documentUrls:t.map(e=>({storagePath:e,uploadedAt:o.Timestamp.now(),documentType:"communication_history"}))}),(0,i.logInfo)("Communication history uploaded to storage",{handoffId:p.id,storagePath:c.storagePath}))}catch(e){(0,i.logError)("Failed to upload documents to storage",e)}return(0,i.logInfo)("Agency handoff created",{handoffId:p.id,invoiceId:e.invoiceId,agencyId:e.agencyId}),{success:!0,handoffId:p.id}}catch(e){return(0,i.logError)("Failed to create agency handoff",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function m(e){try{let t=await n.db.collection("agency_handoffs").doc(e).get();if(!t.exists)return null;return t.data()}catch(e){return(0,i.logError)("Failed to get handoff details",e),null}}async function f(e,t){try{let a=n.db.collection("agency_handoffs").where("freelancerId","==",e).orderBy("createdAt","desc");return t?.status&&(a=a.where("handoffStatus","==",t.status)),t?.limit&&(a=a.limit(t.limit)),(await a.get()).docs.map(e=>e.data())}catch(e){return(0,i.logError)("Failed to list handoffs",e),[]}}e.s(["checkEscalationEligibility",()=>d,"createAgencyHandoff",()=>u,"getHandoffDetails",()=>m,"listFreelancerHandoffs",()=>f]),a()}catch(e){a(e)}},!1),487504,e=>e.a(async(t,a)=>{try{var n=e.i(89171),o=e.i(707218),i=e.i(615155),r=e.i(309053),c=e.i(520143),s=e.i(15776),l=e.i(169907),d=t([i,c]);async function u(e){let t=Date.now();try{let{userId:a}=await (0,o.auth)();if(!a)throw new s.UnauthorizedError;(0,l.logApiRequest)("POST","/api/collections/agency-handoff",a),await (0,c.requireClerkFeature)(a,"dedicated_account_manager");let{invoiceId:d,agencyId:u,notes:m}=await e.json();if(!d||!u)throw new s.ValidationError("Missing required fields: invoiceId, agencyId");let f=await (0,i.checkEscalationEligibility)(d);if(!f.eligible)return n.NextResponse.json({success:!1,error:f.reason,eligible:!1},{status:400});let g=await (0,i.createAgencyHandoff)({invoiceId:d,freelancerId:a,agencyId:u,notes:m});if(!g.success)throw Error(g.error||"Failed to create handoff");await (0,r.logPremiumFeatureUsage)({userId:a,feature:"agency_handoff",invoiceId:d,cost:0});let p=Date.now()-t;return(0,l.logApiResponse)("POST","/api/collections/agency-handoff",200,{duration:p,userId:a}),n.NextResponse.json({success:!0,message:"Invoice escalated to agency successfully",handoffId:g.handoffId,note:"Agency will begin collection efforts within 2-3 business days"})}catch(t){let e=await (0,s.handleApiError)(t);return n.NextResponse.json(e.body,{status:e.status})}}async function m(e){try{let{userId:t}=await (0,o.auth)();if(!t)throw new s.UnauthorizedError;let{searchParams:a}=new URL(e.url),r=a.get("handoffId"),c=a.get("status");if(r){let e=await (0,i.getHandoffDetails)(r);if(!e)throw new s.NotFoundError("Handoff not found");if(e.freelancerId!==t)throw new s.ForbiddenError("You do not have access to this handoff");return n.NextResponse.json({success:!0,handoff:e})}let l=await (0,i.listFreelancerHandoffs)(t,{status:c,limit:50});return n.NextResponse.json({success:!0,handoffs:l,count:l.length})}catch(t){let e=await (0,s.handleApiError)(t);return n.NextResponse.json(e.body,{status:e.status})}}[i,c]=d.then?(await d)():d,e.s(["GET",()=>m,"POST",()=>u,"dynamic",0,"force-dynamic"]),a()}catch(e){a(e)}},!1),210640,e=>e.a(async(t,a)=>{try{var n=e.i(747909),o=e.i(174017),i=e.i(996250),r=e.i(759756),c=e.i(561916),s=e.i(114444),l=e.i(837092),d=e.i(869741),u=e.i(316795),m=e.i(487718),f=e.i(995169),g=e.i(47587),p=e.i(666012),h=e.i(570101),y=e.i(626937),w=e.i(10372),v=e.i(193695);e.i(52474);var I=e.i(600220),E=e.i(487504),b=t([E]);[E]=b.then?(await b)():b;let C=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/collections/agency-handoff/route",pathname:"/api/collections/agency-handoff",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/collections/agency-handoff/route.ts",nextConfigOutput:"",userland:E}),{workAsyncStorage:_,workUnitAsyncStorage:N,serverHooks:P}=C;function R(){return(0,i.patchFetch)({workAsyncStorage:_,workUnitAsyncStorage:N})}async function A(e,t,a){C.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/collections/agency-handoff/route";n=n.replace(/\/index$/,"")||"/";let i=await C.prepare(e,t,{srcPage:n,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:E,params:b,nextConfig:R,parsedUrl:A,isDraftMode:_,prerenderManifest:N,routerServerContext:P,isOnDemandRevalidate:x,revalidateOnlyGenerated:T,resolvedPathname:D,clientReferenceManifest:$,serverActionsManifest:F}=i,S=(0,d.normalizeAppPath)(n),U=!!(N.dynamicRoutes[S]||N.routes[D]),k=async()=>((null==P?void 0:P.render404)?await P.render404(e,t,A,!1):t.end("This page could not be found"),null);if(U&&!_){let e=!!N.routes[D],t=N.dynamicRoutes[S];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await k();throw new v.NoFallbackError}}let O=null;!U||C.isDev||_||(O=D,O="/index"===O?"/":O);let H=!0===C.isDev||!U,M=U&&!H;F&&$&&(0,s.setReferenceManifestsSingleton)({page:n,clientReferenceManifest:$,serverActionsManifest:F,serverModuleMap:(0,l.createServerModuleMap)({serverActionsManifest:F})});let j=e.method||"GET",q=(0,c.getTracer)(),B=q.getActiveScopeSpan(),L={params:b,prerenderManifest:N,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,n)=>C.onRequestError(e,t,n,P)},sharedContext:{buildId:E}},V=new u.NodeNextRequest(e),K=new u.NodeNextResponse(t),X=m.NextRequestAdapter.fromNodeNextRequest(V,(0,m.signalFromNodeResponse)(t));try{let i=async e=>C.handle(X,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=q.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==f.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=a.get("next.route");if(o){let t=`${j} ${o}`;e.setAttributes({"next.route":o,"http.route":o,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${n}`)}),s=!!(0,r.getRequestMeta)(e,"minimalMode"),l=async r=>{var c,l;let d=async({previousCacheEntry:o})=>{try{if(!s&&x&&T&&!o)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(r);e.fetchMetrics=L.renderOpts.fetchMetrics;let c=L.renderOpts.pendingWaitUntil;c&&a.waitUntil&&(a.waitUntil(c),c=void 0);let l=L.renderOpts.collectedTags;if(!U)return await (0,p.sendResponse)(V,K,n,L.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(n.headers);l&&(t[w.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,o=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:I.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:o}}}}catch(t){throw(null==o?void 0:o.isStale)&&await C.onRequestError(e,t,{routerKind:"App Router",routePath:n,routeType:"route",revalidateReason:(0,g.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:x})},P),t}},u=await C.handleResponse({req:e,nextConfig:R,cacheKey:O,routeKind:o.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:x,revalidateOnlyGenerated:T,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:s});if(!U)return null;if((null==u||null==(c=u.value)?void 0:c.kind)!==I.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",x?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),_&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,h.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&U||m.delete(w.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,y.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(V,K,new Response(u.value.body,{headers:m,status:u.value.status||200})),null};B?await l(B):await q.withPropagatedContext(e.headers,()=>q.trace(f.BaseServerSpan.handleRequest,{spanName:`${j} ${n}`,kind:c.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},l))}catch(t){if(t instanceof v.NoFallbackError||await C.onRequestError(e,t,{routerKind:"App Router",routePath:S,routeType:"route",revalidateReason:(0,g.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:x})}),U)throw t;return await (0,p.sendResponse)(V,K,new Response(null,{status:500})),null}}e.s(["handler",()=>A,"patchFetch",()=>R,"routeModule",()=>C,"serverHooks",()=>P,"workAsyncStorage",()=>_,"workUnitAsyncStorage",()=>N]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=_19c41412._.js.map