module.exports=[441310,e=>{"use strict";async function t(e){try{return console.log("Initiating AI collection call:",e),await new Promise(e=>setTimeout(e,1e3)),{success:!0,callSid:`CA${Math.random().toString(36).substring(2,15)}`}}catch(e){return console.error("Failed to initiate AI collection call:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}function a({estimatedDurationMinutes:e,includeSMS:t,includeRecording:a}){let i=.04*!!t,r=.013*e,o=.002*!!a*e,n=.06*e;return{twilioCallCost:r,twilioSMSCost:i,openAICost:n,recordingCost:o,total:r+i+o+n}}e.s(["estimateAICallCost",()=>a,"initiateAICollectionCall",()=>t])},865474,e=>e.a(async(t,a)=>{try{var i=e.i(89171),r=e.i(707218),o=e.i(868253),n=e.i(155742),l=e.i(441310),s=e.i(309053),c=e.i(520143),d=e.i(401645),u=e.i(15776),p=e.i(169907),h=t([o,n,c,d]);async function m(e){let t=Date.now();try{let{userId:a}=await (0,r.auth)();if(!a)throw new u.UnauthorizedError;(0,p.logApiRequest)("POST","/api/collections/ai-call",a),await (0,c.requireClerkFeature)(a,"ai_voice_calls_5_per_month"),await (0,d.validateConsentOrThrow)(a,["call","call_recording","data_storage"]);let{invoiceId:h,recipientPhone:m,recipientName:w,enablePaymentDuringCall:f=!0}=await e.json();if(!h||!m||!w)throw new u.ValidationError("Missing required fields: invoiceId, recipientPhone, recipientName");let g=await o.db.collection("invoices").doc(h).get();if(!g.exists)throw new u.NotFoundError("Invoice not found");let R=g.data();if(R.freelancerId!==a)throw new u.ForbiddenError("You do not have access to this invoice");if("paid"===R.status)throw new u.ValidationError("Invoice is already paid");if(R.amount<50)throw new u.ValidationError("Invoice amount too low for AI call (minimum Â£50)");let v=(await o.db.collection("users").doc(a).get()).data(),A=v?.businessName||v?.name||"Your Freelancer",E=R.dueDate instanceof Date?R.dueDate.getTime():R.dueDate.toMillis(),C=Math.floor((Date.now()-E)/864e5),y=await o.db.collection("collection_attempts").where("invoiceId","==",h).where("attemptType","==","ai_call").orderBy("createdAt","desc").limit(1).get();if(!y.empty){let e=y.docs[0].data(),t=e.createdAt instanceof Date?e.createdAt.getTime():e.createdAt.toMillis();if((Date.now()-t)/36e5<24)throw new u.ValidationError("Cannot make another AI call within 24 hours of the last call")}let I=await (0,l.initiateAICollectionCall)({recipientPhone:m,recipientName:w,invoiceReference:R.reference,amount:R.amount,dueDate:R.dueDate instanceof Date?R.dueDate.toLocaleDateString("en-GB"):R.dueDate.toDate().toLocaleDateString("en-GB"),daysPastDue:C,businessName:A,invoiceId:h,freelancerId:a,enablePaymentDuringCall:f});if(!I.success)throw Error(I.error||"Failed to initiate call");let x=o.db.collection("collection_attempts").doc();await x.set({attemptId:x.id,invoiceId:h,freelancerId:a,attemptType:"ai_call",attemptDate:n.FieldValue.serverTimestamp(),attemptNumber:(R.collectionsAttempts||0)+1,result:"pending",resultDetails:"AI call initiated, awaiting completion",callSID:I.callSid,callStartedAt:n.FieldValue.serverTimestamp(),callOutcome:void 0,isPremiumFeature:!0,consentGiven:!0,createdAt:n.FieldValue.serverTimestamp()}),await o.db.collection("invoices").doc(h).update({collectionsAttempts:n.FieldValue.increment(1),updatedAt:n.FieldValue.serverTimestamp()});let S=(0,l.estimateAICallCost)({estimatedDurationMinutes:5,includeSMS:f,includeRecording:!0});await (0,c.incrementUsageCounter)(a,"ai_call"),await (0,s.logPremiumFeatureUsage)({userId:a,feature:"ai_voice_calls",invoiceId:h,cost:S.total}),(0,p.logInfo)("AI collection call initiated",{invoiceId:h,callSid:I.callSid,estimatedCost:S.total});let T=Date.now()-t;return(0,p.logApiResponse)("POST","/api/collections/ai-call",200,{duration:T,userId:a}),i.NextResponse.json({success:!0,message:"AI collection call initiated",attemptId:x.id,callSid:I.callSid,estimatedCost:S.total,costBreakdown:S,note:"Call is in progress. You will receive a notification when it completes."})}catch(r){let e=Date.now()-t;if((0,p.logApiResponse)("POST","/api/collections/ai-call",r.statusCode||500,{duration:e}),402===r.statusCode)return i.NextResponse.json({error:r.message,upgradeRequired:!0,upgradeUrl:"/settings/billing/upgrade"},{status:402});let a=await (0,u.handleApiError)(r);return i.NextResponse.json(a.body,{status:a.status})}}async function w(e){try{let{userId:t}=await (0,r.auth)();if(!t)throw new u.UnauthorizedError;let{searchParams:a}=new URL(e.url),n=a.get("attemptId");if(!n)throw new u.ValidationError("Missing attemptId parameter");let l=await o.db.collection("collection_attempts").doc(n).get();if(!l.exists)throw new u.NotFoundError("Call attempt not found");let s=l.data();if(s?.freelancerId!==t)throw new u.ForbiddenError("You do not have access to this call");return i.NextResponse.json({success:!0,attempt:{attemptId:s.attemptId,callSid:s.callSID,status:s.result,outcome:s.callOutcome,duration:s.callDuration,transcript:s.callTranscript,summary:s.callNotes,recordingUrl:s.callRecordingUrl,startedAt:s.callStartedAt,endedAt:s.callEndedAt,nextAction:s.nextAction}})}catch(t){let e=await (0,u.handleApiError)(t);return i.NextResponse.json(e.body,{status:e.status})}}[o,n,c,d]=h.then?(await h)():h,e.s(["GET",()=>w,"POST",()=>m,"dynamic",0,"force-dynamic"]),a()}catch(e){a(e)}},!1),737954,e=>e.a(async(t,a)=>{try{var i=e.i(747909),r=e.i(174017),o=e.i(996250),n=e.i(759756),l=e.i(561916),s=e.i(114444),c=e.i(837092),d=e.i(869741),u=e.i(316795),p=e.i(487718),h=e.i(995169),m=e.i(47587),w=e.i(666012),f=e.i(570101),g=e.i(626937),R=e.i(10372),v=e.i(193695);e.i(52474);var A=e.i(600220),E=e.i(865474),C=t([E]);[E]=C.then?(await C)():C;let x=new i.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/collections/ai-call/route",pathname:"/api/collections/ai-call",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/collections/ai-call/route.ts",nextConfigOutput:"",userland:E}),{workAsyncStorage:S,workUnitAsyncStorage:T,serverHooks:D}=x;function y(){return(0,o.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:T})}async function I(e,t,a){x.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let i="/api/collections/ai-call/route";i=i.replace(/\/index$/,"")||"/";let o=await x.prepare(e,t,{srcPage:i,multiZoneDraftMode:!1});if(!o)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:E,params:C,nextConfig:y,parsedUrl:I,isDraftMode:S,prerenderManifest:T,routerServerContext:D,isOnDemandRevalidate:b,revalidateOnlyGenerated:_,resolvedPathname:N,clientReferenceManifest:P,serverActionsManifest:O}=o,U=(0,d.normalizeAppPath)(i),M=!!(T.dynamicRoutes[U]||T.routes[N]),F=async()=>((null==D?void 0:D.render404)?await D.render404(e,t,I,!1):t.end("This page could not be found"),null);if(M&&!S){let e=!!T.routes[N],t=T.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await F();throw new v.NoFallbackError}}let q=null;!M||x.isDev||S||(q=N,q="/index"===q?"/":q);let k=!0===x.isDev||!M,H=M&&!k;O&&P&&(0,s.setReferenceManifestsSingleton)({page:i,clientReferenceManifest:P,serverActionsManifest:O,serverModuleMap:(0,c.createServerModuleMap)({serverActionsManifest:O})});let j=e.method||"GET",V=(0,l.getTracer)(),$=V.getActiveScopeSpan(),B={params:C,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:k,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,i)=>x.onRequestError(e,t,i,D)},sharedContext:{buildId:E}},K=new u.NodeNextRequest(e),L=new u.NodeNextResponse(t),G=p.NextRequestAdapter.fromNodeNextRequest(K,(0,p.signalFromNodeResponse)(t));try{let o=async e=>x.handle(G,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=V.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==h.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${j} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${i}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),c=async n=>{var l,c;let d=async({previousCacheEntry:r})=>{try{if(!s&&b&&_&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await o(n);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let c=B.renderOpts.collectedTags;if(!M)return await (0,w.sendResponse)(K,L,i,B.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(i.headers);c&&(t[R.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,r=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:A.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==r?void 0:r.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:i,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:b})},D),t}},u=await x.handleResponse({req:e,nextConfig:y,cacheKey:q,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:b,revalidateOnlyGenerated:_,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:s});if(!M)return null;if((null==u||null==(l=u.value)?void 0:l.kind)!==A.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(c=u.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",b?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,f.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&M||p.delete(R.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,g.getCacheControlHeader)(u.cacheControl)),await (0,w.sendResponse)(K,L,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};$?await c($):await V.withPropagatedContext(e.headers,()=>V.trace(h.BaseServerSpan.handleRequest,{spanName:`${j} ${i}`,kind:l.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},c))}catch(t){if(t instanceof v.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:b})}),M)throw t;return await (0,w.sendResponse)(K,L,new Response(null,{status:500})),null}}e.s(["handler",()=>I,"patchFetch",()=>y,"routeModule",()=>x,"serverHooks",()=>D,"workAsyncStorage",()=>S,"workUnitAsyncStorage",()=>T]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=_18be5229._.js.map