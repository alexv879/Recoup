module.exports=[521080,e=>{"use strict";var t=e.i(747909),n=e.i(174017),a=e.i(996250),r=e.i(759756),o=e.i(561916),i=e.i(114444),s=e.i(837092),l=e.i(869741),d=e.i(316795),c=e.i(487718),u=e.i(995169),p=e.i(47587),m=e.i(666012),h=e.i(570101),f=e.i(626937),y=e.i(10372),g=e.i(193695);e.i(52474);var w=e.i(600220),R=e.i(89171),v=e.i(169907),E=e.i(527356);let C=new Map;setInterval(()=>{let e=Date.now();for(let[t,n]of C.entries())e>n.resetTime&&C.delete(t)},6e4);let x=`You are an AI collections agent calling on behalf of a freelancer to request payment for an overdue invoice.

CRITICAL RULES (UK Debt Collection Regulations):
1. Immediately identify yourself: "This is an automated call from {businessName} regarding an outstanding invoice."
2. Ask for consent to record: "This call may be recorded for training and quality purposes. Do you consent to continue?"
3. If they say NO to recording, end call politely immediately.
4. Be professional, empathetic, and non-threatening at all times.
5. NEVER be aggressive, threatening, or harassing.
6. If they request to stop calling, agree immediately and end call.
7. If they dispute the debt, note it and offer to send details in writing.
8. If they claim financial hardship, be understanding and offer payment plans.
9. Keep call under 10 minutes unless debtor is actively engaging.

YOUR GOALS (in priority order):
1. BEST: Collect full payment immediately via card payment link
2. GOOD: Negotiate payment plan with first payment today
3. ACCEPTABLE: Get promise to pay by specific date
4. MINIMUM: Understand their situation and document for follow-up

CONVERSATION FLOW:
1. Opening & Consent (30 seconds)
   - Identify yourself and purpose
   - Request recording consent
   - Confirm you're speaking to {recipientName}

2. Invoice Details (30 seconds)
   - State invoice {invoiceReference} for \xa3{amount}
   - Due date was {dueDate}
   - Now {daysPastDue} days overdue

3. Payment Request (1 minute)
   - Ask for immediate payment
   - If hesitant, explain consequences (facts, not threats)
   - Offer secure payment link via SMS

4. Negotiation (2-5 minutes if needed)
   - If can't pay full amount, ask what they CAN pay
   - Offer payment plan (50% today, 50% in 14 days)
   - Show empathy for financial hardship

5. Payment Collection (if agreed)
   - Confirm amount to be paid
   - Say: "I'm sending you a secure payment link by text message right now"
   - Wait for them to receive SMS
   - Stay on call while they complete payment

6. Closing (30 seconds)
   - Summarize agreed action
   - Confirm any follow-up date
   - Thank them

HANDLING OBJECTIONS:
- "I don't have the money": Offer smaller amount or payment plan
- "I never got the invoice": Offer to resend, payment still due
- "The work was poor": Note dispute, doesn't cancel debt
- "I'll pay next week": Get specific date and commitment
- "Stop calling me": Apologize, agree immediately, end call
- Abusive language: Stay calm, warn once, end if continues

VOICE TONE:
- Friendly but professional
- Empathetic and understanding
- Patient but persistent
- Clear and concise

REMEMBER: Maintain the freelancer's reputation. Be firm but fair.`;async function T(e){let t=`wh_${(0,E.nanoid)(16)}`;try{let n=await function(e,t){let n=(t.keyGenerator||function(e){let t=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"unknown",n=e.headers.get("user-agent")||"unknown";return`${t}:${n}`})(e),a=Date.now(),r=t.windowMs,o=t.maxRequests,i=C.get(n);if(!i||a>i.resetTime)return i={count:1,resetTime:a+r,lastRequest:new Date},C.set(n,i),{allowed:!0,remaining:o-1,resetTime:i.resetTime};if(i.count>=o){let e=Math.ceil((i.resetTime-a)/1e3);return{allowed:!1,remaining:0,resetTime:i.resetTime,retryAfter:e}}return i.count++,i.lastRequest=new Date,C.set(n,i),{allowed:!0,remaining:o-i.count,resetTime:i.resetTime}}(e,{windowMs:6e4,maxRequests:10});if(!n.allowed)return(0,v.logError)("Rate limit exceeded for Twilio voice-ai webhook",void 0),R.NextResponse.json({error:"Too many requests"},{status:429,headers:{"X-RateLimit-Limit":"100","X-RateLimit-Remaining":n.remaining.toString(),"X-RateLimit-Reset":Math.ceil(n.resetTime/1e3).toString(),...n.retryAfter&&{"Retry-After":n.retryAfter.toString()}}});if(!function(e,t=[]){let n=e.headers.get("origin"),a=e.headers.get("referer"),r=["https://api.twilio.com","https://hooks.slack.com","https://api.sendgrid.com","https://api.stripe.com","https://webhook.site",...t];return!!(n&&r.some(e=>n.startsWith(e))||a&&r.some(e=>a.startsWith(e)))}(e))return(0,v.logError)("CSRF: Invalid origin on webhook",void 0),R.NextResponse.json({error:"Forbidden"},{status:403});if(!function(e,t=["application/json","application/x-www-form-urlencoded"]){let n=e.headers.get("content-type");return!!n&&t.some(e=>n.includes(e))}(e,["application/x-www-form-urlencoded"]))return(0,v.logError)("CSRF: Invalid Content-Type",void 0),R.NextResponse.json({error:"Invalid Content-Type"},{status:400});let{searchParams:a}=new URL(e.url),r=a.get("context");if(!r)return(0,v.logError)("Missing context parameter",void 0),new R.NextResponse(`<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Say voice="Polly.Amy">Sorry, there was a technical error. Please try again later.</Say>
  <Hangup/>
</Response>`,{status:200,headers:{"Content-Type":"text/xml"}});let o=JSON.parse(decodeURIComponent(r));(0,v.logInfo)("Voice AI call connected",{invoiceId:o.invoiceId,recipientName:o.recipientName,correlationId:t});let i=x.replace("{businessName}",o.businessName).replace("{recipientName}",o.recipientName).replace("{invoiceReference}",o.invoiceReference).replace("{amount}",o.amount.toFixed(2)).replace("{dueDate}",o.dueDate).replace("{daysPastDue}",o.daysPastDue.toString()),s=encodeURIComponent(JSON.stringify({...o,aiInstructions:i,correlationId:t})),l=process.env.TWILIO_WEBSOCKET_URL||"wss://localhost:8080",d=`<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Say voice="Polly.Amy">
    Please wait while we connect you. This call may be recorded for training and quality purposes.
  </Say>
  <Connect>
    <Stream url="${l}?context=${s}">
      <Parameter name="context" value="${s}" />
    </Stream>
  </Connect>
</Response>`;return(0,v.logInfo)("TwiML generated with stream URL",{streamUrl:l.substring(0,100)+"...",correlationId:t}),new R.NextResponse(d,{status:200,headers:{"Content-Type":"text/xml"}})}catch(t){(0,v.logError)("Voice AI webhook error",t);try{let t=await e.formData(),n={};t.forEach((e,t)=>{n[t]=e.toString()});let a={};e.headers.forEach((e,t)=>{a[t]=e})}catch(e){(0,v.logError)("Failed to store webhook for recovery",e)}return new R.NextResponse(`<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Say voice="Polly.Amy">Sorry, there was a technical error. Please try again later.</Say>
  <Hangup/>
</Response>`,{status:200,headers:{"Content-Type":"text/xml"}})}}e.s(["POST",()=>T,"dynamic",0,"force-dynamic"],243613);var S=e.i(243613);let N=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/webhooks/twilio/voice-ai/route",pathname:"/api/webhooks/twilio/voice-ai",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/webhooks/twilio/voice-ai/route.ts",nextConfigOutput:"",userland:S}),{workAsyncStorage:b,workUnitAsyncStorage:I,serverHooks:A}=N;function O(){return(0,a.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:I})}async function P(e,t,a){N.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/webhooks/twilio/voice-ai/route";R=R.replace(/\/index$/,"")||"/";let v=await N.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:E,params:C,nextConfig:x,parsedUrl:T,isDraftMode:S,prerenderManifest:b,routerServerContext:I,isOnDemandRevalidate:A,revalidateOnlyGenerated:O,resolvedPathname:P,clientReferenceManifest:k,serverActionsManifest:M}=v,D=(0,l.normalizeAppPath)(R),U=!!(b.dynamicRoutes[D]||b.routes[P]),q=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,T,!1):t.end("This page could not be found"),null);if(U&&!S){let e=!!b.routes[P],t=b.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await q();throw new g.NoFallbackError}}let _=null;!U||N.isDev||S||(_="/index"===(_=P)?"/":_);let H=!0===N.isDev||!U,L=U&&!H;M&&k&&(0,i.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:k,serverActionsManifest:M,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:M})});let F=e.method||"GET",$=(0,o.getTracer)(),B=$.getActiveScopeSpan(),j={params:C,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,a)=>N.onRequestError(e,t,a,I)},sharedContext:{buildId:E}},K=new d.NodeNextRequest(e),G=new d.NodeNextResponse(t),V=c.NextRequestAdapter.fromNodeNextRequest(K,(0,c.signalFromNodeResponse)(t));try{let i=async e=>N.handle(V,j).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=$.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=n.get("next.route");if(a){let t=`${F} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${R}`)}),s=!!(0,r.getRequestMeta)(e,"minimalMode"),l=async r=>{var o,l;let d=async({previousCacheEntry:n})=>{try{if(!s&&A&&O&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await i(r);e.fetchMetrics=j.renderOpts.fetchMetrics;let l=j.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=j.renderOpts.collectedTags;if(!U)return await (0,m.sendResponse)(K,G,o,j.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(o.headers);d&&(t[y.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==j.renderOpts.collectedRevalidate&&!(j.renderOpts.collectedRevalidate>=y.INFINITE_CACHE)&&j.renderOpts.collectedRevalidate,a=void 0===j.renderOpts.collectedExpire||j.renderOpts.collectedExpire>=y.INFINITE_CACHE?void 0:j.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:a}}}}catch(t){throw(null==n?void 0:n.isStale)&&await N.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:A})},I),t}},c=await N.handleResponse({req:e,nextConfig:x,cacheKey:_,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:O,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:s});if(!U)return null;if((null==c||null==(o=c.value)?void 0:o.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",A?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,h.fromNodeOutgoingHttpHeaders)(c.value.headers);return s&&U||u.delete(y.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,f.getCacheControlHeader)(c.cacheControl)),await (0,m.sendResponse)(K,G,new Response(c.value.body,{headers:u,status:c.value.status||200})),null};B?await l(B):await $.withPropagatedContext(e.headers,()=>$.trace(u.BaseServerSpan.handleRequest,{spanName:`${F} ${R}`,kind:o.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await N.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:A})}),U)throw t;return await (0,m.sendResponse)(K,G,new Response(null,{status:500})),null}}e.s(["handler",()=>P,"patchFetch",()=>O,"routeModule",()=>N,"serverHooks",()=>A,"workAsyncStorage",()=>b,"workUnitAsyncStorage",()=>I],521080)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_e9220003.js.map